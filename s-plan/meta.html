<!DOCTYPE html>
<html lang="es-CO">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="../assets/img/s-plan/icono.png">
    <title id="pageTitle">
        Meta
    </title>
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
    <!-- Nucleo Icons -->
    <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/aa4ade8d2d.js" crossorigin="anonymous"></script>
    <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
    <!-- CSS Files -->
    <link id="pagestyle" href="../assets/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
</head>

<body class="g-sidenav-show bg-gray-100">
    <div class="min-height-300 position-absolute w-100"
        style="background: url('../assets/img/s-plan/bg-splan.png') no-repeat center center/cover;"></div>

    <aside
        class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4"
        id="sidenav-main" style="z-index:1040;">
        <div class="sidenav-header mb-3">
            <a class="navbar-brand m-0 d-flex flex-column align-items-center" href="../index.html">
                <!-- Logo institucional Argon -->
                <img src="../assets/img/s-plan/logo.png" class="navbar-brand-img mb-0" style="max-height:60px;"
                    alt="main_logo">

            </a>
        </div>
        <hr class="horizontal dark mt-0 mb-2">
        <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
            <ul class="navbar-nav">
                <!-- INICIO -->

                <li class="nav-item ">
                    <a class="nav-link d-flex align-items-center gap-2" href="index.html">
                        <i class="fa-solid fa-home text-muted"></i>
                        <span class="nav-link-text">Inicio</span>
                    </a>

                </li>

                <!-- PDI 2024-2028 -->
                <li class="nav-item">
                    <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#"
                        data-bs-toggle="collapse" data-bs-target="#submenuPdi" aria-expanded="true">
                        <!-- Cambié aria-expanded a true -->
                        <div class="d-flex align-items-center">
                            <div
                                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <i class="ni ni-credit-card text-warning text-sm opacity-10"></i>
                            </div>
                            <span class="nav-link-text ms-1">S-Plan</span>
                        </div>
                    </a>
                    <ul class="collapse list-unstyled ms-4 show" id="submenuPdi"> <!-- Agregué la clase "show" -->
                        <li class="nav-item "><a class="nav-link active" href="../s-plan/dashboard.html"><i
                                    class="ni ni-chart-pie-35 text-success"></i> <span class="ms-1">Dashboard</span></a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="../s-plan/ejes.html"><i
                                    class="ni ni-bullet-list-67 text-primary"></i> <span class="ms-1">Ejes</span></a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="../s-plan/programas.html"><i
                                    class="ni ni-bullet-list-67 text-primary"></i> <span class="ms-1">Lista de
                                    Programas</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="../s-plan/dashboard.html"><i
                                    class="ni ni-single-copy-04 text-info"></i> <span
                                    class="ms-1">Observaciones</span></a></li>
                    </ul>
                </li>



                <!-- Buscar / Seleccionar (abre modal) -->
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2" href="#" data-bs-toggle="modal"
                        data-bs-target="#modalBusquedaPolitica">
                        <i class="fa-solid fa-magnifying-glass text-warning"></i>
                        <span class="nav-link-text">Buscar / Seleccionar</span>
                    </a>
                </li>

                <!-- Otras Apps -->
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 collapsed" href="#" data-bs-toggle="collapse"
                        data-bs-target="#submenuPdi" aria-expanded="false">
                        <i class="fa-solid fa-rocket text-danger"></i>
                        <span class="nav-link-text">Otras Apps</span>
                    </a>
                    <ul class="collapse list-unstyled ms-4" id="submenuPdi">
                        <li>
                            <a class="nav-link" href="https://sigunitropico.com" target="_blank">
                                <i class="fa-solid fa-globe text-danger"></i> SIG Unitrópico
                            </a>
                        </li>
                        <li>
                            <a class="nav-link" href="https://sigunitropico.com/planeacion" target="_blank">
                                <i class="fa-solid fa-chart-line text-info"></i> Planeación
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- Admin (solo visible para admins) -->
                <li class="nav-item mt-3 admin-only admin-s-plan" style="display: none;">
                    <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Administración</h6>
                </li>
                <li class="nav-item admin-only admin-s-plan" style="display: none;">
                    <a class="nav-link d-flex align-items-center gap-2" href="../pages/usuarios.html" target="_blank">
                        <i class="fa-solid fa-users text-danger"></i>
                        <span class="nav-link-text">Usuarios</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Login/Logout Aside: centrado y sin overlap -->
        <div class="sidenav-footer w-100 text-center mt-auto pb-3">

            <div class="card card-plain shadow-none mb-2" id="sidenavCard">
                <img class="w-80 mx-auto" src="../assets/img/illustrations/logo-simbolo-unitropico-1.png"
                    alt="sidebar_illustration">
                <div class="card-body text-center p-2 w-100 pt-0">
                    <div class="docs-info">
                        <h6 class="mb-0">¿Necesitas ayuda?</h6>
                        <p class="text-xs font-weight-bold mb-0">Por favor revisa nuestras guías</p>
                    </div>
                </div>
            </div>
            <div id="asideAuthBtn" class="mb-2 d-flex flex-column align-items-center"></div>
            <a href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard" target="_blank"
                class="btn btn-dark btn-sm w-70 mb-2"><i class="fa-solid fa-book me-2"></i>Manual de uso</a>
            <a class="btn btn-primary btn-sm w-70 mb-0" href="mailto:innovacionplaneacion@unitropico.edu.co"
                type="button">
                <i class="fa-solid fa-envelope me-2"></i> Soporte técnico
            </a>

        </div>
    </aside>
    <main class="main-content position-relative border-radius-lg ">
        <!-- Navbar -->
        <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur"
            data-scroll="false">
            <div class="container-fluid py-1 px-3">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                        <li class="breadcrumb-item text-sm cursor-pointer"><a class="opacity-5 text-white"
                                id="id_eje_nav">EJE-</a>
                        </li>

                        <li class="breadcrumb-item text-sm cursor-pointer"><a class="opacity-5 text-white"
                                id="id_programa_nav">PROG-</a>
                        </li>
                        <li class="breadcrumb-item text-sm cursor-pointer" aria-current="page"><a
                                class="opacity-5 text-white" id="id_proyecto_nav">BPU-</a></li>
                        <li class="breadcrumb-item text-sm dropdown">

                            <a href="#" class="dropdown-toggle" id="id_meta_nav" data-bs-toggle="dropdown"
                                style="color: #fff;" aria-expanded="false" role="button">
                                E1M1 </a>

                            <div class="dropdown-menu dropdown-menu-dark p-3 metas-grid-container">
                                <div class="metas-grid" id="containerMetasDropdown">
                                    <a href="#" class="meta-item active">E1M1</a>
                                    <a href="#" class="meta-item">E1M2</a>
                                    <a href="#" class="meta-item">E1M3</a>
                                    <a href="#" class="meta-item">E1M4</a>
                                    <a href="#" class="meta-item">E1M5</a>
                                    <a href="#" class="meta-item">E2M1</a>
                                    <a href="#" class="meta-item">E2M2</a>
                                    <a href="#" class="meta-item">E2M3</a>
                                    <a href="#" class="meta-item">E2M4</a>
                                    <a href="#" class="meta-item">E2M5</a>

                                </div>
                                <style>
                                    /* Contenedor principal del dropdown para darle un ancho fijo */
                                    .metas-grid-container {
                                        min-width: 300px;
                                        /* Ajusta el ancho según necesites */
                                        border-radius: .75rem;
                                        /* Bordes más suaves */
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        backdrop-filter: blur(10px);
                                        background-color: rgba(255, 255, 255, 0.85);
                                        /* Fondo oscuro semitransparente */
                                    }

                                    /* El grid que contiene todas las metas */
                                    .metas-grid {
                                        display: grid;
                                        /* Crea 5 columnas de ancho flexible. Cambia el 5 si quieres más o menos columnas */
                                        grid-template-columns: repeat(5, 1fr);
                                        gap: 8px;
                                        /* Espacio entre los botones de meta */
                                    }

                                    /* Estilo para cada botón de meta */
                                    .meta-item {
                                        display: block;
                                        padding: 8px;
                                        border-radius: 6px;
                                        color: #333 !important;
                                        /* Color de texto claro */
                                        text-align: center;
                                        text-decoration: none;
                                        background-color: rgba(0, 0, 0, 0.05);
                                        transition: background-color 0.2s ease, transform 0.2s ease;
                                        font-size: 0.85rem;
                                        font-weight: 500;
                                    }

                                    /* Efecto al pasar el mouse */
                                    .meta-item:hover {
                                        background-color: rgba(0, 0, 0, 0.2);
                                        color: #fff !important;
                                        transform: translateY(-2px);
                                    }

                                    /* Estilo para la meta que está seleccionada */
                                    .meta-item.active {
                                        background-color: #00594e;
                                        /* Color primario de Bootstrap (puedes cambiarlo) */
                                        color: #fff !important;
                                        font-weight: 700;
                                    }
                                </style>
                            </div>
                        </li>
                    </ol>
                    <h6 class="font-weight-bolder text-white mb-0">última actualización <p
                            class="font-weight-normal text-white mb-0" id="fecha_actualizacion">calculando...</p>
                    </h6>
                </nav>
                <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
                    <div class="ms-md-auto pe-md-3 d-flex align-items-center">

                    </div>
                    <ul class="navbar-nav  justify-content-end">
                        <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
                            <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                                <div class="sidenav-toggler-inner">
                                    <i class="sidenav-toggler-line bg-white"></i>
                                    <i class="sidenav-toggler-line bg-white"></i>
                                    <i class="sidenav-toggler-line bg-white"></i>
                                </div>
                            </a>
                        </li>

                        <li class="nav-item px-3 d-flex align-items-center">
                            <a href="javascript:;" class="nav-link text-white p-0">
                                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
                            </a>
                        </li>

                        <li class="nav-item dropdown pe-2 d-flex align-items-center">
                            <a href="javascript:;" class="nav-link text-white p-0" id="dropdownMenuButton"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa fa-bell cursor-pointer"></i>
                            </a>
                            <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4"
                                aria-labelledby="dropdownMenuButton">
                                <li class="mb-2">
                                    <a class="dropdown-item border-radius-md" href="javascript:;">
                                        <div class="d-flex py-1">
                                            <div class="my-auto">
                                                <img src="../assets/img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                                            </div>
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="text-sm font-weight-normal mb-1">
                                                    <span class="font-weight-bold">New message</span> from Laur
                                                </h6>
                                                <p class="text-xs text-secondary mb-0">
                                                    <i class="fa fa-clock me-1"></i>
                                                    13 minutes ago
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li class="mb-2">
                                    <a class="dropdown-item border-radius-md" href="javascript:;">
                                        <div class="d-flex py-1">
                                            <div class="my-auto">
                                                <img src="../assets/img/small-logos/logo-spotify.svg"
                                                    class="avatar avatar-sm bg-gradient-dark  me-3 ">
                                            </div>
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="text-sm font-weight-normal mb-1">
                                                    <span class="font-weight-bold">New album</span> by Travis Scott
                                                </h6>
                                                <p class="text-xs text-secondary mb-0">
                                                    <i class="fa fa-clock me-1"></i>
                                                    1 day
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item border-radius-md" href="javascript:;">
                                        <div class="d-flex py-1">
                                            <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                                                <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    xmlns:xlink="http://www.w3.org/1999/xlink">
                                                    <title>credit-card</title>
                                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                        <g transform="translate(-2169.000000, -745.000000)"
                                                            fill="#FFFFFF" fill-rule="nonzero">
                                                            <g transform="translate(1716.000000, 291.000000)">
                                                                <g transform="translate(453.000000, 454.000000)">
                                                                    <path class="color-background"
                                                                        d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z"
                                                                        opacity="0.593633743"></path>
                                                                    <path class="color-background"
                                                                        d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z">
                                                                    </path>
                                                                </g>
                                                            </g>
                                                        </g>
                                                    </g>
                                                </svg>
                                            </div>
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="text-sm font-weight-normal mb-1">
                                                    Payment successfully completed
                                                </h6>
                                                <p class="text-xs text-secondary mb-0">
                                                    <i class="fa fa-clock me-1"></i>
                                                    2 days
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown pe-2 d-flex align-items-center">
                            <div id="perfilUsuario" class="d-flex align-items-center gap-2" data-bs-toggle="dropdown"
                                role="button" aria-expanded="false">
                                <img id="imgPerfilUsuario" src="https://ui-avatars.com/api/?name=Usuario" alt="Foto"
                                    class="rounded-circle border" width="40" height="40" style="object-fit:cover;">
                            </div>
                            <ul class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4"
                                aria-labelledby="perfilUsuario">
                                <li>
                                    <a class="dropdown-item border-radius-md" href="../pages/profile.html">
                                        <div class="d-flex py-1 align-items-center">
                                            <div class="my-auto">
                                                <img id="imgPerfilUsuarioDropdown"
                                                    src="https://ui-avatars.com/api/?name=Usuario"
                                                    class="avatar avatar-sm me-3 rounded-circle border"
                                                    style="object-fit:cover;">
                                            </div>
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm text-dark fw-bold"
                                                    style="color: #000!important;" id="nombrePerfilUsuario">
                                                    Usuario</h6>
                                                <small class="text-xs text-muted mb-0" id="correoPerfilUsuario">
                                                    Correo</small>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item border-radius-md" id="rolesUsuario">
                                        <i class="fas fa-user-circle text-primary me-2"></i> Usuario
                                    </a>
                                </li>
                                <li>
                                    <button id="logButton"
                                        class="dropdown-item border-radius-md text-danger d-flex align-items-center">
                                        <span><i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar sesión</span>
                                    </button>
                                    <style>
                                        /* Soluciona contraste para botón rojo dentro de dropdown Bootstrap */
                                        #logButton.dropdown-item.text-danger:hover,
                                        #logButton.dropdown-item.text-danger:focus {
                                            background-color: #dc3545 !important;
                                            /* danger */
                                            color: #fff !important;
                                            /* blanco */
                                            border-radius: .5rem;
                                        }

                                        #logButton.dropdown-item.text-danger:hover i,
                                        #logButton.dropdown-item.text-danger:focus i {
                                            color: #fff !important;
                                        }
                                    </style>
                                </li>
                            </ul>
                        </li>

                    </ul>
                </div>
            </div>
        </nav>
        <!-- End Navbar -->

        <!---  CONTENIDO ---->

        <div class="container-fluid my-4">
            <div class="row">
                <div class="col-12">

                    <!-- Avance del programa y fecha -->
                    <div class="row mt-0">
                        <div class="col-md">
                            <div class="card shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="col">
                                        <!-- Título del programa -->
                                        <h3 class="fw-bold text-muted mb-3 text-start">
                                            Meta:
                                            <span id="metaTitle" class="fw-bold text-primary mb-3"
                                                style="line-height: 100%;">Meta</span>
                                        </h3>
                                    </div>

                                    <!-- Progreso -->
                                    <h6 class="card-title text-muted mb-2">Progreso de la Meta</h6>
                                    <div class="progress" style="height: 30px; width: 100%;" id="contenedorBarraMeta">
                                        <div id="barraAvance"
                                            class="progress-bar progress-bar-striped progress-bar-animated"
                                            role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <span class="text-muted" style="font-size: 0.75rem; font-style: italic;">
                                            Progreso actualizado dinámicamente <span id="porcentajeMeta">0%</span>
                                        </span>

                                        <button class="badge bg-secondary text-white border-0" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseProgramacion"
                                            aria-expanded="false" aria-controls="collapseProgramacion"
                                            style="cursor:pointer; font-size:0.75rem; padding:.5rem .75rem;">
                                            Ver programación
                                            <i class="fa-solid fa-chart-line ms-2 text-white"></i>
                                            <!-- Línea ascendente -->

                                        </button>

                                    </div>

                                    <!-- Acordeón -->
                                    <div class="accordion" id="acordeonProgramacion">
                                        <div class="accordion-item">

                                            <div id="collapseProgramacion" class="accordion-collapse collapse"
                                                aria-labelledby="headingProgramacion"
                                                data-bs-parent="#acordeonProgramacion">
                                                <div class="accordion-body">
                                                    <div id="programacionFisicaMeta" style="height: 300px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Fin acordeón -->

                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Resumen general -->
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">Cantidad de Acciones</h5>
                                    <p class="fs-4 fw-semibold" id="totalAcciones">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">Acciones Completadas</h5>
                                    <p id="accionesCompletadas"></p>
                                    <div class="progress" style="height: 15px;">
                                        <div id="barraAccionesCompletadas" class="progress-bar" role="progressbar"
                                            style="width: 0%;">
                                            0%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">Inversión de la meta</h5>
                                    <p class="fs-4 fw-semibold" id="inversionMeta">0</p>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- Gráfica de ejecución por Acciones -->
                    <div class="row mt-4">
                        <!-- Columna para "Avance General" -->
                        <div class="col-12 col-sm-12 col-md-4 col-lg-3 mb-2">
                            <div class="card shadow p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-primary mb-0">Avance General</h5>
                                </div>
                                <div id="avanceGeneralMeta" style="height: 300px;"></div>
                            </div>
                        </div>
                        <!-- Columna para "Cumplimiento Plan Anual de Acciones" -->
                        <div class="col-12 col-sm-12 col-md-8 col-lg-9">
                            <div class="card shadow p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-primary mb-0">Cumplimiento Plan Anual de Acciones (%)</h5>
                                </div>
                                <div id="graficaCumplimientoMeta" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>



                    <!-- Gráfica de ejecución por Acciones -->
                    <div class="row mt-4" style="display: none;">
                        <div class="col-12">
                            <div class="card shadow p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-primary mb-0">Avance General Anual</h5>
                                </div>
                                <div id="graficaProyeccionMeta" style="height: 300px;"></div>

                            </div>
                        </div>
                    </div>

                    <!-- Lista de Acciones dentro de la meta -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                                <h3 class="text-primary m-0">
                                    Acciones de la Meta <span id="id_meta_sub2">E1M1</span>
                                </h3>

                                <!-- Grupo de indicadores -->
                                <div class="d-flex flex-wrap align-items-center gap-2" role="group"
                                    aria-label="Indicadores de tipo">
                                    <!-- Acumulación -->
                                    <span id="spanAcumulacion"
                                        class="badge rounded-pill bg-info text-white px-3 py-2 d-inline-flex align-items-center cursor-pointer"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Indica que la meta se mide de manera acumulada en el tiempo."
                                        style="font-size: .8rem;">
                                        <i class="fa-solid fa-layer-group me-1"></i> Acumulado
                                    </span>

                                    <!-- Programación -->
                                    <span id="spanProgramacion"
                                        class="badge rounded-pill bg-success text-white px-3 py-2 d-inline-flex align-items-center cursor-pointer"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Indica que la meta se mide por porcentaje de cumplimiento anual."
                                        style="font-size: .8rem;">
                                        <i class="fa-solid fa-percent me-1"></i> Porcentaje
                                    </span>
                                </div>
                            </div>

                            <div class="row mt-3" id="acciones_meta">
                                <div class="d-flex justify-content-center align-items-center" style="height:300px;">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>

        </div>

        </div>


        <style>
            #barraAvance {
                font-size: 1rem;
                font-weight: bold;
            }

            .card-title {
                font-weight: 600;
            }

            .btn-outline-success,
            .btn-outline-primary {
                min-width: 140px;
            }

            @media (max-width: 768px) {
                .progress {
                    height: 25px;
                }

                #graficaProyectosProgramaBar {
                    height: 400px !important;
                }
            }

            .evidencia-item {
                background: rgba(255, 255, 255, 0.87);
                border: 1.2px solid #e7f3ef;
                box-shadow: 0 2px 12px #00594e0b;
                border-left: 4px solid #B5A160;
                transition: box-shadow .16s;
            }

            .evidencia-item:hover {
                box-shadow: 0 6px 26px #00594e15;
                border-left-color: #00594E;
            }

            .evidencia-icono i {
                filter: drop-shadow(0 2px 8px #b5a16022);
            }
        </style>

        <!--- FIN DEL CONTENIDO ---->

        <footer class="footer pt-3  ">
            <div class="container-fluid">
                <div class="row align-items-center justify-content-lg-between">
                    <div class="col-lg-6 mb-lg-0 mb-4">
                        <div class="copyright text-center text-sm text-muted text-lg-start">
                            ©
                            <script>
                                document.write(new Date().getFullYear())
                            </script>,
                            desarrollado por la <a style="font-weight: 600; color: #00584e;"
                                href="https://sigunitropico.com/planeacion-estrategica">Oficina Asesora de
                                Planeación</a> - Unitrópico

                        </div>
                    </div>
                    <div class="col-lg-6">
                        <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                            <li class="nav-item">
                                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Synaris
                                    Corp</a>
                            </li>
                            <li class="nav-item">
                                <a href="https://www.creative-tim.com/presentation" class="nav-link text-muted"
                                    target="_blank">About
                                    Us</a>
                            </li>
                            <li class="nav-item">
                                <a href="https://www.creative-tim.com/blog" class="nav-link text-muted"
                                    target="_blank">Blog</a>
                            </li>
                            <li class="nav-item">
                                <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted"
                                    target="_blank">License</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
        </div>
    </main>
    <div class="fixed-plugin">
        <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear"
                viewBox="0 0 16 16">
                <path
                    d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0" />
                <path
                    d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z" />
            </svg>
        </a>
        <div class="card shadow-lg">
            <div class="card-header pb-0 pt-3 ">
                <div class="float-start">
                    <h5 class="mt-3 mb-0">Argon Configurator</h5>
                    <p>See our dashboard options.</p>
                </div>
                <div class="float-end mt-4">
                    <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
                        <i class="fa fa-close"></i>
                    </button>
                </div>
                <!-- End Toggle Button -->
            </div>
            <hr class="horizontal dark my-1">
            <div class="card-body pt-sm-3 pt-0 overflow-auto">
                <!-- Sidebar Backgrounds -->
                <div>
                    <h6 class="mb-0">Sidebar Colors</h6>
                </div>
                <a href="javascript:void(0)" class="switch-trigger background-color">
                    <div class="badge-colors my-2 text-start">
                        <span class="badge filter bg-gradient-primary active" data-color="primary"
                            onclick="sidebarColor(this)"></span>
                        <span class="badge filter bg-gradient-dark" data-color="dark"
                            onclick="sidebarColor(this)"></span>
                        <span class="badge filter bg-gradient-info" data-color="info"
                            onclick="sidebarColor(this)"></span>
                        <span class="badge filter bg-gradient-success" data-color="success"
                            onclick="sidebarColor(this)"></span>
                        <span class="badge filter bg-gradient-warning" data-color="warning"
                            onclick="sidebarColor(this)"></span>
                        <span class="badge filter bg-gradient-danger" data-color="danger"
                            onclick="sidebarColor(this)"></span>
                    </div>
                </a>
                <!-- Sidenav Type -->
                <div class="mt-3">
                    <h6 class="mb-0">Sidenav Type</h6>
                    <p class="text-sm">Choose between 2 different sidenav types.</p>
                </div>
                <div class="d-flex">
                    <button class="btn bg-gradient-primary w-100 px-3 mb-2 active me-2" data-class="bg-white"
                        onclick="sidebarType(this)">White</button>
                    <button class="btn bg-gradient-primary w-100 px-3 mb-2" data-class="bg-default"
                        onclick="sidebarType(this)">Dark</button>
                </div>
                <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
                <!-- Navbar Fixed -->
                <div class="d-flex my-3">
                    <h6 class="mb-0">Navbar Fixed</h6>
                    <div class="form-check form-switch ps-0 ms-auto my-auto">
                        <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed"
                            onclick="navbarFixed(this)">
                    </div>
                </div>
                <hr class="horizontal dark my-sm-4">
                <div class="mt-2 mb-5 d-flex">
                    <h6 class="mb-0">Light / Dark</h6>
                    <div class="form-check form-switch ps-0 ms-auto my-auto">
                        <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version"
                            onclick="darkMode(this)">
                    </div>
                </div>
                <a class="btn bg-gradient-dark w-100" href="https://www.creative-tim.com/product/argon-dashboard">Free
                    Download</a>
                <a class="btn btn-outline-dark w-100"
                    href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard">View
                    documentation</a>
                <div class="w-100 text-center">
                    <a class="github-button" href="https://github.com/creativetimofficial/argon-dashboard"
                        data-icon="octicon-star" data-size="large" data-show-count="true"
                        aria-label="Star creativetimofficial/argon-dashboard on GitHub">Star</a>
                    <h6 class="mt-3">Thank you for sharing!</h6>
                    <a href="https://twitter.com/intent/tweet?text=Check%20Argon%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fargon-dashboard"
                        class="btn btn-dark mb-0 me-2" target="_blank">
                        <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/argon-dashboard"
                        class="btn btn-dark mb-0 me-2" target="_blank">
                        <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal EVIDENCIAS S-PLAN (estilo "políticas", sin Resumen ni Cargar) -->
    <style>
        :root {
            --brand: #00594E;
            --gold: #B5A160;
            --bg-1: #f8f9fa;
            --bg-2: #ffffff;
            --bg-3: #f1f3f5;
            --muted: #6c757d;
            --line: #dee2e6;
        }

        /* Tamaño y alto */
        .modal-xxl {
            max-width: 1280px;
        }

        .modal-full-h {
            height: 90vh;
        }

        .modal-full-h .modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--bg-2);
            border: 1px solid var(--line);
            border-radius: 18px;
        }

        /* Header / Footer pegajosos (claros) */
        #evidenciasModal .modal-header {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #fff;
            border-bottom: 1px solid var(--line);
        }

        #evidenciasModal .modal-footer {
            position: sticky;
            bottom: 0;
            z-index: 2;
            background: #fff;
            border-top: 1px solid var(--line);
        }

        #evidenciasModal .modal-body {
            overflow: auto;
        }

        /* Tabs principales y subtabs */
        .nav-tabs .nav-link {
            color: var(--brand);
            border: 0;
            border-bottom: 2px solid transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--brand);
            font-weight: 600;
            border-bottom-color: var(--gold);
            background: transparent;
        }

        /* Pegar las barras de tabs al top al hacer scroll */
        #navTabEvidenciasSPlan {
            position: sticky;
            top: .25rem;
            z-index: 4;
            background: #fff;
        }

        #evidenciasTabsSPlan {
            position: sticky;
            top: 3.25rem;
            z-index: 3;
            background: #fff;
        }

        /* ===== Botones fantasma mejorados ===== */
        .btn-ghost {
            --_bd: rgba(0, 0, 0, .14);
            --_bg: transparent;
            --_fg: var(--brand);
            border: 1px solid var(--_bd);
            background: var(--_bg);
            color: var(--_fg);
            border-radius: 12px;
            padding: .45rem .8rem;
            line-height: 1;
            font-weight: 600;
            transition: background .15s ease, border-color .15s ease, transform .08s ease;
        }

        .btn-ghost:hover {
            border-color: rgba(0, 0, 0, .22);
            background: rgba(0, 0, 0, .04);
        }

        .btn-ghost:active {
            transform: translateY(1px);
            color: #333;
        }

        .btn-ghost:focus-visible {
            outline: 3px solid rgba(0, 89, 78, .18);
            outline-offset: 2px;
            color: #000;
        }

        .btn-ghost i {
            font-size: .95rem;
            margin-right: .45rem;
        }

        .btn-ghost-primary {
            --_fg: #0b3d36;
            --_bd: rgba(0, 89, 78, .35);
        }

        .btn-ghost-danger {
            --_fg: #8d2a2a;
            --_bd: rgba(141, 42, 42, .35);
        }

        .btn-ghost-gold {
            --_fg: var(--gold);
            --_bd: rgba(181, 161, 96, .45);
        }

        /* ===== EVIdence Card (políticas style) ===== */
        .evi-card {
            width: 100%;
            background: var(--bg-2);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 14px 16px;
            display: flex;
            gap: 14px;
            align-items: flex-start;
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s;
        }

        .evi-card:hover {
            transform: translateY(-1px);
            border-color: rgba(181, 161, 96, .35);
            box-shadow: 0 8px 20px rgba(0, 0, 0, .08);
        }

        .evi-icon {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            flex: 0 0 46px;
            background: rgba(181, 161, 96, .08);
            color: var(--gold);
            font-size: 1.1rem;
        }

        .evi-main {
            flex: 1 1 auto;
            min-width: 0;
        }

        .evi-title {
            color: #212529;
            font-weight: 600;
            line-height: 1.15;
            display: flex;
            align-items: center;
            gap: .5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .evi-title .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .evi-meta {
            color: var(--muted);
            font-size: .82rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .evi-chip {
            font-size: .75rem;
            padding: .22rem .5rem;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, .1);
            background: rgba(0, 0, 0, .03);
            color: var(--muted);
        }

        /* Estado como chip de color */
        .chip-estado {
            border: 0;
            color: #fff;
            font-weight: 700;
            letter-spacing: .2px;
            background: #2a4b8d;
            /* revision por defecto */
            padding: .25rem .6rem;
            border-radius: 999px;
            font-size: .72rem;
            text-transform: capitalize;
        }

        .chip-estado.aprobado {
            background: #1f8f5f;
        }

        .chip-estado.parcial {
            background: #996c16;
        }

        .chip-estado.rechazado {
            background: #8d2a2a;
        }

        .chip-estado.pendiente,
        .chip-estado.revision {
            background: #2a4b8d;
        }

        /* Acciones a la derecha */
        .evi-actions {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-left: auto;
        }

        /* Estado vacío */
        .empty-state {
            border: 1px dashed var(--line);
            border-radius: 14px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--muted);
            background: var(--bg-1);
        }

        @media (max-width: 768px) {
            .evi-actions {
                width: 100%;
                justify-content: space-between;
                margin-left: 0;
                margin-top: .5rem;
            }

            .evi-card {
                flex-wrap: wrap;
            }
        }
    </style>

    <!-- Modal EVIDENCIAS S-PLAN -->
    <div class="modal fade" id="evidenciasModal" tabindex="-1" aria-labelledby="evidenciasLabel" aria-hidden="true">
        <div class="modal-dialog modal-xxl modal-dialog-centered modal-full-h">
            <div class="modal-content">
                <!-- HEADER -->
                <div class="modal-header">
                    <h5 class="modal-title d-flex align-items-center gap-2" id="evidenciasLabel">
                        <i class="fa-regular fa-folder-open text-gold"></i>
                        Evidencias — <span id="tituloEvidencias" class="text-brand">Acción</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body">
                    <!-- Nav principal -->
                    <ul class="nav nav-tabs nav-fill mb-3" id="navTabEvidenciasSPlan" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active small" id="tab-evs-tab" data-bs-toggle="tab"
                                data-bs-target="#tab-evs" type="button" role="tab">Evidencias</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="navTabEvidenciasSPlanContent">
                        <!-- TAB: Evidencias -->
                        <div class="tab-pane fade show active" id="tab-evs" role="tabpanel">
                            <!-- Sub-tabs por año -->
                            <ul class="nav nav-tabs mb-3" id="evidenciasTabsSPlan" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="anio1-tab" data-bs-toggle="tab"
                                        data-bs-target="#anio1" type="button" role="tab">Año 1</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="anio2-tab" data-bs-toggle="tab" data-bs-target="#anio2"
                                        type="button" role="tab">Año 2</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="anio3-tab" data-bs-toggle="tab" data-bs-target="#anio3"
                                        type="button" role="tab">Año 3</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="anio4-tab" data-bs-toggle="tab" data-bs-target="#anio4"
                                        type="button" role="tab">Año 4</button>
                                </li>
                            </ul>

                            <!-- Barra de acciones -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">
                                    <i class="fa-regular fa-clock me-1"></i>
                                    Última actualización: <span id="ultimaActualizacionEvs">—</span>
                                </div>
                                <div>
                                    <button class="btn btn-ghost btn-sm btn-ghost-primary" id="btnDescargarTodoSPlan">
                                        <i class="fa-solid fa-download me-1"></i> Descargar todo
                                    </button>
                                </div>
                            </div>

                            <!-- Contenido por año -->
                            <div class="tab-content" id="evidenciasTabContentSPlan" style="max-height:none;">
                                <div class="tab-pane fade show active" id="anio1" role="tabpanel">
                                    <ul class="list-group" id="anio1-list"></ul>
                                    <div class="text-center mt-2" id="anio1-more-wrap" style="display:none;">
                                        <button class="btn btn-sm btn-ghost btn-ghost-gold" data-anio="1"
                                            id="anio1-more">Cargar más</button>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="anio2" role="tabpanel">
                                    <ul class="list-group" id="anio2-list"></ul>
                                    <div class="text-center mt-2" id="anio2-more-wrap" style="display:none;">
                                        <button class="btn btn-sm btn-ghost btn-ghost-gold" data-anio="2"
                                            id="anio2-more">Cargar más</button>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="anio3" role="tabpanel">
                                    <ul class="list-group" id="anio3-list"></ul>
                                    <div class="text-center mt-2" id="anio3-more-wrap" style="display:none;">
                                        <button class="btn btn-sm btn-ghost btn-ghost-gold" data-anio="3"
                                            id="anio3-more">Cargar más</button>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="anio4" role="tabpanel">
                                    <ul class="list-group" id="anio4-list"></ul>
                                    <div class="text-center mt-2" id="anio4-more-wrap" style="display:none;">
                                        <button class="btn btn-sm btn-ghost btn-ghost-gold" data-anio="4"
                                            id="anio4-more">Cargar más</button>
                                    </div>
                                </div>
                            </div>
                            <!-- /Contenido por año -->
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END Modal EVIDENCIAS S-PLAN -->

    <!-- Template de tarjeta de evidencia -->
    <template id="tpl-evi-card">
        <li class="list-group-item border-0 px-0 py-2">
            <div class="evi-card" data-id="" data-anio="" data-estado="" data-url="" role="group"
                aria-label="Archivo de evidencia">
                <div class="evi-icon" aria-hidden="true">
                    <i class="fa-regular fa-file-lines"></i>
                </div>

                <div class="evi-main">
                    <div class="evi-title">
                        <span class="name">archivo.ext</span>
                        <span class="chip-estado revision">En revisión</span>
                    </div>

                    <div class="evi-meta mt-1">
                        <span title="Fecha"><i class="fa-regular fa-calendar me-1"></i><span
                                class="fecha">2025-09-14</span></span>
                        <span title="Autor"><i class="fa-regular fa-user me-1"></i><span
                                class="autor">Responsable</span></span>
                        <span title="Año S-Plan"><i class="fa-regular fa-hashtag me-1"></i><span class="anio">Año
                                1</span></span>
                        <span title="Tamaño"><i class="fa-regular fa-hard-drive me-1"></i><span
                                class="peso">—</span></span>
                        <span class="evi-chip" title="Tipo de archivo"><i
                                class="fa-regular fa-typewriter me-1"></i><span class="tipo">—</span></span>
                    </div>
                </div>

                <div class="evi-actions">
                    <button class="btn btn-ghost btn-sm btn-ghost-primary btn-preview" type="button"
                        title="Vista previa">
                        <i class="fa-regular fa-eye"></i> Ver
                    </button>
                    <button class="btn btn-ghost btn-sm btn-download" type="button" title="Descargar">
                        <i class="fa-solid fa-download"></i> Descargar
                    </button>
                    <button class="btn btn-ghost btn-sm btn-ghost-gold btn-copiar" type="button" title="Copiar enlace">
                        <i class="fa-regular fa-link"></i> Copiar
                    </button>
                    <button class="btn btn-ghost btn-sm btn-ghost-danger btn-detalles" type="button" title="Detalles">
                        <i class="fa-regular fa-circle-info"></i> Detalles
                    </button>
                </div>
            </div>
        </li>
    </template>

    <!-- END Modal EVIDENCIAS S-PLAN -->



    <!-- Modal: Búsqueda / Selección -->
    <div class="modal fade" id="modalBusquedaPolitica" tabindex="-1" aria-labelledby="modalBusquedaPoliticaLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <form class="modal-content" action="consulta.html" method="get">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalBusquedaPoliticaLabel">
                        <i class="fa-solid fa-magnifying-glass me-2"></i> Búsqueda avanzada
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <!-- Criterio -->
                    <div class="mb-3">
                        <label for="campoBusqueda" class="form-label">Criterio de búsqueda</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa-solid fa-keyboard"></i></span>
                            <input type="text" class="form-control" id="campoBusqueda" name="busqueda"
                                placeholder="Ej: E1M1, 'calidad', R136" required>
                        </div>
                    </div>
                    <!-- Filtro -->
                    <div>
                        <label for="campoFiltro" class="form-label">Filtrar por</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa-solid fa-filter"></i></span>
                            <select class="form-select" id="campoFiltro" name="filtro">
                                <option value="todos" selected>Todos</option>
                                <option value="ejes">Ejes</option>
                                <option value="programas">Programas</option>
                                <option value="proyectos">Proyectos</option>
                                <option value="metas">Metas</option>
                                <option value="acciones">Acciones</option>
                                <option value="responsables">Responsables</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fa-solid fa-xmark me-1"></i> Cerrar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-arrow-right-to-bracket me-1"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
            (function () {
                const modal = document.getElementById('modalBusquedaPolitica');
                if (!modal) return;

                const form = modal.querySelector('form');
                const inputQ = modal.querySelector('input[name="busqueda"]');
                const selectF = modal.querySelector('select[name="filtro"]');

                // Si necesitas forzar una ruta (ej. "../s-plan/consulta.html"), añade:
                // <div id="modalBusquedaPolitica" data-consulta-path="../s-plan/consulta.html" ...>
                function getBasePath() {
                    const attr = modal.getAttribute('data-consulta-path');
                    if (attr && attr.trim()) return attr.trim();
                    // Fallback: intenta relativa al archivo actual
                    return 'consulta.html';
                }

                function construirURLConsulta(basePath, busqueda, filtro) {
                    const q = (busqueda || '').trim();
                    const f = (filtro || 'todos').trim() || 'todos';
                    const params = new URLSearchParams({ busqueda: q, filtro: f });
                    return `${basePath}?${params.toString()}`;
                }

                form?.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const q = inputQ?.value || '';
                    if (!q.trim()) {
                        inputQ?.focus();
                        return;
                    }
                    const f = selectF?.value || 'todos';
                    const url = construirURLConsulta(getBasePath(), q, f);
                    window.location.href = url;
                });

                // Opcional: abrir el modal y enfocar con "/" (fuera de inputs)
                document.addEventListener('keydown', (e) => {
                    const t = (e.target?.tagName || '').toLowerCase();
                    if (e.key === '/' && !['input', 'textarea', 'select'].includes(t)) {
                        e.preventDefault();
                        const bsModal = bootstrap ? new bootstrap.Modal(modal) : null;
                        bsModal?.show();
                        setTimeout(() => inputQ?.focus(), 200);
                    }
                });
            })();
    </script>

    <!-- Modal de Confirmación de Cierre de Sesión -->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutLabel">Cerrar sesión</h5>
                </div>
                <div class="modal-body text-center">
                    <p>¿Estás seguro de que quieres cerrar sesión?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmLogout">Cerrar sesión</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor de notificaciones (Toasts) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
        <div id="toastContainer"></div>
    </div>

    <script type="module">

    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9/firebase-storage.js"></script>
    <!--   Core JS Files   -->
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>
    <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Librería ECharts oficial -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <!-- Tu theme personalizado -->
    <script src="../assets/js/s-plan-charts.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getDatabase, ref, get, update, remove, set } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyADKfjkB9LO1k1smRJ31sOb-7rrxOrQ7lc",
            authDomain: "sigunitropico.firebaseapp.com",
            projectId: "sigunitropico",
            storageBucket: "sigunitropico.appspot.com",
            messagingSenderId: "32992004482",
            appId: "1:32992004482:web:bd4d5e9a2b7a8b976e279b"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const database = getDatabase(app); // ✅ Esta línea es clave
        const auth = getAuth(app);


        // Obtener el ID de la meta desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        let idMeta = "";
        let idPrograma = "";
        let idEje = "";
        let idProyecto = "";





        const metaTitle = document.getElementById('metaTitle');

        // Variable para evitar agregar múltiples event listeners
        let logoutListenerAdded = false;

        // === Defaults de roles para visitantes (no loggeado) ===
        window.userRoles = ['public'];   // o []
        window.esAdmin = false;

        // Anúncialo para que waitRoles() no se bloquee
        document.dispatchEvent(new Event('roles:ready'));


        /************************************************************
        * 0) HELPERS GENERALES (formato, normalización y cortes)
        ************************************************************/
        const GOLD = '#B5A160';
        const GREEN = '#00594E';

        const baseAnio = 2024;
        const aniosKeys = ['año1', 'año2', 'año3', 'año4'];
        // Modificar las etiquetas para las gráficas
        const etiquetas = ['Año 1', 'Año 2', 'Año 3', 'Año 4'];



        // Verificar si el usuario está autenticado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                logButton.textContent = "Cerrar sesión";
                logButton.classList.remove("btn-primary");
                logButton.classList.add("btn-danger");

                // Mostrar foto y nombre de perfil
                const nombreCompleto = user.displayName || user.email || "Usuario";
                window.userCorreo = user.email;
                const nombreCorto = obtenerNombreCorto(nombreCompleto);
                const foto = user.photoURL
                    ? user.photoURL
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(nombreCorto)}&background=0D8ABC&color=fff&rounded=true&size=64`;

                if (document.getElementById("nombrePerfilUsuario")) {
                    document.getElementById("nombrePerfilUsuario").textContent = nombreCompleto;
                    document.getElementById("correoPerfilUsuario").textContent = user.email;

                }


                if (document.getElementById("imgPerfilUsuario")) {
                    document.getElementById("imgPerfilUsuario").src = foto;
                    document.getElementById("imgPerfilUsuario").alt = nombreCorto;
                    document.getElementById("imgPerfilUsuario").title = nombreCorto;
                }

                if (document.getElementById("imgPerfilUsuarioDropdown")) {
                    document.getElementById("imgPerfilUsuarioDropdown").src = foto;
                    document.getElementById("imgPerfilUsuarioDropdown").alt = nombreCorto;
                    document.getElementById("imgPerfilUsuarioDropdown").title = nombreCorto;
                }


                // Prevenir múltiples listeners
                if (!logoutListenerAdded) {
                    logButton.addEventListener("click", () => {
                        const logoutModal = new bootstrap.Modal(document.getElementById("logoutModal"));
                        logoutModal.show();

                        const confirmBtn = document.getElementById("confirmLogout");
                        const clonedBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(clonedBtn, confirmBtn);

                        clonedBtn.addEventListener("click", () => {
                            signOut(auth).then(() => {
                                window.location.href = "https://sigunitropico.com/plan-it-one/pages/sign-in.html";
                            }).catch((error) => {
                                console.error("Error al cerrar sesión:", error);
                            });
                        });
                    });

                    logoutListenerAdded = true;
                }

                // Buscar por correo sanitizado
                const correoSanitizado = user.email.replace(/\./g, "_");
                const userRef = ref(db, 'usuarios/' + correoSanitizado);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const roles = userData.roles || [];

                        console.log("Roles del usuario:", roles);

                        // Guarda roles globalmente y bandera admin
                        window.userRoles = roles;
                        window.esAdmin = roles.some(r => r.toLowerCase().includes('admin'));

                        // Notifica que los roles están listos
                        document.dispatchEvent(new Event('roles:ready'));

                        // Aplica visibilidad inmediatamente (por si ya hay UI renderizada)
                        applyRoleVisibility(document, roles);


                        if (roles.includes("admin")) {
                            document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
                        }

                        if (roles.includes("admin-s-plan")) {
                            document.querySelectorAll(".admin-s-plan").forEach(el => el.style.display = "block");
                        }

                        if (roles.includes("admin-s-plan") || roles.includes("responsable-s-plan")) {
                            document.querySelectorAll(".admin-responsable-only").forEach(el => el.style.display = "block");
                        }

                        if (document.getElementById("rolesUsuario")) {
                            let rolSimplificado = "Usuario"; // valor por defecto

                            // Normaliza los roles a minúsculas para evitar problemas de comparación
                            const rolesMinusculas = roles.map(r => r.toLowerCase());

                            // Verifica por orden de prioridad: admin > responsable > observador
                            if (rolesMinusculas.some(r => r.includes("admin"))) {
                                rolSimplificado = "Admin";
                            } else if (rolesMinusculas.some(r => r.includes("responsable"))) {
                                rolSimplificado = "Responsable";
                            } else if (rolesMinusculas.some(r => r.includes("observador"))) {
                                rolSimplificado = "Observador";
                            }

                            document.getElementById("rolesUsuario").textContent = rolSimplificado;
                        }


                    } else {
                        console.warn("Usuario autenticado pero no registrado en la base de datos.");
                    }
                }).catch((error) => {
                    console.error("Error al obtener datos del usuario:", error);
                });

            } else {
                logButton.textContent = "Iniciar Sesión";
                logButton.classList.remove("btn-danger");
                logButton.classList.add("btn-primary");

                logButton.addEventListener("click", () => {
                    window.location.href = "https://sigunitropico.com/plan-it-one/pages/sign-in.html";
                });

                window.userRoles = ['public'];
                window.esAdmin = false;
                document.dispatchEvent(new Event('roles:ready'));  // re-aplica restricciones
            }
        });


        document.getElementById('pageTitle').textContent = 'Meta ' + idMeta;
        document.getElementById('id_meta_sub2').textContent = idMeta;

        // Función para mostrar una notificación (Toast)
        function mostrarToast(mensaje, tipo = "info") {
            const toastContainer = document.getElementById("toastContainer");

            // Crear toast
            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-white bg-${tipo} border-0 show`;
            toast.role = "alert";
            toast.ariaLive = "assertive";
            toast.ariaAtomic = "true";
            toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${mensaje}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        `;

            toastContainer.appendChild(toast);

            // Mostrar el toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Eliminar el toast después de 5 segundos
            setTimeout(() => {
                bsToast.hide();
                setTimeout(() => toast.remove(), 500);
            }, 2000);
        }


        // 1. Función auxiliar para obtener el string del año (evita repetir el switch)
        function getAnioString(year) {
            switch (year) {
                case 2024: return "Año 1";  // Empezamos el ciclo en 2024
                case 2025: return "Año 2";
                case 2026: return "Año 3";
                case 2027: return "Año 4";
                default: return `Año ${year - 2023}`;  // Calcula dinámicamente el año
            }
        }


        // 2. Obtener año actual y determinar el string por defecto
        const anioInicio = 2024; // Obtiene el año actual (ej: 2025)
        const defaultAnioString = getAnioString(anioInicio); // Obtiene el string (ej: "año1")

        // 3. Inicializar 'rango' con el valor por defecto DENTRO de un array
        const rango = [defaultAnioString]; // rango ahora empieza como ["año1"]

        console.log("Rango inicial:", rango); // Verifica el valor inicial




        const listaAcciones = document.getElementById('acciones_meta');
        listaAcciones.innerHTML = 'Cargando...';

        let mapaResponsables = {};

        // Buscar acciones en toda la estructura S-PLAN
        const ejesRef = ref(db, 'S-PLAN/ejes');
        const fechaRef = ref(db, `S-PLAN/fecha_actualizacion`);

        const responsablesRef = ref(db, 'responsables');
        get(responsablesRef)
            .then(snapshot => {
                if (snapshot.exists()) {
                    mapaResponsables = snapshot.val(); // Debes declarar esto arriba como variable global
                } else {
                    console.warn("⚠️ No se encontraron responsables en la base de datos.");
                    mapaResponsables = {};
                }
            })
            .catch(error => {
                console.error("❌ Error al cargar responsables:", error);
                mapaResponsables = {};
            });



        get(fechaRef).then(snapshot => {
            if (snapshot.exists()) {
                const timestamp = snapshot.val(); // valor en milisegundos

                const fecha = new Date(timestamp);

                const opcionesFecha = {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                };

                const fechaFormateada = fecha.toLocaleString('es-CO', opcionesFecha);

                window.fechaFormateada = fechaFormateada

                document.getElementById('fecha_actualizacion').textContent = fechaFormateada;
            } else {
                document.getElementById('fecha_actualizacion').textContent = "No disponible";
            }
        }).catch(error => {
            console.error("❌ Error al obtener la fecha:", error);
            document.getElementById('fecha_actualizacion').textContent = "Error al cargar";
        });

        // Corta la serie luego de >N ceros consecutivos (reemplaza por null para romper la línea)
        function cortarTrasCerosConsecutivos(arr, maxCeros = 1) {
            let consecutivos = 0;
            const out = [...arr];
            for (let i = 0; i < out.length; i++) {
                const v = Number(out[i]) || 0;
                if (v === 0) {
                    consecutivos++;
                    if (consecutivos > maxCeros) {
                        for (let j = i; j < out.length; j++) out[j] = null; // rompe línea desde aquí
                        break;
                    }
                } else {
                    consecutivos = 0;
                }
            }
            return out;
        }

        const toNumber = (v) => {
            const n = parseFloat(v);
            return isNaN(n) ? 0 : n;
        };



        // Normaliza proyección según acumulación (flujo | acumulado | capacidad)
        // y tipo de programación (porcentaje | entero)
        function buildProjectionData(meta, tipo_acumulacion_meta, tipo_programacion_meta) {
            const tipoProg = String(tipo_programacion_meta || '').toLowerCase();
            const tipoAcum = String(tipo_acumulacion_meta || '').toLowerCase();
            const proy = meta?.proyeccion_anual || {};

            // 1) valores crudos por año
            const raw = aniosKeys.map(k => toNumber(proy[k]));
            // 2) si es porcentaje: si viene 0..1 -> pasa a 0..100; si ya viene 0..100 se conserva
            const maxCrudo = Math.max(...raw, 0);
            const vieneComoProporcion = (tipoProg === 'porcentaje') && maxCrudo <= 1;
            const normalizados = raw.map(v => (tipoProg === 'porcentaje' ? (vieneComoProporcion ? v * 100 : v) : v));

            // 3) acumulación
            function acumular(arr) {
                let s = 0;
                return arr.map(v => (s += (isNaN(v) ? 0 : v)));
            }
            let dataProyeccion;
            switch (tipoAcum) {
                case 'acumulado': dataProyeccion = acumular(normalizados); break;
                case 'flujo':
                case 'capacidad':
                default: dataProyeccion = normalizados.slice(); break;
            }

            // 4) etiquetado eje Y y formateadores segun tipo
            const esPercent = (tipoProg === 'porcentaje');
            const axisLabel = esPercent ? '{value} %' : '{value}';
            const fmtVal = (val) => {
                if (val == null) return '—';
                const n = +val;
                return esPercent ? `${n.toFixed(2)}%` : n.toLocaleString('es-CO', { maximumFractionDigits: 2 });
            };
            const maxProj = Math.max(...dataProyeccion, 0);
            const maxY = esPercent ? 100 : (maxProj ? maxProj * 1.1 : 10);

            return { dataProyeccion, esPercent, axisLabel, fmtVal, maxY };
        }

        // Calcula ejecución: SUMA por año del último corte de cada acción (en %)
        function buildEjecutadoAnual(meta) {
            const accionesMeta = meta?.acciones || {};
            const sumaEjecutado = [0, 0, 0, 0]; // en %

            for (const idAccion in accionesMeta) {
                const acc = accionesMeta[idAccion] || {};
                const avances = acc.avance_accion_anual || {};
                const fechas = Object.keys(avances).sort();
                const ultimaFecha = fechas.at(-1);
                const anual = ultimaFecha ? (avances[ultimaFecha] || {}) : {};

                for (let i = 0; i < 4; i++) {
                    let v = toNumber(anual[aniosKeys[i]]); // 0..1
                    if (!isNaN(v)) {
                        v = v * 100;              // a %
                        sumaEjecutado[i] += v;    // SUMA por año
                    }
                }
            }
            return sumaEjecutado;
        }

        // Objetivo anual (según cronograma): si acción tiene ≥1 mes marcado en año k,
        // su ponderación cuenta COMPLETA ese año (peso en %).
        function buildObjetivoAnual(meta) {
            const accionesMeta = meta?.acciones || {};
            const objetivoAnual = [0, 0, 0, 0];

            const toPctW = v => {
                const n = toNumber(v);
                return (n <= 1 ? n * 100 : n);
            };

            for (const idAccion in accionesMeta) {
                const acc = accionesMeta[idAccion] || {};
                const peso = toPctW(acc.ponderacion_accion ?? acc.importancia_accion ?? 0);
                const crono = acc.cronograma_anual || acc.cronograma || {};
                aniosKeys.forEach((k, idx) => {
                    const meses = crono?.[k] || {};
                    const programadaEseAnio = Object.values(meses).some(Boolean);
                    if (programadaEseAnio) objetivoAnual[idx] += peso;
                });
            }
            return objetivoAnual;
        }

        // Cargar gráfica de proyección anual de la meta
        const contenedorGrafica = document.getElementById('graficaProyeccionMeta');
        const chartProyeccion = echarts.init(contenedorGrafica, 'S-PLAN');

        // Referencias de los spans
        const spanAcumulacion = document.getElementById('spanAcumulacion');
        const spanProgramacion = document.getElementById('spanProgramacion');

        // Event listeners para hacer los spans editables
        spanAcumulacion.addEventListener('click', () => editarSpan(spanAcumulacion, 'tipo_acumulacion'));
        spanProgramacion.addEventListener('click', () => editarSpan(spanProgramacion, 'tipo_programacion'));

        async function editarSpan(span, tipo) {
            // Mostrar modal Swal2 para editar el valor
            const { value: nuevoValor } = await Swal.fire({
                title: `Editar ${span.textContent}`,
                input: 'text',
                inputValue: span.textContent, // Establece el valor actual en el campo de entrada
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value) {
                        return '¡Este campo no puede estar vacío!';
                    }
                }
            });

            // Si el usuario ingresa un nuevo valor
            if (nuevoValor) {
                span.textContent = nuevoValor; // Actualiza el texto del span

                // Actualiza la variable en la base de datos
                const nuevaRuta = `S-PLAN/ejes/${window.ctxRutaSPlan.idEje}/programas/${window.ctxRutaSPlan.idPrograma}/proyectos/${window.ctxRutaSPlan.idProyecto}/metas/${idMeta}`;

                // Asegúrate de pasar el valor dentro de un objeto
                const updateData = {};
                updateData[tipo] = nuevoValor;  // Aquí se encapsula el valor en un objeto

                // Actualiza el valor en Firebase
                await update(ref(db, nuevaRuta), updateData);
                Swal.fire('¡Actualizado!', `${tipo} ha sido actualizado a ${nuevoValor}`, 'success');
            }
        }



        async function cargarDatos() {


            let accionesEncontradas = [];



            // 2. Validar que todos los parámetros necesarios existan
            if (!idMeta || !idEje || !idPrograma || !idProyecto) {
                console.error("❌ Faltan parámetros en la URL. Se requieren 'id', 'eje', 'programa' y 'proyecto'.");
                const listaAcciones = document.getElementById('listaAcciones');
                if (listaAcciones) {
                    listaAcciones.innerHTML = '<div class="alert alert-danger">Error: No se proporcionó la información completa para cargar la meta. Verifique la URL.</div>';
                }
                return; // Detener la ejecución si falta algún dato
            }

            // 3. Establecer el contexto global con los IDs de la ruta (¡Importante!)
            window.ctxRutaSPlan = { idEje, idPrograma, idProyecto };

            // 4. Construir la referencia directa al nodo de la meta
            const metaRef = ref(db, `S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}/metas/${idMeta}`);

            try {
                // 5. Esperar a que los roles del usuario estén listos
                await waitRoles();

                // 6. Realizar una única y eficiente lectura a la base de datos
                const snapshot = await get(metaRef);

                if (!snapshot.exists()) {
                    console.error(`❌ No se encontró la meta con la ruta: S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}/metas/${idMeta}`);
                    document.getElementById('listaAcciones').innerHTML = '<div class="alert alert-warning">No se encontró la información de esta meta.</div>';
                    return;
                }

                // --- A partir de aquí, la lógica es muy similar, pero sin bucles anidados ---
                const meta = snapshot.val();

                let avanceMeta = 0;

                console.log(metaRef);

                // --- Configuración de la Interfaz de Usuario (UI) ---

                // Título de la meta
                metaTitle.textContent = meta.titulo_meta || 'Meta sin título';

                // Navegación jerárquica (breadcrumbs)
                document.getElementById('id_eje_nav').textContent = idEje;
                document.getElementById('id_eje_nav').href = `eje.html?id=${idEje}`;
                document.getElementById('id_programa_nav').textContent = idPrograma;
                document.getElementById('id_programa_nav').href = `programa.html?id=${idPrograma}&eje=${idEje}`;
                document.getElementById('id_proyecto_nav').textContent = idProyecto;
                document.getElementById('id_proyecto_nav').href = `proyecto.html?id=${idProyecto}&programa=${idPrograma}&eje=${idEje}`;
                document.getElementById('id_meta_nav').textContent = idMeta;

                // Información adicional
                const tipo_acumulacion_meta = (meta.tipo_acumulacion || '').toLowerCase();
                const tipo_programacion_meta = (meta.tipo_programacion || '').toLowerCase();

                window.tipo_acumulacion_meta = tipo_acumulacion_meta;
                window.tipo_programacion_meta = tipo_programacion_meta;

                document.getElementById('spanAcumulacion').textContent = tipo_acumulacion_meta;
                document.getElementById('spanProgramacion').textContent = tipo_programacion_meta;

                // Inversión en formato de moneda COP
                document.getElementById('inversionMeta').textContent = new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0
                }).format(meta.inversion_realizada || 0);

                const acciones = meta.acciones || {};
                const totalAcciones = Object.keys(acciones).length;
                document.getElementById('totalAcciones').textContent = totalAcciones;

                // --- Cálculo del Avance de la Meta ---
                const ANIOS_KEYS = ['año1', 'año2', 'año3', 'año4'];

                for (const idAccion in acciones) {
                    const accion = acciones[idAccion] || {};
                    const avances = accion.avance_accion_anual || {};

                    const fechas = Object.keys(avances).sort();
                    const ultimaFecha = fechas.at(-1);
                    const anual = ultimaFecha ? (avances[ultimaFecha] || {}) : {};

                    let sumaAccion = 0; // en rango 0..1
                    for (const k of ANIOS_KEYS) {
                        const v = parseFloat(anual[k] ?? 0);
                        if (!isNaN(v)) sumaAccion += v;
                    }

                    sumaAccion = Math.max(0, Math.min(1, sumaAccion)); // Asegurar rango 0..1
                    const progresoPct = sumaAccion * 100; // Convertir a porcentaje

                    avanceMeta += progresoPct;

                    accionesEncontradas.push({
                        id: idAccion,
                        nombre: accion.titulo_accion || 'Acción sin título',
                        responsable: accion.responsable || 'Sin responsable',
                        progreso: parseFloat(progresoPct.toFixed(2)),
                        evidencia: accion.evidencia || {},
                        importancia_accion: accion.ponderacion_accion,
                        progreso_accion: progresoPct,
                        idMeta: idMeta,
                        idEje: idEje,
                        idPrograma: idPrograma,
                        idProyecto: idProyecto,
                        avance_accion_anual: accion.avance_accion_anual || {},
                        cronograma_anual: accion.cronograma_anual || accion.cronograma || {},
                    });
                }

                // --- Actualización de la Barra de Avance de la Meta ---
                const avanceMetaClamped = Math.max(0, Math.min(100, avanceMeta));
                const barraAvance = document.getElementById('barraAvance');
                barraAvance.style.width = `${avanceMetaClamped}%`;
                barraAvance.textContent = `${avanceMetaClamped.toFixed(2)}%`;
                barraAvance.style.backgroundColor = getProgressBarColor(avanceMetaClamped);
                document.getElementById('porcentajeMeta').textContent = `${avanceMetaClamped.toFixed(2)}%`;

                // --- Guardar el avance calculado en la base de datos ---
                try {
                    const fechaActual = new Date();
                    const fechaFormateada = `${String(fechaActual.getDate()).padStart(2, '0')}-${String(fechaActual.getMonth() + 1).padStart(2, '0')}-${fechaActual.getFullYear()}`;

                    // Referencia a la ruta de avances de la meta
                    const avanceRef = ref(db, `S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}/metas/${idMeta}/avance_meta`);

                    const nuevoValor = avanceMetaClamped / 100;
                    const umbral = 0.005; // ~0.5% de diferencia

                    const snap = await get(avanceRef);
                    let ultimoValor = null;

                    if (snap.exists()) {
                        const data = snap.val();
                        const fechas = Object.keys(data).sort(); // orden cronológico
                        const ultimaFecha = fechas.at(-1);
                        ultimoValor = parseFloat(data[ultimaFecha]) || 0;
                    }

                    // Solo actualizar si no existe registro o si hay diferencia significativa
                    if (ultimoValor === null || Math.abs(nuevoValor - ultimoValor) >= umbral) {
                        const updates = {};
                        updates[`S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}/metas/${idMeta}/avance_meta/${fechaFormateada}`] = nuevoValor;

                        await update(ref(db), updates);
                        console.log(`✅ Avance actualizado: ${nuevoValor * 100}%`);
                    } else {
                        console.log(`ℹ️ No se actualiza, cambio menor al umbral (${(umbral * 100).toFixed(2)}%)`);
                    }

                } catch (error) {
                    console.error("❌ Error al guardar el avance de la Meta:", error);
                    mostrarToast("❌ Error al guardar el avance de la meta.", "danger");
                }


                // === LOG: Avance anual por acción (en %) ===
                (function logAvanceAnualPorAccion(meta) {
                    const acciones = meta?.acciones || {};
                    const rows = [];
                    const pad = (s, n = 80) => String(s || '—').slice(0, n);

                    for (const id in acciones) {
                        const acc = acciones[id] || {};
                        const avances = acc.avance_accion_anual || {};
                        const fechas = Object.keys(avances).sort();
                        const ultima = fechas.at(-1);
                        const anual = ultima ? (avances[ultima] || {}) : {};

                        // Avance anual 0..1 -> %
                        const ejPct = {};
                        aniosKeys.forEach(k => {
                            let v = toNumber(anual[k]);
                            ejPct[k] = (v <= 1 ? v * 100 : v);
                        });

                        // Ponderación → %
                        const w = toNumber(acc.ponderacion_accion ?? acc.importancia_accion ?? 0);
                        const wPct = (w <= 1 ? w * 100 : w);

                        // ¿Estuvo programada en el cronograma por año?
                        const crono = acc.cronograma_anual || acc.cronograma || {};
                        const prog = {};
                        aniosKeys.forEach(k => {
                            prog[k] = Object.values(crono?.[k] || {}).some(Boolean) ? 'Sí' : 'No';
                        });

                        // Fila para console.table
                        rows.push({
                            ID: id,
                            Acción: pad(acc.titulo_accion),
                            'Pond. %': +wPct.toFixed(2),
                            'Prog A1': prog['año1'], 'Año 1 %': +ejPct['año1'].toFixed(2),
                            'Prog A2': prog['año2'], 'Año 2 %': +ejPct['año2'].toFixed(2),
                            'Prog A3': prog['año3'], 'Año 3 %': +ejPct['año3'].toFixed(2),
                            'Prog A4': prog['año4'], 'Año 4 %': +ejPct['año4'].toFixed(2),
                            'Total %': +(aniosKeys.reduce((s, k) => s + (ejPct[k] || 0), 0).toFixed(2)),
                            'Último corte': (ultima || '—')
                        });

                        // Detalle por acción (útil si quieres expandir en consola)
                        console.groupCollapsed(`[Acción] ${id}`);
                        console.table({
                            'Ponderación %': +wPct.toFixed(2),
                            'Prog Año 1': prog['año1'], 'Ej Año 1 %': +ejPct['año1'].toFixed(2),
                            'Prog Año 2': prog['año2'], 'Ej Año 2 %': +ejPct['año2'].toFixed(2),
                            'Prog Año 3': prog['año3'], 'Ej Año 3 %': +ejPct['año3'].toFixed(2),
                            'Prog Año 4': prog['año4'], 'Ej Año 4 %': +ejPct['año4'].toFixed(2),
                            'Total %': +(aniosKeys.reduce((s, k) => s + (ejPct[k] || 0), 0).toFixed(2)),
                            'Último corte': (ultima || '—')
                        });
                        console.log('anual RAW:', anual);
                        console.groupEnd();
                    }

                    console.groupCollapsed('%cAvance anual por acción (tabla global)', 'color:#00594E;font-weight:700;');
                    console.table(rows);
                    console.groupEnd();

                    // Totales por año (suma de todas las acciones)
                    const totales = {
                        'Año 1 %': +rows.reduce((s, r) => s + (r['Año 1 %'] || 0), 0).toFixed(2),
                        'Año 2 %': +rows.reduce((s, r) => s + (r['Año 2 %'] || 0), 0).toFixed(2),
                        'Año 3 %': +rows.reduce((s, r) => s + (r['Año 3 %'] || 0), 0).toFixed(2),
                        'Año 4 %': +rows.reduce((s, r) => s + (r['Año 4 %'] || 0), 0).toFixed(2),
                        'Total %': +rows.reduce((s, r) => s + (r['Total %'] || 0), 0).toFixed(2),
                    };
                    console.groupCollapsed('%cTotales ejecutados por año (suma de acciones)', 'color:#B5A160;font-weight:700;');
                    console.table([totales]);
                    console.groupEnd();
                })(meta);


                initGraficasMeta(meta, tipo_acumulacion_meta, tipo_programacion_meta);


            }


            catch (error) {
                console.error("❌ Error fatal al cargar los datos de la meta:", error);
                document.getElementById('listaAcciones').innerHTML = '<div class="alert alert-danger">Ocurrió un error al cargar la información de la meta.</div>';

            }


            /************************************************************
             * 1) PROGRAMACIÓN FÍSICA (SOLO PROYECCIÓN)
             ************************************************************/
            function renderProgramacionFisica(meta, tipo_acumulacion_meta, tipo_programacion_meta) {
                console.log(tipo_acumulacion_meta, tipo_programacion_meta);
                const el = document.getElementById('programacionFisicaMeta');
                if (!el) return;

                const { dataProyeccion, esPercent, axisLabel, fmtVal, maxY } =
                    buildProjectionData(meta, tipo_acumulacion_meta, tipo_programacion_meta);

                // Limitar el valor de maxY a 2 decimales
                const maxYFormatted = parseFloat(maxY).toFixed(2); // Limita a 2 decimales

                const option = {
                    title: {
                        top: 2, text: 'Programación Física de la Meta', left: 'center',
                        textStyle: { fontSize: 14, color: '#333' }
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: (params) => {
                            const p = params[0];
                            return `${p.axisValue}<br/>${p.marker} Proyección: ${fmtVal(p.value)}`;
                        }
                    },
                    legend: { top: 26, data: ['Proyección'] },
                    xAxis: {
                        type: 'category',
                        data: etiquetas,
                        axisLabel: { color: '#666' },
                        axisLine: { lineStyle: { color: '#aaa' } }
                    },
                    yAxis: {
                        type: 'value',
                        min: 0,
                        max: maxYFormatted, // Usa el valor limitado a 2 decimales
                        axisLabel: { formatter: axisLabel },
                        axisLine: { lineStyle: { color: '#aaa' } },
                        splitLine: { lineStyle: { color: '#eee' } }
                    },
                    series: [{
                        name: 'Proyección',
                        type: 'line',
                        data: dataProyeccion,
                        smooth: true,
                        lineStyle: { color: GOLD, width: 3, type: 'dotted' },
                        itemStyle: { color: GOLD },
                        symbol: 'circle',
                        symbolSize: 8,
                        label: { show: true, formatter: (p) => fmtVal(p.value), position: 'top' },
                        // areaStyle: { opacity: 0.08 }
                    }]
                };

                // init on demand (por acordeón)
                const chart = echarts.init(el);
                chart.setOption(option, true);
                window.addEventListener('resize', () => chart.resize());
            }


            /************************************************************
             * 2) AVANCE GENERAL (Proyección fondo + Ejecución TOTAL acumulada)
             * Casuística:
             *  - flujo|porcentaje        → denom=100, sumaEjecutado (%)
             *  - capacidad|porcentaje    → idem
             *  - acumulado|porcentaje    → idem (NO convertir proyección a deltas)
             *  - flujo|entero            → TRATAR COMO PORCENTAJE (idem flujo|porcentaje)
             *  - capacidad|entero        → TRATAR COMO PORCENTAJE (idem flujo|porcentaje)
             *  - acumulado|entero        → unidades ejecutadas vs suma proyectada (deltas)
             ************************************************************/
            function renderAvanceGeneral(meta, sumaEjecutado) {
                const div = document.getElementById('avanceGeneralMeta');
                if (!div) return;

                const tipoProg = String(meta?.tipo_programacion || '').toLowerCase();   // 'porcentaje' | 'entero'
                const tipoAcum = String(meta?.tipo_acumulacion || '').toLowerCase();    // 'flujo' | 'acumulado' | 'capacidad'
                const key = `${tipoAcum}|${tipoProg}`;

                // --- Proyección por año (0..1, 0..100 o unidades) ---
                const proy = meta?.proyeccion_anual || {};
                let vals = aniosKeys.map(k => toNumber(proy[k]));

                // porcentajes: si vienen 0..1 -> 0..100
                const maxCrudo = Math.max(...vals, 0);
                const esPorcentaje = (tipoProg === 'porcentaje');
                if (esPorcentaje && maxCrudo <= 1) vals = vals.map(v => v * 100);

                // SOLO convertir a deltas si es ACUMULADO+ENTERO
                if (key === 'acumulado|entero') {
                    let prev = 0;
                    vals = vals.map(v => {
                        const n = Number(v) || 0;
                        const inc = Math.max(0, n - prev);
                        prev = n;
                        return inc;
                    });
                }

                // Fondo (stack a 100%)
                const totalProj = vals.reduce((a, b) => a + (isNaN(b) ? 0 : b), 0);
                const partsProj = totalProj > 0 ? vals.map(v => (v / totalProj) * 100) : [0, 0, 0, 0];

                // --- Helpers para ejecución ---
                const pickUltAnual = (avances) => {
                    const ks = Object.keys(avances || {});
                    if (!ks.length) return {};
                    ks.sort(); // llaves tipo 'YYYY-MM-DD'
                    return avances[ks[ks.length - 1]] || {};
                };

                // Unidades ejecutadas por año (solo para acumulado|entero)
                function ejecutadoUnidadesEntero(meta) {
                    const acciones = meta?.acciones || {};
                    const ids = Object.keys(acciones);

                    // pesos por acción (si todos 0 → repartir iguales)
                    let sumPesos = 0;
                    const pesos = {};
                    ids.forEach(id => {
                        const a = acciones[id] || {};
                        const w = toNumber(a.ponderacion_accion ?? a.importancia_accion ?? 0);
                        const wPct = (w <= 1 ? w * 100 : w);
                        const wPos = Math.max(0, wPct);
                        pesos[id] = wPos; sumPesos += wPos;
                    });
                    const defaultPct = ids.length ? (100 / ids.length) : 0;

                    const totalUnits = totalProj; // suma de deltas de proyección
                    if (totalUnits <= 0) return [0, 0, 0, 0];

                    const E = [0, 0, 0, 0];
                    ids.forEach(id => {
                        const acc = acciones[id] || {};
                        const anual = pickUltAnual(acc.avance_accion_anual || {});
                        const pctAcc = sumPesos > 0 ? (pesos[id] / sumPesos) * 100 : defaultPct;
                        const unitsShare = (pctAcc / 100) * totalUnits; // “cuota” de unidades de esta acción

                        for (let i = 0; i < aniosKeys.length; i++) {
                            const k = aniosKeys[i];
                            let v = Number(anual[k]) || 0; // 0..1 o 0..100
                            if (v > 1) v = v / 100;        // a 0..1
                            E[i] += unitsShare * v;        // unidades ejecutadas ese año
                        }
                    });
                    return E;
                }

                // --- Ejecución total y denominador según caso ---
                let totalEjec = 0;
                let denom = 100; // por defecto “como porcentaje”

                switch (key) {
                    // === TRATADOS COMO PORCENTAJE (denom=100, sumar % ejecutado de todos los años) ===
                    case 'flujo|porcentaje':
                    case 'capacidad|porcentaje':
                    case 'acumulado|porcentaje': // ojo: NO tocamos los deltas de la proyección
                    case 'flujo|entero':         // ← igual que flujo|porcentaje
                    case 'capacidad|entero':     // ← igual que flujo|porcentaje
                    case 'acumulado|entero':     // ← igual que flujo|porcentaje (cambio pedido)
                        totalEjec = (sumaEjecutado || [0, 0, 0, 0])
                            .reduce((a, b) => a + (Number(b) || 0), 0);
                        denom = 100;
                        break;

                    // Fallback: tratar como porcentaje
                    default:
                        totalEjec = (sumaEjecutado || [0, 0, 0, 0])
                            .reduce((a, b) => a + (Number(b) || 0), 0);
                        denom = 100;
                        break;
                }


                const ejecTotalPct = denom > 0 ? (totalEjec / denom) * 100 : 0;
                const ejecTotalPctCap = Math.max(0, Math.min(100, ejecTotalPct));

                // --- Serie fondo + overlay ---
                const etiquetasAG = ['AVANCE'];
                const coloresAG = { 'año1': '#E74C3C', 'año2': '#F1C40F', 'año3': '#E67E22', 'año4': '#00594E' };

                const seriesProy = aniosKeys.map((k, i) => ({
                    name: `Proyección ${k}`,
                    type: 'bar',
                    stack: 'proy',
                    barWidth: '48%',
                    data: [+(partsProj[i] || 0).toFixed(2)],
                    itemStyle: { color: coloresAG[k], opacity: 0.5 },
                    label: {
                        show: true, position: 'inside',
                        formatter: p => p.value > 0 ? `${p.value.toFixed(1)}%` : '',
                        fontWeight: 600, color: '#fff'
                    },
                    z: 1
                }));

                const serieEjec = {
                    name: 'Ejecución total acumulada',
                    type: 'bar',
                    barWidth: '48%',
                    barGap: '-100%',
                    data: [+ejecTotalPctCap.toFixed(2)],
                    itemStyle: { color: GOLD, opacity: 1 },
                    label: {
                        show: true, position: 'insideTop', distance: 6,
                        formatter: p => p.value > 0 ? `${p.value.toFixed(1)}%` : '',
                        fontWeight: 700, color: '#FFF'
                    },
                    z: 3
                };

                const optionAG = {
                    grid: { left: 34, right: 18, top: 10, bottom: 36 },
                    legend: { show: false },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: () => {
                            const proy = partsProj.map(v => v.toFixed(1) + '%');
                            const ej = ejecTotalPct.toFixed(1) + '%';
                            return `
<b>AVANCE</b><br/>
Proyección total: 100%<br/>
• ${aniosKeys[0]}: ${proy[0]}<br/>
• ${aniosKeys[1]}: ${proy[1]}<br/>
• ${aniosKeys[2]}: ${proy[2]}<br/>
• ${aniosKeys[3]}: ${proy[3]}<br/>
<hr style="margin:4px 0;border-top:1px solid #eee"/>
<span style="color:${GOLD};font-weight:700">
  Ejecución total acumulada: ${ej}
</span>`;
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: etiquetasAG,
                        axisTick: { show: false },
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#444', fontWeight: 600, margin: 18 }
                    },
                    yAxis: {
                        type: 'value',
                        min: 0,
                        max: 100,
                        axisLabel: { formatter: '{value}%' },
                        splitLine: { lineStyle: { color: '#eee' } }
                    },
                    series: [...seriesProy, serieEjec]
                };

                const chart = echarts.init(div);
                chart.setOption(optionAG);
                window.addEventListener('resize', () => chart.resize());
            }

            /************************************************************
  * 3) CUMPLIMIENTO ANUAL (Ejec./Objetivo * 100) con cronograma
  ************************************************************/
            function renderCumplimientoAnual(meta, sumaEjecutado) {
                const cont = document.getElementById('graficaCumplimientoMeta');
                if (!cont) return;

                const tipoProg = String(meta?.tipo_programacion || '').toLowerCase();   // 'porcentaje' | 'entero'
                const tipoAcum = String(meta?.tipo_acumulacion || '').toLowerCase();    // 'flujo' | 'acumulado' | 'capacidad'
                const key = `${tipoAcum}|${tipoProg}`;

                const acciones = meta?.acciones || {};
                const toPctW = (w) => { const n = Number(w); return !isFinite(n) || n <= 0 ? 0 : (n <= 1 ? n * 100 : n); };
                const toPctVal = (v) => { let n = Number(v) || 0; return n <= 1 ? n * 100 : n; };
                const pickUltAnual = (avances) => { const ks = Object.keys(avances || {}); if (!ks.length) return {}; ks.sort(); return avances[ks.at(-1)] || {}; };

                let objetivoAnual = [0, 0, 0, 0]; // P (%)
                let ejecutadoAnual = [0, 0, 0, 0]; // E (%)

                switch (key) {
                    case 'flujo|porcentaje': {
                        // Objetivo por año = Σ (ponderación% / 4) de las acciones programadas ese año
                        // Ejecutado por año = Σ avance anual (%) de esas acciones
                        for (const id in acciones) {
                            const acc = acciones[id] || {};
                            const w4 = toPctW(acc.ponderacion_accion ?? acc.importancia_accion ?? 0) / 4;
                            const crono = acc.cronograma_anual || acc.cronograma || {};
                            const anual = pickUltAnual(acc.avance_accion_anual || {});
                            for (let i = 0; i < aniosKeys.length; i++) {
                                const k = aniosKeys[i];
                                const programada = Object.values(crono?.[k] || {}).some(Boolean);
                                if (!programada) continue;
                                objetivoAnual[i] += w4;              // ← sólo ¼ del peso
                                ejecutadoAnual[i] += toPctVal(anual[k]);
                            }
                        }
                        break;
                    }

                    // Mantén el resto como lo tenías
                    case 'flujo|entero':
                    case 'capacidad|porcentaje':
                    case 'capacidad|entero':
                    case 'acumulado|porcentaje':
                    case 'acumulado|entero': {
                        for (const id in acciones) {
                            const acc = acciones[id] || {};
                            const w = toPctW(acc.ponderacion_accion ?? acc.importancia_accion ?? 0);
                            const crono = acc.cronograma_anual || acc.cronograma || {};
                            const anual = pickUltAnual(acc.avance_accion_anual || {});
                            for (let i = 0; i < aniosKeys.length; i++) {
                                const k = aniosKeys[i];
                                const programada = Object.values(crono?.[k] || {}).some(Boolean);
                                if (!programada) continue;
                                objetivoAnual[i] += w;               // en estos casos sí es el peso completo
                                ejecutadoAnual[i] += toPctVal(anual[k]);
                            }
                        }
                        break;
                    }

                    default: {
                        objetivoAnual = buildObjetivoAnual(meta);
                        ejecutadoAnual = (sumaEjecutado || [0, 0, 0, 0]).slice();
                    }
                }

                // Cumplimiento = E / P * 100 (null si no hay objetivo ese año)
                const cumplimientoRaw = aniosKeys.map((_, i) => {
                    const P = Number(objetivoAnual[i]) || 0;
                    const E = Number(ejecutadoAnual[i]) || 0;
                    return P > 0 ? (E / P) * 100 : null;
                });

                // ▸ Partimos el cumplimiento en dos: base (máx. 100) + superávit (>100)
                const cumplimientoBase = cumplimientoRaw.map(v => v == null ? null : Math.min(100, v));
                const superavit = cumplimientoRaw.map(v => v == null ? null : Math.max(0, v - 100));

                // Y-axis: si hay superávit, sube el techo para que se vea el tramo extra
                const maxCumpl = Math.max(
                    100,
                    ...cumplimientoRaw.filter(v => v != null),
                    ...superavit.filter(v => v != null).map(v => 100 + v)
                );
                const maxY = Math.ceil((maxCumpl * 1.1) / 10) * 10;

                const option = {
                    title: {
                        text: 'Cumplimiento Plan Anual de Acciones (%)',
                        left: 'center', textStyle: { fontSize: 14, color: '#333' }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: (params) => {
                            const i = params[0]?.dataIndex ?? 0;
                            const P = (objetivoAnual[i] ?? 0).toFixed(2);
                            const E = (ejecutadoAnual[i] ?? 0).toFixed(2);
                            const C = (cumplimientoRaw[i] == null) ? '—' : `${cumplimientoRaw[i].toFixed(2)}%`;
                            const S = (superavit[i] && superavit[i] > 0) ? ` (+${superavit[i].toFixed(2)}% superávit)` : '';
                            return `${etiquetas[i]}<br/>
Objetivo (según cronograma): ${P}%<br/>
Ejecutado (programadas): ${E}%<br/>
Cumplimiento: ${C}${S}`;
                        }
                    },
                    xAxis: {
                        type: 'category', data: etiquetas,
                        axisLabel: { color: '#666' },
                        axisLine: { lineStyle: { color: '#aaa' } }
                    },
                    yAxis: {
                        type: 'value',
                        min: 0,
                        max: maxY,
                        axisLabel: { formatter: '{value} %' },
                        axisLine: { lineStyle: { color: '#aaa' } },
                        splitLine: { lineStyle: { color: '#eee' } }
                    },
                    series: [
                        // Línea de referencia 100%
                        {
                            name: 'Meta (100%)',
                            type: 'line',
                            data: etiquetas.map(() => 100),
                            smooth: true, symbol: 'none',
                            lineStyle: { color: GOLD, type: 'dashed', width: 2 },
                            tooltip: { show: false }, z: 1
                        },
                        // Cumplimiento base (hasta 100%)
                        {
                            name: 'Cumplimiento',
                            type: 'bar',
                            stack: 'cumpl',
                            data: cumplimientoBase,
                            barWidth: 36,
                            itemStyle: { color: GREEN, opacity: 1 },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: (p) => (p.value == null ? '' : `${(+p.value).toFixed(1)}%`)
                            },
                            z: 3
                        },
                        // Superávit (lo que excede 100%), con transparencia
                        {
                            name: 'Superávit',
                            type: 'bar',
                            stack: 'cumpl',
                            data: superavit,
                            barWidth: 36,
                            itemStyle: {
                                color: GREEN,
                                opacity: 0.3   // ← tono transparente
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: (p) => {
                                    const v = Number(p.value) || 0;
                                    return v > 0 ? `+${v.toFixed(1)}%` : '';
                                }
                            },
                            z: 2
                        }
                    ]
                };

                const chart = echarts.init(cont);
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());

            }



            /************************************************************
             * 4) ORQUESTACIÓN: enciende cada bloque en orden
             *    1) Programación física (al abrir acordeón)
             *    2) Avance general (inmediato)
             *    3) Cumplimiento anual (inmediato)
             ************************************************************/
            function initGraficasMeta(meta, tipo_acumulacion_meta, tipo_programacion_meta) {
                // 2 y 3 necesitan ejecución anual:
                const sumaEjecutado = buildEjecutadoAnual(meta);

                // (1) Render de programación física SOLO cuando se muestre el acordeón
                const colapsable = document.getElementById('collapseProgramacion');
                if (colapsable) {
                    colapsable.addEventListener('shown.bs.collapse', () => {
                        renderProgramacionFisica(meta, tipo_acumulacion_meta, tipo_programacion_meta);
                    });
                    // si llegara abierto:
                    if (colapsable.classList.contains('show')) {
                        renderProgramacionFisica(meta, tipo_acumulacion_meta, tipo_programacion_meta);
                    }
                }

                // (2) Avance general
                renderAvanceGeneral(meta, sumaEjecutado);

                // (3) Cumplimiento anual
                renderCumplimientoAnual(meta, sumaEjecutado);
            }


            /************************************************************
             * 5) CALL: Llama initGraficasMeta cuando ya tengas `meta`
             *    y hayas definido tipo_acumulacion_meta / tipo_programacion_meta
             ************************************************************/
            // Ejemplo:
            // tipo_acumulacion_meta = meta.tipo_acumulacion;        // 'flujo' | 'acumulado' | 'capacidad'
            // tipo_programacion_meta = meta.tipo_programacion;      // 'porcentaje' | 'entero'
            // initGraficasMeta(meta, tipo_acumulacion_meta, tipo_programacion_meta);



            // Helpers locales
            const toPct = (v) => {
                const n = parseFloat(v);
                if (isNaN(n)) return 0;
                return n <= 1 ? n * 100 : n;
            };
            const fmtPct = (v, d = 2) => `${(Number(v) || 0).toFixed(d)}%`;

            // Mostrar acciones
            if (accionesEncontradas.length === 0) {
                listaAcciones.innerHTML = '<div class="alert alert-warning">No se encontraron acciones asociadas a esta meta.</div>';
                return;
            }


            // === Acciones completadas (desde Ejecutado vs Proyección / barra) ===
            let columnas = '';
            let accionesCompletadas = 0;
            const totalAcciones = accionesEncontradas.length;

            accionesEncontradas.forEach((accion) => {
                const ejecutadoPct = Math.max(0, Math.min(1000, Number(accion.progreso_accion) || 0));
                const proyeccionPct = toPct(accion.importancia_accion ?? accion.ponderacion_accion ?? 0);
                const cumplimientoAccion = proyeccionPct > 0 ? (ejecutadoPct / proyeccionPct) * 100 : null;
                const esCompletada = cumplimientoAccion != null && cumplimientoAccion >= 100;
                if (esCompletada) accionesCompletadas++;

                const barraWidth = Math.max(0, Math.min(100, cumplimientoAccion ?? 0));
                const barraColor = getProgressBarColor(barraWidth);
                const badgeEjClass = ejecutadoPct >= proyeccionPct ? 'bg-success' : (ejecutadoPct > 0 ? 'bg-info' : 'bg-secondary');
                const badgeCumplClass = (cumplimientoAccion ?? 0) >= 100 ? 'bg-success' : (cumplimientoAccion == null ? 'bg-secondary' : 'bg-warning');
                const responsableTxt = obtenerResponsablesPorCodigo(accion.responsable);

                const overWidth = Math.max(0, (cumplimientoAccion ?? 0) - 100);
                const meterClasses = (cumplimientoAccion ?? 0) > 100 ? 'meter over' : 'meter';
                const esAdmin = !!window.esAdmin;
                const styleDisabled = esAdmin ? 'cursor:pointer;' : 'cursor:not-allowed;opacity:.6;';
                const attrDisabled = '';

                const barraHTML = `
    <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
        <span>Cumplimiento de la acción</span>
        <span class="badge ${badgeCumplClass}">
            ${cumplimientoAccion == null ? '—' : fmtPct(cumplimientoAccion, 1)}
        </span>
    </div>

    <div class="${meterClasses}"
         style="--val:${barraWidth}%; --fill:${barraColor};"
         data-bs-toggle="tooltip"
         title="Ejecutado: ${fmtPct(ejecutadoPct)} • Proyección: ${fmtPct(proyeccionPct)}">
        <div class="meter-fill"></div>
        ${overWidth > 0 ? `<div class="meter-over" style="--over:${Math.min(overWidth, 100)}%;"></div>` : ''}

        <div class="meter-tick tick-25"></div>
        <div class="meter-tick tick-50"></div>
        <div class="meter-tick tick-75"></div>
        <div class="meter-tick tick-100" title="Meta 100%"></div>
    </div>
`;

                const badgeCompletada = esCompletada
                    ? `<span class="badge bg-success ms-2"><i class="fa-solid fa-circle-check me-1"></i>Completada</span>`
                    : '';

                columnas += `
    <div class="col-12 col-md-6 col-lg-4 d-flex">
        <div class="card flex-fill h-100 shadow-sm border-0 card-hover">
            
            <!-- HEADER -->
            <div class="card-header d-flex justify-content-between align-items-center text-white"
                 style="background:linear-gradient(90deg,#00594e,#07d6bc);">
                <h6 class="mb-0 fw-bold text-truncate text-white">
                    ${limitarTexto(responsableTxt, 60)}
                </h6>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-light text-dark">
                        ${fmtPct(ejecutadoPct, 0)} / ${fmtPct(proyeccionPct, 0)}
                    </span>
                    ${badgeCompletada}
                </div>
            </div>

            <!-- BODY -->
            <div class="card-body d-flex flex-column">
                <p class="text-muted small mb-2 text-justify" title="${accion.nombre}">
                    ${limitarTexto(accion.nombre, 120)}
                </p>

                <!-- Badges -->
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <button type="button"
                            class="badge ${badgeEjClass} bg-opacity-75 d-inline-flex align-items-center gap-1 btnEvaluar"
                            style="border:0;${styleDisabled}"
                            ${attrDisabled}
                            data-meta="${idMeta}" data-accion="${accion.id}"
                            data-avance-accion-anual='${encodeURIComponent(JSON.stringify(accion.avance_accion_anual || {}))}'
                            data-responsable="${responsableTxt}"
                            data-ejecutado="${ejecutadoPct}" data-proyeccion="${proyeccionPct}">
                        <i class="fa-solid fa-scale-balanced"></i>
                        Ejecutado: ${fmtPct(ejecutadoPct)}
                    </button>

                    <span class="badge"
                          style="background:#B5A1601a;color:#B5A160;border:1px solid #B5A16066;">
                        Proyección: ${fmtPct(proyeccionPct)}
                    </span>
                </div>

                <!-- Barra -->
                ${barraHTML}

                <!-- Cronograma -->
                <div class="mt-3 flex-grow-1">
                    ${cronogramaHTML(idMeta, accion.id, accion.cronograma_anual, BASE_ANIO_PLAN, esAdmin)}
                </div>

                <!-- Acciones -->
                <div class="d-flex gap-1 flex-wrap mt-3" style="max-width: 160px;">
                    <button class="btn btn-outline-primary btn-sm btnAbrirEvidencias fw-semibold rounded-pill shadow-sm btn-evidencias-splan"
                            style="max-width:36px;min-width:36px;padding-left:.5rem;padding-right:.5rem;"
                            data-meta="${idMeta}"
                            data-accion="${accion.id}"
                            data-tituloaccion="${accion.nombre}"
                            data-responsable="${responsableTxt}"
                            title="Ver evidencias de esta acción">
                    <i class="fas fa-eye"></i>
                    </button>

                    <button class="btn btn-outline-danger btn-sm rounded-pill shadow-sm admin-only admin-s-plan"
                            style="display:none;max-width:36px;min-width:36px;padding-left:.5rem;padding-right:.5rem;"
                            title="Eliminar acción">
                    <i class="fas fa-trash-alt"></i>
                    </button>

                    <button class="btn btn-outline-warning btn-sm rounded-pill shadow-sm btn-subir-evidencia admin-responsable-only"
                            style="display:none;max-width:36px;min-width:36px;padding-left:.5rem;padding-right:.5rem;"
                            data-meta="${idMeta}"
                            data-accion="${accion.id}"
                            title="Subir nueva evidencia">
                    <i class="fas fa-cloud-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
`;
            });

            // Render tarjetas en matriz responsiva
            listaAcciones.innerHTML = `<div class="row g-3">${columnas}</div>`;

            applyRoleVisibility(listaAcciones);



            // === Actualiza “X de Y completadas” y barra ===
            const porcentajeCompletadas = totalAcciones ? (accionesCompletadas / totalAcciones) * 100 : 0;
            document.getElementById('accionesCompletadas').textContent =
                `${accionesCompletadas} de ${totalAcciones} completadas`;

            const barraCompletadas = document.getElementById('barraAccionesCompletadas');
            barraCompletadas.style.width = `${porcentajeCompletadas}%`;
            barraCompletadas.style.backgroundColor = getProgressBarColor(porcentajeCompletadas);
            barraCompletadas.textContent = `${porcentajeCompletadas.toFixed(1)}%`;

            console.log(`[Completadas] ${accionesCompletadas}/${totalAcciones} (${porcentajeCompletadas.toFixed(1)}%)`);

            // Tooltips Bootstrap 5
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                try { new bootstrap.Tooltip(el); } catch { }
            });




        }


        // Cambiar de año (tabs)
        document.addEventListener('click', (e) => {
            const tab = e.target.closest('.year-tab');
            if (!tab) return;
            const wrap = tab.closest('.crono');
            if (!wrap) return;

            // activar tab
            wrap.querySelectorAll('.year-tab').forEach(b => b.classList.remove('active'));
            tab.classList.add('active');

            // mostrar grid del año
            const year = tab.dataset.year;
            wrap.querySelectorAll('.grid').forEach(g => g.style.display = 'none');
            const grid = wrap.querySelector(`.grid[data-grid="${year}"]`);
            if (grid) grid.style.display = '';
        });

        // Toggle mes y persistir
        document.addEventListener('click', async (e) => {
            const cell = e.target.closest('.crono .cell');
            if (!cell) return;

            // Solo admins editan
            if (cell.classList.contains('readonly') || !window.esAdmin) return;

            // Toggle visual
            cell.classList.toggle('on');

            // Datos
            const { meta, accion, anio, mes } = cell.dataset;
            const { idEje, idPrograma, idProyecto } = (window.ctxRutaSPlan || {});
            if (!idEje || !idPrograma || !idProyecto) { console.warn('Falta contexto de ruta'); return; }

            // Valor a guardar
            const value = cell.classList.contains('on');

            try {
                // RTDB: acciones/<idAccion>/cronograma_anual/añoN/<mes>: true/false
                const path = `S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}/metas/${meta}/acciones/${accion}/cronograma_anual/${anio}/${mes}`;
                const updates = {};
                updates[path] = value ? true : null; // si quieres "desmarcar" borrando el nodo, usa null; si prefieres false, usa false
                await update(ref(db), updates);
            } catch (err) {
                console.error('Error guardando cronograma:', err);
                // revertir visual si falló
                cell.classList.toggle('on');
                mostrarToast('No se pudo guardar el cronograma.', 'danger');
            }
        });


        /* ===========================
  EVALUACIÓN DE ACCIONES
  =========================== */

        // Crea el modal de evaluación una sola vez
        function ensureEvalModal() {
            if (document.getElementById('modalEvalAccion')) return;

            const html = `
  <div class="modal fade" id="modalEvalAccion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header" style="background:#00594e;color:#fff;">
          <h5 class="modal-title text-white"><i class="fa-solid fa-scale-balanced me-2"></i>Evaluar acción</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small text-muted">
            <div><b>Meta:</b> <span id="eval-meta-id">—</span></div>
            <div><b>Acción:</b> <span id="eval-accion-id">—</span></div>
            <div><b>Responsable:</b> <span id="eval-responsable">—</span></div>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-semibold">Año a evaluar</label>
              <select id="eval-anio" class="form-select">
                ${YEARS_KEYS.map((k, i) => `<option value="año${i + 1}">${BASE_ANIO_PLAN + i} (${k})</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Avance (%)</label>
              <input id="eval-valor-num" type="number" class="form-control" min="0" max="100" step="0.1" value="0">
            </div>
            <div class="col-12">
              <input id="eval-valor-range" type="range" min="0" max="100" step="0.1" value="0" class="form-range">
              <div class="d-flex justify-content-between small text-muted">
                <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
              </div>
            </div>
            <div class="col-12">
              <div class="alert alert-info py-2 text-white">
                Se registrará un nuevo corte en <b>Avance anual</b> con la fecha de hoy (<span id="eval-fecha">—</span>).
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btnEvalGuardar" type="button" class="btn btn-success">
            <i class="fa-regular fa-floppy-disk me-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>`;
            document.body.insertAdjacentHTML('beforeend', html);

            // Sincroniza slider <-> número
            const num = document.getElementById('eval-valor-num');
            const rng = document.getElementById('eval-valor-range');
            num.addEventListener('input', () => { let v = +num.value || 0; v = Math.min(100, Math.max(0, v)); rng.value = v; });
            rng.addEventListener('input', () => { num.value = rng.value; });
        }


        // Abre el modal con los datos de la acción
        window.abrirPanelEvaluacion = function abrirPanelEvaluacion({ meta, accion, responsable = '', ejecutado = 0, proyeccion = 0, avanceAccionAnual = {} }) {
            ensureEvalModal();

            // UI básica
            const modalEl = document.getElementById('modalEvalAccion');
            const bsModal = new bootstrap.Modal(modalEl);
            document.getElementById('eval-meta-id').textContent = meta || '—';
            document.getElementById('eval-accion-id').textContent = accion || '—';
            document.getElementById('eval-responsable').textContent = responsable || '—';

            // Año por defecto (el calculado al inicio del script)
            const selAnio = document.getElementById('eval-anio');
            selAnio.value = (typeof defaultAnioString === 'string' ? defaultAnioString : 'año1');

            // Fecha visible
            const hoyISO = new Date().toISOString().slice(0, 10);
            document.getElementById('eval-fecha').textContent = hoyISO;

            // Cargar el último valor guardado de ese año
            function getUltimoValor(anualObj, k) {
                try {
                    const fechas = Object.keys(anualObj || {}).sort();
                    const ultima = fechas.at(-1);
                    const byYear = ultima ? (anualObj[ultima] || {}) : {};
                    const v = parseFloat(byYear[k] ?? 0);
                    return isNaN(v) ? 0 : (v * 100); // 0..1 -> %
                } catch { return 0; }
            }

            const inicialPct = getUltimoValor(avanceAccionAnual, selAnio.value);
            document.getElementById('eval-valor-num').value = inicialPct.toFixed(1);
            document.getElementById('eval-valor-range').value = inicialPct.toFixed(1);

            // Si cambia año, refresca valor inicial
            selAnio.onchange = () => {
                const v = getUltimoValor(avanceAccionAnual, selAnio.value);
                document.getElementById('eval-valor-num').value = v.toFixed(1);
                document.getElementById('eval-valor-range').value = v.toFixed(1);
            };

            // Guardar
            document.getElementById('btnEvalGuardar').onclick = async () => {
                try {
                    const yearKey = selAnio.value;                 // 'año1'..'año4'
                    let valPct = parseFloat(document.getElementById('eval-valor-num').value) || 0;
                    valPct = Math.min(100, Math.max(0, valPct));
                    const val = +(valPct / 100).toFixed(4);        // 0..1

                    const { idEje, idPrograma, idProyecto } = (window.ctxRutaSPlan || {});
                    if (!idEje || !idPrograma || !idProyecto) {
                        mostrarToast('Falta contexto (eje/programa/proyecto).', 'danger');
                        return;
                    }

                    const fechaISO = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                    const path = `S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}/metas/${meta}/acciones/${accion}/avance_accion_anual/${fechaISO}/${yearKey}`;

                    const updates = {};
                    updates[path] = val;
                    document.getElementById('btnEvalGuardar').disabled = true;

                    await update(ref(db), updates);

                    mostrarToast('Avance guardado correctamente.', 'success');
                    bootstrap.Modal.getInstance(modalEl)?.hide();

                    // Refresca pantalla con los nuevos datos
                    if (typeof cargarDatos === 'function') cargarDatos();
                } catch (err) {
                    console.error('[Evaluación] Error al guardar:', err);
                    mostrarToast('No se pudo guardar el avance.', 'danger');
                } finally {
                    document.getElementById('btnEvalGuardar').disabled = false;
                }
            };

            // === Guardar con Enter (dentro del modal) ===
            // Limpia un handler previo para evitar duplicados si se reabre el modal
            if (modalEl._handleEnterGuardar) {
                modalEl.removeEventListener('keydown', modalEl._handleEnterGuardar);
            }

            modalEl._handleEnterGuardar = (ev) => {
                // Solo Enter "normal" (sin Shift)
                if (ev.key === 'Enter' && !ev.shiftKey) {
                    const t = ev.target;
                    // Ignora si es textarea o contenteditable
                    if (t && (t.tagName === 'TEXTAREA' || t.isContentEditable)) return;
                    // Asegura que el evento venga desde el propio modal
                    if (modalEl.contains(t)) {
                        ev.preventDefault();         // evita submit o beep
                        document.getElementById('btnEvalGuardar').click(); // dispara el guardado
                    }
                }
            };

            modalEl.addEventListener('keydown', modalEl._handleEnterGuardar);

            // Al cerrar el modal, quitar el listener
            modalEl.addEventListener('hidden.bs.modal', () => {
                if (modalEl._handleEnterGuardar) {
                    modalEl.removeEventListener('keydown', modalEl._handleEnterGuardar);
                    modalEl._handleEnterGuardar = null;
                }
            }, { once: true });

            // (Opcional) enfocar el input numérico para que Enter esté listo
            const inputNum = document.getElementById('eval-valor-num');
            if (inputNum) { inputNum.focus(); inputNum.select(); }

            // Mostrar modal
            bsModal.show();


            bsModal.show();
        };



        // ==== Reemplaza tu listener actual de .btnEvaluar por este ====
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btnEvaluar');
            if (!btn) return;
            if (!window.esAdmin) return;

            const meta = btn.dataset.meta;
            const accion = btn.dataset.accion;
            const responsable = btn.dataset.responsable || '';
            const ejecutado = Number(btn.dataset.ejecutado || 0);
            const proyeccion = Number(btn.dataset.proyeccion || 0);

            // viene URI-encoded en la tarjeta
            let avanceAccionAnual = {};
            try {
                const raw = btn.getAttribute('data-avance-accion-anual') || encodeURIComponent('{}');
                avanceAccionAnual = JSON.parse(decodeURIComponent(raw));
            } catch { avanceAccionAnual = {}; }

            window.abrirPanelEvaluacion({ meta, accion, responsable, ejecutado, proyeccion, avanceAccionAnual });
        });





        // Función para obtener el color de la barra de progreso según el porcentaje
        const getProgressBarColor = (progreso) => {
            if (progreso <= 40) return "#ff5c5c";  // Rojo
            if (progreso <= 75) return "#ffa500";  // Naranja
            return "#4caf50";  // Verde
        };

        // **Función para limitar texto**
        function limitarTexto(texto, limite) {
            return texto.length > limite ? texto.substring(0, limite) + "..." : texto;
        }

        function exportarGrafica(idCanvas, nombreArchivo = "grafica.png", scaleFactor = 4) {
            const canvas = document.getElementById(idCanvas);
            if (!canvas) {
                console.error("El canvas no se encontró.");
                return;
            }

            // Crear un canvas temporal con mayor resolución
            const canvasExport = document.createElement("canvas");
            const ctxExport = canvasExport.getContext("2d");

            // Ajustar tamaño del nuevo canvas para mayor resolución
            canvasExport.width = canvas.width * scaleFactor;
            canvasExport.height = canvas.height * scaleFactor;

            // Mejorar la calidad del renderizado
            ctxExport.imageSmoothingEnabled = true;
            ctxExport.imageSmoothingQuality = "high";

            // Dibujar la gráfica en el nuevo canvas con mayor resolución
            ctxExport.scale(scaleFactor, scaleFactor);
            ctxExport.drawImage(canvas, 0, 0);

            // Convertir a imagen en formato PNG con calidad máxima
            const imagen = canvasExport.toDataURL("image/png", 1.0);

            // Crear un enlace de descarga
            const link = document.createElement("a");
            link.href = imagen;
            link.download = nombreArchivo;

            // Simular clic para descargar la imagen
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.exportarGrafica = exportarGrafica;

        function exportarDatosAGrafica(labels, datos, nombreColumnas = ["Etiqueta", "Valor"], nombreArchivo = "datos_grafica.xlsx") {
            if (!labels || !datos || labels.length !== datos.length) {
                console.error("Error: Los datos y etiquetas deben tener la misma longitud.");
                return;
            }

            // Crear los datos para el archivo Excel
            let datosExcel = labels.map((label, index) => ({
                [nombreColumnas[0]]: label,
                [nombreColumnas[1]]: datos[index].toFixed(2) // Formatear a dos decimales
            }));

            // Convertir datos a hoja de Excel
            const ws = XLSX.utils.json_to_sheet(datosExcel);

            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos");

            // Descargar el archivo
            XLSX.writeFile(wb, nombreArchivo);
        }
        window.exportarDatosAGrafica = exportarDatosAGrafica;





        function obtenerNombreCorto(nombreCompleto) {
            if (!nombreCompleto) return "";
            const partes = nombreCompleto.trim().split(" ");
            if (partes.length === 1) return partes[0];
            return partes[0] + " " + partes[1];
        }

        const YEARS_KEYS = ['año1', 'año2', 'año3', 'año4'];

        /** Construye el HTML del cronograma para una acción */
        function cronogramaHTML(idMeta, idAccion, cronograma = {}, baseYear = BASE_ANIO_PLAN, editable = !!window.esAdmin) {
            // Crear las pestañas con "Año 1", "Año 2", etc.
            const tabs = YEARS_KEYS.map((k, i) =>
                `<button class="year-tab ${i === 0 ? 'active' : ''}" data-year="${k}" data-meta="${idMeta}" data-accion="${idAccion}">
            Año ${i + 1}
        </button>`).join('');

            // Crear las filas de los meses
            const rows = YEARS_KEYS.map((k, i) => {
                const style = i === 0 ? '' : 'style="display:none"';
                const meses = Array.from({ length: 12 }, (_, m) => {
                    const isOn = !!(cronograma?.[k]?.[m + 1]);
                    const ro = editable ? '' : 'readonly';
                    return `<div class="cell ${isOn ? 'on' : ''} ${ro}" data-meta="${idMeta}"
              data-accion="${idAccion}" data-anio="${k}" data-mes="${m + 1}"
              title="${k.toUpperCase()} • Mes ${m + 1}">${m + 1}</div>`;
                }).join('');
                return `<div class="grid" data-grid="${k}" ${style}>${meses}</div>`;
            }).join('');

            return `
    <div class="crono" data-meta="${idMeta}" data-accion="${idAccion}">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong class="small">Cronograma anual</strong>
        <div class="year-tabs">${tabs}</div>
      </div>
      ${rows}
      <div class="legend">
        <span class="me-3"><span class="sw on"></span>Programado</span>
        <span><span class="sw"></span>Libre</span>
      </div>
    </div>`;
        }

        function waitRoles() {
            if ((window.userRoles && window.userRoles.length) || typeof window.esAdmin !== 'undefined') {
                return Promise.resolve();
            }
            return new Promise(resolve => {
                document.addEventListener('roles:ready', resolve, { once: true });
            });
        }

        function applyRoleVisibility(scope = document, rolesInput) {
            const roles = Array.isArray(rolesInput) ? rolesInput : (window.userRoles || []);
            const rolesLower = roles.map(r => String(r || '').toLowerCase());
            const esAdmin = rolesLower.some(r => r.includes('admin')); // 'admin' en cualquier variante
            window.esAdmin = esAdmin;

            // Etiqueta simplificada (Admin > Responsable > Observador > Usuario)
            const etiqueta = document.getElementById('rolesUsuario');
            if (etiqueta) {
                let rolSimplificado = 'Usuario';
                if (rolesLower.some(r => r.includes('admin'))) rolSimplificado = 'Admin';
                else if (rolesLower.some(r => r.includes('responsable'))) rolSimplificado = 'Responsable';
                else if (rolesLower.some(r => r.includes('observador'))) rolSimplificado = 'Observador';
                etiqueta.textContent = rolSimplificado;
            }

            // Si es admin, desbloquear cronograma
            if (esAdmin) {
                scope.querySelectorAll('.crono .cell.readonly').forEach(el => el.classList.remove('readonly'));
            }

            // Normaliza visibilidad previa
            const ALL_ROLE_SELECTORS = '.admin-only, .admin-s-plan, .admin-s-plan-only, .admin-responsable-only, .responsable-s-plan-only';
            scope.querySelectorAll(ALL_ROLE_SELECTORS).forEach(el => {
                if (el.style.display === 'none') el.style.display = '';
                el.hidden = false;
            });

            // Oculta todo controlado por rol y luego muestra lo que toque
            const hide = sel => scope.querySelectorAll(sel).forEach(el => el.style.display = 'none');
            const show = sel => scope.querySelectorAll(sel).forEach(el => el.style.display = 'block');
            hide(ALL_ROLE_SELECTORS);

            // Mostrar según reglas que ya usas
            // 1) admin (incluye cualquier 'admin' en el rol)
            if (roles.includes('admin') || esAdmin) {
                show('.admin-only');
            }
            // 2) admin-s-plan
            if (roles.includes('admin-s-plan') || rolesLower.includes('admin-s-plan')) {
                show('.admin-s-plan, .admin-s-plan-only');
            }
            // 3) admin-s-plan O responsable-s-plan
            if (
                roles.includes('admin-s-plan') || rolesLower.includes('admin-s-plan') ||
                roles.includes('responsable-s-plan') || rolesLower.includes('responsable-s-plan')
            ) {
                show('.admin-responsable-only, .responsable-s-plan-only');
            }

            // Botón Evaluar (solo admin interactúa)
            scope.querySelectorAll('.btnEvaluar').forEach(b => {
                if (esAdmin) {
                    b.removeAttribute('disabled');
                    b.style.cursor = 'pointer';
                    b.style.opacity = '1';
                    b.title = 'Evaluar acción';
                } else {
                    b.setAttribute('disabled', '');
                    b.style.cursor = 'not-allowed';
                    b.style.opacity = '.6';
                    b.title = 'Solo disponible para admins';
                }
            });
        }

        // (Opcional) re-aplicar cuando se anuncien roles globalmente
        document.addEventListener('roles:ready', () => applyRoleVisibility(document));

        // Aplícala una vez con los roles actuales (visitante al inicio)
        applyRoleVisibility(document);



        // ========================
        // EVIDENCIAS S-PLAN (4 años)
        // ========================

        /* Reemplaza tu función anterior por esta.
           Asume que el botón que abre el modal tiene:
           data-meta, data-accion, data-responsable (opcional), data-tituloaccion
        */

        const YEARS = ['año1', 'año2', 'año3', 'año4'];
        const YEAR_IDS = { 'año1': 'anio1', 'año2': 'anio2', 'año3': 'anio3', 'año4': 'anio4' };
        const BRAND_GREEN = '#00594E';
        const BRAND_GOLD = '#B5A160';

        // Estado en memoria para la sesión del modal
        const evsState = {
            key: null,                       // meta|accion
            meta: null,
            accion: null,
            tituloAccion: null,
            cache: {},                       // key -> { porAnio, flatList, total }
            paginacion: { 'año1': 4, 'año2': 4, 'año3': 4, 'año4': 4 }, // visibles por año
            urls: []                         // urls para "Descargar todo"
        };

        // ========= Helpers UI =========
        function $(sel) { return document.querySelector(sel); }
        function $id(id) { return document.getElementById(id); }

        function limitarTextoSafe(t, n = 90) {
            if (typeof limitarTexto === 'function') return limitarTexto(t, n);
            t = String(t ?? '');
            return t.length > n ? t.slice(0, n - 1) + '…' : t;
        }


        function formatearFechaSafe(fechaLike) {
            if (!fechaLike) return '—';
            let d = null;
            if (typeof fechaLike === 'number') d = new Date(fechaLike);
            else if (/^\d+$/.test(String(fechaLike))) d = new Date(Number(fechaLike));
            else d = new Date(fechaLike);
            if (isNaN(d)) return '—';
            return d.toLocaleString('es-CO', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }


        function obtenerIconoArchivoSafe(formato, extraCls = '') {
            if (typeof obtenerIconoArchivo === 'function') return obtenerIconoArchivo(formato, extraCls);
            const f = (formato || '').toLowerCase();
            let ic = 'fa-file';
            if (/(pdf)/.test(f)) ic = 'fa-file-pdf';
            else if (/(xls|xlsx|csv)/.test(f)) ic = 'fa-file-excel';
            else if (/(doc|docx)/.test(f)) ic = 'fa-file-word';
            else if (/(ppt|pptx)/.test(f)) ic = 'fa-file-powerpoint';
            else if (/(png|jpg|jpeg|webp)/.test(f)) ic = 'fa-file-image';
            else if (/(zip|rar|7z)/.test(f)) ic = 'fa-file-zipper';
            return `<i class="fa-regular ${ic} ${extraCls}"></i>`;
        }
        function badgeEstado(estado = 'pendiente') {
            const map = {
                aprobado: { cls: 'bg-success', text: 'Aprobado', icon: 'fa-circle-check' },
                en_validacion: { cls: 'bg-warning text-dark', text: 'En validación', icon: 'fa-hourglass-half' },
                rechazado: { cls: 'bg-danger', text: 'Rechazado', icon: 'fa-circle-xmark' },
                pendiente: { cls: 'bg-secondary', text: 'Pendiente', icon: 'fa-clock' }
            };
            const { cls, text, icon } = map[estado] || map.pendiente;
            return `<span class="badge ${cls} rounded-pill"><i class="fa-solid ${icon} me-1"></i>${text}</span>`;
        }


        // ========= Transformación de datos =========

        // Año base del plan (ajústalo si cambia)
        const BASE_ANIO_PLAN = 2024;

        // Inferir año desde "ciclo" tipo "2025_2" -> "año1" (clamp 1..4)
        function inferirAnioDesdeCiclo(ciclo, base = BASE_ANIO_PLAN) {
            if (!ciclo || typeof ciclo !== 'string') return null;
            const m = ciclo.match(/^(\d{4})_/); if (!m) return null;
            const idx = Math.min(4, Math.max(1, (parseInt(m[1], 10) - base) + 1));
            return `año${idx}`;
        }

        // === Deducción de formato ===
        const MIME_TO_EXT = {
            'application/pdf': 'pdf',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
            'application/vnd.ms-excel': 'xls',
            'text/csv': 'csv',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
            'application/msword': 'doc',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'pptx',
            'application/vnd.ms-powerpoint': 'ppt',
            'image/png': 'png',
            'image/jpeg': 'jpg',
            'image/jpg': 'jpg',
            'image/webp': 'webp',
            'image/svg+xml': 'svg',
            'image/tiff': 'tiff',
            'application/zip': 'zip',
            'application/x-7z-compressed': '7z',
            'application/x-rar-compressed': 'rar',
            'text/plain': 'txt',
            'application/json': 'json',
            'text/xml': 'xml',
            'video/mp4': 'mp4',
            'audio/mpeg': 'mp3'
        };

        function normalizarFormato(ext) {
            if (!ext) return null;
            const map = { jpeg: 'jpg', tif: 'tiff', htm: 'html' };
            ext = ext.toLowerCase();
            return map[ext] || ext;
        }

        function extraerExtensionDeRuta(ruta) {
            if (!ruta) return null;
            // quita query/fragmento y toma el último segmento
            const base = ruta.split('?')[0].split('#')[0].split('/').pop();
            const m = base && base.match(/\.([a-z0-9]+)$/i);
            return m ? m[1].toLowerCase() : null;
        }

        function extraerNombreDeRuta(ruta = '') {
            if (!ruta) return null;
            const base = ruta.split('?')[0].split('#')[0];
            const last = base.substring(base.lastIndexOf('/') + 1);
            if (!last) return null;
            try { return decodeURIComponent(last); } catch { return last; }
        }

        /**
         * Obtiene formato (extensión) preferentemente desde el nombre del archivo.
         * Fallback: desde URL, o desde contentType.
         */
        function obtenerFormato(nombre, url, contentType) {
            let ext = extraerExtensionDeRuta(nombre) ||
                extraerExtensionDeRuta(url) ||
                (contentType ? MIME_TO_EXT[String(contentType).toLowerCase().split(';')[0].trim()] : null);
            return normalizarFormato(ext);
        }


        function flattenArchivos(archivos, cicloKey, idMeta, idAccion) {
            const out = [];
            const pushPlano = (src = {}, fileId, base = {}) => {
                let nombre = src.nombre || src.filename || src.titulo || base.nombre || base.filename || base.titulo || '';
                if (!nombre) nombre = extraerNombreDeRuta(src.url || src.downloadURL || base.url || base.downloadURL || '') || 'archivo';

                const autor =
                    src.correo || src.email || src.uploader ||
                    base.autor || base.usuario || base.responsable || base.correo || base.email || '—';

                const fecha = src.fecha || src.fechaSubida || src.timestamp || src.createdAt || base.fecha || '';
                const formato = (src.formato || src.extension || base.formato || base.extension ||
                    obtenerFormato(nombre, (src.url || base.url), (src.contentType || src.mimeType || base.contentType || base.mimeType)) || '')
                    .toUpperCase();

                const anioKey = (src.anio || src.año || src.year || inferirAnioDesdeCiclo(cicloKey) || 'año1') + '';
                const anioNorm = YEARS.includes(anioKey.toLowerCase()) ? anioKey.toLowerCase() : (inferirAnioDesdeCiclo(cicloKey) || 'año1');

                out.push({
                    id: fileId,
                    uploadId: null,
                    meta: idMeta,
                    accion: idAccion,
                    ciclo: cicloKey,
                    anioKey: anioNorm,
                    nombre,
                    formato,
                    fecha,
                    autor,
                    peso: getPesoString(src, base),           // ← AQUÍ
                    url: src.url || src.downloadURL || base.url || base.downloadURL || '',
                    estado: src.estado || base.estado || 'pendiente',
                    descripcion: src.descripcion || base.descripcion || '',
                    observaciones: src.observaciones || base.observaciones || ''
                });
            };

            for (const fileId in (archivos || {})) {
                const node = archivos[fileId] || {};
                if (node.uploads && typeof node.uploads === 'object') {
                    for (const upId in node.uploads) {
                        const up = node.uploads[upId] || {};
                        pushPlano(up, `${fileId}__${upId}`, node);
                        out[out.length - 1].uploadId = upId;
                    }
                } else {
                    pushPlano(node, fileId, node);
                }
            }
            return out;
        }


        function agruparPorAnio(flatList) {
            const porAnio = { 'año1': [], 'año2': [], 'año3': [], 'año4': [] };
            (flatList || []).forEach(ev => {
                let k = (ev.anioKey || '').toLowerCase();
                if (!YEARS.includes(k)) k = 'año1';
                porAnio[k].push(ev);
            });
            YEARS.forEach(k => porAnio[k].sort((a, b) => (new Date(b.fecha || 0)) - (new Date(a.fecha || 0))));
            return porAnio;
        }

        function setUltimaActualizacion() {
            const span = $id('ultimaActualizacionEvs'); if (!span) return;
            const cache = evsState.cache?.[evsState.key];
            const fechas = (cache?.flatList || []).map(x => new Date(x.fecha || 0).getTime()).filter(Boolean);
            span.textContent = fechas.length ? new Date(Math.max(...fechas)).toLocaleString('es-CO') : '—';
        }

        // ========= Render =========

        function evidenciaItemHTML(ev) {
            const icon = obtenerIconoArchivoSafe(ev.formato, 'fa-lg');
            const fecha = formatearFechaSafe(ev.fecha);
            const desc = (ev.descripcion || ev.observaciones || '').trim();
            const estadoBadge = badgeEstado(ev.estado);

            // Si el id viene como "fileId__upId" (caso uploads), lo separamos para facilitar la ruta
            const idStr = String(ev.id || '');
            const [fileIdBase, uploadId] = idStr.includes('__') ? idStr.split('__') : [idStr, ''];

            return `
    <li class="list-group-item d-flex gap-3 align-items-start border-0 border-bottom">
      <div class="pt-1 flex-shrink-0">${icon}</div>
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between align-items-start">
          <h6 class="mb-1" style="color:#234;font-weight:600">${limitarTextoSafe(ev.titulo, 100)}</h6>
          <div class="ms-2">${estadoBadge}</div>
        </div>

        <div class="small text-muted mb-1">
          ${fecha !== '—' ? `<i class="fa-regular fa-calendar me-1"></i>${fecha}` : ''}
          ${ev.usuario ? `&nbsp;•&nbsp;<i class="fa-regular fa-user me-1"></i>${ev.usuario}` : ''}
          &nbsp;•&nbsp;<span class="text-uppercase">${(ev.formato || '').toString()}</span>
          &nbsp;•&nbsp;<span class="text-muted">Ciclo: ${ev.ciclo}</span>
        </div>

        ${desc ? `<div class="text-secondary" style="font-size:.95em">${limitarTextoSafe(desc, 180)}</div>` : ''}

        <div class="mt-2 d-flex flex-wrap gap-2">
          ${ev.url
                    ? `<a href="${ev.url}" target="_blank" class="btn btn-sm btn-outline-success">
                   <i class="fa-solid fa-up-right-from-square me-1"></i> Ver / Descargar
                 </a>`
                    : `<span class="small text-warning">No disponible para descarga</span>`
                }

          <button class="btn btn-sm btn-outline-warning admin-s-plan btnEditarEvidencia"  style="display:none;"
          
            data-ciclo="${ev.ciclo || ''}"
            data-meta="${ev.meta || ''}"
            data-accion="${ev.accion || ''}"
            data-id="${idStr}"
            data-fileid="${fileIdBase}"
            data-uploadid="${uploadId}"
            data-anio="${ev.anioKey || ''}"
            data-url="${ev.url ? encodeURIComponent(ev.url) : ''}"
          >
            <i class="fa-solid fa-scale-balanced me-1"></i> Editar
          </button>

          <!-- NUEVO: Eliminar -->
          <button
            class="btn btn-sm btn-outline-danger btnEliminarEvidencia admin-only admin-s-plan"

            style="display:none;
      
            title="Eliminar evidencia"
        
            data-ciclo="${ev.ciclo || ''}"
            data-meta="${ev.meta || ''}"
            data-accion="${ev.accion || ''}"
            data-id="${idStr}"
            data-fileid="${fileIdBase}"
            data-uploadid="${uploadId}"
            data-anio="${ev.anioKey || ''}"
            data-url="${ev.url ? encodeURIComponent(ev.url) : ''}"
          >
            <i class="fa-solid fa-trash-can me-1"></i> Eliminar
          </button>
        </div>
      </div>
    </li>
  `;


        }




        function renderAllYears() { YEARS.forEach(k => renderYearList(k)); setUltimaActualizacion(); }

        function renderYearList(k = 'año1') {
            const list = $id(`${YEAR_IDS[k]}-list`);
            const wrapMore = $id(`${YEAR_IDS[k]}-more-wrap`);
            if (!list) return;

            const cache = evsState.cache?.[evsState.key];
            const data = cache?.porAnio?.[k] || [];
            const limit = evsState.paginacion?.[k] || 4;

            list.innerHTML = '';
            if (!data.length) {
                list.innerHTML = `<li class="list-group-item border-0 px-0"><div class="empty-state"><i class="fa-regular fa-inbox-out me-2"></i>No hay evidencias para este año.</div></li>`;
                if (wrapMore) wrapMore.style.display = 'none';
                return;
            }

            const frag = document.createDocumentFragment();
            data.slice(0, limit).forEach(item => frag.appendChild(renderEviCard(item)));
            list.appendChild(frag);

            if (wrapMore) wrapMore.style.display = data.length > limit ? '' : 'none';
        }

        // Preparar “Descargar todo”
        function prepararUrlsDescarga() {
            const flat = evsState.cache[evsState.key]?.flatList || [];
            evsState.urls = flat.filter(x => !!x.url).map(x => x.url);
            const btn = $id('btnDescargarTodoSPlan');
            if (btn) btn.disabled = evsState.urls.length === 0;
        }

        // ========= Lógica principal =========

        export async function abrirModalEvidencias(event, roles = []) {

            const btn = (event?.currentTarget || event?.target) ?? null;
            const idMeta = btn?.dataset?.meta || btn?.getAttribute('data-meta');
            const idAccion = btn?.dataset?.accion || btn?.getAttribute('data-accion');
            const tituloAccion = btn?.dataset?.tituloaccion || 'Acción';

            if (!idMeta || !idAccion) {
                console.error('Faltan data-*: data-meta y/o data-accion');
                return;
            }

            // Estado
            evsState.key = `${idMeta}|${idAccion}`;
            evsState.meta = idMeta;
            evsState.accion = idAccion;
            evsState.tituloAccion = tituloAccion;
            evsState.paginacion = { 'año1': 4, 'año2': 4, 'año3': 4, 'año4': 4 };

            // Título y loading
            const tituloEl = $id('tituloEvidencias');
            if (tituloEl) tituloEl.textContent = limitarTextoSafe(tituloAccion, 90);
            setUltimaActualizacion();

            // Limpia listas y pone “cargando…”
            YEARS.forEach(k => {
                const list = $id(`${YEAR_IDS[k]}-list`);
                if (list) list.innerHTML = `<li class="list-group-item border-0 text-center text-muted py-3">
      <span class="spinner-border spinner-border-sm text-success me-2"></span>Cargando evidencias...</li>`;
                const wrapMore = $id(`${YEAR_IDS[k]}-more-wrap`);
                if (wrapMore) wrapMore.style.display = 'none';
            });


            const evidenciasRootRef = ref(db, 'S-PLAN/evidencias');

            try {
                const snap = await get(evidenciasRootRef);
                if (!snap.exists()) {
                    YEARS.forEach(k => {
                        const list = $id(`${YEAR_IDS[k]}-list`);
                        if (list) list.innerHTML = `<li class="list-group-item border-0 text-center text-muted py-3">
          No hay evidencias cargadas.</li>`;
                    });
                    prepararUrlsDescarga();
                    new bootstrap.Modal($id('evidenciasModal')).show();
                    // Aplica roles dentro del modal (botones evaluar/eliminar, etc.)
                    const modalEl = document.getElementById('evidenciasModal');
                    if (modalEl) applyRoleVisibility(modalEl);

                    return;
                }

                const ciclos = snap.val();
                const flat = [];
                let total = 0;

                // Recorre todos los ciclos y toma los de esta meta/acción
                for (const cicloKey in ciclos) {
                    const ciclo = ciclos[cicloKey] || {};
                    const nodoMeta = ciclo[idMeta];
                    if (nodoMeta && nodoMeta[idAccion]) {
                        const archivos = nodoMeta[idAccion];
                        const arr = flattenArchivos(archivos, cicloKey, idMeta, idAccion);
                        flat.push(...arr);
                        total += arr.length;
                    }
                }

                // Cachear
                const porAnio = agruparPorAnio(flat);
                evsState.cache[evsState.key] = { porAnio, flatList: flat, total };

                // Render
                renderAllYears();
                prepararUrlsDescarga();


                // Mostrar modal
                new bootstrap.Modal($id('evidenciasModal')).show();

                // Log útil
                console.groupCollapsed('%c[S-PLAN] Evidencias', 'color:#00594E; font-weight:600');
                console.log('Meta:', idMeta, 'Acción:', idAccion, 'Total evidencias:', total);
                console.table(flat.map(x => ({
                    id: x.id, ciclo: x.ciclo, anio: x.anioKey || '—', formato: x.formato, fecha: x.fecha, usuario: x.usuario, tieneURL: !!x.url
                })));
                console.groupEnd();

            } catch (err) {
                console.error('Error al consultar evidencias:', err);
                YEARS.forEach(k => {
                    const list = $id(`${YEAR_IDS[k]}-list`);
                    if (list) list.innerHTML = `<li class="list-group-item border-0 text-center text-danger py-3">
        Error al consultar Firebase.</li>`;
                });
                new bootstrap.Modal($id('evidenciasModal')).show();
            }
        }

        // ========= Eventos del modal =========

        // Delegación para “Cargar más” por año
        $id('evidenciasModal')?.addEventListener('click', (e) => {
            const moreBtn = e.target.closest('button[id$="-more"]');
            if (!moreBtn) return;
            const anio = moreBtn.getAttribute('data-anio');
            if (!anio) return;
            const k = `año${anio}`;
            evsState.paginacion[k] = (evsState.paginacion[k] || 4) + 9999; // mostrar todo lo restante
            renderYearList(k);
        });

        // Descargar todo (abre cada URL en una nueva pestaña; si el navegador bloquea, sugiere permitir popups)
        $id('btnDescargarTodoSPlan')?.addEventListener('click', () => {
            if (!evsState.urls.length) return;
            // Pequeño throttle para evitar bloqueo agresivo del navegador
            let i = 0;
            const openNext = () => {
                if (i >= evsState.urls.length) return;
                window.open(evsState.urls[i], '_blank');
                i++;
                setTimeout(openNext, 200);
            };
            openNext();
        });

        // Ejemplo: enganche global (usa tu clase real en los botones)
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-evidencias-splan'); // <button class="btn-evidencias-splan" data-meta="..." data-accion="..." ...>
            if (!btn) return;
            // Pasa tus roles reales si los tienes en una variable global p.ej. window.rolesUsuario
            abrirModalEvidencias({ currentTarget: btn }, window.rolesUsuario || []);
        });


        // Utilidades
        function formatearFecha(fechaISO) {
            if (!fechaISO) return "";
            const d = new Date(fechaISO);
            return d.toLocaleDateString("es-CO", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        }

        function obtenerIconoArchivo(formato, size = "fa-2x") {
            let icon = "fa-file";
            const ext = (formato || "").toLowerCase();
            if (ext.includes("pdf")) icon = "fa-file-pdf text-danger";
            else if (ext.includes("doc") || ext.includes("word")) icon = "fa-file-word text-primary";
            else if (ext.includes("xls") || ext.includes("excel")) icon = "fa-file-excel text-success";
            else if (["jpg", "jpeg", "png", "gif", "bmp"].some(e => ext.includes(e))) icon = "fa-file-image text-info";
            else if (ext.includes("zip") || ext.includes("rar")) icon = "fa-file-archive text-warning";
            else if (ext.includes("mp4") || ext.includes("avi")) icon = "fa-file-video text-secondary";
            return `<i class="fas ${icon} ${size}"></i>`;
        }


        function obtenerResponsablesPorCodigo(codigos) {
            if (!codigos || typeof codigos !== 'string') return 'Sin responsable';

            const ids = codigos.split(',').map(c => c.trim());
            const nombres = [];

            ids.forEach(id => {
                const responsable = mapaResponsables[id];
                if (responsable && responsable.area) {
                    nombres.push(responsable.area);
                } else {
                    nombres.push(id); // fallback por si no se encuentra
                }
            });

            return nombres.join(', ');
        }

        /** Abre un popup centrado en pantalla */
        function openCenteredPopup(url, width = 1600, height = 1080) {
            const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
            const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;

            const w = window.innerWidth || document.documentElement.clientWidth || screen.width;
            const h = window.innerHeight || document.documentElement.clientHeight || screen.height;

            const systemZoom = w / window.screen.availWidth;
            const left = (w - width) / (2 * systemZoom) + dualScreenLeft;
            const top = (h - height) / (2 * systemZoom) + dualScreenTop;

            const features = [
                `width=${width}`, `height=${height}`,
                `top=${top}`, `left=${left}`,
                'resizable=yes', 'scrollbars=yes'
            ].join(',');

            const popup = window.open(url, 'cargarEvidencias', features);
            if (popup && popup.focus) popup.focus();
            return popup;
        }

        /** Espera (promesa) a que el popup se cierre */
        function waitForClose(win) {
            return new Promise(resolve => {
                const iv = setInterval(() => {
                    if (!win || win.closed) {
                        clearInterval(iv);
                        resolve();
                    }
                }, 400);
            });
        }

        /** Delegación: click en cualquier .btn-subir-evidencia */
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.btn-subir-evidencia');
            if (!btn) return;

            // Lee m (meta) y a (acción) de data-attributes
            const meta = btn.dataset.meta || btn.getAttribute('data-m');
            const accion = btn.dataset.accion || btn.getAttribute('data-a');

            if (!meta || !accion) {
                console.warn('Faltan parámetros para abrir el popup (m/a).', { meta, accion });
                alert('No se pudo abrir: faltan parámetros de meta o acción.');
                return;
            }

            // Construye la URL del popup
            const url = `cargar2.html?m=${encodeURIComponent(meta)}&a=${encodeURIComponent(accion)}`;

            // Abre el popup centrado
            const popup = openCenteredPopup(url);

            // Si el navegador bloquea el popup, como fallback navega en la misma pestaña
            if (!popup) {
                window.location.href = url;
                return;
            }

            // Espera a que el usuario cierre el popup
            await waitForClose(popup);

            // Post-cierre: refresca datos o dispara un evento global para que escuches donde quieras
            try {
                // Si tienes una función específica de recarga, úsala:
                if (typeof recargarEvidenciasDeAccion === 'function') {
                    await recargarEvidenciasDeAccion(meta, accion);
                }

                // Además, dispara un CustomEvent por si otro módulo quiere reaccionar
                document.dispatchEvent(new CustomEvent('evidencias:popupClosed', { detail: { meta, accion } }));
                console.log('Popup cerrado. Refrescando vista de evidencias…', { meta, accion });
            } catch (err) {
                console.error('Error al refrescar después del popup:', err);
            }
        });


        // Delegación: clic en botón eliminar
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.btnEliminarEvidencia');
            if (!btn) return;

            const ciclo = btn.dataset.ciclo;
            const meta = btn.dataset.meta;
            const accion = btn.dataset.accion;
            const id = btn.dataset.id;
            const fileId = btn.dataset.fileid;
            const uploadId = btn.dataset.uploadid;
            const url = btn.dataset.url ? decodeURIComponent(btn.dataset.url) : '';

            if (!ciclo || !meta || !accion || !fileId) {
                console.warn('[Eliminar] Faltan datos para construir la ruta', { ciclo, meta, accion, fileId, uploadId });
                mostrarToast('No se puede eliminar: datos incompletos.', 'danger');
                return;
            }

            // Confirma con SweetAlert 2
            const result = await Swal.fire({
                title: '¿Seguro que deseas eliminar esta evidencia?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            // Construye la ruta en RTDB
            let dbPath = `S-PLAN/evidencias/${ciclo}/${meta}/${accion}/${fileId}`;
            if (uploadId) dbPath += `/uploads/${uploadId}`;

            try {
                // Borra nodo en RTDB
                await remove(ref(db, dbPath));

                // (Opcional) borrar archivo en Storage si tienes la URL
                if (url) {
                    try {
                        // Si importas refFromURL:
                        // const storageRef = refFromURL(url);
                        // await deleteObject(storageRef);

                        // Si no tienes refFromURL, omite o implementa conversión URL->path
                    } catch (errStorage) {
                        console.warn('[Eliminar] No se pudo borrar en Storage (continuo):', errStorage);
                    }
                }

                // Feedback y refresco UI
                mostrarToast('Evidencia eliminada correctamente.', 'success');
                // Quita el item de la lista visual
                const li = btn.closest('li.list-group-item');
                if (li) li.remove();

            } catch (err) {
                console.error('[Eliminar] Error al eliminar:', err);
                mostrarToast('Error al eliminar la evidencia.', 'danger');
            }
        });







        // === Dropdown dinámico de METAS (E#M#) ===========================
        const metasContainer = document.getElementById('containerMetasDropdown');
        const metasToggler = document.getElementById('id_meta_nav');

        function parseEM(s) {
            const m = /^E(\d+)M(\d+)$/i.exec((s || '').trim());
            return m ? { e: +m[1], m: +m[2] } : null;
        }
        function sortEM(a, b) {
            const pa = parseEM(a), pb = parseEM(b);
            if (pa && pb) return pa.e === pb.e ? pa.m - pb.m : pa.e - pb.e;
            return String(a).localeCompare(String(b), undefined, { numeric: true, sensitivity: 'base' });
        }
        function extractCodes(val) {
            if (!val) return [];
            if (Array.isArray(val)) return val.filter(Boolean);
            if (typeof val === 'object') {
                const out = [];
                for (const [k, v] of Object.entries(val)) {
                    if (v && typeof v === 'object') out.push(v.codigo || v.alias || k);
                    else out.push(k);
                }
                return out;
            }
            return [];
        }
        function storageKeyFor(ids) {
            return `splan.meta.activa.${ids.idEje}.${ids.idPrograma}.${ids.idProyecto}`;
        }
        function renderMetasGrid(codes, active) {
            metasContainer.innerHTML = codes.map(c =>
                `<a href="#" class="meta-item ${c === active ? 'active' : ''}" data-meta="${c}">${c}</a>`
            ).join('');
        }

        function setActiveMeta(code, ids, { silent = false, persist = true, reload = true } = {}) {
            // UI activa en el grid
            metasContainer.querySelector('.meta-item.active')?.classList.remove('active');
            metasContainer.querySelector(`.meta-item[data-meta="${code}"]`)?.classList.add('active');

            // Breadcrumb y encabezados
            if (metasToggler) metasToggler.textContent = code;
            const sub2 = document.getElementById('id_meta_sub2'); if (sub2) sub2.textContent = code;
            const pageTitleEl = document.getElementById('pageTitle'); if (pageTitleEl) pageTitleEl.textContent = 'Meta ' + code;

            // Actualiza la variable global y recarga data
            idMeta = code;
            if (reload && typeof cargarDatos === 'function') cargarDatos();

            // Cierra el dropdown (Bootstrap 5)
            try {
                if (window.bootstrap && metasToggler) {
                    (bootstrap.Dropdown.getInstance(metasToggler) || new bootstrap.Dropdown(metasToggler)).hide();
                }
            } catch { }

            // Persistencia por proyecto
            if (persist) localStorage.setItem(storageKeyFor(ids), code);

            // Evento / callback (por si quieres escuchar cambios en otro módulo)
            metasContainer.dispatchEvent(new CustomEvent('meta-change', { detail: { code, ids } }));
            if (!silent && typeof window.onMetaChange === 'function') window.onMetaChange(code, ids);
        }

        async function initMetasDropdown(ids, metaDefault) {
            if (!metasContainer) return;
            metasContainer.dataset.ids = JSON.stringify(ids);
            metasContainer.innerHTML = `<div class="text-center py-2 small text-muted">Cargando metas…</div>`;

            const refProyecto = ref(db, `S-PLAN/ejes/${ids.idEje}/programas/${ids.idPrograma}/proyectos/${ids.idProyecto}/metas_indices`);
            try {
                const snap = await get(refProyecto);
                const codes = extractCodes(snap.val()).filter(Boolean).sort(sortEM);

                if (!codes.length) {
                    metasContainer.innerHTML = `<div class="text-center py-2 small text-muted">Sin metas para mostrar</div>`;
                    if (metasToggler) metasToggler.textContent = '—';
                    return;
                }

                const stored = localStorage.getItem(storageKeyFor(ids));
                const initial = (stored && codes.includes(stored))
                    ? stored
                    : (metaDefault && codes.includes(metaDefault) ? metaDefault : codes[0]);

                renderMetasGrid(codes, initial);
                // Marca activa y actualiza UI sin recargar todo aún
                setActiveMeta(initial, ids, { silent: true, reload: false, persist: true });
            } catch (err) {
                console.error('[Dropdown metas] Error cargando metas:', err);
                metasContainer.innerHTML = `<div class="text-danger small">Error cargando metas</div>`;
            }
        }

        // Delegación de clics dentro del grid
        metasContainer?.addEventListener('click', (e) => {
            const a = e.target.closest('.meta-item');
            if (!a) return;
            e.preventDefault();
            let ids = {};
            try { ids = JSON.parse(metasContainer.dataset.ids || '{}'); } catch { }
            setActiveMeta(a.dataset.meta, ids);
        });

        async function ensureMetasIndices(
            { idEje, idPrograma, idProyecto },
            { reconstruir = false } = {}
        ) {
            if (!idEje || !idPrograma || !idProyecto) {
                console.warn('[ensureMetasIndices] Faltan IDs (eje/programa/proyecto).');
                return { created: false, count: 0, reason: 'ids_invalidos' };
            }

            const basePath = `S-PLAN/ejes/${idEje}/programas/${idPrograma}/proyectos/${idProyecto}`;
            const idxRef = ref(db, `${basePath}/metas_indices`);

            try {
                // 1) Si ya existen y no queremos reconstruir, salir rápido.
                const idxSnap = await get(idxRef);
                if (idxSnap.exists() && !reconstruir) {
                    const existing = idxSnap.val() || {};
                    return { created: false, count: Object.keys(existing).length, reason: 'ya_existian' };
                }

                // 2) Leer metas del proyecto
                const metasRef = ref(db, `${basePath}/metas`);
                const metasSnap = await get(metasRef);
                if (!metasSnap.exists()) {
                    console.warn('[ensureMetasIndices] No hay metas para indexar.');
                    return { created: false, count: 0, reason: 'sin_metas' };
                }

                const metas = metasSnap.val() || {};
                const indices = {};

                // 3) Construir un índice mínimo por cada meta
                //    (solo datos ligeros para listas/menús)
                for (const [metaId, meta] of Object.entries(metas)) {
                    indices[metaId] = {
                        codigo: metaId,
                        titulo: meta?.titulo_meta || '',                  // útil para tooltip/lista
                        tipo_programacion: meta?.tipo_programacion || '', // opcional pero liviano
                        tipo_acumulacion: meta?.tipo_acumulacion || ''    // opcional pero liviano
                        // agrega aquí cualquier otro campo ligero que te sirva en UI
                    };
                }

                // 4) Guardar (un solo write)
                await update(ref(db), { [`${basePath}/metas_indices`]: indices });

                // (opcional) feedback visual
                if (typeof mostrarToast === 'function') {
                    mostrarToast(`metas_indices creados: ${Object.keys(indices).length}`, 'success');
                }

                return { created: true, count: Object.keys(indices).length };
            } catch (err) {
                console.error('[ensureMetasIndices] Error:', err);
                if (typeof mostrarToast === 'function') {
                    mostrarToast('No se pudieron crear los índices de metas.', 'danger');
                }
                return { created: false, count: 0, error: String(err) };
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Obtén los parámetros de la URL actual.
            const urlParams = new URLSearchParams(window.location.search);
            const dataCodificada = urlParams.get('data');

            if (!dataCodificada) {
                console.error("No se proporcionaron datos codificados en la URL.");
                // Opcional: Mostrar un error en la página.
                document.body.innerHTML = '<h1>Error: Faltan parámetros para cargar la meta.</h1>';
                if (!idMeta) {
                    window.location.href = "dashboard.html";  // Redirigir si no hay ID válido
                }
                return;
            }

            try {
                // 2. Decodifica la cadena Base64 para obtener los parámetros originales.
                const paramsDecodificados = atob(dataCodificada); // "id=E1M1&programa=PROG-001..."

                // 3. Usa URLSearchParams de nuevo para parsear la cadena decodificada fácilmente.
                const params = new URLSearchParams(paramsDecodificados);

                // 4. Extrae cada valor como lo hacías antes.
                idMeta = params.get('id');
                idPrograma = params.get('programa');
                idEje = params.get('eje');
                idProyecto = params.get('proyecto');

                await initMetasDropdown({ idEje, idPrograma, idProyecto }, idMeta);

                await ensureMetasIndices({ idEje, idPrograma, idProyecto });

                cargarDatos();


            } catch (error) {
                console.error("Error al decodificar los parámetros:", error);
                document.body.innerHTML = '<h1>Error: Los parámetros de la URL son inválidos.</h1>';
            }
        });



        /* ================== Helpers genéricos ================== */




        function normalizarItem(src = {}, ctx = {}) {
            const nombre = src.nombre || src.filename || src.titulo || 'archivo';
            const formato = (src.formato || src.ext || nombre.split('.').pop() || '').toUpperCase();
            const fecha = src.fecha || src.fechaSubida || src.timestamp || src.createdAt || null;
            return {
                id: ctx.fileId,
                uploadId: ctx.uploadId,
                meta: ctx.idMeta,
                accion: ctx.idAccion,
                ciclo: ctx.cicloKey,
                anioKey: inferirAnioDesdeCiclo(ctx.cicloKey),
                nombre,
                formato,
                fecha,
                usuario: src.usuario || src.autor || src.subidoPor || '—',
                peso: src.peso || src.sizePretty || prettyBytes(src.size) || '—',
                url: src.url || src.downloadURL || ''
            };
        }

        function prettyBytes(b) {
            const x = Number(b || 0); if (!x) return '';
            const u = ['B', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(x) / Math.log(1024));
            return (x / Math.pow(1024, i)).toFixed(i > 1 ? 2 : 1) + ' ' + u[i];
        }

        // Pon esto cerca de prettyBytes
        function getPesoString(src = {}, base = {}) {
            // intenta valores ya “bonitos” primero
            const nice = src.sizePretty ?? base.sizePretty ?? src.peso ?? base.peso;
            if (typeof nice === 'string' && /\d+(\.\d+)?\s?(B|KB|MB|GB|TB)$/i.test(nice.trim())) {
                return nice.trim();
            }

            // candidatos en bytes (pueden venir como número o string)
            const candidates = [
                src.peso, base.peso,
                src.size, base.size,
                src.sizeBytes, base.sizeBytes,
                src.bytes, base.bytes,
                src.fileSize, base.fileSize,
                src.contentLength, base.contentLength,
                src.tamano, base.tamano,
                src['tamaño'], base['tamaño']
            ];

            for (const v of candidates) {
                if (v == null || v === '') continue;
                const n = Number(String(v).replace(/[, ]/g, '')); // soporta "1,024,000"
                if (Number.isFinite(n) && n > 0) return prettyBytes(n);
            }
            return '—';
        }




        /* Requiere el <template id="tpl-evi-card"> del modal */
        function renderEviCard(item) {
            const tpl = $id('tpl-evi-card');
            const node = tpl?.content?.firstElementChild?.cloneNode(true);
            if (!node) {
                const li = document.createElement('li'); li.className = 'list-group-item'; li.textContent = item?.nombre || 'archivo'; return li;
            }

            const card = node.querySelector('.evi-card');
            card.dataset.id = item.id || '';
            card.dataset.anio = item.anioKey || '';
            card.dataset.estado = (item.estado || 'revision');
            card.dataset.url = item.url || '#';

            // Campos (¡ya no salen "—"!)
            node.querySelector('.name').textContent = item.nombre || extraerNombreDeRuta(item.url) || 'archivo';
            node.querySelector('.fecha').textContent = formatearFecha(item.fecha);
            node.querySelector('.autor').textContent = item.autor || '—';
            node.querySelector('.anio').textContent = `Año ${String(item.anioKey || 'año1').replace('año', '')}`;
            node.querySelector('.peso').textContent = item.peso || '—';
            node.querySelector('.tipo').textContent = item.formato || '—';

            // Icono + estado
            node.querySelector('.evi-icon i').className = iconoPorTipo(item.formato);
            const chip = node.querySelector('.chip-estado');
            chip.classList.add(estadoClase(item.estado));
            chip.textContent = (item.estado ? String(item.estado).replace('_', ' ') : 'En revisión');

            // Acciones
            node.querySelector('.btn-preview')?.addEventListener('click', () => { if (item.url) window.open(item.url, '_blank'); });
            node.querySelector('.btn-download')?.addEventListener('click', () => { if (item.url) window.location.href = item.url; });
            node.querySelector('.btn-copiar')?.addEventListener('click', async () => {
                if (!item.url) return;
                try { await navigator.clipboard.writeText(item.url); mostrarToast?.('Enlace copiado', 'success'); } catch { }
            });
            node.querySelector('.btn-detalles')?.addEventListener('click', () => { console.log('[Detalles evidencia]', item); /* abrirModalDetallesEvidencia?.(item) */ });

            return node;
        }
        /* ================== Utilidades visuales de ícono/estado ================== */
        function iconoPorTipo(ext = '') {
            const t = String(ext || '').toLowerCase();
            if (t.includes('pdf')) return 'fa-regular fa-file-pdf';
            if (t.includes('xls') || t.includes('sheet') || t.includes('csv')) return 'fa-regular fa-file-excel';
            if (t.includes('doc')) return 'fa-regular fa-file-word';
            if (t.includes('ppt')) return 'fa-regular fa-file-powerpoint';
            if (t.includes('zip') || t.includes('rar') || t.includes('7z')) return 'fa-regular fa-file-zipper';
            if (['png', 'jpg', 'jpeg', 'webp', 'gif', 'bmp'].some(s => t.includes(s))) return 'fa-regular fa-file-image';
            if (['mp4', 'mov', 'avi', 'mkv'].some(s => t.includes(s))) return 'fa-regular fa-file-video';
            return 'fa-regular fa-file-lines';
        }

        function estadoClase(e) {
            const map = { aprobado: 'aprobado', parcial: 'parcial', rechazado: 'rechazado', pendiente: 'pendiente', en_validacion: 'revision', revision: 'revision' };
            return map[String(e || '').toLowerCase()] || 'revision';
        }


        /* ========= Integración con tu flujo existente =========
           - abrirModalEvidencias() ya lo tienes. Solo necesita que existan:
             - agruparPorAnio, renderAllYears, prepararUrlsDescarga (definidas arriba)
             - evsState, YEARS, YEAR_IDS, setUltimaActualizacion
           - El resto de listeners que ya pegaste quedan igual.
        ======================================================== */

        /* ──────────────────────────────────────────────────────────────
           EDITAR EN CALIENTE: Evidencias (mueve RTDB + Storage al cambiar fecha)
           ────────────────────────────────────────────────────────────── */

        // Helpers de fecha/ciclo
        function parseDateFlex(v) {
            if (!v) return null;
            if (v instanceof Date) return isNaN(v) ? null : v;
            const s = String(v).trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T12:00:00'); // YYYY-MM-DD
            if (/^\d{2}-\d{2}-\d{4}$/.test(s)) { // DD-MM-YYYY
                const [dd, mm, yyyy] = s.split('-').map(n => +n);
                return new Date(yyyy, mm - 1, dd, 12, 0, 0);
            }
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }
        function formatForInput(d) {
            if (!(d instanceof Date) || isNaN(d)) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }
        function deriveCycleFromDate(d, base = BASE_ANIO_PLAN) {
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const sem = (m <= 6) ? 1 : 2;
            const anioKey = `año${Math.min(4, Math.max(1, (y - base) + 1))}`;
            return {
                rtdb: `${y}_${sem}`,    // RTDB usa guion_bajo
                storage: `${y}-${sem}`, // Storage usa guion
                anioKey
            };
        }

        // Encuentra el item en cache por id
        function getItemFromCacheById(id) {
            const cache = evsState.cache?.[evsState.key];
            return cache?.flatList?.find(x => String(x.id) === String(id)) || null;
        }

        // Inyecta botón Editar en la tarjeta (visible para admin-s-plan y responsable-s-plan)
        function attachEditButton(node, item) {
            const bar = node.querySelector('.evi-actions')
                || node.querySelector('.evi-card')
                || node;

            if (!bar.querySelector('.btn-edit-evi')) {
                const btn = document.createElement('button');
                btn.type = 'button';
                // 👇 esta clase hace que lo vean admin-s-plan **y** responsable-s-plan
                btn.className = 'btn btn-ghost btn-sm btn-ghost-gold btn-edit-evi admin-responsable-only';
                btn.innerHTML = '<i class="fa-regular fa-pen-to-square me-1"></i> Editar';
                bar.appendChild(btn);

                // aplicar visibilidad sólo a este card recién creado
                const cardScope = node.querySelector('.evi-card') || node;
                applyRoleVisibility(cardScope);
            }
        }

        // Editor UI (aireado) con permisos por rol
        function buildEditorHTML(item, card) {
            const isAdmin = !!window.esAdmin; // true = admin/admin-s-plan; false = responsable-s-plan/otros
            const fechaInputVal = (() => {
                const d = parseDateFlex(item.fecha) || new Date();
                return formatForInput(d);
            })();

            const dis = isAdmin ? '' : 'disabled';     // deshabilitar inputs para responsable
            const noteOnlyName = isAdmin ? '' : `
    <div class="alert alert-info py-2 px-3 my-2 text-white">
      <i class="fa-regular fa-lock me-1"></i>
      Solo puedes editar el <b>nombre del archivo</b>. La <b>fecha</b> y el <b>autor</b> están bloqueados por tu rol.
    </div>`;

            const wrap = document.createElement('section');
            wrap.className = 'evi-editor shadow-sm';
            wrap.innerHTML = `
    <div class="evi-editor-head d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <i class="fa-regular fa-pen-to-square"></i>
        <strong>Edición rápida de evidencia</strong>
        <span class="text-muted small">(${item.id || '—'})</span>
      </div>
      <button type="button" class="btn-close btn-cancel-evi" aria-label="Cerrar"></button>
    </div>

    <div class="evi-editor-body">
      ${noteOnlyName}
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label fw-semibold small">Nombre del archivo</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-regular fa-file-lines"></i></span>
            <input type="text" class="form-control inp-nombre" value="${(item.nombre || '').replace(/"/g, '&quot;')}" />
          </div>
        </div>

        <div class="col-md-5">
          <label class="form-label fw-semibold small">Autor</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-regular fa-user"></i></span>
            <input type="text" class="form-control inp-autor" ${dis} value="${(item.autor || '').replace(/"/g, '&quot;')}" />
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold small">Fecha</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-regular fa-calendar"></i></span>
            <input type="date" class="form-control inp-fecha" ${dis} value="${fechaInputVal}" />
          </div>
        </div>

        <div class="col-md-3 text-md-end">
          <div class="d-grid d-md-flex gap-2 mt-1 mt-md-4">
            <button type="button" class="btn btn-ghost  btn-ghost-primary btn-save-evi">
              <i class="fa-regular fa-floppy-disk me-1"></i> Guardar
            </button>
            <button type="button" class="btn btn-ghost  btn-ghost-danger btn-cancel-evi">Cancelar</button>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center mt-3 small text-muted">
        <span class="badge rounded-pill text-bg-light">
          Ciclo actual: <b>${item.ciclo || '—'}</b>
        </span>
        <span class="badge rounded-pill text-bg-light">
          Ciclo nuevo: <b class="preview-ciclo">—</b>
        </span>
        <span class="badge rounded-pill text-bg-light">
          Año: <b class="preview-anio">—</b>
        </span>
      </div>
    </div>
  `;

            // Live preview del ciclo/año al cambiar fecha (solo admin puede cambiar fecha)
            const fechaInput = wrap.querySelector('.inp-fecha');
            const prevCiclo = wrap.querySelector('.preview-ciclo');
            const prevAnio = wrap.querySelector('.preview-anio');
            const refreshPreview = () => {
                const d = parseDateFlex(fechaInput?.value);
                if (!d) { prevCiclo.textContent = '—'; prevAnio.textContent = '—'; return; }
                const { rtdb, anioKey } = deriveCycleFromDate(d);
                prevCiclo.textContent = rtdb;
                prevAnio.textContent = anioKey.replace('año', 'Año ');
            };
            if (fechaInput) fechaInput.addEventListener('input', refreshPreview);
            refreshPreview();

            return wrap;
        }

        /** Inserta el editor debajo del bloque de metadatos del card */
        function openInlineEditor(card, item) {
            card.querySelectorAll('.evi-editor')?.forEach(n => n.remove());
            const editorEl = buildEditorHTML(item, card);

            const metaRow =
                card.querySelector('.evi-meta') ||
                card.querySelector('.small.text-muted') ||
                card.querySelector('.meta-row');

            const titleEl = card.querySelector('h6, .evi-title');
            const body =
                card.querySelector('.evi-card-body') ||
                card.querySelector('.flex-grow-1') ||
                card;

            if (metaRow) metaRow.insertAdjacentElement('afterend', editorEl);
            else if (titleEl) titleEl.insertAdjacentElement('afterend', editorEl);
            else body.appendChild(editorEl);

            requestAnimationFrame(() => editorEl.classList.add('is-open'));

            editorEl.querySelectorAll('.btn-cancel-evi').forEach(b =>
                b.addEventListener('click', () => {
                    editorEl.classList.remove('is-open');
                    setTimeout(() => editorEl.remove(), 180);
                })
            );

            return editorEl;
        }

        // Entra/sale de modo edición
        function enterEditMode(card) {
            if (card.classList.contains('editing')) return;
            const id = card.dataset.id;
            const item = getItemFromCacheById(id);
            if (!item) return;
            openInlineEditor(card, item);
            card.classList.add('editing');
        }
        function exitEditMode(card) {
            card.querySelector('.evi-editor')?.remove();
            card.classList.remove('editing');
        }

        // Refresca el contenido del modal releyendo RTDB (misma meta/acción)
        async function refreshEvidenciasModal() {
            try {
                if (!evsState?.meta || !evsState?.accion) return;
                YEARS.forEach(k => {
                    const list = document.getElementById(`${YEAR_IDS[k]}-list`);
                    if (list) list.innerHTML = `<li class="list-group-item border-0 text-center text-muted py-3">
        <span class="spinner-border spinner-border-sm text-success me-2"></span>Actualizando…
      </li>`;
                });

                const evidenciasRootRef = ref(db, 'S-PLAN/evidencias');
                const snap = await get(evidenciasRootRef);

                const flat = [];
                let total = 0;
                if (snap.exists()) {
                    const ciclos = snap.val() || {};
                    for (const cicloKey in ciclos) {
                        const ciclo = ciclos[cicloKey] || {};
                        const nodoMeta = ciclo[evsState.meta];
                        if (nodoMeta && nodoMeta[evsState.accion]) {
                            const archivos = nodoMeta[evsState.accion];
                            const arr = flattenArchivos(archivos, cicloKey, evsState.meta, evsState.accion);
                            flat.push(...arr);
                            total += arr.length;
                        }
                    }
                }

                const porAnio = agruparPorAnio(flat);
                evsState.cache[evsState.key] = { porAnio, flatList: flat, total };

                renderAllYears();
                prepararUrlsDescarga();
                applyRoleVisibility(document.getElementById('evidenciasModal'));
            } catch (err) {
                console.error('[refreshEvidenciasModal] Error:', err);
            }
        }

        // Mueve nodo en RTDB (copy → delete) y actualiza campos
        async function moveAndUpdateRTDB({ oldCiclo, newCicloRTDB, item, fileIdBase, uploadId, newPayload }) {
            let oldPath = `S-PLAN/evidencias/${oldCiclo}/${item.meta}/${item.accion}/${fileIdBase}`;
            if (uploadId) oldPath += `/uploads/${uploadId}`;
            let newPath = `S-PLAN/evidencias/${newCicloRTDB}/${item.meta}/${item.accion}/${fileIdBase}`;
            if (uploadId) newPath += `/uploads/${uploadId}`;

            const srcSnap = await get(ref(db, oldPath));
            const data = srcSnap.exists() ? srcSnap.val() : {};
            const merged = { ...data, ...newPayload };

            await set(ref(db, newPath), merged);
            if (oldPath !== newPath) await remove(ref(db, oldPath));
            return { newPath };
        }

        // Mueve el archivo en Storage (copy bytes → upload → delete) y retorna nueva URL
        async function moveInStorageAndGetURL({ item, newCicloStorage, fileName }) {
            if (!item.url) return null;
            try {
                const oldRef = refFromURL(item.url); // https:// o gs://
                const bytes = await getBytes(oldRef);

                const destPath = `/PlanItOne/S-PLAN/evidencias/${newCicloStorage}/${item.meta}/${item.accion}/${fileName}`;
                const destRef = storageRef(storage, destPath);

                await uploadBytes(destRef, bytes); // deja que infiera contentType
                const newUrl = await getDownloadURL(destRef);

                try { await deleteObject(oldRef); } catch { }
                return newUrl;
            } catch (err) {
                console.warn('[Storage] No se pudo mover el archivo; se mantiene la URL anterior.', err);
                return null;
            }
        }

        // Guarda cambios del editor (respeta permisos de rol) + refresca modal
        async function saveEditFromCard(card) {
            const id = card.dataset.id;
            const fileIdBase = card.dataset.fileid || id;
            const uploadId = card.dataset.uploadid || '';

            const item = getItemFromCacheById(id);
            if (!item) return mostrarToast?.('No se encontró la evidencia en cache.', 'danger');

            const isAdmin = !!window.esAdmin;

            const nombreNew = card.querySelector('.inp-nombre')?.value?.trim() || item.nombre || '';

            // Bloquea botones mientras guarda
            const btnSave = card.querySelector('.btn-save-evi');
            const btnCancel = card.querySelector('.btn-cancel-evi');
            btnSave && (btnSave.disabled = true);
            btnCancel && (btnCancel.disabled = true);

            try {
                if (!isAdmin) {
                    // ── RESPONSABLE-S-PLAN: solo puede editar "nombre" (misma ruta; sin mover ciclo/storage)
                    let samePath = `S-PLAN/evidencias/${item.ciclo}/${item.meta}/${item.accion}/${fileIdBase}`;
                    if (uploadId) samePath += `/uploads/${uploadId}`;
                    await update(ref(db, samePath), { nombre: nombreNew });

                    // feedback y UI
                    mostrarToast?.('Nombre actualizado.', 'success');
                    exitEditMode(card);
                    await refreshEvidenciasModal();
                    return;
                }

                // ── ADMIN / ADMIN-S-PLAN: edición completa (autor/fecha + mover ciclo/Storage)
                const autorNew = card.querySelector('.inp-autor')?.value?.trim() || item.autor || '';
                const fechaStr = card.querySelector('.inp-fecha')?.value || '';
                const fechaDate = parseDateFlex(fechaStr) || new Date();
                const { rtdb: cicloNew, storage: cicloNewStorage, anioKey } = deriveCycleFromDate(fechaDate);

                const oldCiclo = item.ciclo;
                const isCycleChanged = String(oldCiclo) !== String(cicloNew);

                const newPayload = {
                    nombre: nombreNew,
                    autor: autorNew,
                    fecha: fechaStr || formatForInput(fechaDate),
                    anio: anioKey,
                    año: anioKey,
                    year: anioKey.replace('año', 'year'),
                    ciclo: cicloNew
                };

                let newUrl = null;

                if (isCycleChanged) {
                    await moveAndUpdateRTDB({
                        oldCiclo,
                        newCicloRTDB: cicloNew,
                        item,
                        fileIdBase,
                        uploadId,
                        newPayload
                    });

                    try {
                        const fileNameForStorage = extraerNombreDeRuta(item.url) || (nombreNew || 'archivo');
                        newUrl = await moveInStorageAndGetURL({
                            item,
                            newCicloStorage: cicloNewStorage,
                            fileName: fileNameForStorage
                        });
                        if (newUrl) {
                            let newPath = `S-PLAN/evidencias/${cicloNew}/${item.meta}/${item.accion}/${fileIdBase}`;
                            if (uploadId) newPath += `/uploads/${uploadId}`;
                            await update(ref(db, newPath), { url: newUrl });
                        }
                    } catch (errS) {
                        console.warn('[Storage] Error moviendo archivo:', errS);
                    }
                } else {
                    let samePath = `S-PLAN/evidencias/${oldCiclo}/${item.meta}/${item.accion}/${fileIdBase}`;
                    if (uploadId) samePath += `/uploads/${uploadId}`;
                    await update(ref(db, samePath), newPayload);
                }

                mostrarToast?.('Cambios guardados correctamente.', 'success');
                exitEditMode(card);
                await refreshEvidenciasModal();

            } catch (err) {
                console.error('[Editar evidencia] Error:', err);
                mostrarToast?.('No se pudieron guardar los cambios.', 'danger');
            } finally {
                btnSave && (btnSave.disabled = false);
                btnCancel && (btnCancel.disabled = false);
            }
        }

        /* ──────────────────────────────────────────────────────────────
           Integración con tu render: añade el botón Editar y data attrs
           ────────────────────────────────────────────────────────────── */
        /* ──────────────────────────────────────────────────────────────
    Hook de render: datasets + botón Editar + botón Eliminar
    ────────────────────────────────────────────────────────────── */
        if (typeof renderEviCard === 'function') {
            const _old_renderEviCard = renderEviCard;
            renderEviCard = function (item) {
                const node = _old_renderEviCard(item);
                const card = node.querySelector('.evi-card') || node;

                // datasets necesarios
                const idStr = String(item.id || '');
                const [fileIdBase, uploadId] = idStr.includes('__') ? idStr.split('__') : [idStr, ''];
                card.dataset.id = idStr;
                card.dataset.fileid = fileIdBase || idStr;
                card.dataset.uploadid = uploadId || '';
                card.dataset.ciclo = item.ciclo || '';
                card.dataset.meta = item.meta || '';
                card.dataset.accion = item.accion || '';

                // Botón EDITAR (admin-s-plan + responsable-s-plan)
                attachEditButton(node, item);

                // Quitar “Detalles” antiguo si existe
                node.querySelector('.btn-detalles')?.remove();

                // Botón ELIMINAR (solo admin-s-plan)
                const actionsBar =
                    node.querySelector('.evi-actions') ||
                    node.querySelector('.evi-card') ||
                    node;

                if (!actionsBar.querySelector('.btn-eliminar-evi')) {
                    const del = document.createElement('button');
                    del.type = 'button';
                    del.className = 'btn btn-ghost btn-ghost-danger btn-sm btn-eliminar-evi admin-s-plan';
                    del.title = 'Eliminar evidencia';
                    del.innerHTML = '<i class="fa-regular fa-trash-can me-1"></i> Eliminar';

                    // empaquetar datos para el handler
                    del.dataset.ciclo = item.ciclo || '';
                    del.dataset.meta = item.meta || '';
                    del.dataset.accion = item.accion || '';
                    del.dataset.id = idStr;
                    del.dataset.fileid = fileIdBase;
                    del.dataset.uploadid = uploadId;
                    del.dataset.url = item.url ? encodeURIComponent(item.url) : '';

                    actionsBar.appendChild(del);

                    // aplicar visibilidad por rol al card recién creado
                    const scope = node.querySelector('.evi-card') || node;
                    if (typeof applyRoleVisibility === 'function') applyRoleVisibility(scope);
                }

                return node;
            };
        }

        /* ──────────────────────────────────────────────────────────────
           Delegación de eventos: Editar / Guardar / Cancelar / Eliminar
           ────────────────────────────────────────────────────────────── */
        document.addEventListener('click', async (e) => {
            // Editar
            const editBtn = e.target.closest('.btn-edit-evi');
            if (editBtn) {
                const card = editBtn.closest('.evi-card') || editBtn.closest('li') || editBtn.closest('.card');
                if (card) enterEditMode(card);
                return;
            }

            // Guardar
            const saveBtn = e.target.closest('.btn-save-evi');
            if (saveBtn) {
                const card = saveBtn.closest('.evi-card') || saveBtn.closest('li') || saveBtn.closest('.card');
                if (card) saveEditFromCard(card);
                return;
            }

            // Cancelar
            const cancelBtn = e.target.closest('.btn-cancel-evi');
            if (cancelBtn) {
                const card = cancelBtn.closest('.evi-card') || cancelBtn.closest('li') || cancelBtn.closest('.card');
                if (card) exitEditMode(card);
                return;
            }

            // Eliminar (solo admin)
            const delBtn = e.target.closest('.btn-eliminar-evi');
            if (delBtn) {
                if (!window.esAdmin) { mostrarToast?.('Solo administradores.', 'warning'); return; }

                const ciclo = delBtn.dataset.ciclo;
                const meta = delBtn.dataset.meta;
                const accion = delBtn.dataset.accion;
                const fileId = delBtn.dataset.fileid;
                const uploadId = delBtn.dataset.uploadid;
                const url = delBtn.dataset.url ? decodeURIComponent(delBtn.dataset.url) : '';

                if (!ciclo || !meta || !accion || !fileId) {
                    console.warn('[Eliminar] Datos incompletos:', { ciclo, meta, accion, fileId, uploadId });
                    mostrarToast?.('No se puede eliminar: datos incompletos.', 'danger');
                    return;
                }

                const ok = await Swal.fire({
                    title: '¿Eliminar evidencia?',
                    text: 'Esta acción no se puede deshacer.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                });
                if (!ok.isConfirmed) return;

                // RTDB path
                let dbPath = `S-PLAN/evidencias/${ciclo}/${meta}/${accion}/${fileId}`;
                if (uploadId) dbPath += `/uploads/${uploadId}`;

                try {
                    // 1) Borra en RTDB
                    await remove(ref(db, dbPath));

                    // 2) (Opcional) borra en Storage si refFromURL está disponible
                    if (url && typeof refFromURL === 'function') {
                        try {
                            const sref = refFromURL(url);
                            await deleteObject(sref);
                        } catch (errS) {
                            console.warn('[Eliminar/Storage] No se pudo borrar el archivo:', errS);
                        }
                    }

                    mostrarToast?.('Evidencia eliminada.', 'success');

                    // 3) Quitar el elemento visual inmediato
                    delBtn.closest('li.list-group-item, .evi-card, .card')?.remove();

                    // 4) Refrescar el modal completo (relee RTDB)
                    if (typeof refreshEvidenciasModal === 'function') await refreshEvidenciasModal();
                } catch (err) {
                    console.error('[Eliminar] Error:', err);
                    mostrarToast?.('Error al eliminar la evidencia.', 'danger');
                }
            }
        });



        /* ──────────────────────────────────────────────────────────────
    ESTADO de evidencia (dropdown SOLO para admin) – colores para todos
    ────────────────────────────────────────────────────────────── */

        /* 1) Estilos seguros (overflow visible + z-index correcto + colores chip) */
        (function ensureEstadoStyles() {
            if (document.getElementById('evi-estado-styles')) return;
            const s = document.createElement('style');
            s.id = 'evi-estado-styles';
            s.textContent = `
  /* Evitar recortes en el modal */
  #evidenciasModal .modal-content,
  #evidenciasModal .modal-body,
  #evidenciasModal .tab-content,
  #evidenciasModal .tab-pane,
  #evidenciasModal .list-group,
  #evidenciasModal .list-group-item,
  #evidenciasModal .card,
  #evidenciasModal .evi-card{
    overflow: visible !important;
  }

  /* Elevar el card SOLO cuando el dropdown está abierto */
  #evidenciasModal .evi-card.dd-open{ z-index: 2004; position: relative; }

  /* Contenedor del control */
  #evidenciasModal .status-dd{ position: relative; }

  /* Botón (admin) */
  #evidenciasModal .status-dd .btn-status{
    border:0; border-radius:999px; padding:.35rem .8rem;
    font-weight:700; line-height:1.1; color:#fff;
  }
  #evidenciasModal .status-dd .btn-status[disabled]{ opacity:.6; cursor:not-allowed; }

  /* Colores del botón admin */
  #evidenciasModal .status-dd .btn-status.st-aprobado{  background:#16a34a; }
  #evidenciasModal .status-dd .btn-status.st-parcial{    background:#b5a160; color:#1e293b; }
  #evidenciasModal .status-dd .btn-status.st-rechazado{  background:#dc2626; }
  #evidenciasModal .status-dd .btn-status.st-revision{   background:#1f3a8a; }

  /* Menú por encima de todo dentro del modal */
  #evidenciasModal .status-dd .dropdown-menu{
    z-index: 3000;              /* > card y dentro del modal */
    min-width: 220px;
    border-radius: 12px;
    border: 1px solid #e6eaf0;
  }

  /* Chip (no-admin) */
  #evidenciasModal .chip-estado{
    border-radius:999px;
    padding:.28rem .65rem;
    font-weight:700;
    border:1px solid transparent;
    display:inline-flex; align-items:center; gap:.35rem;
  }
  #evidenciasModal .chip-estado.aprobado  { background:#dcfce7; color:#166534; border-color:#86efac; }
  #evidenciasModal .chip-estado.parcial   { background:#f5f1df; color:#8a7824; border-color:#e0d7a0; }
  #evidenciasModal .chip-estado.rechazado { background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
  #evidenciasModal .chip-estado.revision  { background:#e0e7ff; color:#1f3a8a; border-color:#c7d2fe; }
  `;
            document.head.appendChild(s);
        })();

        /* 2) Mapeo de estados y helpers */
        const ESTADOS_META = [
            { key: 'aprobado', label: 'Aprobado', btn: 'st-aprobado', chip: 'aprobado' },
            { key: 'parcial', label: 'Entrega parcial', btn: 'st-parcial', chip: 'parcial' },
            { key: 'rechazado', label: 'Rechazado', btn: 'st-rechazado', chip: 'rechazado' },
            { key: 'en_validacion', label: 'En revisión', btn: 'st-revision', chip: 'revision' },
        ];
        const estadoFind = (k) => ESTADOS_META.find(e => e.key === String(k || '').toLowerCase()) || ESTADOS_META[3];
        const estadoLabel = (k) => estadoFind(k).label;

        /* 3) Construye/reemplaza el control en una tarjeta (dropdown si admin, chip si no) */
        function installEstadoDropdown(node, item) {
            // En tu template existe <span class="chip-estado">…</span>
            const holder = node.querySelector('.chip-estado');
            if (!holder) return;

            // Limpia cualquier contenido previo
            holder.className = 'chip-estado';
            holder.textContent = '';

            const e = estadoFind(item.estado);

            if (window.esAdmin) {
                const dd = document.createElement('div');
                dd.className = 'dropdown status-dd';
                dd.innerHTML = `
      <button class="btn btn-status ${e.btn} dropdown-toggle" type="button"
              data-bs-toggle="dropdown" data-bs-boundary="viewport" data-bs-offset="0,8"
              aria-expanded="false" title="Cambiar estado">${e.label}</button>
      <ul class="dropdown-menu">
        ${ESTADOS_META.map(x => `<li><button type="button" class="dropdown-item" data-status="${x.key}">${x.label}</button></li>`).join('')}
      </ul>`;
                holder.replaceWith(dd);
            } else {
                holder.classList.add(e.chip);
                holder.textContent = e.label;
            }
        }

        /* 4) Actualiza color/label del botón del dropdown (tras cambiar estado) */
        function updateEstadoButtonUI(ddWrap, key) {
            const btn = ddWrap.querySelector('.btn-status');
            const e = estadoFind(key);
            btn.textContent = e.label;
            btn.classList.remove('st-aprobado', 'st-parcial', 'st-rechazado', 'st-revision');
            btn.classList.add(e.btn);
        }

        /* 5) Si roles cambian en caliente, degrada cualquier dropdown a chip para no-admin */
        function lockStatusDropdownForNonAdmins(scope = document) {
            if (window.esAdmin) return;
            scope.querySelectorAll('.status-dd').forEach(dd => {
                const txt = (dd.querySelector('.btn-status')?.textContent || '').trim().toLowerCase();
                const key = txt.includes('aprobado') ? 'aprobado'
                    : txt.includes('parcial') ? 'parcial'
                        : txt.includes('rechazado') ? 'rechazado'
                            : 'en_validacion';
                const chip = document.createElement('span');
                chip.className = `chip-estado ${estadoFind(key).chip}`;
                chip.textContent = estadoLabel(key);
                dd.replaceWith(chip);
            });
        }
        document.addEventListener('roles:ready', () => lockStatusDropdownForNonAdmins(document));

        /* 6) Elevar/bajar el card mientras abre/cierra el dropdown (evita recortes) */
        document.addEventListener('show.bs.dropdown', ev => {
            const btn = ev.target.closest('.btn-status'); if (!btn) return;
            const card = btn.closest('.evi-card') || btn.closest('li'); if (card) card.classList.add('dd-open');
        });
        document.addEventListener('hidden.bs.dropdown', ev => {
            const btn = ev.target.closest('.btn-status'); if (!btn) return;
            const card = btn.closest('.evi-card') || btn.closest('li'); if (card) card.classList.remove('dd-open');
        });

        /* 7) Persistencia en RTDB al elegir estado (solo admin) + UI inline */
        document.addEventListener('click', async (e) => {
            const opt = e.target.closest('.status-dd .dropdown-item');
            if (!opt) return;
            e.preventDefault();

            if (!window.esAdmin) return;

            const newStatus = opt.getAttribute('data-status');
            const dd = opt.closest('.status-dd');
            const card = dd.closest('.evi-card') || dd.closest('li') || dd;
            const idStr = card?.dataset?.id || '';
            const [fileIdBase, uploadId] = idStr.includes('__') ? idStr.split('__') : [idStr, ''];

            const item = getItemFromCacheById(idStr);
            if (!item) return;

            let path = `S-PLAN/evidencias/${item.ciclo}/${item.meta}/${item.accion}/${fileIdBase}`;
            if (uploadId) path += `/uploads/${uploadId}`;

            try {
                await update(ref(db), { [path + '/estado']: newStatus });
                item.estado = newStatus;            // cache
                updateEstadoButtonUI(dd, newStatus);
                mostrarToast?.('Estado actualizado.', 'success');
            } catch (err) {
                console.error('[Estado] Error actualizando:', err);
                mostrarToast?.('No se pudo actualizar el estado.', 'danger');
            }
        });

        /* 8) Hook de render: instala el control y asegura permisos/colores visibles */
        if (typeof renderEviCard === 'function') {
            const __prevRenderEviCard = renderEviCard;
            renderEviCard = function (item) {
                const node = __prevRenderEviCard(item);

                // Instalar dropdown o chip según rol
                installEstadoDropdown(node, item);

                // Si aún no estaban listos los roles, aseguramos visual para no-admin
                lockStatusDropdownForNonAdmins(node);

                return node;
            };
        }



        /* Opcional: expón funciones si usas módulos */
        window.__EVS__ = {
            renderAllYears, renderYearList, agruparPorAnio, flattenArchivos, prepararUrlsDescarga,
            setUltimaActualizacion
        };

    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Github buttons -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="../assets/js/argon-dashboard.min.js?v=2.0.4"></script>
</body>
<style>
    .meter {
        position: relative;
        height: 16px;
        background: linear-gradient(180deg, #f3f5f7, #eef2f3);
        border-radius: 999px;
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, .08);
    }

    .meter-fill {
        position: absolute;
        inset: 0 auto 0 0;
        width: var(--val, 0%);
        background: var(--fill, #00594e);

        background-size: 16px 100%, 100% 100%;
        transition: width .45s ease;
    }

    .meter.over .meter-fill {
        border-right: 1px solid rgba(0, 0, 0, .08);
    }

    /* Parte que muestra el sobre-cumplimiento (más allá de 100%) */
    .meter-over {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 100%;
        transform: translateX(-100%);
        width: var(--over, 0%);
        background: repeating-linear-gradient(45deg,
                #B5A160 0 10px,
                #d7c79a 10px 20px);
    }

    /* Marcas */
    .meter-tick {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(0, 0, 0, .09);
    }

    .meter .tick-25 {
        left: 25%;
    }

    .meter .tick-50 {
        left: 50%;
    }

    .meter .tick-75 {
        left: 75%;
    }

    .meter .tick-100 {
        left: 100%;
        width: 3px;
        background: #B5A160;
    }

    .meter-label {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: .72rem;
        color: #213;
        font-weight: 600;
        pointer-events: none;
        text-shadow: 0 1px 0 rgba(255, 255, 255, .6);
    }


    /* Estilo para las filas de la tabla */
    #tablaPoliticas tr {
        cursor: pointer;
        /* Cambia el cursor a pointer cuando se pasa sobre la fila */
    }

    /* Cambia el color de fondo de la fila al pasar el cursor */
    #tablaPoliticas tr:hover {
        background-color: hsla(214, 83%, 48%, 0.233);
        /* Color verde oscuro al pasar el cursor */
        color: #000;
        font-weight: 500;
        /* Opcional: cambia el color del texto al blanco para mejor contraste */
    }

    #tablaPoliticas2 tr:hover {
        background-color: hsla(173, 100%, 17%, 0.233);
        /* Color verde oscuro al pasar el cursor */
        color: #ffffff;
        /* Opcional: cambia el color del texto al blanco para mejor contraste */
    }
</style>

<style>
    /* Paleta */
    .crono {
        --on: #00594e;
        --on-600: #00463e;
        --off: #eef2f4;
        --bd: #d7dde3;
    }

    /* Tabs */
    .crono .year-tab {
        padding: .2rem .6rem;
        border-radius: 999px;
        border: 1px solid var(--bd);
        background: #fff;
        font-weight: 600;
        font-size: .8rem;
        cursor: pointer;
        transition: background .15s ease, color .15s ease, border-color .15s ease;
    }

    .crono .year-tab:not(.active):hover {
        background: #f1f5f9;
    }

    .crono .year-tab.active {
        background: var(--on);
        color: #fff;
        border-color: var(--on);
    }

    /* Grid meses */
    .crono .grid {
        display: grid;
        grid-template-columns: repeat(12, minmax(28px, 1fr));
        gap: 6px;
    }

    /* Celdas */
    .crono .cell {
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: .78rem;
        border-radius: 6px;
        background: var(--off);
        border: 1px solid var(--bd);
        user-select: none;
        transition: all .15s ease;
    }

    /* Hover solo si NO es readonly */
    .crono .cell:not(.readonly) {
        cursor: pointer;
    }

    .crono .cell:not(.readonly):hover {
        box-shadow: 0 0 0 2px var(--on) inset;
        transform: translateY(-1px);
    }

    /* Marcado */
    .crono .cell.on {
        background: var(--on);
        color: #fff;
        border-color: var(--on);
    }

    .crono .cell.on:not(.readonly):hover {
        background: var(--on-600);
    }

    /* Readonly: NO pointer-events:none; para que llegue el click y lo filtre el JS */
    .crono .cell.readonly {
        opacity: .6;
        cursor: not-allowed;
    }

    /* Leyenda */
    .crono .legend {
        font-size: .75rem;
        color: #667085;
        margin-top: .25rem;
    }

    .crono .legend .sw {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid var(--bd);
        vertical-align: middle;
        margin-right: 6px;
    }

    .crono .legend .sw.on {
        background: var(--on);
        border-color: var(--on);
    }

    /* Accesibilidad teclado */
    .crono .cell:focus-visible {
        outline: 2px solid var(--on);
        outline-offset: 2px;
    }

    /* Responsive: 6 columnas en tablet, 4 en móvil */
    @media (max-width: 992px) {
        .crono .grid {
            grid-template-columns: repeat(6, minmax(30px, 1fr));
        }
    }

    @media (max-width: 576px) {
        .crono .grid {
            grid-template-columns: repeat(4, minmax(36px, 1fr));
        }

        .crono .cell {
            height: 36px;
            font-size: .9rem;
        }
    }

    .evi-editor {
        background: #f8fafb;
        border: 1px dashed rgba(181, 161, 96, .6);
        border-radius: 14px;
        padding: 12px;
        margin-top: 12px;
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height .18s ease, opacity .18s ease, transform .18s ease;
        transform: translateY(-4px);
        width: 90vh;
    }

    .evi-editor.is-open {
        max-height: 420px;
        opacity: 1;
        transform: translateY(0);
    }

    .evi-editor-head {
        padding: 6px 6px 2px 6px;
        border-bottom: 1px solid rgba(0, 0, 0, .06);
        margin-bottom: 10px;
    }

    .evi-editor-body {
        padding: 2px 6px 6px 6px;
    }

    .evi-editor .input-group-text {
        background: #fff;
    }
</style>


<style id="evi-dropdown-fix">
    /* No generes stacking context en el contenedor */
    #evidenciasModal .evi-title .status-dd {
        position: relative;
        z-index: auto !important;
        /* <- quitamos el z-index */
    }

    /* El que debe estar por encima es EL MENÚ */
    #evidenciasModal .status-dd .dropdown-menu {
        z-index: 3000 !important;
        /* mayor que modal/cards */
        min-width: 220px;
        border-radius: 12px;
        border: 1px solid #e6eaf0;
    }

    /* Evitar recortes en ancestros */
    #evidenciasModal .evi-card,
    #evidenciasModal .list-group,
    #evidenciasModal .tab-pane {
        overflow: visible !important;
    }

    /* Fila del título: que no recorte el menú */
    #evidenciasModal .evi-title {
        display: flex;
        align-items: center;
        gap: .5rem;
        overflow: visible !important;
        position: relative;
    }

    #evidenciasModal .evi-title .name {
        min-width: 0;
        flex: 1 1 auto;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Wrapper del dropdown y su menú por encima del resto */
    #evidenciasModal .evi-title .status-dd {
        flex: 0 0 auto;
        position: relative;
        z-index: 2006;
    }

    #evidenciasModal .status-dd .dropdown-menu {
        z-index: 2007;
        min-width: 220px;
        border-radius: 12px;
        border: 1px solid #e6eaf0;
    }

    /* Eleva la tarjeta mientras el menú está abierto */
    #evidenciasModal .evi-card.dd-open {
        position: relative;
        z-index: 2004;
        overflow: visible !important;
    }

    /* Botón de estado (píldora) */
    #evidenciasModal .btn-status {
        border: 0;
        border-radius: 999px;
        padding: .35rem .9rem;
        font-weight: 700;
        line-height: 1.1;
    }

    /* Colores por estado */
    #evidenciasModal .btn-status.st-aprobado {
        background: #16a34a;
        color: #fff;
    }

    #evidenciasModal .btn-status.st-parcial {
        background: #b08900;
        color: #fff;
    }

    #evidenciasModal .btn-status.st-rechazado {
        background: #dc2626;
        color: #fff;
    }

    #evidenciasModal .btn-status.st-revision {
        background: #1e3a8a;
        color: #fff;
    }

    /* Deshabilitado para no-admin (por si lo ves en otra vista) */
    #evidenciasModal .btn-status[disabled] {
        opacity: .6;
        cursor: not-allowed;
    }
</style>



</html>