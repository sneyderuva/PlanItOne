<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/polariscore/icono.png">
  <title>
    Acciones e Indicadores
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/aa4ade8d2d.js" crossorigin="anonymous"></script>
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
</head>

<body class="g-sidenav-show   bg-gray-100">
  <div class="min-height-300 position-absolute w-100"
    style="background: url('../assets/img/polariscore/bg-gradient.png') no-repeat center center/cover;">
  </div>
  <aside
    class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4"
    id="sidenav-main" style="z-index:1040;">
    <div class="sidenav-header mb-3">
      <a class="navbar-brand m-0 d-flex flex-column align-items-center" href="../index.html">
        <!-- Logo institucional Argon -->
        <img src="../assets/img/polariscore/logo.png" class="navbar-brand-img mb-0" style="max-height:60px;"
          alt="main_logo">

      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <!-- INICIO -->

        <li class="nav-item ">
          <a class="nav-link d-flex align-items-center gap-2" href="index.html">
            <i class="fa-solid fa-home text-muted"></i>
            <span class="nav-link-text">Inicio</span>
          </a>

        </li>

        <!-- Políticas -->
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2" href="#" data-bs-toggle="collapse"
            data-bs-target="#submenuPoliticas" aria-expanded="false">
            <i class="fa-solid fa-landmark text-success"></i>
            <span class="nav-link-text">Políticas</span>
          </a>
          <ul class="collapse list-unstyled ms-4" id="submenuPoliticas">
            <li><a class="nav-link " href="../polariscore/dashboard.html"><i
                  class="fa-solid fa-chart-pie text-success"></i> Análisis General</a></li>
            <li><a class="nav-link" href="../polariscore/politicas.html"><i
                  class="fa-solid fa-list-ul text-primary"></i> Lista de Políticas</a></li>
            <li class="admin-responsable-only" style="display: none;"><a class="nav-link"
                href="../polariscore/politicas.html?t="><i class="fa-regular fa-folder-open text-info"></i> Mis
                Políticas</a></li>
            <li><a class="nav-link" href="../polariscore/observaciones.html"><i
                  class="fa-regular fa-comment-dots text-info"></i> Observaciones</a></li>
          </ul>
        </li>

        <!-- Seleccionar Política -->
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2" href="#" data-bs-toggle="collapse"
            data-bs-target="#cargarPoliticas" aria-expanded="true">
            <i class="fa-solid fa-gavel text-warning"></i>
            <span class="nav-link-text">Seleccionar política</span>
          </a>
          <ul class="collapse show list-unstyled ms-4" id="cargarPoliticas"></ul>
        </li>

        <!-- Otras Apps -->
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2 collapsed" href="#" data-bs-toggle="collapse"
            data-bs-target="#submenuPdi" aria-expanded="false">
            <i class="fa-solid fa-rocket text-danger"></i>
            <span class="nav-link-text">Otras Apps</span>
          </a>
          <ul class="collapse list-unstyled ms-4" id="submenuPdi">
            <li>
              <a class="nav-link" href="https://sigunitropico.com" target="_blank">
                <i class="fa-solid fa-globe text-danger"></i> SIG Unitrópico
              </a>
            </li>
            <li>
              <a class="nav-link" href="https://sigunitropico.com/planeacion" target="_blank">
                <i class="fa-solid fa-chart-line text-info"></i> Planeación
              </a>
            </li>
          </ul>
        </li>

        <!-- Admin (solo visible para admins) -->
        <li class="nav-item mt-3 admin-only admin-polariscore" style="display: none;">
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Administración</h6>
        </li>
        <li class="nav-item admin-only admin-polariscore" style="display: none;">
          <a class="nav-link d-flex align-items-center gap-2" href="../pages/usuarios.html" target="_blank">
            <i class="fa-solid fa-users text-danger"></i>
            <span class="nav-link-text">Usuarios</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Login/Logout Aside: centrado y sin overlap -->
    <div class="sidenav-footer w-100 text-center mt-auto pb-3">

      <div class="card card-plain shadow-none mb-2" id="sidenavCard">
        <img class="w-80 mx-auto" src="../assets/img/illustrations/logo-simbolo-unitropico-1.png"
          alt="sidebar_illustration">
        <div class="card-body text-center p-2 w-100 pt-0">
          <div class="docs-info">
            <h6 class="mb-0">¿Necesitas ayuda?</h6>
            <p class="text-xs font-weight-bold mb-0">Por favor revisa nuestras guías</p>
          </div>
        </div>
      </div>
      <div id="asideAuthBtn" class="mb-2 d-flex flex-column align-items-center"></div>
      <a href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard" target="_blank"
        class="btn btn-dark btn-sm w-70 mb-2"><i class="fa-solid fa-book me-2"></i>Manual de uso</a>
      <a class="btn btn-primary btn-sm w-70 mb-0" href="mailto:innovacionplaneacion@unitropico.edu.co" type="button">
        <i class="fa-solid fa-envelope me-2"></i> Soporte técnico
      </a>

    </div>
  </aside>
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->

    <style>
      @media (max-width: 768px) {
        .ocultar {
          display: none !important;
        }

        .margin-top-5 {
          margin-top: 5%;
        }

        .resaltar {
          background-color: #00594e;
          border-radius: 0px;
          margin: 0px auto !important;
        }

        .fecha_actualizacion {
          font-size: 0.9rem;
          color: #fff;

        }

        .ocultarPc {
          display: block;
        }
      }

      @media (min-width: 1200px) {
        .ocultarPc {
          display: none;
        }
      }
    </style>
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl resaltar" id="navbarBlur"
      data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm ocultar"><a class="opacity-5 text-white "
                href="politicas.html">Políticas</a></li>
            <li class="breadcrumb-item text-sm ocultar"><a class="opacity-5 text-white fecha_actualizacion"
                href="politicas.html" id="namePolitica">Política</a></li>
            <li class="breadcrumb-item text-sm text-white active ocultar" id="idName" aria-current="page"> IAP-000</li>

          </ol>
          <li class="breadcrumb-item text-sm text-white active ocultarPc" onclick="history.back()" aria-current="page">
            <i class="fa-solid fa-angle-left"></i> Volver
          </li>
          <h6 class="font-weight-bolder text-white mb-0 ocultar">Detalles de la Acción</h6>
        </nav>
        <div class="ms-md-auto pe-md-3 d-flex align-items-center">

        </div>


        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">

          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-2 d-flex align-items-center">
              <a class="nav-link text-white p-0" id="documentosBtn" title="Ver Documentos" href="#"
                data-bs-toggle="modal" data-bs-target="#DocumentosModal">
                <i class="fa-solid fa-folder-open cursor-pointer"></i>
              </a>
            </li>
            <li class="nav-item pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>

            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="dropdownMenuButton" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fa fa-bell cursor-pointer"></i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New message</span> from Laur
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          13 minutes ago
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/small-logos/logo-spotify.svg"
                          class="avatar avatar-sm bg-gradient-dark  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New album</span> by Travis Scott
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          1 day
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background"
                                    d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z"
                                    opacity="0.593633743"></path>
                                  <path class="color-background"
                                    d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z">
                                  </path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          Payment successfully completed
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          2 days
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <div id="perfilUsuario" class="d-flex align-items-center gap-2" data-bs-toggle="dropdown" role="button"
                aria-expanded="false">
                <img id="imgPerfilUsuario" src="https://ui-avatars.com/api/?name=Usuario" alt="Foto"
                  class="rounded-circle border" width="40" height="40" style="object-fit:cover;">
              </div>
              <ul class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4" aria-labelledby="perfilUsuario">
                <li>
                  <a class="dropdown-item border-radius-md" href="../pages/profile.html">
                    <div class="d-flex py-1 align-items-center">
                      <div class="my-auto">
                        <img id="imgPerfilUsuarioDropdown" src="https://ui-avatars.com/api/?name=Usuario"
                          class="avatar avatar-sm me-3 rounded-circle border" style="object-fit:cover;">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm text-dark fw-bold" id="nombrePerfilUsuario"> Usuario</h6>
                        <small class="text-xs text-muted mb-0" id="correoPerfilUsuario"> Correo</small>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" id="rolesUsuario">
                    <i class="fas fa-user-circle text-primary me-2"></i> Usuario
                  </a>
                </li>
                <li>
                  <button id="logButton" class="dropdown-item border-radius-md text-danger d-flex align-items-center">
                    <span><i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar sesión</span>
                  </button>
                  <style>
                    /* Soluciona contraste para botón rojo dentro de dropdown Bootstrap */
                    #logButton.dropdown-item.text-danger:hover,
                    #logButton.dropdown-item.text-danger:focus {
                      background-color: #dc3545 !important;
                      /* danger */
                      color: #fff !important;
                      /* blanco */
                      border-radius: .5rem;
                    }

                    #logButton.dropdown-item.text-danger:hover i,
                    #logButton.dropdown-item.text-danger:focus i {
                      color: #fff !important;
                    }
                  </style>
                </li>
              </ul>
            </li>


          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->

    <!----------------- INICIO del contenido --------------->


    <div class="container-fluid py-4">
      <div class="row mb-4 gx-3">
        <div class="col-lg-12">
          <h3 class="text-center text-uppercase font-weight-bold mb-3 text-white">
            Seguimiento de Cumplimiento de la Acción
          </h3>
        </div>
      </div>

      <!-- Sección de detalles generales -->
      <div class="row text-center mb-4 gx-3">
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Política</h6>
              <h4 class="font-weight-bolder" id="titulo_politica" style="line-height: 98%;">Cargando...</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Objetivo General</h6>
              <p id="objetivo_general" class="mb-0">Cargando...</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Indicador</h6>
              <p id="indicador_politica" class="mb-0">Cargando...</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Fecha de Inicio</h6>
              <p id="fecha_inicio" class="mb-0">Cargando...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de gráficas -->
      <div class="row text-center mb-3 gx-3">
        <div class="col-md-8 mb-2">
          <div class="card shadow-sm ">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="text-uppercase text-muted mb-2 text-center w-100">Cumplimiento por años Programado vs
                  Ejecutado</h6>


              </div>
              <div id="grafica_tiempo" style="width: 100%; max-height: 400px;"></div>
            </div>

            <!-- Estilos para los botones -->
            <style>
              .btn-export {
                background: none;
                border: none;
                color: #adb5bd;
                /* Gris claro */
                font-size: 18px;
              }

              .btn-export:hover {
                color: #6c757d;
                /* Gris oscuro */
              }
            </style>

          </div>
        </div>
        <div class="col-md-4 mb-3" id="exportarGraficaAccion">
          <div class="card shadow-sm h-100" style="cursor: pointer;">
            <div class="card-body">

              <!-- Cabecera con botón a la derecha -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="text-center w-100">
                  <h6 class="text-uppercase text-muted mb-1">Cumplimiento de la acción</h6>
                  <p class="mb-0">Gráfica de cumplimiento total de la acción</p>
                </div>

                <!-- Botón para Exportar Imagen -->
                <div class="ms-auto">
                  <button onclick="exportarElementoComoImagen('exportarGraficaAccion', 'cumplimiento_total_accion.png')"
                    class="btn-export">
                    <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" fill="currentColor"
                      class="bi bi-download" viewBox="0 0 16 16">
                      <path
                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5" />
                      <path
                        d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Contenedor de la gráfica -->
              <div id="grafica_cumplimiento" style="max-height: 400px;" class="text-center"
                onclick="abrirEvaluarModal('${evidenciaId}')">
                <svg viewBox="0 0 100 160"
                  style="width: 100%; height: auto; max-width: 150px; margin: 0 auto; display: block;">
                  <image class="stat-svg" href="../assets/img/stat.svg" x="0" y="0" width="100" height="160"
                    opacity="0.6" />
                  <defs>
                    <clipPath id="clip-overlay">
                      <rect id="clip-rect" x="0" y="0" width="100" height="400" />
                    </clipPath>
                    <filter id="colorFilter" x="0" y="0" width="100%" height="100%">
                      <feColorMatrix id="matrix" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1 0" />
                    </filter>
                  </defs>
                  <image class="stat-svg" id="overlay" href="../assets/img/stat1.svg" x="0" y="0" width="100"
                    height="160" clip-path="url(#clip-overlay)" />
                </svg>
                <p id="porcentaje" style="font-weight: bold;">0%</p>
              </div>

            </div>
          </div>

        </div>
      </div>



      <!-- Sección de acción y resumen -->
      <div class="row text-center mb-2 gx-3">
        <div class="col-md-8 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-gradient-success text-white text-uppercase font-weight-bold">
              Detalles de la Acción
            </div>
            <div class="card-body" id="detalle_politica">
              Cargando detalles...
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-gradient-secondary text-white text-uppercase font-weight-bold">
              Resumen de Evaluación
            </div>
            <div class="card-body" id="resumen_politica">
              Cargando resumen...
            </div>
          </div>
        </div>
      </div>

      <!-- Bloque visual del indicador de la acción -->
      <div class="row mt-4 gx-3 admin-only admin-polariscore-only responsable-polariscore-only" style="display: none;"
        id="containerIndicador">
        <div class="col-lg-12">
          <div class="card shadow-sm">
            <div class="card-header bg-gradient-success text-white text-uppercase font-weight-bold">
              <i class="fa-solid fa-chart-line me-2"></i>
              Desglose del Indicador <small class="text-white-50">(Visible solo para responsables y
                administradores)</small>
            </div>
            <div class="card-body pb-3 pt-3">
              <h2>Proyección</h2>
              <!-- Aquí se renderiza visualmente el indicador -->
              <div id="indicadorVisual" class="w-100 mb-4"></div>
              <div class="d-flex gap-2 align-items-center mb-4 admin-responsable-polariscore">
                <button
                  class="btn btn-outline-success fw-semibold rounded-pill shadow-sm px-4 py-2 admin-responsable-only"
                  style="display: none;" id="btnCrearIndicador">
                  <i class="fa-solid fa-plus me-2"></i> Crear indicador
                </button>
                <button
                  class="btn btn-outline-danger fw-semibold rounded-pill shadow-sm px-4 py-2 admin-responsable-only"
                  style="display: none;" id="btnEliminarIndicador">
                  <i class="fa-solid fa-trash me-2"></i> Eliminar indicador
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Sección de tabla (visible solo para responsables y admins) -->
      <div class="row mt-4 gx-3 admin-only admin-polariscore-only responsable-polariscore-only" style="display: none;">
        <div class="col-lg-12">
          <div class="card shadow-sm">
            <div class="card-header bg-gradient-success text-white text-uppercase font-weight-bold">
              Documentos y Evidencias <small>(Visible solo para responsables y administradores)</small>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover table-bordered text-center" id="tabla_cumplimiento">
                  <thead class="bg-light">
                    <tr>
                      <th>Evidencia</th>
                      <th>Responsables</th>
                      <th>Formatos permitidos</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="4">Cargando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- Botón para abrir el modal -->
              <div class="text-start admin-only admin-polariscore-only" style="display: none;">
                <button type="button" class="btn btn-outline-success btn-sm me-2" data-bs-toggle="modal"
                  data-bs-target="#modalAgregarEvidencia">
                  <i class="fa-solid fa-plus"></i> Añadir Evidencia
                </button>
                <button class="btn btn-outline-info btn-sm me-2" title="Evaluar"
                  onclick="abrirEvaluarModal('${evidenciaId}')">
                  <i class="fa-solid fa-file-pen"></i> Evaluar Acción
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div class="d-flex gap-2 align-items-center mb-3 admin-responsable-polariscore"
        style="margin-top: 2%; display: none;">
        <button class="btn btn-outline-secondary fw-semibold rounded-pill shadow-sm px-4 py-2" onclick="history.back()">
          <i class="fa-solid fa-arrow-left me-2"></i> Volver atrás
        </button>

      </div>

    </div>
    <!--- FIN del contenido --->

    <!-- Modal Crear Indicador -->
    <div class="modal fade" id="modalCrearIndicador" tabindex="-1" aria-labelledby="labelModalCrearIndicador"
      aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <form class="modal-content" id="formCrearIndicador">
          <div class="modal-header">
            <h5 class="modal-title" id="labelModalCrearIndicador">
              <i class="fas fa-chart-line me-2"></i> Crear indicador de acción
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- 1. Selección tipo indicador -->
            <div class="mb-3">
              <label class="form-label fw-bold">Tipo de indicador</label>
              <select id="tipoIndicador" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="hitos">Hitos</option>
                <option value="cumplimiento">Cumplimiento</option>
                <option value="productos">Productos</option>
              </select>
            </div>
            <!-- 2. Si es hitos: agregar hitos -->
            <div id="bloqueHitos" class="mb-3" style="display:none;">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="fw-semibold text-success">Hitos de la acción</span>
                <button type="button" class="btn btn-outline-success btn-sm rounded-pill px-3 py-1" id="btnAgregarHito">
                  <i class="fa fa-plus me-1"></i> Agregar hito
                </button>
              </div>
              <div id="listaHitos"></div>
            </div>
            <!-- 3. Tipo de métrica -->
            <div class="mb-3">
              <label class="form-label fw-bold">Tipo de métrica</label>
              <select id="tipoMetrica" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="acumulado">Acumulado</option>
                <option value="flujo">Flujo</option>
              </select>
              <small id="acumuladoAyuda" class="text-muted" style="display:none;">
                <i class="fa fa-info-circle"></i> La suma de la programación por año no puede superar el 100%.
              </small>
            </div>
            <!-- 4. Descripción del indicador -->
            <div class="mb-3">
              <label class="form-label fw-bold">Descripción del indicador</label>
              <textarea class="form-control" id="descripcionIndicador" required></textarea>
            </div>
            <!-- 5. Programación por año -->
            <div class="mb-3">
              <label class="form-label fw-bold">Programación de cumplimiento anual (%) del indicador</label>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0" id="tablaProgramacionAnios">
                  <thead class="table-light">
                    <tr>
                      <th>Año</th>
                      <th>Programado (%)</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyProgramacionAnios"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary px-4" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-success px-4 fw-semibold" type="submit">
              <i class="fa fa-save me-1"></i> Guardar indicador
            </button>
          </div>
        </form>
      </div>
    </div>



    <footer class="footer pt-3  ">
      <div class="container-fluid">
        <div class="row align-items-center justify-content-lg-between">
          <div class="col-lg-6 mb-lg-0 mb-4">
            <div class="copyright text-center text-sm text-muted text-lg-start">
              ©
              <script>
                document.write(new Date().getFullYear())
              </script>,
              desarrollado por la <a style="font-weight: 600; color: #00584e;"
                href="https://sigunitropico.com/planeacion-estrategica">Oficina Asesora de Planeación</a> - Unitrópico

            </div>
          </div>
          <div class="col-lg-6">
            <ul class="nav nav-footer justify-content-center justify-content-lg-end">
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Synaris Corp</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Nosotros</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Blog</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link pe-0 text-muted" target="_blank">Licencia</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    </div>


    <!--------- Fin del contenido ----------->
  </main>
  <div class="fixed-plugin">
    <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
      <i class="fa fa-cog py-2"> </i>
    </a>

    <style>
      /* Estilo base para botones flotantes */
      .boton-politica {
        position: fixed;
        right: 1.8%;
        z-index: 5;
        background-color: #ffffff;
        color: #00594E;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
        border: 2px solid #00594E;
      }

      @media (max-width: 768px) {

        .boton-politica {
          right: 5%;
        }

      }

      .boton-politica:hover {
        background-color: #00594E;
        color: #ffffff;
        transform: scale(1.1);
      }

      .boton-politica svg {
        pointer-events: none;
      }

      /* Posiciones individuales */
      #anteriorBtn {
        bottom: 10%;
      }

      #siguienteBtn {
        bottom: 16%;
      }

      .documentosBtn {
        bottom: 22%;
        border: 2px solid #b5a160;
        color: #b5a160;
      }

      .documentosBtn:hover {
        background-color: #b5a160;
        color: #fff;
      }

      /* Estilo para deshabilitado visual */
      .boton-politica.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
    </style>

    <a id="anteriorBtn" class="boton-politica" title="Política Anterior" href="#">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-left"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
      </svg>
    </a>

    <a id="siguienteBtn" class="boton-politica" title="Política Siguiente" href="#">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-right"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8" />
      </svg>
    </a>

    <div id="fixedBtnCargarEvidencias" class="cursor-pointer">

    </div>
    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3 ">
        <div class="float-start">
          <h5 class="mt-3 mb-0">PolariScore</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="fa fa-close"></i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0 overflow-auto">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-gradient-primary active" data-color="primary"
              onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between 2 different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn bg-gradient-primary w-100 px-3 mb-2 active me-2" data-class="bg-white"
            onclick="sidebarType(this)">White</button>
          <button class="btn bg-gradient-primary w-100 px-3 mb-2" data-class="bg-default"
            onclick="sidebarType(this)">Dark</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="d-flex my-3">
          <h6 class="mb-0">Navbar Fixed</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
          </div>
        </div>
        <hr class="horizontal dark my-sm-4">
        <div class="mt-2 mb-5 d-flex">
          <h6 class="mb-0">Light / Dark</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version" onclick="darkMode(this)">
          </div>
        </div>
        <a class="btn bg-gradient-dark w-100" href="https://www.creative-tim.com/product/argon-dashboard">Free
          Download</a>
        <a class="btn btn-outline-dark w-100"
          href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard">View documentation</a>
        <div class="w-100 text-center">
          <a class="github-button" href="https://github.com/creativetimofficial/argon-dashboard"
            data-icon="octicon-star" data-size="large" data-show-count="true"
            aria-label="Star creativetimofficial/argon-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="https://twitter.com/intent/tweet?text=Check%20Argon%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fargon-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/argon-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal DOCUMENTOS -->
  <div class="modal fade" id="DocumentosModal" tabindex="-1" aria-labelledby="DocumentosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="DocumentosLabel">
            <i class="fa-solid fa-folder-open me-2"></i> Documentos
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="card shadow-sm">
            <div class="card-header pb-2">
              <div class="row g-2 align-items-center">
                <div class="col-12 col-md-6 d-flex align-items-center">
                  <h6 class="mb-0">Documentos de la Política</h6>
                </div>
                <div class="col-12 col-md-6 text-md-end">
                  <button class="btn btn-outline-primary btn-sm mb-0" id="descargar_todo">
                    <i class="fa-solid fa-download me-1"></i> Descargar todo
                  </button>
                  <button class="btn btn-primary btn-sm mb-0 ms-2 d-none" id="btnSubirDocumento">
                    <i class="fa-solid fa-file-arrow-up me-1"></i> Subir
                  </button>
                  <!-- Input file oculto (se activa desde JS) -->
                  <input type="file" id="inputArchivoDocumento" class="d-none" multiple
                    accept="application/pdf,image/*,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar">
                </div>
              </div>
            </div>

            <div class="card-body pt-3">
              <!-- Progreso de cargas -->
              <div id="docsUploadProgress" class="mb-3"></div>

              <!-- Contenedor de la lista -->
              <div id="modalDocumentos">
                <ul class="list-group list-group-flush">
                  <!-- Items de documentos se inyectan por JS -->
                </ul>
              </div>

              <!-- Mensaje vacío opcional (JS puede reemplazarlo) -->
              <!--
            <div class="text-center text-muted py-4" id="docsEmptyMsg">
              No hay documentos registrados para esta política.
            </div>
            -->
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <small class="me-auto text-muted">Solo administradores pueden subir documentos.</small>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>


  <style>
    /* Limita la altura del modal y permite scroll solo en el contenido */
    .modal-dialog.custom-modal-height {
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-content {
      flex: 1 1 auto;
      overflow: hidden;
    }
  </style>


  <!-- Modal EVIDENCIAS -->
  <div class="modal fade" id="evidenciasModal" tabindex="-1" aria-labelledby="evidenciasLabel" aria-hidden="true">
    <div class="modal-dialog modal-xxl modal-dialog-centered modal-full-h">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="evidenciasLabel">
            <i class="fa-regular fa-folder-open text-gold"></i>
            Evidencias Subidas — <span id="tituloEvidencias" class="text-brand">Política</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <!-- Nav principal -->
          <ul class="nav nav-tabs nav-fill mb-3" id="navTabCargaMasiva" role="tablist">
            <li class="nav-item">
              <button class="nav-link active small" id="tab-acciones-tab" data-bs-toggle="tab"
                data-bs-target="#tab-acciones" type="button" role="tab">Evidencias</button>
            </li>
            <li class="nav-item">
              <button class="nav-link small" id="tab-resumen-tab" data-bs-toggle="tab" data-bs-target="#tab-resumen"
                type="button" role="tab">Resumen</button>
            </li>
            <li class="nav-item responsable-polariscore-only" style="display: none;">
              <button class="nav-link small" id="tab-evidencias-tab" data-bs-toggle="tab"
                data-bs-target="#tab-evidencias" type="button" role="tab"
                onclick="window.location.href='cargar.html'">Cargar Evidencias</button>
            </li>
          </ul>

          <div class="tab-content" id="navTabCargaMasivaContent">
            <!-- TAB: Evidencias -->
            <div class="tab-pane fade show active" id="tab-acciones" role="tabpanel">
              <!-- Sub-tabs por año -->
              <ul class="nav nav-tabs mb-3" id="evidenciasTabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="anio1-tab"
                    data-bs-toggle="tab" data-bs-target="#anio1" type="button" role="tab">Año 1</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio2-tab" data-bs-toggle="tab"
                    data-bs-target="#anio2" type="button" role="tab">Año 2</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio3-tab" data-bs-toggle="tab"
                    data-bs-target="#anio3" type="button" role="tab">Año 3</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio4-tab" data-bs-toggle="tab"
                    data-bs-target="#anio4" type="button" role="tab">Año 4</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio5-tab" data-bs-toggle="tab"
                    data-bs-target="#anio5" type="button" role="tab">Año 5</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio6-tab" data-bs-toggle="tab"
                    data-bs-target="#anio6" type="button" role="tab">Año 6</button></li>
              </ul>

              <!-- Contenido sub-tabs -->
              <div class="tab-content" id="evidenciasTabContent" style="max-height: none;">
                <div class="tab-pane fade show active" id="anio1" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio2" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio3" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio4" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio5" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio6" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
              </div>
            </div>

            <!-- TAB: Resumen -->
            <div class="tab-pane fade" id="tab-resumen" role="tabpanel">
              <div class="p-3 border rounded-3 border-dashed" style="border-color: var(--line); color:#cfd7da;">
                Aquí puedes renderizar un resumen por año / estado / formatos con tus métricas clave.
              </div>
            </div>

            <!-- TAB: Cargar Evidencias -->
            <div class="tab-pane fade responsable-polariscore-only" style="display: none;" id="tab-evidencias"
              role="tabpanel">
              <div class="mb-4">
                <span class="spinner-border spinner-border-sm text-gold me-2" role="status"></span>Guardando...
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- END Modal EVIDENCIAS -->




  <!-- Modal para agregar evidencia -->
  <div class="modal fade" id="modalAgregarEvidencia" tabindex="-1" aria-labelledby="modalAgregarEvidenciaLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAgregarEvidenciaLabel">Añadir Nueva Evidencia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formAgregarEvidencia">
            <!-- Campo de Título -->
            <div class="mb-3">
              <label for="tituloEvidencia" class="form-label">Título de la Evidencia</label>
              <input type="text" class="form-control" id="tituloEvidencia" required>
            </div>

            <!-- Campo de Formato -->
            <div class="mb-3">
              <label for="formatoEvidencia" class="form-label">Formato</label>
              <select class="form-select" id="formatoEvidencia" required>
                <option value="PDF">PDF</option>
                <option value="Excel">Excel</option>
                <option value="Word">Word</option>
                <option value="Otro">Otro (Especificar)</option>
              </select>
            </div>

            <!-- Campo para otro formato (oculto por defecto) -->
            <div class="mb-3" id="otroFormatoContainer" style="display: none;">
              <label for="otroFormato" class="form-label">Especificar Formato</label>
              <input type="text" class="form-control" id="otroFormato">
            </div>

            <!-- Peso Máximo (Oculto si es PDF, Excel o Word) -->
            <div class="mb-3" id="pesoMaxContainer" style="display: none;">
              <label for="pesoMax" class="form-label">Peso Máximo (MB)</label>
              <input type="number" class="form-control" id="pesoMax" value="80" readonly>
            </div>

            <!-- Botón de Guardar -->
            <div class="text-end">
              <button type="submit" class="btn btn-success">
                <i class="fa-solid fa-floppy-disk"></i> Guardar Evidencia
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- End Modal para agregar evidencia -->

  <!-- === Estilos del modal de Evaluación === -->
  <style>
    :root {
      --brand: #00594E;
      /* Verde Unitrópico */
      --brand-alt: #E8F4F2;
      /* Verde muy claro */
      --gold: #B5A160;
    }

    #evaluarModal .modal-header {
      background: var(--brand);
      color: #fff;
    }

    #evaluarModal .modal-title {
      color: #fff;
    }

    #evaluarModal .btn-close-white {
      filter: invert(1);
    }

    /* Tabs */
    #evaluarModal .nav-tabs {
      border-bottom: 1px solid #e5ecea;
    }

    #evaluarModal .nav-tabs .nav-link {
      color: #5f6b67;
      white-space: nowrap;
    }

    #evaluarModal .nav-tabs .nav-link.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    /* Contenido */
    #evaluarModal .tab-pane {
      background: #f8f9fa;
    }

    #evaluarModal .input-programado[readonly] {
      background: #f1f3f5;
      cursor: not-allowed;
    }

    #evaluarModal .avance-wrap .progress {
      height: 8px;
      background: #e9ecef;
    }

    #evaluarModal .avance-wrap .progress-bar {
      background: var(--brand);
    }

    #evaluarModal .help {
      font-size: .82rem;
      color: #6c757d
    }
  </style>

  <!-- === Modal EVALUAR === -->
  <div class="modal fade" id="evaluarModal" tabindex="-1" aria-labelledby="evaluarLabel" aria-hidden="false">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
      <div class="modal-content shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="evaluarLabel">
            <i class="fa-solid fa-scale-balanced me-2"></i> Evaluar Acción
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">

          <!-- Tabs (scrollables en pantallas pequeñas) -->
          <ul class="nav nav-tabs flex-nowrap overflow-auto" id="navTabEjemplo" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1" type="button"
                role="tab" aria-controls="tab1" aria-selected="true">Año 1</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2" type="button"
                role="tab" aria-controls="tab2" aria-selected="false">Año 2</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button"
                role="tab" aria-controls="tab3" aria-selected="false">Año 3</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab4-tab" data-bs-toggle="tab" data-bs-target="#tab4" type="button"
                role="tab" aria-controls="tab4" aria-selected="false">Año 4</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab5-tab" data-bs-toggle="tab" data-bs-target="#tab5" type="button"
                role="tab" aria-controls="tab5" aria-selected="false">Año 5</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab6-tab" data-bs-toggle="tab" data-bs-target="#tab6" type="button"
                role="tab" aria-controls="tab6" aria-selected="false">Año 6</button>
            </li>
          </ul>

          <!-- Contenido -->
          <div class="tab-content mt-3" id="navTabEjemploContent">
            <!-- ==== Plantilla por año (cambia solo el id tabX) ==== -->
            <div class="tab-pane fade show active p-3 border rounded-3" id="tab1" role="tabpanel"
              aria-labelledby="tab1-tab">
              <p class="mb-3 text-muted text-center help">Completa el campo para evaluar la ejecución (se detecta % o
                proporción).</p>
              <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-ejecutado"
                    placeholder="0" style="width: 100px;">
                </div>
                <span class="fs-4">/</span>
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-programado" readonly
                    style="width: 100px;">
                </div>
              </div>
              <div class="avance-wrap text-center">
                <span class="badge bg-secondary rounded-pill avance-badge">—</span>
                <div class="progress mt-2">
                  <div class="progress-bar" role="progressbar" style="width:0%" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100"></div>
                </div>
                <div class="help mt-2">El porcentaje se calcula como Ejecutado ÷ Programado.</div>
              </div>
            </div>

            <!-- Año 2 -->
            <div class="tab-pane fade p-3 border rounded-3" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
              <p class="mb-3 text-muted text-center help">Completa el campo para evaluar la ejecución (se detecta % o
                proporción).</p>
              <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-ejecutado"
                    placeholder="0" style="width: 100px;">
                </div>
                <span class="fs-4">/</span>
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-programado" readonly
                    style="width: 100px;">
                </div>
              </div>
              <div class="avance-wrap text-center">
                <span class="badge bg-secondary rounded-pill avance-badge">—</span>
                <div class="progress mt-2">
                  <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
              </div>
            </div>

            <!-- Año 3 -->
            <div class="tab-pane fade p-3 border rounded-3" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
              <p class="mb-3 text-muted text-center help">Completa el campo para evaluar la ejecución (se detecta % o
                proporción).</p>
              <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-ejecutado"
                    placeholder="0" style="width: 100px;">
                </div>
                <span class="fs-4">/</span>
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-programado" readonly
                    style="width: 100px;">
                </div>
              </div>
              <div class="avance-wrap text-center">
                <span class="badge bg-secondary rounded-pill avance-badge">—</span>
                <div class="progress mt-2">
                  <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
              </div>
            </div>

            <!-- Año 4 -->
            <div class="tab-pane fade p-3 border rounded-3" id="tab4" role="tabpanel" aria-labelledby="tab4-tab">
              <p class="mb-3 text-muted text-center help">Completa el campo para evaluar la ejecución.</p>
              <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-ejecutado"
                    placeholder="0" style="width: 100px;">
                </div>
                <span class="fs-4">/</span>
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-programado" readonly
                    style="width: 100px;">
                </div>
              </div>
              <div class="avance-wrap text-center">
                <span class="badge bg-secondary rounded-pill avance-badge">—</span>
                <div class="progress mt-2">
                  <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
              </div>
            </div>

            <!-- Año 5 -->
            <div class="tab-pane fade p-3 border rounded-3" id="tab5" role="tabpanel" aria-labelledby="tab5-tab">
              <p class="mb-3 text-muted text-center help">Completa el campo para evaluar la ejecución.</p>
              <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-ejecutado"
                    placeholder="0" style="width: 100px;">
                </div>
                <span class="fs-4">/</span>
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-programado" readonly
                    style="width: 100px;">
                </div>
              </div>
              <div class="avance-wrap text-center">
                <span class="badge bg-secondary rounded-pill avance-badge">—</span>
                <div class="progress mt-2">
                  <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
              </div>
            </div>

            <!-- Año 6 -->
            <div class="tab-pane fade p-3 border rounded-3" id="tab6" role="tabpanel" aria-labelledby="tab6-tab">
              <p class="mb-3 text-muted text-center help">Completa el campo para evaluar la ejecución.</p>
              <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-ejecutado"
                    placeholder="0" style="width: 100px;">
                </div>
                <span class="fs-4">/</span>
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" step="0.01" min="0" class="form-control text-center input-programado" readonly
                    style="width: 100px;">
                </div>
              </div>
              <div class="avance-wrap text-center">
                <span class="badge bg-secondary rounded-pill avance-badge">—</span>
                <div class="progress mt-2">
                  <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
              </div>
            </div>
          </div>

          <hr>

          <!-- Historial -->
          <h6 class="text-uppercase text-muted mb-3 mt-2">Historial de Evaluaciones</h6>
          <ul class="list-group small" id="historialEvaluaciones">
            <!-- Se llena dinámicamente -->
          </ul>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="guardarEvaluacion()">
            <i class="fa-regular fa-floppy-disk me-1"></i> Guardar Evaluación
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
      // Refresca etiquetas de tabs con el año calendario y calcula % en vivo
      (function initEvaluarModalUI() {
        const modal = document.getElementById('evaluarModal');
        if (!modal) return;

        const setYearLabels = () => {
          const raw = window.fechaInicioPolitica;
          if (!raw) return;
          const start = raw.includes('/') ? parseInt(raw.split('/')[2], 10) : new Date(raw).getFullYear();
          if (!Number.isFinite(start)) return;
          for (let i = 1; i <= 6; i++) {
            const btn = document.getElementById(`tab${i}-tab`);
            if (btn) btn.textContent = `Año ${i} (${start + i - 1})`;
          }
        };

        const bindComputes = () => {
          modal.querySelectorAll('.tab-pane').forEach(pane => {
            const ej = pane.querySelector('.input-ejecutado');
            const pr = pane.querySelector('.input-programado');
            const badge = pane.querySelector('.avance-badge');
            const bar = pane.querySelector('.progress-bar');
            const compute = () => {
              const e = parseFloat((ej?.value || '').toString().replace(',', '.')) || 0;
              const p = parseFloat((pr?.value || '').toString().replace(',', '.')) || 0;
              const pct = p > 0 ? (e / p) * 100 : 0;
              if (badge) {
                badge.textContent = p > 0 ? `${pct.toFixed(0)}%` : '—';
                badge.className = 'badge rounded-pill ' + (pct >= 100 ? 'bg-success' : 'bg-secondary');
              }
              if (bar) {
                const w = Math.max(0, Math.min(100, pct));
                bar.style.width = w.toFixed(0) + '%';
                bar.setAttribute('aria-valuenow', w.toFixed(0));
              }
            };
            ej && ej.addEventListener('input', compute);
            // Primer cálculo
            compute();
          });
        };

        modal.addEventListener('shown.bs.modal', () => {
          setYearLabels();
          bindComputes();
        });
      })();
  </script>

  <!-- Modal OBSERVACIONES -->
  <div class="modal fade" id="observacionesModal" tabindex="-1" role="dialog" aria-labelledby="observacionesLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title d-flex align-items-center text-white" id="observacionesLabel">
            <i class="fa-regular fa-comments me-2 text-white"></i> Observaciones <span id="tituloEvidenciaModal"></span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <!-- Chat de Observaciones -->
          <div id="chatObservaciones" class="overflow-auto px-2"
            style="max-height: 500px; min-height: 300px; display: flex; flex-direction: column-reverse;">
            <ul class="list-unstyled mb-0" id="listaMensajes">
              <li class="text-center text-muted">Cargando mensajes...</li>
            </ul>
          </div>

          <!-- Campo de entrada y botón de envío -->
          <div class="mt-3">
            <div class="input-group">
              <input type="text" id="mensajeObservacion" class="form-control rounded-start-pill"
                placeholder="Escribe un mensaje..." style="height: 45px;">
              <button class="btn btn-primary rounded-end-pill d-flex align-items-center justify-content-center"
                style="width: 50px; height: 45px;" id="enviarMensajeObservacion">
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- end Modal OBSERVACIONES -->

  <!-- Modal de Confirmación para Eliminar Evidencia -->
  <div class="modal fade" id="modalEliminarEvidencia" tabindex="-1" aria-labelledby="modalEliminarEvidenciaLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title text-white" id="modalEliminarEvidenciaLabel">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body text-center">
          <p class="mb-0 fs-6">¿Estás seguro de eliminar esta evidencia?</p>
          <small class="text-muted">Esta acción no se puede deshacer.</small>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmarEliminarEvidencia">
            <i class="fa-solid fa-trash me-1"></i> Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal de Confirmación de Cierre de Sesión -->
  <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutLabel">Cerrar sesión</h5>
        </div>
        <div class="modal-body text-center">
          <p>¿Estás seguro de que quieres cerrar sesión?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmLogout">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor de notificaciones (Toasts) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="toastContainer"></div>
  </div>

  <!--   Core JS Files   -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- html2canvas primero -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- canvg después -->
  <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.9/lib/umd.min.js"></script>


  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example /pages etc -->
  <script src="../assets/js/argon-dashboard.min.js?v=2.0.4"></script>
  <script type="module">
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, get, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
    import { getStorage, ref as storageRef, listAll, uploadBytes, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-storage.js";



    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyADKfjkB9LO1k1smRJ31sOb-7rrxOrQ7lc",
      authDomain: "sigunitropico.firebaseapp.com",
      databaseURL: "https://sigunitropico-default-rtdb.firebaseio.com/",
      projectId: "sigunitropico",
      storageBucket: "sigunitropico.appspot.com",
      messagingSenderId: "32992004482",
      appId: "1:32992004482:web:bd4d5e9a2b7a8b976e279b",
      measurementId: "G-B95VYWYDJT"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage();
    const database = getDatabase(app); // ✅ Esta línea es clave

    // Obtener el ID de la acción desde la URL
    const idAccion = getQueryParam("id");

    if (idAccion) {
      cargarDatosAccion(idAccion);
    }

    function limitarTexto(texto, max) {
      if (typeof texto !== "string") return "";
      return texto.length > max ? texto.substring(0, max) + "..." : texto;
    }

    let objetivoIndex = null; // Variable global para almacenar el índice del objetivo

    // Variables globales para almacenar los datos de la gráfica de tiempo de la acción
    window.labelsAccion = [];
    window.aniosDataAccionEjecutados = [];
    window.aniosDataAccionProgramados = [];
    window.fechaInicioPolitica = "";
    window.idAccionSeleccionada = "";


    document.addEventListener("DOMContentLoaded", () => {
      // Tu lógica de inicialización

      // 👇 Aquí puedes poner el listener global para el modal
      const evidenciasModal = document.getElementById('evidenciasModal');
      if (evidenciasModal) {
        evidenciasModal.addEventListener('hidden.bs.modal', function () {
          console.log("🛑 Modal de evidencias cerrado.");
          cargarDatosAccion(idAccionSeleccionada);
        });
      }

      // ...otros listeners globales, como botones, etc.
    });

    // Obtener fecha actual en formato dd-mm-aaaa
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const anio = hoy.getFullYear();
    const fechaFormateada = `${dia}-${mes}-${anio}`;

    window.fechaFormateada = fechaFormateada;

    const iconosPoliticas = {
      "P-001": "fas fa-chalkboard-teacher text-primary",         // Formación Profesoral
      "P-002": "fas fa-flask text-success",                      // Investigación y Convocatorias
      "P-003": "fas fa-tasks text-info",                         // Autoevaluación, Autorregulación y Mejoramiento
      "P-004": "fas fa-lightbulb text-warning",                  // Propiedad Intelectual
      "P-005": "fas fa-university text-danger",                  // Académica
      "P-006": "fas fa-graduation-cap text-secondary",           // Innovación Educativa y Buenas Prácticas Pedagógicas
      "P-007": "fas fa-leaf text-success",                       // Ambiental
      "P-008": "fas fa-language text-primary",                   // Lingüística
      "P-009": "fas fa-users text-info",                         // Inclusiva e Intercultural (PESII)
      "P-010": "fas fa-heart text-primary",                       // Bienestar Universitario
      "P-011": "fas fa-user-graduate text-warning",               // Egresados
      "P-012": "fas fa-globe-americas text-primary",              // Internacionalización
      "P-013": "fas fa-user-tie text-dark",                       // Gestión Estratégica de Talento Humano
      "P-014": "fas fa-award text-warning",                       // Incentivos y Estímulos del Personal
      "P-015": "fas fa-chart-bar text-success",                   // Gestión de la Información Estadística
      "P-016": "fas fa-balance-scale text-danger",                 // Transparencia y Lucha contra la Corrupción
      "P-017": "fas fa-headset text-info",                        // Atención al Ciudadano
      "P-018": "fas fa-archive text-secondary",                   // Gestión Documental
      "P-019": "fas fa-tools text-dark",                          // Mantenimiento y Renovación de Infraestructura
      "P-020": "fas fa-handshake text-success",                   // Integridad
      "P-021": "fas fa-hands-helping text-primary"                 // Proyección Social
    };


    function cargarDatosAccion(idAccion) {
      const dbRef = ref(db, "PolariScore/politicas");

      get(dbRef)
        .then((snapshot) => {
          if (snapshot.exists()) {
            let politicas = snapshot.val();
            let accionEncontrada = null;
            let politicaAsociada = null;
            let evidencias = [];

            const ulPoliticas = document.getElementById('cargarPoliticas');
            ulPoliticas.innerHTML = "";

            for (const idPolitica in politicas) {
              const politica = politicas[idPolitica];
              const nombrePolitica = politica.titulo || "Sin nombre";

              // Obtener el icono o usar uno por defecto
              const icono = iconosPoliticas[idPolitica] || "fas fa-file-alt text-secondary";

              const li = document.createElement("li");
              li.className = "nav-item";

              li.innerHTML = `
          <a class="nav-link d-flex align-items-center" href="#" title="${nombrePolitica}" data-id="${idPolitica}">
            <i class="${icono} me-2"></i> 
            ${limitarTexto(nombrePolitica, 23)}
          </a>
        `;

              li.querySelector("a").addEventListener("click", (e) => {
                e.preventDefault();
                window.location.href = `politica.html?id=${idPolitica}`;
              });

              ulPoliticas.appendChild(li);


            }


            // Recorrer la estructura: política > objetivos_especificos > acciones
            Object.values(politicas).forEach((politica) => {

              if (politica.objetivos_especificos && typeof politica.objetivos_especificos === "object") {
                Object.entries(politica.objetivos_especificos).forEach(([index, objetivo]) => {

                  if (!objetivo || !objetivo.acciones || typeof objetivo.acciones !== "object") return;

                  let acciones = Object.values(objetivo.acciones);

                  acciones.forEach((accion) => {
                    if (accion.id_accion === idAccion) {
                      window.fechaInicioPolitica = politica.fecha_politica;
                      actualizarNombresTabsEvidencias();
                      actualizarNombresTabsEvaluar();


                      accionEncontrada = accion;
                      politicaAsociada = politica;
                      objetivoIndex = index; // Guardar el índice del objetivo actual
                      cargarDatosEvaluacionEnTabs(
                        politicaAsociada.id,
                        objetivoIndex,
                        accionEncontrada.id_accion,
                        politicaAsociada.fecha_politica
                      );


                      document.getElementById("btnCrearIndicador").onclick = function () {
                        abrirModalIndicador(politicaAsociada.id, objetivoIndex, accionEncontrada.id_accion);
                      }

                      // --- RUTA RTDB
                      const rutaIndicador = `PolariScore/politicas/${politicaAsociada.id}/objetivos_especificos/${objetivoIndex}/acciones/${idAccion}/Indicador/`;


                      get(ref(db, rutaIndicador)).then(snap => {
                        const indicador = snap.val();
                        renderIndicadorVisual(indicador, ["2023", "2024", "2025", "2026", "2027", "2028"]);

                      });

                      // Función interna, lista para ser llamada por el listener externo
                      window.eliminarIndicadorActual = async function () {
                        try {
                          await remove(ref(db, rutaIndicador));
                          return true;
                        } catch (err) {
                          console.error("❌ Error eliminando indicador:", err);
                          throw err;
                        }
                      };



                      var tituloPolitica = limitarTexto(politica.titulo, 20);
                      document.getElementById("namePolitica").textContent = tituloPolitica;
                      document.getElementById("namePolitica").href = "politica.html?id=" + politicaAsociada.id;
                    }
                  });
                });
              }
            });

            renderDocumentosPolitica(politicaAsociada);

            // Si se encontró la acción, cargar los datos en la interfaz
            if (accionEncontrada && politicaAsociada) {
              document.getElementById("titulo_politica").textContent = politicaAsociada.titulo;
              document.getElementById("objetivo_general").textContent = limitarTexto(politicaAsociada.objetivo_general, 70);
              document.getElementById("objetivo_general").title = politicaAsociada.objetivo_general;
              document.getElementById("indicador_politica").textContent = limitarTexto(accionEncontrada.indicador, 70);
              document.getElementById("indicador_politica").title = accionEncontrada.indicador;
              document.getElementById("fecha_inicio").textContent = politicaAsociada.fecha_politica;
              document.getElementById("idName").textContent = accionEncontrada.id_accion;
              document.getElementById("detalle_politica").textContent = accionEncontrada.accion;
              const containerCargarEvidencias = document.getElementById("fixedBtnCargarEvidencias");

              containerCargarEvidencias.innerHTML = `
              <a class="boton-politica documentosBtn btnCargarEvidencias"
              data-id-politica="${politicaAsociada.id}"
                              data-objetivo-index="${objetivoIndex}"
                              data-id-accion="${idAccion}"
                              title="Cargar Evidencias"
              >
                <i class="fa-solid fa-cloud-arrow-up cursor-pointer"></i>
              </a>`;

              var programacionFisica = accionEncontrada.anios;

              async function evaluarCumplimiento() {
                const anioInicio = politicaAsociada.fecha_politica.includes('/')
                  ? parseInt(politicaAsociada.fecha_politica.split('/')[2])
                  : new Date(politicaAsociada.fecha_politica).getFullYear();

                let cumplimientoAccion = await calcularCumplimientoAccion(accionEncontrada, anioInicio);

                document.getElementById("resumen_politica").textContent = `
                  La presente acción cuenta con el indicador: ${accionEncontrada.indicador},
                  una Importancia de ${(accionEncontrada.importancia_accion * 100).toFixed(2)}%,
                  y a la fecha tiene un cumplimiento del ${cumplimientoAccion}%`;

                animarCumplimiento(cumplimientoAccion);
              }

              evaluarCumplimiento();

              // Llamar a la función para generar la gráfica de tiempo
              generarGraficaTiempoAccion(accionEncontrada, politicaAsociada.fecha_politica);


              // Llenar la tabla de cumplimiento con evidencias
              let tablaCumplimiento = document.getElementById("tabla_cumplimiento");
              tablaCumplimiento.innerHTML = ""; // Limpiar la tabla antes de llenarla

              let filas = "";

              const dbRef = ref(db, `PolariScore/evidencias/${idAccion}`);

              onValue(dbRef, (snapshot) => {
                const evidencias = snapshot.val();
                let filas = "";


                if (evidencias && typeof evidencias === "object") {
                  let hayEvidencias = false;

                  Object.entries(evidencias).forEach(([idEvidencia, evidencia]) => {
                    hayEvidencias = true;

                    const objetivoEspecificoTitulo = politicaAsociada.objetivos_especificos?.[objetivoIndex]?.objetivo_especifico || "Sin título";

                    filas += `
                      <tr class="align-middle hover-effect">
                        <td title="${evidencia.titulo}" class="p-3" style="text-align: start;">${limitarTexto(evidencia.titulo || '', 100)}</td>
                        <td title="${politicaAsociada?.responsables || ''}" class="p-3">${limitarTexto(politicaAsociada?.responsables || '', 50)}</td>
                        <td title="${evidencia.formato}" class="p-3 text-center">
                          <span class="me-2">${obtenerIconoArchivo(evidencia.formato || "", "fa-lg")}</span> 
                        </td>
                        <td class="text-center p-3">
                          <div class="d-flex justify-content-center gap-2">
                            <!-- ADMIN botón ABRIR -->
                            <button 
                              class="btn btn-outline-primary btn-sm btnAbrirEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore-only" 
                              style="display: none;" 
                              data-id="${idEvidencia}" 
                              data-titulo="${evidencia.titulo}" 
                              data-id-accion="${idAccion}" 
                              data-id-politica="${politicaAsociada.id}" 
                              data-titulo-politica="${politicaAsociada.titulo}"
                              data-fecha-inicio-politica="${politicaAsociada.fecha_politica}"  
                              data-formato="${evidencia.formato}" 
                              data-objetivo-index="${objetivoIndex}" 
                              data-objetivo-especifico="${objetivoEspecificoTitulo}"
                              data-bs-toggle="modal" 
                              data-bs-target="#evidenciasModal">
                              <i class="fa-solid fa-file-pen me-1"></i>
                            </button>

                            <!-- ADMIN botón ELIMINAR -->
                            <button 
                              class="btn btn-outline-danger btn-sm btnEliminarEvidencia fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore-only" 
                              style="display: none;"
                              data-id="${idEvidencia}" 
                              data-id-accion="${idAccion}" 
                              data-id-politica="${politicaAsociada.id}" 
                              data-objetivo-index="${objetivoIndex}">
                              <i class="fa-solid fa-trash"></i>
                            </button>

                            <!-- RESPONSABLE botón ABRIR -->
                            <button 
                              class="btn btn-outline-primary btn-sm btnAbrirEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm responsable-polariscore-only" 
                              data-id="${idEvidencia}" 
                              data-titulo="${evidencia.titulo}" 
                              data-id-accion="${idAccion}" 
                              data-id-politica="${politicaAsociada.id}" 
                              data-titulo-politica="${politicaAsociada.titulo}" 
                              data-fecha-inicio-politica="${politicaAsociada.fecha_politica}"  
                              data-formato="${evidencia.formato}" 
                              data-objetivo-index="${objetivoIndex}" 
                              data-objetivo-especifico="${objetivoEspecificoTitulo}"
                              data-bs-toggle="modal" 
                              data-bs-target="#evidenciasModal">
                              <i class="fa-solid fa-bullseye me-1"></i>
                            </button>
                            <button 
                              class="btn btn-outline-warning btn-sm btnCargarEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm admin-responsable-polariscore"
                              data-id-politica="${politicaAsociada.id}"
                              data-objetivo-index="${objetivoIndex}"
                              data-id-accion="${idAccion}"
                              title="Cargar evidencias"
                            >
                              <i class="fa-solid fa-cloud-arrow-up me-1"></i>
                            </button>

                          </div>
                        </td>
                      </tr>`;
                  });

                  if (hayEvidencias) {
                    const encabezado = `
                      <thead class="sticky-top bg-transparent">
                        <tr class="text-center text-uppercase fw-semibold text-primary border-bottom">
                          <th class="py-3">Evidencia</th>
                          <th class="py-3">Responsables</th>
                          <th class="py-3">Formato</th>
                          <th class="py-3">Acción</th>
                        </tr>
                      </thead>`;

                    tablaCumplimiento.innerHTML = `
                      <table class="table table-hover bg-transparent text-dark">
                        ${encabezado}
                        <tbody class="shadow-sm rounded-3">${filas}</tbody>
                      </table>`;
                    inicializarBotonesAbrirEvidencias();

                  } else {
                    renderTablaSinEvidencias();
                  }

                } else {
                  renderTablaSinEvidencias();
                }
              });

              function renderTablaSinEvidencias() {
                let encabezadoAlternativo = `
                  <thead class="sticky-top bg-transparent">
                    <tr class="text-center text-uppercase fw-semibold text-primary border-bottom">
                      <th class="py-3">Indicador</th>
                      <th class="py-3">Evidencia</th>
                      <th class="py-3">Responsables</th>
                      <th class="py-3">Acción</th>
                    </tr>
                  </thead>`;

                let filas = `
                  <tr class="align-middle hover-effect">
                    <td title="${accionEncontrada.indicador}" class="p-3">${limitarTexto(accionEncontrada.indicador, 50)}</td>
                    <td class="text-muted text-center p-3">No se encontraron documentos</td>
                    <td title="${politicaAsociada.responsables}" class="p-3">${limitarTexto(politicaAsociada.responsables, 50)}</td>
                    <td class="text-center p-3">
                      <button class="btn btn-outline-success btn-sm fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore-only" style="display: none;"
                        data-bs-toggle="modal" data-bs-target="#evidenciasModal">
                        <i class="fa-solid fa-check me-1"></i> Completar
                      </button>
                      <button class="btn btn-outline-success btn-sm fw-semibold px-3 py-2 rounded-pill shadow-sm responsable-polariscore-only" style="display: none;"
                        data-bs-toggle="modal" data-bs-target="#evidenciasModal">
                        <i class="fa-solid fa-check me-1"></i> Analizar
                      </button>
                    </td>
                  </tr>`;

                tablaCumplimiento.innerHTML = `
                  <table class="table table-hover bg-transparent text-dark">
                    ${encabezadoAlternativo}
                    <tbody class="shadow-sm rounded-3">${filas}</tbody>
                  </table>`;
              }


              let listenerFormularioEvidenciaAgregado = false;




              if (!listenerFormularioEvidenciaAgregado) {
                document.getElementById("formAgregarEvidencia").addEventListener("submit", function (event) {
                  event.preventDefault(); // Prevenir envío del formulario

                  const titulo = document.getElementById("tituloEvidencia").value.trim();
                  const formato = document.getElementById("formatoEvidencia").value;
                  const otroFormato = document.getElementById("otroFormato").value.trim();
                  const pesoMax = document.getElementById("pesoMax").value;

                  const formatoFinal = (formato === "Otro") ? otroFormato : formato;

                  // Validaciones
                  if (!titulo || !formatoFinal) {
                    mostrarToast("⚠️ Por favor, completa todos los campos requeridos.", "warning");
                    return;
                  }

                  if (!accionEncontrada || !politicaAsociada) {
                    mostrarToast("❌ No se ha encontrado la acción para registrar la evidencia.", "danger");
                    return;
                  }

                  // Desactivar botón mientras se guarda
                  const botonGuardar = document.querySelector('#formAgregarEvidencia button[type="submit"]');
                  botonGuardar.disabled = true;
                  botonGuardar.innerHTML = `
                    <span class="spinner-border spinner-border-sm text-white me-2" role="status"></span>Guardando...
                  `;
                  location.reload(true); // En navegadores modernos ya no se usa "true", pero se mantiene por compatibilidad



                  let ultimaEvidencia = null;

                  function guardarNuevaEvidencia(evidenciaId, accionId, datosEvidencia) {
                    const nuevaEvidenciaRef = ref(db, `PolariScore/evidencias/${accionId}/${evidenciaId}`);
                    return set(nuevaEvidenciaRef, { id_evidencia: evidenciaId, id_accion: accionId, ...datosEvidencia })
                      .then(() => {
                        mostrarToast("✅ Evidencia agregada con éxito.", "success");
                        setTimeout(() => {
                          document.getElementById("formAgregarEvidencia").reset();
                          botonGuardar.disabled = false;
                          botonGuardar.innerHTML = `<i class="fa-solid fa-floppy-disk me-1"></i> Guardar Evidencia`;
                          const modal = bootstrap.Modal.getInstance(document.getElementById("modalAgregarEvidencia"));
                          modal.hide();
                          cargarDatosAccion(accionId);
                        }, 1500);
                      })
                      .catch((error) => {
                        console.error("Error al guardar evidencia:", error);
                        mostrarToast("❌ Error al guardar la evidencia.", "danger");
                        botonGuardar.disabled = false;
                        botonGuardar.innerHTML = `<i class="fa-solid fa-floppy-disk me-1"></i> Guardar Evidencia`;
                        throw error; // Re-lanza el error para que el bloque .catch() principal también lo capture si es necesario
                      });
                  }

                  get(dbRef)
                    .then((snapshot) => {
                      let siguienteIdEvidencia;
                      if (snapshot.exists()) {
                        const evidencias = snapshot.val();
                        const keys = Object.keys(evidencias);
                        const ultimaEvidenciaId = keys.length > 0 ? keys[keys.length - 1] : null;
                        siguienteIdEvidencia = obtenerSiguienteConsecutivo(ultimaEvidenciaId);
                      } else {
                        siguienteIdEvidencia = "EV-001";
                      }

                      const nuevaEvidenciaData = {
                        titulo: titulo,
                        formato: formatoFinal,
                        peso_max: `${pesoMax}MB`,
                        fecha_entrega1: "Por definir",
                        uploads: [],
                        estado: "En revisión"
                      };

                      return guardarNuevaEvidencia(siguienteIdEvidencia, accionEncontrada.id_accion, nuevaEvidenciaData);
                    })
                    .catch((error) => {
                      // Este bloque catch ahora manejará cualquier error ocurrido durante la lectura o escritura.
                      console.error("Error en el proceso de agregar evidencia:", error);
                    });

                  function obtenerSiguienteConsecutivo(ultimaEvidenciaId) {
                    if (ultimaEvidenciaId && ultimaEvidenciaId.startsWith("EV-")) {
                      const numero = parseInt(ultimaEvidenciaId.split("-")[1], 10);
                      const siguienteNumero = numero + 1;
                      return `EV-${siguienteNumero.toString().padStart(3, '0')}`;
                    } else {
                      return "EV-001";
                    }
                  }
                });

                listenerFormularioEvidenciaAgregado = true;
              }


              // Función auxiliar para calcular el progreso de cada año, aplicando toFixed(2)
              // Si el tipo es "porcentaje": (yearValue / divisor)
              // Si el tipo es "entero": (yearValue / divisor) * 100
              function computeProgress(yearValue, divisor, tipo) {
                if (divisor === 0) {
                  return 0;
                }
                let result;
                if (tipo === "porcentaje") {
                  result = yearValue / divisor * 10000;
                } else if (tipo === "entero") {
                  result = (yearValue / divisor) * 100;
                } else {
                  result = 0;
                }
                return parseFloat(result.toFixed(2));
              }



              async function generarGraficaTiempoAccion(accionEncontrada, fecha_inicio) {
                if (!accionEncontrada.anios || accionEncontrada.anios.length === 0) return;

                const db = getDatabase();
                const idAccion = accionEncontrada.id_accion;

                const startingYear = fecha_inicio.includes('/')
                  ? parseInt(fecha_inicio.split('/')[2])
                  : new Date(fecha_inicio).getFullYear();

                const labels = accionEncontrada.anios.map((_, index) => (startingYear + index).toString());
                window.labelsAccion = labels;

                // Contenedor ECharts
                const graficaTiempoContainer = document.getElementById("grafica_tiempo");
                graficaTiempoContainer.innerHTML = '<div id="grafica_tiempo_canvas" style="height: 300px; width: 100%;"></div>';

                // Total programado de toda la acción
                const totalProgramado = accionEncontrada.anios.reduce((acc, v) => acc + parseFloat(v || 0), 0);

                try {
                  const ejecutadoSnap = await get(ref(db, `PolariScore/seguimientos/${idAccion}/ejecutado`));
                  const ejecutadoData = ejecutadoSnap.exists() ? ejecutadoSnap.val() : {};

                  const aniosEjecutados = labels.map(anio => {
                    const ejecutado = parseFloat(ejecutadoData[anio] || 0);
                    return totalProgramado > 0 ? (ejecutado / totalProgramado) * 100 : 0;
                  });

                  const aniosProgramados = accionEncontrada.anios.map(v =>
                    totalProgramado > 0 ? (parseFloat(v || 0) / totalProgramado) * 100 : 0
                  );

                  window.aniosDataAccionEjecutados = aniosEjecutados;
                  window.aniosDataAccionProgramados = aniosProgramados;

                  // Máximo del eje Y
                  const maxY = Math.max(...aniosProgramados.concat(aniosEjecutados)) > 30
                    ? 100
                    : Math.max(...aniosProgramados.concat(aniosEjecutados)) * 1.2;

                  // Configuración ECharts
                  const chartDom = document.getElementById('grafica_tiempo_canvas');
                  const myChart = echarts.init(chartDom);

                  const option = {
                    tooltip: {
                      trigger: 'axis',
                      formatter: params => {
                        return params.map(p => `${p.marker} ${p.seriesName}: ${p.value.toFixed(2)}%`).join('<br>');
                      }
                    },
                    legend: {
                      data: ['Ejecutado', 'Programado']
                    },
                    grid: {
                      left: '5%',
                      right: '5%',
                      bottom: '18%',
                      containLabel: true
                    },
                    xAxis: {
                      type: 'category',
                      data: labels,
                      axisLine: { lineStyle: { color: '#ccc' } }
                    },
                    yAxis: {
                      type: 'value',
                      min: 0,
                      max: maxY,
                      axisLabel: {
                        formatter: value => value.toFixed(2) + '%'
                      }
                    }
                    ,
                    series: [
                      {
                        name: 'Ejecutado',
                        type: 'line',
                        smooth: false,
                        data: aniosEjecutados,
                        lineStyle: {
                          color: '#00594E',
                          width: 2
                        },
                        areaStyle: {
                          color: 'rgba(0, 89, 78, 0.1)'
                        }
                      },
                      {
                        name: 'Programado',
                        type: 'line',
                        smooth: true,
                        data: aniosProgramados,
                        lineStyle: {
                          color: '#B5A160',
                          width: 2
                        },
                        areaStyle: {
                          color: 'rgba(181, 161, 96, 0.05)'
                        }
                      }
                    ]
                  };

                  myChart.setOption(option);
                  window.addEventListener('resize', () => myChart.resize());
                  aplicarFirmaSPlan(myChart, window.fechaFormateada);

                } catch (error) {
                  console.error("❌ Error al cargar datos ejecutados:", error);
                  mostrarToast("Error al cargar ejecución de la acción.", "danger");
                }
              }



            } else {
              console.error("Acción no encontrada en Firebase.");
            }
          } else {
            console.error("No se encontraron datos en Firebase.");
          }
        })
        .catch((error) => {
          console.error("Error al obtener datos:", error);
        });
    }

    /** Abre un popup centrado en pantalla */
    function openCenteredPopup(url, width = 1500, height = 900) {
      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;

      const w = window.innerWidth || document.documentElement.clientWidth || screen.width;
      const h = window.innerHeight || document.documentElement.clientHeight || screen.height;

      const systemZoom = w / window.screen.availWidth;
      const left = (w - width) / (2 * systemZoom) + dualScreenLeft;
      const top = (h - height) / (2 * systemZoom) + dualScreenTop;

      const features = [
        `width=${width}`, `height=${height}`,
        `top=${top}`, `left=${left}`,
        'resizable=yes', 'scrollbars=yes'
      ].join(',');

      const popup = window.open(url, 'cargarEvidencias', features);
      if (popup && popup.focus) popup.focus();
      return popup;
    }

    /** Espera (promesa) a que el popup se cierre */
    function waitForClose(win) {
      return new Promise(resolve => {
        const iv = setInterval(() => {
          if (!win || win.closed) {
            clearInterval(iv);
            resolve();
          }
        }, 400);
      });
    }

    /** Delegación: click en cualquier .btnCargarEvidencias */
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btnCargarEvidencias');
      if (!btn) return;

      // Construir URL con tus parámetros
      const p = btn.dataset.idPolitica;       // politicaAsociada.id
      const obj = btn.dataset.objetivoIndex;    // objetivoIndex
      const a = btn.dataset.idAccion;         // idAccion

      if (!p || !obj || !a) {
        console.warn('Faltan parámetros para abrir el popup (p/obj/a).');
        return;
      }

      const url = `cargar.html?p=${encodeURIComponent(p)}&obj=${encodeURIComponent(obj)}&a=${encodeURIComponent(a)}`;

      // Abrir popup centrado
      const popup = openCenteredPopup(url);

      // Esperar a que el usuario cierre el popup
      await waitForClose(popup);

      // 👉 Aquí actúas tras el cierre: refresca datos, re-renderiza tabla, etc.
      // Por ejemplo, si quieres re-leer y re-pintar la tabla de cumplimiento:
      // (usa las mismas variables de tu contexto que ya tienes en ese scope)
      try {
        // vuelve a disparar tu lector (onValue ya escucha; si no, puedes forzar un refresh)
        console.log('Popup cerrado. Refrescando evidencias…');
        // Si tienes una función específica: await recargarTablaCumplimiento(); 
        // O cerrar/re-abrir el modal si hace falta, etc.
      } catch (err) {
        console.error('Error al refrescar después del popup:', err);
      }
    });

    function animarCumplimiento(valorFinal) {
      let clipRect = document.getElementById("clip-rect");
      let porcentajeTexto = document.getElementById("porcentaje");
      let overlay = document.getElementById("overlay");
      let colorMatrix = document.getElementById("matrix");

      // Actualiza la matriz de color para simular el mapa de calor:
      // 0% = rojo (rgb(255,0,0)) y 100% = verde (rgb(0,255,0))
      function updateColorMatrix(porcentaje) {
        const r = Math.max(255 - (porcentaje * 2.55), 0) / 255;
        const g = Math.min(porcentaje * 2.55, 255) / 255;
        const b = 0; // sin componente azul
        const values = `${r} 0 0 0 0  0 ${g} 0 0 0  0 0 ${b} 0 0  0 0 0 1 0`;
        colorMatrix.setAttribute("values", values);
      }

      function animarRect(from, to, duration, callback) {
        let startTime = null;
        function animar(timestamp) {
          if (!startTime) startTime = timestamp;
          let progress = (timestamp - startTime) / duration;
          if (progress > 1) progress = 1;

          let newHeight = from + (to - from) * progress;
          let porcentaje = ((newHeight / 160) * 100).toFixed(2);
          clipRect.setAttribute("y", 160 - newHeight);
          clipRect.setAttribute("height", newHeight);
          porcentajeTexto.textContent = porcentaje + "%";

          updateColorMatrix(parseFloat(porcentaje));

          if (progress < 1) {
            requestAnimationFrame(animar);
          } else if (callback) {
            setTimeout(callback, 500);
          }
        }
        requestAnimationFrame(animar);
      }

      // Secuencia de animación:
      // 1. De 0 a 100% en 2 segundos.
      // 2. De 100 a 0 en 2 segundos.
      // 3. De 0 al valor final en 2 segundos.
      animarRect(0, 160, 800, () => {
        animarRect(160, 0, 800, () => {
          animarRect(0, (valorFinal / 100) * 160, 1600);
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const idAccion = getQueryParam("id");
      const anteriorBtn = document.getElementById("anteriorBtn");
      const siguienteBtn = document.getElementById("siguienteBtn");

      if (idAccion) {
        cargarNavegacion(idAccion);
      }

      function cargarNavegacion(idAccion) {
        const dbRef = ref(db, "PolariScore/politicas");

        get(dbRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              let politicas = snapshot.val();
              let listaAcciones = [];
              let indexActual = -1;

              // Recorrer todas las políticas y extraer sus acciones
              Object.values(politicas).forEach((politica) => {
                if (politica.objetivos_especificos && typeof politica.objetivos_especificos === "object") {
                  Object.values(politica.objetivos_especificos).forEach((objetivo) => {

                    if (objetivo.acciones && typeof objetivo.acciones === "object") {
                      // 🔥 Convertir `acciones` en un array antes de recorrerlo
                      Object.values(objetivo.acciones).forEach((accion) => {
                        listaAcciones.push(accion.id_accion);
                      });
                    }
                  });
                }
              });

              // Encontrar el índice de la acción actual en el array
              indexActual = listaAcciones.indexOf(idAccion);

              if (indexActual !== -1) {
                // Asignar eventos de clic a los botones de navegación
                anteriorBtn.addEventListener("click", () => {
                  if (indexActual > 0) {
                    window.location.href = `accion.html?id=${listaAcciones[indexActual - 1]}`;
                  }
                });

                siguienteBtn.addEventListener("click", () => {
                  if (indexActual < listaAcciones.length - 1) {
                    window.location.href = `accion.html?id=${listaAcciones[indexActual + 1]}`;
                  }
                });

                // Deshabilitar botones si no hay más acciones
                anteriorBtn.disabled = indexActual === 0;
                siguienteBtn.disabled = indexActual === listaAcciones.length - 1;
              }
            }
          })
          .catch((error) => {
            console.error("Error al obtener datos de Firebase:", error);
          });
      }
    });


    function exportarDatosAGrafica(labels, datos, nombreColumnas = ["Etiqueta", "Valor"], nombreArchivo = "datos_grafica.xlsx") {
      if (!labels || !datos || labels.length !== datos.length) {
        console.error("Error: Los datos y etiquetas deben tener la misma longitud.");
        return;
      }

      // Crear los datos para el archivo Excel
      let datosExcel = labels.map((label, index) => ({
        [nombreColumnas[0]]: label,
        [nombreColumnas[1]]: datos[index].toFixed(2) // Formatear a dos decimales
      }));

      // Convertir datos a hoja de Excel
      const ws = XLSX.utils.json_to_sheet(datosExcel);

      // Crear libro de trabajo
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Datos");

      // Descargar el archivo
      XLSX.writeFile(wb, nombreArchivo);
    }
    window.exportarDatosAGrafica = exportarDatosAGrafica;

    function exportarGrafica(idCanvas, nombreArchivo = "grafica.png", scaleFactor = 4) {
      const canvas = document.getElementById(idCanvas);
      if (!canvas) {
        console.error("El canvas no se encontró.");
        return;
      }

      // Crear un canvas temporal con mayor resolución
      const canvasExport = document.createElement("canvas");
      const ctxExport = canvasExport.getContext("2d");

      // Ajustar tamaño del nuevo canvas para mayor resolución
      canvasExport.width = canvas.width * scaleFactor;
      canvasExport.height = canvas.height * scaleFactor;

      // Mejorar la calidad del renderizado
      ctxExport.imageSmoothingEnabled = true;
      ctxExport.imageSmoothingQuality = "high";

      // Dibujar la gráfica en el nuevo canvas con mayor resolución
      ctxExport.scale(scaleFactor, scaleFactor);
      ctxExport.drawImage(canvas, 0, 0);

      // Convertir a imagen en formato PNG con calidad máxima
      const imagen = canvasExport.toDataURL("image/png", 1.0);

      // Crear un enlace de descarga
      const link = document.createElement("a");
      link.href = imagen;
      link.download = nombreArchivo;

      // Simular clic para descargar la imagen
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.exportarGrafica = exportarGrafica;

    const auth = getAuth(app);

    // Obtener el botón de login/logout
    const logButton = document.getElementById("logButton");

    // Variable para evitar agregar múltiples event listeners
    let logoutListenerAdded = false;

    // Función para mostrar elementos según los roles del usuario (disponible globalmente)
    window.mostrarElementosDinamicos = function (rolesUsuario = []) {
      if (!Array.isArray(rolesUsuario)) {
        console.error("⚠️ Error: rolesUsuario no es un array. Valor recibido:", rolesUsuario);
        rolesUsuario = []; // Asignar un array vacío si es incorrecto
      }

      setTimeout(() => {
        // Ocultar todos los elementos antes de mostrarlos según el rol
        document.querySelectorAll(".admin-only, .admin-polariscore-only, .responsable-polariscore-only").forEach(el => {
          el.style.display = "none";
        });

        // Mostrar solo los elementos que coincidan con los roles del usuario
        if (rolesUsuario.includes("admin")) {
          document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
        }
        if (rolesUsuario.includes("admin-polariscore")) {
          document.querySelectorAll(".admin-polariscore-only").forEach(el => el.style.display = "block");
        }
        if (rolesUsuario.includes("responsable-polariscore")) {
          document.querySelectorAll(".responsable-polariscore-only").forEach(el => el.style.display = "block");
        }
      }, 50);
    };

    // Escuchar cambios en el estado de autenticación
    onAuthStateChanged(auth, (user) => {
      console.log("Usuario autenticado:", user); // 🚀 Verifica si el usuario está autenticado

      if (user) {
        logButton.textContent = "Cerrar sesión";
        logButton.classList.remove("btn-primary");
        logButton.classList.add("btn-danger");

        // Mostrar foto y nombre de perfil
        const nombreCompleto = user.displayName || user.email || "Usuario";
        window.correoUsuario = user.email;
        const nombreCorto = obtenerNombreCorto(nombreCompleto);
        window.nombreCompleto = nombreCompleto;
        const foto = user.photoURL
          ? user.photoURL
          : `https://ui-avatars.com/api/?name=${encodeURIComponent(nombreCorto)}&background=0D8ABC&color=fff&rounded=true&size=64`;

        window.userFoto = foto;
        if (document.getElementById("nombrePerfilUsuario")) {
          document.getElementById("nombrePerfilUsuario").textContent = nombreCompleto;
          document.getElementById("correoPerfilUsuario").textContent = user.email;

        }


        if (document.getElementById("imgPerfilUsuario")) {
          document.getElementById("imgPerfilUsuario").src = foto;
          document.getElementById("imgPerfilUsuario").alt = nombreCorto;
          document.getElementById("imgPerfilUsuario").title = nombreCorto;
        }

        if (document.getElementById("imgPerfilUsuarioDropdown")) {
          document.getElementById("imgPerfilUsuarioDropdown").src = foto;
          document.getElementById("imgPerfilUsuarioDropdown").alt = nombreCorto;
          document.getElementById("imgPerfilUsuarioDropdown").title = nombreCorto;
        }



        // Manejo del logout (evita agregar múltiples eventos)
        if (!logoutListenerAdded) {
          logButton.addEventListener("click", () => {
            let logoutModal = new bootstrap.Modal(document.getElementById("logoutModal"));
            logoutModal.show();

            document.getElementById("confirmLogout").addEventListener("click", () => {
              signOut(auth).then(() => {
                window.location.href = "../pages/sign-in.html";
              }).catch((error) => {
                console.error("Error al cerrar sesión:", error);
                mostrarToast("Error al cerrar sesión.", "danger");
              });
            });
          });
          logoutListenerAdded = true;
        }

        // Obtener los roles del usuario desde Firebase Database
        const correoSanitizado = user.email.replace(/\./g, '_');
        const userRef = ref(database, `usuarios/${correoSanitizado}`);

        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            const userRoles = Array.isArray(userData.roles) ? userData.roles : [];

            window.rolesUsuarioActual = userRoles; // ✅ Esto permite acceder a los roles desde cualquier lugar


            mostrarElementosDinamicos(userRoles);

            // Detectar si es admin (si cualquier rol contiene "admin", case-insensitive)
            let esAdmin = userRoles.some(r => r.toLowerCase().includes('admin'));
            window.esAdmin = esAdmin;

            updateSubirVisibility();

            if (userRoles.includes("admin")) {
              document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
            }

            if (userRoles.includes("admin-polariscore")) {
              document.querySelectorAll(".admin-polariscore").forEach(el => el.style.display = "block");
            }

            if (userRoles.includes("admin-polariscore") || userRoles.includes("responsable-polariscore")) {
              document.querySelectorAll(".admin-responsable-only").forEach(el => el.style.display = "block");
            }

            if (document.getElementById("rolesUsuario")) {
              let rolSimplificado = "Usuario"; // valor por defecto

              // Normaliza los roles a minúsculas para evitar problemas de comparación
              const rolesMinusculas = userRoles.map(r => r.toLowerCase());

              // Verifica por orden de prioridad: admin > responsable > observador
              if (rolesMinusculas.some(r => r.includes("admin"))) {
                rolSimplificado = "Admin";
              } else if (rolesMinusculas.some(r => r.includes("responsable"))) {
                rolSimplificado = "Responsable";
              } else if (rolesMinusculas.some(r => r.includes("observador"))) {
                rolSimplificado = "Observador";
              }

              document.getElementById("rolesUsuario").textContent = rolSimplificado;
            }

            // Observar cambios en el DOM
            const observer = new MutationObserver(() => {
              mostrarElementosDinamicos(userRoles);
            });
            observer.observe(document.body, { childList: true, subtree: true });

          } else {
            console.error("⚠️ No se encontró información del usuario en la base de datos.");
            mostrarToast("No se encontró la información del usuario.", "warning");
          }
        }).catch((error) => {
          console.error("❌ Error al obtener datos del usuario:", error);
          mostrarToast("Error al obtener los datos del usuario.", "danger");
        });

      } else {
        console.log("No hay usuario autenticado");

        logButton.textContent = "Iniciar Sesión";
        logButton.classList.remove("btn-danger");
        logButton.classList.remove("text-danger");
        logButton.classList.add("btn-primary");
        logButton.classList.add("text-white");

        logButton.style.backgroundColor = "#00594e";
        logButton.style.color = "#fff!important";
        logButton.addEventListener("click", () => {
          window.location.href = "../pages/sign-in.html";
        });

        mostrarElementosDinamicos([]);
      }
    });


    function obtenerNombreCorto(nombreCompleto) {
      if (!nombreCompleto) return "";
      const partes = nombreCompleto.trim().split(" ");
      if (partes.length === 1) return partes[0];
      return partes[0] + " " + partes[1];
    }



    let idEvidenciaEliminar = null;
    let idAccionEliminar = null;

    document.addEventListener("click", function (e) {
      if (e.target.closest(".btnEliminarEvidencia")) {
        const boton = e.target.closest(".btnEliminarEvidencia");

        // Obtener valores directamente desde el botón
        idEvidenciaEliminar = boton.getAttribute("data-id");
        idAccionEliminar = boton.getAttribute("data-id-accion");

        const modalAbierto = document.querySelector(".modal.show");
        if (modalAbierto) {
          bootstrap.Modal.getInstance(modalAbierto).hide();
        }

        // Mostrar modal de confirmación
        setTimeout(() => {
          const modal = new bootstrap.Modal(document.getElementById("modalEliminarEvidencia"));
          modal.show();
        }, 300);
      }
    });

    document.getElementById("confirmarEliminarEvidencia").addEventListener("click", () => {
      if (!idEvidenciaEliminar || !idAccionEliminar) {
        mostrarToast("⚠️ No se puede eliminar la evidencia. Datos incompletos.", "danger");
        return;
      }

      // Crear la referencia a la evidencia con la nueva estructura de rutas
      const evidenciaRef = ref(db, `PolariScore/evidencias/${idAccionEliminar}/${idEvidenciaEliminar}`);

      set(evidenciaRef, null)
        .then(() => {
          mostrarToast("🗑️ Evidencia eliminada con éxito.", "success");

          const modal = bootstrap.Modal.getInstance(document.getElementById("modalEliminarEvidencia"));
          modal.hide();

          // Actualizar la tabla
          cargarDatosAccion(idAccionEliminar);
        })
        .catch((error) => {
          console.error("❌ Error al eliminar evidencia:", error);
          mostrarToast("❌ Error al eliminar la evidencia.", "danger");
        });
    });



    function cargarResumenPoliticaYAccion(
      idPolitica,
      tituloPolitica,
      fechaInicioPolitica,
      idAccion,
      tituloEvidencia,
      objetivoIndex,
      objetivoEspecifico
    ) {
      const contenedorResumen = document.getElementById("tab-resumen");

      if (!contenedorResumen) {
        console.warn("⚠️ No se encontró el contenedor #tab-resumen.");
        return;
      }

      const resumenHTML = `
    <div class="mt-4 mx-2 p-4 bg-light border rounded-4 shadow-sm">
      <p class="mb-4">
        Esta acción (<span class="fw-semibold text-primary">${idAccion}</span>) hace parte de la política institucional 
        <strong class="text-success">"${tituloPolitica}"</strong> (<em>${idPolitica}</em>), con fecha de inicio 
        <strong>${fechaInicioPolitica}</strong>. La acción aborda el tema <em class="text-muted">"${tituloEvidencia}"</em>, 
        perteneciente al objetivo específico <strong>#${objetivoIndex + 1}</strong>. Este resumen describe el contexto estratégico de la acción.
      </p>

      <div class="mb-4 p-3 border-start border-4 border-primary bg-white rounded-3">
        <h5 class="mb-3 text-primary fw-bold"><i class="fa-solid fa-bolt me-2"></i>Resumen de la Acción</h5>
        <p><strong>Código de Acción:</strong> ${idAccion}</p>
        <p><strong>Nombre de la Acción:</strong> ${tituloEvidencia}</p>
        <p><strong>Indicador:</strong> ${tituloEvidencia}</p>
        ${objetivoIndex !== null ? `<p><strong>Objetivo Específico:</strong> ${objetivoEspecifico}</p>` : ""}
      </div>

      <div class="mb-4 p-3 border-start border-4 border-warning bg-white rounded-3">
        <h5 class="mb-3 text-warning fw-bold"><i class="fa-solid fa-file-lines me-2"></i>Resumen de la Evidencia</h5>
        <p><strong>Nombre de la Evidencia:</strong> ${tituloEvidencia}</p>
        <p><strong>Formato:</strong> ${tituloEvidencia}</p>
      </div>

      <div class="mb-3 p-3 border-start border-4 border-success bg-white rounded-3">
        <h5 class="mb-3 text-success fw-bold"><i class="fa-solid fa-scale-balanced me-2"></i>Resumen de la Política</h5>
        <p><strong>Código:</strong> ${idPolitica}</p>
        <p><strong>Título:</strong> ${tituloPolitica}</p>
        <p><strong>Fecha de Inicio:</strong> ${fechaInicioPolitica}</p>
      </div>
    </div>
  `;

      contenedorResumen.innerHTML = resumenHTML;
    }


    // Limpia el contenido de todos los tabs de año del modal
    function limpiarTabsEvidencias(maxAnios = 6) {
      for (let i = 1; i <= maxAnios; i++) {
        const container = document.querySelector(`#anio${i} ul.list-group`);
        if (container) {
          container.innerHTML = `
        <li class="list-group-item border-0 text-center text-muted">
          Cargando evidencias...
        </li>`;
        }
      }
    }



    function claseBadgeEstado(estado = '') {
      const e = (estado || '').toLowerCase().trim();
      if (e === 'aprobado') return 'badge-estado aprobado';
      if (e === 'entrega parcial') return 'badge-estado parcial';
      if (e === 'rechazado') return 'badge-estado rechazado';
      if (e === 'en revisión' || e === 'en revision') return 'badge-estado revision';
      return 'badge-soft';
    }

    function chipFormato({ nombre, mime }) {
      let ext = '';
      if (mime) {
        ext = mime.split('/')[1] || '';
      } else if (nombre && nombre.includes('.')) {
        ext = nombre.split('.').pop();
      }
      ext = (ext || 'file').toUpperCase();
      return `<span class="evi-chip" title="Formato">${ext}</span>`;
    }

    // Render moderno de evidencia con estado interactivo si es admin
    function liUploadItem({
      upload,
      idAccion,
      idEvidencia,
      cicloKey,
      formato,
      uploadPath,        // /PolariScore/evidencias/.../uploads/...(/subKey)
      esAdmin = false
    }) {
      const fechaISO = upload.fecha_subida || upload.fechaSubida || null;
      const fecha = fechaISO ? new Date(fechaISO) : null;
      const fechaStr = fecha ? fecha.toLocaleDateString("es-CO") : "—";
      const horaStr = fecha ? fecha.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true }) : "—";

      const nombre = upload.nombre || upload.nombre_archivo || "Archivo";
      const url = upload.url || "#";
      const mime = upload.type || "";
      const icono = mime ? iconoPorMime(mime) : iconoPorFormato(formato);
      const size = upload.size ? ` • ${(upload.size / 1024 / 1024).toFixed(2)} MB` : "";

      const estado = (upload.estado || 'en revisión').toString();
      const estadoCls = claseBadgeEstado(estado);

      const descripcion = upload.descripcion || '';

      const badgeSoloLectura = `
    <span class="badge-estado-base ${estadoCls}" title="Estado de la evidencia">
      ${estado}
    </span>
  `;

      const badgeInteractivo = `
    <div class="dropdown estado-dropdown" data-upload-path="${uploadPath}">
      <a href="#" class="badge-estado-base ${estadoCls} dropdown-toggle text-decoration-none"
         data-bs-toggle="dropdown" aria-expanded="false" title="Cambiar estado">
        ${estado}
      </a>
      <ul class="dropdown-menu dropdown-menu-dark shadow">
        <li><a class="dropdown-item" href="#" data-role="estado-opcion" data-estado="aprobado"        data-upload-path="${uploadPath}">Aprobado</a></li>
        <li><a class="dropdown-item" href="#" data-role="estado-opcion" data-estado="entrega parcial" data-upload-path="${uploadPath}">Entrega parcial</a></li>
        <li><a class="dropdown-item" href="#" data-role="estado-opcion" data-estado="rechazado"       data-upload-path="${uploadPath}">Rechazado</a></li>
        <li><a class="dropdown-item" href="#" data-role="estado-opcion" data-estado="en revisión"     data-upload-path="${uploadPath}">En revisión</a></li>
      </ul>
    </div>
  `;

      return `
    <li class="list-group-item border-0 px-0 mb-3">
      <div class="evi-card d-flex align-items-start gap-3">
        <!-- Icono -->
        <div class="evi-icon flex-shrink-0"><i class="${icono}"></i></div>

        <!-- Contenido -->
        <div class="flex-grow-1 min-w-0">
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <h6 class="evi-title mb-0 text-truncate" title="${nombre}" style="max-width: 70%;">
              ${typeof limitarTexto === 'function' ? limitarTexto(nombre, 72) : nombre}
            </h6>
            <div class="d-flex align-items-center gap-2">
              ${chipFormato({ nombre, mime })}
              ${esAdmin && uploadPath ? badgeInteractivo : badgeSoloLectura}
            </div>
          </div>

          ${descripcion ? `<p class="mb-2 mt-1" style="color:#cfd7da;">${descripcion}</p>` : ""}

          <div class="evi-meta d-flex flex-wrap gap-3">
            <span title="Ciclo"><i class="fa-solid fa-arrows-rotate me-1 text-gold"></i>${cicloKey}</span>
            <span title="ID evidencia"><i class="fa-regular fa-folder-open me-1 text-gold"></i>${idEvidencia}</span>

            <!-- FECHA -->
            <span title="Fecha" class="d-inline-flex align-items-center gap-1">
              <i class="fa-regular fa-calendar me-1 text-gold ${esAdmin ? 'cursor-pointer' : ''}"
                 role="button" tabindex="0" aria-label="Editar fecha"
                 data-role="evi-fecha-trigger"
                 data-upload-path="${uploadPath}"
                 data-fecha-iso="${fechaISO || ''}"></i>
              <span
                data-role="evi-fecha"
                data-upload-path="${uploadPath}"
                data-fecha-iso="${fechaISO || ''}"
                class="${esAdmin ? 'cursor-pointer' : ''}"
                title="${fechaISO || ''}"
              >${fechaStr}</span>
            </span>

            <!-- HORA -->
            <span title="Hora" class="d-inline-flex align-items-center gap-1">
              <i class="fa-regular fa-clock me-1 text-gold ${esAdmin ? 'cursor-pointer' : ''}"
                 role="button" tabindex="0" aria-label="Editar hora"
                 data-role="evi-hora-trigger"
                 data-upload-path="${uploadPath}"
                 data-fecha-iso="${fechaISO || ''}"></i>
              <span
                data-role="evi-hora"
                data-upload-path="${uploadPath}"
                data-fecha-iso="${fechaISO || ''}"
                class="${esAdmin ? 'cursor-pointer' : ''}"
                title="${fechaISO || ''}"
              >${horaStr}</span>
            </span>

            <span title="Tamaño aproximado">${size}</span>
          </div>
        </div>

        <!-- Acciones -->
        <div class="ms-auto d-flex align-items-center evi-actions flex-wrap">
          <button class="btn btn-ghost btn-sm"
            title="Observaciones" type="button"
            data-role="abrir-observaciones"
            data-id-accion="${idAccion}"
            data-id-evidencia="${idEvidencia}"
            data-ciclo="${cicloKey}"
            data-titulo="${descripcion || nombre}">
            <i class="fa-regular fa-comments"></i>
          </button>

          <a href="${url}" target="_blank" class="btn btn-ghost btn-sm" title="Ver / Descargar">
            <i class="fa-solid fa-arrow-up-right-from-square"></i>
          </a>

          ${esAdmin && uploadPath
          ? `<button class="btn btn-ghost btn-sm text-danger"
                   title="Eliminar este archivo"
                   type="button"
                   data-role="eliminar-upload"
                   data-upload-path="${uploadPath}"
                   data-nombre="${(nombre || '').replace(/"/g, '&quot;')}">
                   <i class="fa-regular fa-trash-can"></i>
                 </button>`
          : ''
        }
        </div>
      </div>
    </li>
  `;
    }

    // Eliminar un upload (nodo en RTDB) con confirmación
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-role="eliminar-upload"]');
      if (!btn) return;

      const esAdmin = Array.isArray(window.rolesUsuarioActual) &&
        window.rolesUsuarioActual.includes('admin-polariscore');
      if (!esAdmin) {
        mostrarToast?.('🔒 No tienes permisos para eliminar.', 'warning');
        return;
      }

      const uploadPath = btn.getAttribute('data-upload-path');
      const nombre = btn.getAttribute('data-nombre') || 'archivo';

      if (!uploadPath) return;

      // Confirmación rápida (puedes reemplazar por tu modal Bootstrap si prefieres)
      const ok = window.confirm(`¿Eliminar definitivamente "${nombre}"?\nEsta acción no se puede deshacer.`);
      if (!ok) return;

      // Opcional: deshabilitar botón mientras borra
      btn.disabled = true;

      try {
        // Elimina TODO el subárbol del upload (incluye observaciones/auditoría si están debajo)
        await remove(ref(db, uploadPath));

        // Saca el item del DOM
        const li = btn.closest('li.list-group-item');
        if (li) li.remove();

        mostrarToast?.('🗑️ Archivo eliminado.', 'success');

        // Si quieres refrescar el modal completo:
        // if (window._ctxEvidenciasModal) await cargarEvidenciasEnModalFirebase(window._ctxEvidenciasModal);

      } catch (err) {
        console.error('Error eliminando upload:', err);
        mostrarToast?.('❌ No se pudo eliminar el archivo.', 'danger');
        btn.disabled = false;
      }
    });

    // Requiere: ref, update, push, set, get, serverTimestamp y db.
    // Reusa guardarFechaUploadConAuditoria(...) y utilidades iso<->local de mi mensaje anterior.

    (function initInlineFechaEditor() {
      // Abrir editor con click en los triggers o con teclado (Enter/Espacio)
      document.addEventListener('click', handleOpen);
      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        if (e.target.matches('[data-role="evi-fecha-trigger"], [data-role="evi-hora-trigger"], [data-role="evi-fecha"], [data-role="evi-hora"]')) {
          e.preventDefault();
          handleOpen(e);
        }
      });

      async function handleOpen(e) {
        const fechaIcon = e.target.closest('[data-role="evi-fecha-trigger"]');
        const horaIcon = e.target.closest('[data-role="evi-hora-trigger"]');
        const fechaSpan = e.target.closest('[data-role="evi-fecha"]');
        const horaSpan = e.target.closest('[data-role="evi-hora"]');
        const target = fechaIcon || horaIcon || fechaSpan || horaSpan;
        if (!target) return;

        const esAdmin = Array.isArray(window.rolesUsuarioActual) &&
          window.rolesUsuarioActual.includes('admin-polariscore');
        if (!esAdmin) { mostrarToast?.('🔒 No tienes permisos para editar la fecha.', 'warning'); return; }

        const uploadPath = target.getAttribute('data-upload-path');
        if (!uploadPath) return;

        // Evita editor duplicado para el mismo upload
        if (document.querySelector(`.inline-date-editor[data-upload-path="${CSS.escape(uploadPath)}"]`)) return;

        // ISO actual
        let isoActual = target.getAttribute('data-fecha-iso') || '';
        if (!isoActual) {
          try {
            const snap = await get(ref(db, uploadPath));
            const data = snap.exists() ? (snap.val() || {}) : {};
            isoActual = data.fecha_subida || data.fechaSubida || '';
          } catch { }
        }

        // Contenedor popover
        const hostRect = target.getBoundingClientRect();
        const editor = document.createElement('div');
        editor.className = 'inline-date-editor';
        editor.dataset.uploadPath = uploadPath;
        Object.assign(editor.style, {
          position: 'absolute',
          zIndex: 1080,
          background: '#1f2a31',
          border: '1px solid #334048',
          borderRadius: '.5rem',
          padding: '.5rem',
          boxShadow: '0 10px 30px rgba(0,0,0,.4)',
          top: `${hostRect.bottom + window.scrollY + 6}px`,
          left: `${Math.min(hostRect.left + window.scrollX, window.scrollX + document.documentElement.clientWidth - 300)}px`,
          width: 'min(300px, 92vw)'
        });

        const tieneFlatpickr = typeof window.flatpickr === 'function';
        editor.innerHTML = `
  <div class="inline-editor-row d-flex align-items-center gap-2">
    ${tieneFlatpickr ? `
      <input type="text" class="form-control form-control-sm flex-grow-1" id="fpInlineInput">
      
      <button class="btn btn-secondary btn-sm" data-role="inline-cancel">Cancelar</button>
      <button class="btn btn-primary btn-sm" data-role="inline-save">Guardar</button>
    ` : `
      <input type="datetime-local" class="form-control form-control-sm flex-grow-1" id="nativeDtLocal">
      
      <button class="btn btn-secondary btn-sm" data-role="inline-cancel">Cancelar</button>
      <button class="btn btn-primary btn-sm" data-role="inline-save">Guardar</button> 
    `}
  </div>
  <!-- Aquí se pintará el calendario para que NO tape los botones -->
  <div id="fpHolder" class="mt-2"></div>
`;

        document.body.appendChild(editor);

        let currentISO = isoActual;
        let fpInstance = null;

        if (tieneFlatpickr) {
          const input = editor.querySelector('#fpInlineInput');
          const holder = editor.querySelector('#fpHolder');

          fpInstance = flatpickr(input, {
            enableTime: true,
            time_24hr: false,
            dateFormat: 'Y-m-d H:i',
            allowInput: true,
            defaultDate: isoActual ? new Date(isoActual) : new Date(),

            // 👇 clave: calendario dentro del editor y sin cerrar al seleccionar
            appendTo: holder,
            static: true,
            closeOnSelect: false,

            onChange: (dates) => {
              const d = dates?.[0];
              if (d && !isNaN(d.getTime())) currentISO = d.toISOString();
            }
          });

          // Abre el calendario inmediatamente
          setTimeout(() => fpInstance.open(), 0);
        } else {
          const n = editor.querySelector('#nativeDtLocal');
          n.value = isoToDatetimeLocal(isoActual) || isoToDatetimeLocal(new Date().toISOString());
        }

        // Evitar que clicks dentro del editor se propaguen al documento (y lo cierren)
        const stopInside = (ev) => ev.stopPropagation();
        editor.addEventListener('mousedown', stopInside);
        editor.addEventListener('click', stopInside);

        // Cerrar solo si el click fue afuera del editor Y del calendario
        const onDocPointerDown = (ev) => {
          const clickedInsideEditor = editor.contains(ev.target);
          const clickedOnTrigger = target.contains(ev.target);
          const clickedInsideCalendar = !!(fpInstance && fpInstance.calendarContainer && fpInstance.calendarContainer.contains(ev.target));
          if (clickedInsideEditor || clickedOnTrigger || clickedInsideCalendar) return;
          cleanup();
        };
        setTimeout(() => document.addEventListener('mousedown', onDocPointerDown, true), 0);

        // Botones del editor
        editor.addEventListener('click', async (ev) => {
          const cancel = ev.target.closest('[data-role="inline-cancel"]');
          const save = ev.target.closest('[data-role="inline-save"]');
          if (!cancel && !save) return;
          ev.preventDefault();

          if (cancel) { cleanup(); return; }

          let isoNueva = currentISO;
          if (!tieneFlatpickr) {
            const n = editor.querySelector('#nativeDtLocal');
            const localVal = (n?.value || '').trim();
            if (!localVal) { mostrarToast?.('⏱️ Ingresa una fecha válida.', 'warning'); return; }
            isoNueva = datetimeLocalToIso(localVal);
          }
          if (!isoNueva) { mostrarToast?.('⏱️ Fecha inválida.', 'warning'); return; }

          const btn = editor.querySelector('[data-role="inline-save"]');
          btn.disabled = true;
          try {
            await guardarFechaUploadConAuditoria(uploadPath, {
              fechaIsoAnterior: isoActual || null,
              fechaIsoNueva: isoNueva,
              motivo: 'Edición rápida inline'
            });

            const mov = await moverUploadSiCambiaCiclo(uploadPath, isoNueva);
            if (mov.moved) {
              mostrarToast?.(`📦 Movido al ciclo ${mov.newCicloKey}.`, 'info');
              if (window._ctxEvidenciasModal && typeof cargarEvidenciasEnModalFirebase === 'function') {
                await cargarEvidenciasEnModalFirebase(window._ctxEvidenciasModal);
              }
            }


            // Refrescar UI y propagar nueva ISO a los elementos relacionados
            actualizarUIFechaHora(uploadPath, isoNueva);
            document.querySelectorAll(`[data-upload-path="${CSS.escape(uploadPath)}"][data-fecha-iso]`)
              .forEach(el => el.setAttribute('data-fecha-iso', isoNueva));

            mostrarToast?.('✅ Fecha actualizada.', 'success');
            cleanup();
          } catch (e) {
            console.error(e);
            mostrarToast?.('⚠️ No se pudo actualizar la fecha.', 'danger');
            btn.disabled = false;
          }
        });

        // Cerrar con Escape
        const onKeydown = (ev) => { if (ev.key === 'Escape') cleanup(); };
        document.addEventListener('keydown', onKeydown);

        function cleanup() {
          document.removeEventListener('mousedown', onDocPointerDown, true);
          document.removeEventListener('keydown', onKeydown);
          try { fpInstance?.destroy?.(); } catch { }
          editor.remove();
        }
      }
    })();

    // ==== UTILIDADES GLOBALES ====

    // Guarda la fecha y audita el cambio
    async function guardarFechaUploadConAuditoria(uploadPath, { fechaIsoAnterior, fechaIsoNueva, motivo }) {
      const path = (uploadPath || '').replace(/\/+$/, '');
      const userId = window?.usuarioActual?.uid || window?.usuarioActual?.email || 'sistema';
      const now = typeof serverTimestamp === 'function' ? serverTimestamp() : Date.now();

      // Actualiza ambos campos por compatibilidad
      await update(ref(db, path), {
        fecha_subida: fechaIsoNueva,
        fechaSubida: fechaIsoNueva,
        fecha_editada_en: now,
        fecha_editada_por: userId
      });

      // Auditoría detallada
      const auditRef = ref(db, `${path}/auditoria_cambios`);
      const itemRef = push(auditRef);
      await set(itemRef, {
        tipo_cambio: 'cambio_fecha_upload',
        fecha_anterior: fechaIsoAnterior || null,
        fecha_nueva: fechaIsoNueva,
        motivo: motivo || null,
        realizado_por: userId,
        realizado_en: now
      });
    }

    // Convierte ISO -> valor para <input type="datetime-local">
    function isoToDatetimeLocal(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '';
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // Convierte "YYYY-MM-DDTHH:MM" (local) -> ISO (manteniendo la intención local)
    function datetimeLocalToIso(localStr) {
      const [datePart, timePart] = (localStr || '').split('T');
      if (!datePart || !timePart) return null;
      const [Y, M, D] = datePart.split('-').map(Number);
      const [h, m] = timePart.split(':').map(Number);
      const d = new Date(Y, M - 1, D, h, m, 0, 0);
      return d.toISOString();
    }

    // Refresca los spans visibles (fecha y hora) que correspondan al uploadPath
    function actualizarUIFechaHora(uploadPath, nuevaIso) {
      const d = new Date(nuevaIso);
      const fechaStr = isNaN(d.getTime()) ? '—' : d.toLocaleDateString('es-CO');
      const horaStr = isNaN(d.getTime()) ? '—' : d.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true });
      const fechaEl = document.querySelector(`[data-role="evi-fecha"][data-upload-path="${CSS.escape(uploadPath)}"]`);
      const horaEl = document.querySelector(`[data-role="evi-hora" ][data-upload-path="${CSS.escape(uploadPath)}"]`);
      if (fechaEl) fechaEl.textContent = fechaStr;
      if (horaEl) horaEl.textContent = horaStr;
    }

    /**
     * Carga SOLO la evidencia seleccionada en el modal, repartiendo sus uploads por año (tabs #anio1..#anio6).
     * params: { idPolitica, objetivoIndex, idAccion, idEvidencia, tituloEvidencia, formatoEvidencia, tituloPolitica, fechaInicioPolitica, objetivoEspecifico }
     */
    async function cargarEvidenciasEnModalFirebase(params) {
      const {
        idPolitica, objetivoIndex, idAccion, idEvidencia, tituloEvidencia, formatoEvidencia, tituloPolitica, fechaInicioPolitica, objetivoEspecifico
      } = params || {};

      window._ctxEvidenciasModal = params;

      // Título del modal
      document.getElementById("tituloEvidencias").textContent =
        (typeof limitarTexto === 'function' ? limitarTexto(tituloEvidencia || "Evidencia", 50) : (tituloEvidencia || "Evidencia"));

      // Limpia tabs y muestra modal
      limpiarTabsEvidencias(6);
      const modalEl = document.getElementById('evidenciasModal');
      if (modalEl && typeof bootstrap !== 'undefined') {
        const m = bootstrap.Modal.getOrCreateInstance(modalEl);
        m.show();
      }

      // Validaciones mínimas
      if (!idAccion || !idEvidencia || !fechaInicioPolitica) {
        console.warn("Faltan parámetros para cargar la evidencia en el modal.");
        // pinta vacío amigable
        for (let i = 1; i <= 6; i++) {
          const container = document.querySelector(`#anio${i} ul.list-group`);
          if (container) {
            container.innerHTML = `
          <li class="list-group-item border-0 text-center text-muted">
            No hay evidencias registradas para este año.
          </li>`;
          }
        }
        return;
      }

      cargarResumenPoliticaYAccion(
        idPolitica,
        tituloPolitica,
        fechaInicioPolitica,
        idAccion,
        tituloEvidencia,
        objetivoIndex,
        objetivoEspecifico
      )

      // Año de inicio de la política (dd/mm/aaaa)
      const partes = fechaInicioPolitica.split("/");
      const anioInicio = parseInt(partes[2], 10);
      if (isNaN(anioInicio)) {
        console.warn("fechaInicioPolitica inválida:", fechaInicioPolitica);
        return;
      }

      // Leer SOLO la evidencia seleccionada
      // /PolariScore/evidencias/{idAccion}/{idEvidencia}/uploads
      const uploadsSnap = await get(ref(db, `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads`));

      // Construye buffers por tab
      const tabs = { anio1: "", anio2: "", anio3: "", anio4: "", anio5: "", anio6: "" };

      let mensajes = [];

      if (uploadsSnap.exists()) {
        const uploadsAll = uploadsSnap.val(); // { "2025_1": {...}, "2025_2": {...}, ... }

        // Recorre cicloKey (AAAA_N)
        for (const cicloKey in uploadsAll) {
          const [anioStr] = cicloKey.split("_");
          const anio = parseInt(anioStr, 10);
          if (isNaN(anio)) continue;

          const diff = anio - anioInicio; // 0=>anio1, 1=>anio2...
          const tabKey = `anio${diff + 1}`;
          if (!tabs.hasOwnProperty(tabKey)) continue; // fuera de rango 1..6

          const nodo = uploadsAll[cicloKey];

          mensajes = nodo;

          // Detecta si es objeto directo (url/nombre) o múltiples hijos
          const esDirecto = nodo && typeof nodo === "object" &&
            ("url" in nodo || "nombre" in nodo || "fecha_subida" in nodo || "fechaSubida" in nodo);

          const esAdmin =
            Array.isArray(window.rolesUsuarioActual) &&
            window.rolesUsuarioActual.includes('admin-polariscore');

          if (esDirecto) {
            // Upload directo
            tabs[tabKey] += liUploadItem({
              upload: nodo,
              idAccion,                       // ✅ pásalo
              idEvidencia,
              cicloKey,
              formato: formatoEvidencia,
              uploadPath: `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${cicloKey}`, // ✅
              esAdmin                                                              // ✅
            });
          } else {
            // Upload con hijos
            for (const sub in nodo) {
              const up = nodo[sub];
              if (up && typeof up === "object") {
                tabs[tabKey] += liUploadItem({
                  upload: up,
                  idAccion,                   // ✅ pásalo
                  idEvidencia,
                  cicloKey,
                  formato: formatoEvidencia,
                  uploadPath: `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${cicloKey}/${sub}`, // ✅
                  esAdmin                                                          // ✅
                });
              }
            }
          }

        }
      }



      // Pintar en DOM
      for (let i = 1; i <= 6; i++) {
        const container = document.querySelector(`#anio${i} ul.list-group`);
        if (!container) continue;
        const key = `anio${i}`;
        container.innerHTML = tabs[key] || `
      <li class="list-group-item border-0 text-center text-muted">
        No hay evidencias registradas para este año.
      </li>`;
      }

      // Opcional: activar automáticamente el tab del primer año con contenido
      const firstWithData = Object.keys(tabs).find(k => tabs[k] && tabs[k].trim() !== "");
      if (firstWithData) {
        const idx = parseInt(firstWithData.replace("anio", ""), 10);
        // activar botón y pane
        const btn = document.getElementById(`anio${idx}-tab`);
        if (btn) new bootstrap.Tab(btn).show();
      } else {
        // si no hay datos, deja Año 1 activo (default del HTML)
      }

      // Cualquier post-procesamiento visual
      if (typeof mostrarElementosDinamicos === "function") {
        setTimeout(() => mostrarElementosDinamicos(), 50);
      }


    }


    // Extrae partes del uploadPath:
    // /PolariScore/evidencias/{idAccion}/{idEvidencia}/uploads/{cicloKey}(/subKey)
    // /PolariScore/evidencias/{idAccion}/{idEvidencia}/uploads/{cicloKey}(/subKey)
    function parseUploadPath(uploadPath) {
      const parts = (uploadPath || '').split('/').filter(Boolean);
      const idx = parts.indexOf('uploads');
      if (idx < 0 || !parts[idx + 1]) throw new Error('uploadPath inválido');
      const baseUploadsPath = '/' + parts.slice(0, idx + 1).join('/'); // .../uploads
      const cicloKey = parts[idx + 1];                                 // 2025_2
      const subKey = parts[idx + 2] || null;                         // hijo opcional
      return { baseUploadsPath, cicloKey, subKey };
    }

    function buildNewCicloKey(oldCicloKey, newYear) {
      const [, tail] = String(oldCicloKey).split('_'); // e.g. "2"
      return tail ? `${newYear}_${tail}` : `${newYear}`;
    }

    async function moverUploadSiCambiaCiclo(oldUploadPath, nuevaIso) {
      const { baseUploadsPath, cicloKey: oldCicloKey, subKey } = parseUploadPath(oldUploadPath);
      const oldYear = parseInt(String(oldCicloKey).split('_')[0], 10);
      const newYear = new Date(nuevaIso).getFullYear();
      if (isNaN(oldYear) || isNaN(newYear) || oldYear === newYear) return { moved: false };

      // 1) lee el nodo actual
      const snap = await get(ref(db, oldUploadPath));
      if (!snap.exists()) return { moved: false };
      const data = snap.val();
      data.fecha_subida = nuevaIso;
      data.fechaSubida = nuevaIso;

      // 2) calcula destino (evita colisión si ya existe)
      const newCicloKey = buildNewCicloKey(oldCicloKey, newYear);
      const baseDest = `${baseUploadsPath}/${newCicloKey}`; // .../uploads/2023_2
      let finalNewPath;

      if (subKey) {
        finalNewPath = `${baseDest}/${subKey}`;
      } else {
        const destSnap = await get(ref(db, baseDest));
        if (!destSnap.exists()) {
          finalNewPath = baseDest; // nodo directo
        } else {
          const autoId = push(ref(db, baseDest)).key; // evita overwrite
          finalNewPath = `${baseDest}/${autoId}`;
        }
      }

      // 3) MOVE atómico: copiar nuevo + borrar viejo (SIN auditoría aquí)
      const updates = {};
      updates[finalNewPath] = data;
      updates[oldUploadPath] = null;
      await update(ref(db), updates);

      // 4) Auditoría en una segunda operación (para no violar la restricción padre/hijo)
      const now = typeof serverTimestamp === 'function' ? serverTimestamp() : Date.now();
      const userId = window?.usuarioActual?.uid || window?.usuarioActual?.email || 'sistema';
      const auditRef = push(ref(db, `${finalNewPath}/auditoria_cambios`));
      await set(auditRef, {
        tipo_cambio: 'movimiento_ciclo',
        desde: oldUploadPath,
        hacia: finalNewPath,
        realizado_por: userId,
        realizado_en: now,
        motivo: 'Cambio de fecha que altera el año del ciclo'
      });

      return { moved: true, newPath: finalNewPath, newCicloKey, oldCicloKey };
    }

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-role="abrir-observaciones"]');
      if (!btn) return;

      const idAccion = btn.getAttribute('data-id-accion');
      const idEvidencia = btn.getAttribute('data-id-evidencia');
      const cicloKey = btn.getAttribute('data-ciclo');          // p.ej. "2025_2"
      const titulo = btn.getAttribute('data-titulo') || '';

      abrirObservacionesModal({ idAccion, idEvidencia, cicloKey, tituloEvidencia: titulo });
    });
    //OBSERVACIONES
    // Datos de prueba
    let idEvidenciaPrueba = "EV001";

    let mensajesPrueba = [
      {
        tipo: "responsable",
        nombre: "Juan Pérez",
        mensaje: "Buenas tardes, adjunto la evidencia solicitada.",
        fecha: "2025-08-13 14:35",
        timestamp: 1723553700000,
        imgUrl: ""
      },
      {
        tipo: "admin",
        nombre: "Administrador",
        mensaje: "Gracias Juan, voy a revisarla y te confirmo.",
        fecha: "2025-08-13 14:40",
        timestamp: 1723554000000,
        imgUrl: ""

      },
      {
        tipo: "responsable",
        nombre: "Juan Pérez",
        mensaje: "Perfecto, quedo pendiente de tus comentarios.",
        fecha: "2025-08-13 14:42",
        timestamp: 1723554120000,
        imgUrl: ""
      }
    ];



    function abrirObservacionesModal({ idAccion, idEvidencia, cicloKey, tituloEvidencia }) {
      // Cerrar otro modal abierto si aplica
      const abierto = document.querySelector('.modal.show');
      if (abierto) bootstrap.Modal.getInstance(abierto)?.hide();

      const modal = document.getElementById('observacionesModal');
      modal.dataset.idAccion = idAccion;
      modal.dataset.idEvidencia = idEvidencia;
      modal.dataset.cicloKey = cicloKey;

      const tituloSpan = document.getElementById('tituloEvidenciaModal');
      if (tituloSpan) tituloSpan.textContent = ` - ${tituloEvidencia || ''}`;

      setTimeout(() => {
        bootstrap.Modal.getOrCreateInstance(modal).show();
        // Cargar mensajes (usa UNA de las dos funciones: GET único o listener en vivo)
        cargarObservacionesDesdeFirebase({ idAccion, idEvidencia, cicloKey });           // Lectura única
        // cargarObservacionesEnVivo({ idAccion, idEvidencia, cicloKey });               // 🔄 En vivo
      }, 200);
    }


    // Utilidad: obtener el rol principal del usuario (admin/responsable)
    function getRolUsuarioActual() {
      if (window.rolesUsuarioActual.includes('admin-polariscore')) return 'admin';
      if (window.rolesUsuarioActual.includes('responsable-polariscore')) return 'responsable';
      return null; // otro rol/no definido
    }

    function getAvatarPorRolFallback(rol) {
      if (rol === 'admin') return '../assets/img/admin.jpg';
      if (rol === 'responsable') return '../assets/img/responsable.jpg';
      return 'https://ui-avatars.com/api/?name=Usuario&background=0D8ABC&color=fff&rounded=true&size=64';
    }



    async function cargarObservacionesDesdeFirebase({ idAccion, idEvidencia, cicloKey }) {
      const lista = document.getElementById('listaMensajes');
      const chatBox = document.getElementById('chatObservaciones');
      if (lista) lista.innerHTML = `<li class="text-center text-muted">Cargando mensajes...</li>`;

      try {
        const obsPath = `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${cicloKey}/observaciones`;
        const obsRef = ref(db, obsPath);
        const snap = await get(obsRef);

        let mensajes = [];
        if (snap.exists()) {
          const val = snap.val(); // {key: {...}, key2: {...}}
          mensajes = Object.values(val).filter(v => v && typeof v === 'object');
        }

        cargarMensajesObservaciones(idEvidencia, mensajes);
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        console.error('Error leyendo observaciones:', e);
        if (lista) lista.innerHTML = `<li class="text-center text-muted">No fue posible cargar las observaciones.</li>`;
      }
    }


    // Cargar los mensajes en el modal con lógica emisor/receptor
    function cargarMensajesObservaciones(idEvidencia, mensajes) {
      const listaMensajes = document.getElementById("listaMensajes");
      const chatBox = document.getElementById("chatObservaciones");
      listaMensajes.innerHTML = ""; // Limpiar

      const rolActual = getRolUsuarioActual();

      // Orden cronológico ascendente
      mensajes.sort((a, b) => a.timestamp - b.timestamp);

      mensajes.forEach(msg => {
        const esEmisor = rolActual && msg.tipo === rolActual;

        // Clases y estilos según emisor/receptor
        const alineacion = esEmisor ? "justify-content-end" : "justify-content-start";
        const estiloMensaje = esEmisor ? "bg-primary text-white" : "bg-light text-dark";

        // Avatar: primero el que viene en la observación (msg.imgUrl).
        // Si no está, fallback: si es emisor => window.userFoto; si no => avatar por rol.
        const avatar = msg.imgUrl
          ? msg.imgUrl
          : (esEmisor ? (window.userFoto || getAvatarPorRolFallback(rolActual))
            : getAvatarPorRolFallback(msg.tipo));

        const fechaMostrada = msg.fecha || new Date(msg.timestamp).toLocaleString('es-CO');

        const li = document.createElement("li");
        li.classList.add("d-flex", "mb-3", alineacion);

        const avatarIzq = !esEmisor
          ? `<img src="${avatar}" alt="Perfil" class="rounded-circle shadow-sm me-2" style="width:40px;height:40px;object-fit:cover;">`
          : "";

        const avatarDer = esEmisor
          ? `<img src="${avatar}" alt="Perfil" class="rounded-circle shadow-sm ms-2" style="width:40px;height:40px;object-fit:cover;">`
          : "";

        li.innerHTML = `
      <div class="d-flex align-items-end" style="max-width: 75%;">
        ${avatarIzq}
        <div class="p-2 rounded-3 shadow-sm ${estiloMensaje}">
          <small class="fw-bold">${msg.nombre || (msg.tipo === 'admin' ? 'Administrador' : 'Responsable')}</small>
          <p class="mb-1">${msg.mensaje || ''}</p>
          <small class="${estiloMensaje} d-block text-end" style="font-size:0.8rem;">${fechaMostrada}</small>
        </div>
        ${avatarDer}
      </div>
    `;

        listaMensajes.appendChild(li);
      });

      // Desplazar hacia el último mensaje
      if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }

    let unsubObservaciones = null; // guarda el listener para poder limpiarlo si cambias de evidencia

    function cargarObservacionesEnVivo({ idAccion, idEvidencia, cicloKey }) {
      const obsPath = `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${cicloKey}/observaciones`;
      const obsRef = ref(db, obsPath);

      // Limpia listener previo si existía
      if (typeof unsubObservaciones === 'function') unsubObservaciones();

      const off = onValue(obsRef, (snap) => {
        let mensajes = [];
        if (snap.exists()) {
          const val = snap.val();
          mensajes = Object.values(val).filter(v => v && typeof v === 'object');
        }
        cargarMensajesObservaciones(idEvidencia, mensajes);
        const chatBox = document.getElementById('chatObservaciones');
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
      }, (err) => {
        console.error('onValue observaciones error:', err);
      });

      // Guarda función de cleanup
      unsubObservaciones = () => off(); // en v9 onValue devuelve la función para desuscribirse
    }



    async function enviarMensajeObservacion() {
      const modal = document.getElementById('observacionesModal');
      const input = document.getElementById('mensajeObservacion');
      const chatBox = document.getElementById('chatObservaciones');

      if (!modal || !input) return;

      const texto = (input.value || '').trim();
      if (!texto) return;

      const idAccion = modal.dataset.idAccion;
      const idEvidencia = modal.dataset.idEvidencia;
      const cicloKey = modal.dataset.cicloKey;

      if (!idAccion || !idEvidencia || !cicloKey) {
        console.warn('Faltan parámetros de ruta (idAccion, idEvidencia, cicloKey)');
        return;
      }

      const ahora = Date.now();
      const rol = getRolUsuarioActual();

      const nuevoMensaje = {
        tipo: rol, // "admin" | "responsable"
        nombre: window.nombreCompleto || 'Usuario',
        mensaje: texto,
        fecha: new Date(ahora).toLocaleString('es-CO'),
        timestamp: ahora,
        imgUrl: window.userFoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(window.nombreCompleto || 'Usuario')}&background=0D8ABC&color=fff&rounded=true&size=64`,
        serverTime: serverTimestamp() // ⬅️ requiere el import
      };

      // Append optimista
      appendMensajeAlChat(nuevoMensaje, /*esEmisorForzado=*/true);
      if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
      input.value = '';

      try {
        const basePath = `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${cicloKey}/observaciones`;
        const obsRef = ref(db, basePath);
        const newRef = push(obsRef);
        await set(newRef, nuevoMensaje);
      } catch (err) {
        console.error('Error enviando observación:', err);
        // TODO: revertir optimista si quieres
      }
    }

    // Enviar con Enter (Shift+Enter = salto)
    document.getElementById('mensajeObservacion')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        enviarMensajeObservacion();
      }
    });

    // Click en el botón de enviar mensaje
    document.getElementById('enviarMensajeObservacion')?.addEventListener('click', () => {
      enviarMensajeObservacion();
    });



    function appendMensajeAlChat(msg, esEmisorForzado = false) {
      const listaMensajes = document.getElementById('listaMensajes');
      const chatBox = document.getElementById('chatObservaciones');
      if (!listaMensajes) return;

      const rolActual = getRolUsuarioActual();
      const esEmisor = esEmisorForzado || (rolActual && msg.tipo === rolActual);

      const alineacion = esEmisor ? 'justify-content-end' : 'justify-content-start';
      const estiloMensaje = esEmisor ? 'bg-primary text-white' : 'bg-light text-dark';

      // 1) Prioriza la imagen que viene en el mensaje
      // 2) Si soy emisor y no hay imgUrl, usa window.userFoto
      // 3) Si no, usa un fallback por rol
      const avatar = msg.imgUrl
        ? msg.imgUrl
        : (esEmisor
          ? (window.userFoto || getAvatarPorRolFallback(rolActual))
          : getAvatarPorRolFallback(msg.tipo));

      const fechaMostrada = msg.fecha || new Date(msg.timestamp || Date.now()).toLocaleString('es-CO');

      const li = document.createElement('li');
      li.classList.add('d-flex', 'mb-3', alineacion);

      const avatarIzq = !esEmisor
        ? `<img src="${avatar}" alt="Perfil" class="rounded-circle shadow-sm me-2" style="width:40px;height:40px;object-fit:cover;">`
        : '';

      const avatarDer = esEmisor
        ? `<img src="${avatar}" alt="Perfil" class="rounded-circle shadow-sm ms-2" style="width:40px;height:40px;object-fit:cover;">`
        : '';

      li.innerHTML = `
    <div class="d-flex align-items-end" style="max-width: 75%;">
      ${avatarIzq}
      <div class="p-2 rounded-3 shadow-sm ${estiloMensaje}">
        <small class="fw-bold">${msg.nombre || (msg.tipo === 'admin' ? 'Administrador' : 'Responsable')}</small>
        <p class="mb-1">${msg.mensaje || ''}</p>
        <small class="text-muted d-block text-end" style="font-size:0.8rem;">${fechaMostrada}</small>
      </div>
      ${avatarDer}
    </div>
  `;

      // Tu contenedor usa column-reverse en el DIV, pero el UL lista normal.
      // Para mantener orden cronológico simple, añadimos al final.
      listaMensajes.appendChild(li);

      if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }


    // Requiere: ref, update, push, set, serverTimestamp de Firebase v9 y tu instancia `db`.
    document.addEventListener('click', async (e) => {
      const opt = e.target.closest('[data-role="estado-opcion"]');
      if (!opt) return;
      e.preventDefault();

      const esAdmin = Array.isArray(window.rolesUsuarioActual) &&
        window.rolesUsuarioActual.includes('admin-polariscore');
      if (!esAdmin) {
        mostrarToast?.('🔒 No tienes permisos para cambiar el estado.', 'warning');
        return;
      }

      const nuevoEstadoRaw = (opt.getAttribute('data-estado') || '').trim();
      if (!nuevoEstadoRaw) return;

      // Contenedor dropdown y ruta
      const dropdown = opt.closest('.estado-dropdown');
      const uploadPath = dropdown?.getAttribute('data-upload-path') || opt.getAttribute('data-upload-path');
      if (!uploadPath) return;

      // Evitar dobles clics mientras guarda
      if (dropdown?.dataset.saving === '1') return;
      if (dropdown) dropdown.dataset.saving = '1';

      // Elemento visible (badge)
      const toggle = dropdown ? dropdown.querySelector('.badge-estado-base') : null;
      const estadoAnterior = toggle ? toggle.textContent.trim() : null;

      // Normalizaciones
      const nuevoEstado = nuevoEstadoRaw.toLowerCase();
      const mostrar = (s) => s.charAt(0).toUpperCase() + s.slice(1);

      // UI optimista
      if (toggle) {
        toggle.textContent = mostrar(nuevoEstado);
        toggle.className = `badge-estado-base ${claseBadgeEstado(nuevoEstado)} dropdown-toggle text-decoration-none`;
      }

      try {
        // Persistencia con metadatos
        const payload = {
          estado: nuevoEstado,
          estado_actualizado_por: window?.usuarioActual?.uid || window?.usuarioActual?.email || 'sistema',
          estado_actualizado_en: serverTimestamp?.() || Date.now()
        };

        await update(ref(db, uploadPath), payload);

        // Auditoría opcional
        try {
          const auditRef = ref(db, `${uploadPath.replace(/\/+$/, '')}/auditoria_estado`);
          const itemRef = push(auditRef);
          await set(itemRef, { ...payload, _accion: 'cambio_estado' });
        } catch (e2) {
          console.warn('Auditoría de estado no registrada:', e2);
        }

        // Cerrar dropdown y toast
        try {
          const ddTrigger = dropdown?.querySelector('[data-bs-toggle="dropdown"]');
          if (ddTrigger) bootstrap.Dropdown.getOrCreateInstance(ddTrigger).hide();
        } catch { }
        mostrarToast?.('✅ Estado actualizado.', 'success');

        // Observación automática opcional (deja traza en chat)
        try {
          const obsRef = ref(db, `${uploadPath.replace(/\/+$/, '')}/observaciones`);
          const msgRef = push(obsRef);
          await set(msgRef, {
            tipo: 'sistema',
            nombre: 'Sistema',
            mensaje: `Estado cambiado a "${mostrar(nuevoEstado)}"${estadoAnterior ? ` (antes: ${estadoAnterior})` : ''}.`,
            timestamp: serverTimestamp?.() || Date.now(),
            fecha: new Date().toLocaleString('es-CO'),
            imgUrl: ''
          });
        } catch (e3) {
          console.warn('Observación automática no registrada:', e3);
        }

      } catch (err) {
        console.error('No se pudo actualizar el estado:', err);
        // Revertir UI si falla
        if (toggle && estadoAnterior) {
          toggle.textContent = estadoAnterior;
          toggle.className = `badge-estado-base ${claseBadgeEstado(estadoAnterior)} dropdown-toggle text-decoration-none`;
        }
        mostrarToast?.('⚠️ No se pudo actualizar el estado. Intenta de nuevo.', 'danger');
      } finally {
        if (dropdown) dropdown.dataset.saving = '0';
      }
    });


    //FIN DE LAS OBSERVACIONES



    function obtenerBadgeEstado(estado) {
      const estadoLimpio = estado.toLowerCase();
      const clasesBase = 'badge rounded-pill text-xs px-1.5 py-0.5';
      switch (estadoLimpio) {
        case "aprobado":
          return `<span class="${clasesBase} bg-success"><i class="fa-solid fa-check-circle me-1"></i> ${estado}</span>`;
        case "entrega parcial":
          return `<span class="${clasesBase} bg-yellow"><i class="fa-solid| fa-check-circle me-1"></i> ${estado}</span>`;
        case "rechazado":
          return `<span class="${clasesBase} bg-danger"><i class="fa-solid fa-times-circle me-1"></i> ${estado}</span>`;
        case "en revisión":
          return `<span class="${clasesBase} bg-warning text-white"><i class="fa-solid fa-hourglass-half me-1"></i> ${estado}</span>`;
        default:
          return `<span class="${clasesBase} bg-info"><i class="fa-solid fa-clock me-1"></i> ${estado}</span>`;
      }
    }




    function inicializarBotonesAbrirEvidencias() {

      const botones = document.querySelectorAll(".btnAbrirEvidencias");

      botones.forEach(boton => {

        boton.addEventListener("click", function () {

          const idEvidencia = this.dataset.id;
          const tituloEvidencia = this.dataset.titulo || "";
          const formatoEvidencia = this.dataset.formato || "";
          const idAccion = this.dataset.idAccion || "";
          const idPolitica = this.dataset.idPolitica || "";
          const tituloPolitica = this.dataset.tituloPolitica || "";
          const objetivoIndex = this.dataset.objetivoIndex;
          const fechaInicioPolitica = this.dataset.fechaInicioPolitica || "";
          const objetivoEspecifico = this.dataset.objetivoEspecifico || "";

          console.table({ idEvidencia, tituloEvidencia, idAccion, idPolitica, tituloPolitica, objetivoIndex, fechaInicioPolitica, objetivoEspecifico });

          if (!idEvidencia || !idAccion || !idPolitica || !tituloEvidencia || !objetivoIndex) {
            mostrarToast("❌ Faltan datos para abrir la evidencia.", "danger");
            console.error("🚫 Faltan datos:", { idEvidencia, idAccion, idPolitica, tituloEvidencia, objetivoIndex, objetivoEspecifico });
            return;
          }

          document.getElementById("tituloEvidencias").textContent = limitarTexto(tituloEvidencia || "Política", 50);

          cargarEvidenciasEnModalFirebase({
            idPolitica,
            objetivoIndex,
            idAccion,
            idEvidencia,
            tituloEvidencia,
            formatoEvidencia,
            tituloPolitica,
            fechaInicioPolitica,
            objetivoEspecifico
          });
        });
      });
    }


    // Helpers de ícono (ajústalos a tus clases/fa si quieres más granularidad)
    function iconoPorMime(type = "", sizeClass = "fa-lg") {
      const t = type.toLowerCase();
      if (t.includes("pdf")) return `fas fa-file-pdf ${sizeClass} text-danger`;
      if (t.includes("spreadsheet") || t.includes("excel") || t.includes("csv")) return `fas fa-file-excel ${sizeClass} text-success`;
      if (t.includes("word") || t.includes("document")) return `fas fa-file-word ${sizeClass} text-primary`;
      if (t.startsWith("image/")) return `fas fa-file-image ${sizeClass} text-info`;
      if (t.startsWith("video/")) return `fas fa-file-video ${sizeClass} text-warning`;
      if (t.startsWith("audio/")) return `fas fa-file-audio ${sizeClass} text-warning`;
      return `fas fa-file ${sizeClass} text-secondary`;
    }

    function iconoPorFormato(formato = "", sizeClass = "fa-lg") {
      const f = (formato || "").toLowerCase();
      if (f === "pdf") return `fas fa-file-pdf ${sizeClass} text-danger`;
      if (["xls", "xlsx", "excel"].includes(f)) return `fas fa-file-excel ${sizeClass} text-success`;
      if (["doc", "docx", "word"].includes(f)) return `fas fa-file-word ${sizeClass} text-primary`;
      if (["jpg", "jpeg", "png", "imagen", "image"].includes(f)) return `fas fa-file-image ${sizeClass} text-info`;
      return `fas fa-file ${sizeClass} text-secondary`;
    }



    async function calcularCumplimientoAccion(accion, anioInicio) {
      const db = getDatabase();
      const ejecutadoRef = ref(db, `PolariScore/seguimientos/${accion.id_accion}/ejecutado`);

      try {
        const snapshot = await get(ejecutadoRef);
        const ejecutadoData = snapshot.exists() ? snapshot.val() : {};
        const aniosProgramados = accion.anios || [];

        let sumaProgramado = 0;
        let sumaEjecutado = 0;

        for (let i = 0; i < aniosProgramados.length; i++) {
          const anio = anioInicio + i;
          const programado = parseFloat(aniosProgramados[i]) || 0;
          const ejecutado = parseFloat(ejecutadoData[anio]) || 0;

          sumaProgramado += programado;
          sumaEjecutado += ejecutado;
        }

        const cumplimientoTotal = sumaProgramado > 0
          ? (sumaEjecutado / sumaProgramado) * 100
          : 0;

        return parseFloat(cumplimientoTotal.toFixed(2));

      } catch (error) {
        console.error("❌ Error al calcular cumplimiento:", error);
        return 0;
      }
    }



    async function subirArchivoYGuardarRegistro(descripcion, archivo, anioTimestamp) {
      const idPolitica = document.querySelector(".btnAbrirEvidencias").dataset.idPolitica;
      const idAccion = document.querySelector(".btnAbrirEvidencias").dataset.idAccion;
      const idEvidencia = document.querySelector(".btnAbrirEvidencias").dataset.id;
      const objetivoIndex = document.querySelector(".btnAbrirEvidencias").dataset.objetivoIndex;

      console.table({ idPolitica, idAccion, idEvidencia, objetivoIndex });

      if (!idPolitica || !idAccion || !idEvidencia || !objetivoIndex) {
        throw new Error("Faltan datos clave para ubicar la evidencia en Firebase.");
      }

      const storage = getStorage();
      const db = getDatabase();

      const nombreArchivo = archivo.name;

      // ✅ Convertir timestamp a año
      const anio = new Date(parseInt(anioTimestamp) * 1000).getFullYear();


      // ✅ Ruta en Storage con año incluido
      const rutaStorage = `PlanItOne/PolariScore/politicas/${idPolitica}/objetivos_especificos/${objetivoIndex}/acciones/${idAccion}/evidencias/${idEvidencia}/uploads/${anio}/${nombreArchivo}`;
      const archivoRef = storageRef(storage, rutaStorage);

      // Subir archivo
      await uploadBytes(archivoRef, archivo);

      // Obtener URL
      const url = await getDownloadURL(archivoRef);

      // Crear registro en Realtime Database
      const uploadData = {
        descripcion: descripcion,
        nombre_archivo: nombreArchivo,
        url: url,
        fechaEvidencia: anioTimestamp, // este ya lo tienes como timestamp del año seleccionado
        fechaSubida: Math.floor(Date.now() / 1000), // ⏱️ timestamp del momento actual
        estado: "En revisión",
        observaciones: "Sin observaciones",
      };


      // ✅ Ruta con año incluido
      const uploadsRef = ref(db, `PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${anio}`);
      const nuevaRef = push(uploadsRef);

      await set(nuevaRef, uploadData);
    }
    // === Utilidades de estilo para Swal ===
    const BRAND_GREEN = "#00594E";

    // Construye una tabla HTML bonita para el Swal a partir de {año: valor}
    function buildSwalTableHTML(datosEjecutado, warnings = []) {
      const filas = Object.entries(datosEjecutado)
        .sort(([a], [b]) => Number(a) - Number(b))
        .map(([anio, val], idx) => {
          const bg = idx % 2 === 0 ? "#FFFFFF" : "#E8F4F2";
          return `<tr style="background:${bg}">
        <td style="padding:8px 10px;border:1px solid #dfe5e3">${anio}</td>
        <td style="padding:8px 10px;border:1px solid #dfe5e3">${val}</td>
      </tr>`;
        }).join("");

      const advertencias = warnings.length
        ? `<div style="margin-top:8px;color:#b45309;background:#FFF7ED;border:1px solid #FFEDD5;padding:8px;border-radius:6px">
         <strong>Advertencias:</strong>
         <ul style="margin:6px 0 0 18px">${warnings.map(w => `<li>${w}</li>`).join("")}</ul>
       </div>`
        : "";

      return `
  <div style="text-align:left">
    <table style="width:100%;border-collapse:collapse;font-family:system-ui, Arial, sans-serif">
      <thead>
        <tr>
          <th style="background:${BRAND_GREEN};color:#fff;text-transform:uppercase;letter-spacing:.02em;
                     padding:10px;border:1px solid #dfe5e3">Año</th>
          <th style="background:${BRAND_GREEN};color:#fff;text-transform:uppercase;letter-spacing:.02em;
                     padding:10px;border:1px solid #dfe5e3">Ejecutado</th>
        </tr>
      </thead>
      <tbody>${filas}</tbody>
    </table>
    ${advertencias}
  </div>`;
    }

    // === Cargar datos en tabs (agrega logs de depuración) ===
    async function cargarDatosEvaluacionEnTabs(idPolitica, objetivoIndex, idAccion, fechaInicioPolitica) {
      console.groupCollapsed("[Eval/Tabs] Iniciando carga de datos");
      console.log({ idPolitica, objetivoIndex, idAccion, fechaInicioPolitica });

      const db = getDatabase();
      const aniosRef = ref(db, `PolariScore/politicas/${idPolitica}/objetivos_especificos/${objetivoIndex}/acciones/${idAccion}/anios`);
      const ejecutadoRef = ref(db, `PolariScore/seguimientos/${idAccion}/ejecutado`);

      try {
        const [aniosSnap, ejecutadoSnap] = await Promise.all([get(aniosRef), get(ejecutadoRef)]);
        const anios = aniosSnap.exists() ? aniosSnap.val() : [];
        const ejecutadoObj = ejecutadoSnap.exists() ? ejecutadoSnap.val() : {};
        console.log("[Eval/Tabs] anios (programado):", anios);
        console.log("[Eval/Tabs] ejecutadoObj:", ejecutadoObj);

        const anioInicio = fechaInicioPolitica.includes('/')
          ? parseInt(fechaInicioPolitica.split('/')[2], 10)
          : new Date(fechaInicioPolitica).getFullYear();
        console.log("[Eval/Tabs] anioInicio:", anioInicio);

        const programadoPorAnio = programadoArrayToObj(anios, anioInicio);
        console.log("[Eval/Tabs] programadoPorAnio:", programadoPorAnio);

        if (typeof cargarHistorialEvaluaciones === "function") {
          cargarHistorialEvaluaciones(idAccion, anioInicio, programadoPorAnio);
        } else {
          console.warn("[Eval/Tabs] cargarHistorialEvaluaciones no está definida.");
        }

        for (let i = 1; i <= 6; i++) {
          const anio = anioInicio + (i - 1);
          const programado = obtenerProgramado(anios, anio, i - 1);
          const ejecutado = ejecutadoObj[anio] ?? "";

          const tabPane = document.getElementById(`tab${i}`);
          if (!tabPane) {
            console.warn(`⚠️ No existe el panel #tab${i}`);
            continue;
          }
          const inputEjecutado = tabPane.querySelector("input.input-ejecutado");
          const inputProgramado = tabPane.querySelector("input.input-programado");

          if (inputEjecutado && inputProgramado) {
            inputEjecutado.value = ejecutado;
            inputProgramado.value = programado;
            console.log(`[Eval/Tabs] tab${i}`, { anio, programado, ejecutado });
          } else {
            console.warn(`⚠️ Faltan inputs en tab${i}`, { tieneEjecutado: !!inputEjecutado, tieneProgramado: !!inputProgramado });
          }
        }
      } catch (error) {
        console.error("❌ Error al cargar datos de evaluación:", error);
        Swal.fire({
          icon: "error",
          title: "Error al cargar",
          text: "No fue posible cargar los datos de evaluación.",
          confirmButtonColor: BRAND_GREEN
        });
      } finally {
        console.groupEnd();
      }
    }

    function obtenerProgramado(anios, anio, indice) {
      if (Array.isArray(anios)) return anios[indice] || 0;      // array por índice
      if (typeof anios === "object" && anios !== null) return anios[anio] || 0; // objeto por clave año
      return 0;
    }

    // === Guardar evaluación (con logs y confirmación en tabla) ===



    window.guardarEvaluacion = async function guardarEvaluacion() {
      console.groupCollapsed("[Eval/Guardar] Inicio");
      const db = getDatabase();
      const idAccion = window.idAccionSeleccionada || getQueryParam("id");
      console.log("[Eval/Guardar] idAccion:", idAccion);

      if (!idAccion) {
        Swal.fire({ icon: "error", title: "Falta información", text: "No se encontró el ID de la acción.", confirmButtonColor: "#00594E" });
        console.groupEnd(); return;
      }

      const fechaInicio = window.fechaInicioPolitica;
      console.log("[Eval/Guardar] fechaInicioPolitica:", fechaInicio);
      if (!fechaInicio) {
        Swal.fire({ icon: "error", title: "Falta información", text: "No se ha definido la fecha de inicio de la política.", confirmButtonColor: "#00594E" });
        console.groupEnd(); return;
      }

      const anioInicio = fechaInicio.includes('/') ? parseInt(fechaInicio.split('/')[2], 10)
        : new Date(fechaInicio).getFullYear();
      console.log("[Eval/Guardar] anioInicio:", anioInicio);

      // Lee inputs de tabs -> {2023: x, ...}
      const datosEjecutado = {};
      const warnings = [];
      for (let i = 1; i <= 6; i++) {
        const anio = anioInicio + (i - 1);
        const input = document.querySelector(`#tab${i} input.input-ejecutado`);
        if (!input) {
          warnings.push(`No se encontró input en tab ${i} (${anio}). Se guardará 0.`);
          datosEjecutado[anio] = 0;
          continue;
        }
        const val = parseFloat(String(input.value).replace(",", "."));
        if (!Number.isFinite(val)) {
          warnings.push(`Valor no numérico en ${anio}. Se guardará 0.`);
          datosEjecutado[anio] = 0;
        } else {
          datosEjecutado[anio] = val;
          if (val < 0) warnings.push(`Año ${anio}: valor negativo (${val}).`);
          if (val > 100) warnings.push(`Año ${anio}: valor > 100 (${val}). ¿% o proporción?`);
        }
      }
      console.log("[Eval/Guardar] datosEjecutado construidos:", datosEjecutado);
      if (warnings.length) console.warn("[Eval/Guardar] Advertencias:", warnings);

      // Confirmación en tabla
      const { isConfirmed } = await Swal.fire({
        icon: "question",
        title: "Confirmar evaluación",
        html: buildSwalTableHTML(datosEjecutado, warnings), // tu helper ya creado
        width: 720,
        showCancelButton: true,
        confirmButtonText: "Guardar",
        cancelButtonText: "Cancelar",
        confirmButtonColor: "#00594E",
        focusConfirm: false
      });
      console.log("[Eval/Guardar] Confirmación:", isConfirmed);
      if (!isConfirmed) { console.groupEnd(); return; }

      try {
        // ⚠️ NO hacer await aquí (si no, queda esperando para siempre)
        try { document.activeElement && document.activeElement.blur(); } catch (e) { }
        Swal.fire({
          title: "Guardando...",
          html: "Por favor espera",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        const fechaActual = new Date();
        const fechaFormateada = `${String(fechaActual.getDate()).padStart(2, '0')}-${String(fechaActual.getMonth() + 1).padStart(2, '0')}-${fechaActual.getFullYear()}`;
        const user = auth.currentUser;
        const correoSanitizado = (user?.email || "desconocido").replace(/\./g, '_');

        // Versionado de historial
        console.log("[Eval/Guardar] Consultando historial para versionar clave...");
        const refHistorial = ref(db, `PolariScore/seguimientos/${idAccion}/historialEvaluacion`);
        const snapshotHistorial = await get(refHistorial);
        let contador = 0;
        if (snapshotHistorial.exists()) {
          Object.keys(snapshotHistorial.val()).forEach(key => { if (key.startsWith(fechaFormateada)) contador++; });
        }
        const claveFinal = contador === 0 ? fechaFormateada : `${fechaFormateada}_${contador}`;
        console.log("[Eval/Guardar] claveFinal:", claveFinal);

        const updates = {};
        updates[`PolariScore/seguimientos/${idAccion}/ejecutado`] = datosEjecutado;
        updates[`PolariScore/seguimientos/${idAccion}/historialEvaluacion/${claveFinal}`] = {
          fecha: fechaActual.toISOString(),
          id_usuario: correoSanitizado,
          ejecutado: datosEjecutado
        };
        console.log("[Eval/Guardar] updates ->", updates);

        console.log("[Eval/Guardar] Ejecutando update...");
        await update(ref(db), updates);
        console.log("[Eval/Guardar] Update OK");

        Swal.close();
        await Swal.fire({
          icon: "success",
          title: "¡Guardado!",
          text: "Evaluación guardada con éxito.",
          confirmButtonColor: "#00594E"
        });

        // Cierra el modal de Bootstrap si está abierto
        const modalEl = document.getElementById("evaluarModal");
        if (modalEl) {
          const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          modal.hide();
        }

        if (typeof cargarDatosAccion === "function") {
          console.log("[Eval/Guardar] Refrescando datos de la acción…");
          await cargarDatosAccion(idAccion);
        } else {
          console.warn("[Eval/Guardar] cargarDatosAccion no definido. Recargando página.");
          location.reload();
        }
      } catch (error) {
        console.error("❌ Error al guardar evaluación:", error);
        try { Swal.close(); } catch { }
        Swal.fire({
          icon: "error",
          title: "Error al guardar",
          text: "Ocurrió un problema guardando la evaluación.",
          confirmButtonColor: "#00594E"
        });
      } finally {
        console.groupEnd();
      }
    };





    // Convierte anios a objeto {2025: 5, 2026: 6, ...}
    function programadoArrayToObj(anios, anioInicio) {
      const obj = {};
      if (Array.isArray(anios)) {
        for (let i = 0; i < anios.length; i++) obj[anioInicio + i] = anios[i];
      } else if (typeof anios === "object" && anios !== null) {
        return anios;
      }
      return obj;
    }


    async function cargarHistorialEvaluaciones(idAccion, anioInicio, programadoPorAnio) {
      const db = getDatabase();
      const refHistorial = ref(db, `PolariScore/seguimientos/${idAccion}/historialEvaluacion`);
      const snapshot = await get(refHistorial);

      const historial = [];
      if (snapshot.exists()) {
        const valores = snapshot.val();
        for (const key of Object.keys(valores)) {
          const evaluacion = valores[key];
          let aniosEvaluados = Object.keys(evaluacion.ejecutado || {});

          // Resumen global (suma todos los años)
          let totalEjecutado = 0;
          let totalProgramado = 0;
          let resumenPorc = 0;
          aniosEvaluados.forEach(anio => {
            const ejecutado = parseFloat(evaluacion.ejecutado[anio]) || 0;
            const programado = programadoPorAnio[anio] ? parseFloat(programadoPorAnio[anio]) : 0;
            totalEjecutado += ejecutado;
            totalProgramado += programado;
          });
          if (totalProgramado > 0) resumenPorc = (totalEjecutado / totalProgramado) * 100;

          // Detalles de cada año (para el colapsable)
          let detalles = `
        <ul class="list-group list-group-flush ms-3 mb-3 mt-2">
          ${aniosEvaluados.map(anio => {
            const ejecutado = parseFloat(evaluacion.ejecutado[anio]) || 0;
            const programado = programadoPorAnio[anio] ? parseFloat(programadoPorAnio[anio]) : 0;
            const porcentaje = programado > 0 ? (ejecutado / programado) * 100 : 0;
            return `
            <li class="list-group-item px-0 py-1 d-flex justify-content-between align-items-center small">
              <span>
                <i class="ni ni-calendar-grid-58 text-warning"></i>
                <b>${anio}</b>
                <span class="ms-1">Ejecutado:</span>
                <span class="text-success fw-bold">${formatearNumero(ejecutado)}</span>
                <span class="ms-1">Programado:</span>
                <span class="fw-bold">${formatearNumero(programado)}</span>
              </span>
              <span class="badge ${porcentaje >= 100 ? 'bg-success' : (porcentaje >= 80 ? 'bg-info' : 'bg-warning text-dark')}">
                ${formatearNumero(porcentaje)}%
              </span>
            </li>`;
          }).join('')}
        </ul>
      `;

          historial.push({
            fecha: evaluacion.fecha,
            correo: evaluacion.id_usuario ? evaluacion.id_usuario.replace(/_/g, '.') : "",
            resumenPorc,
            totalEjecutado,
            totalProgramado,
            detalles
          });
        }
      }

      // Ordena por fecha descendente
      historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      // Renderizar como menú colapsable Argon
      const ul = document.getElementById("historialEvaluaciones");
      ul.innerHTML = "";
      if (historial.length === 0) {
        ul.innerHTML = `<li class="list-group-item text-muted text-center">No hay evaluaciones registradas aún.</li>`;
        return;
      }
      historial.forEach((ev, idx) => {
        const colId = `colEval${idx}`;
        ul.innerHTML += `
      <li class="nav-item mb-3" style="list-style:none;">
        <div class="card shadow border-0 rounded-4 transition-ease position-relative" style="overflow:hidden;">
          <a class="stretched-link text-decoration-none" data-bs-toggle="collapse" href="#${colId}" aria-expanded="false">
            <div class="card-body py-3 px-4 d-flex flex-row align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <span class="icon icon-shape icon-md border-radius-md bg-gradient-warning text-center me-3 shadow-sm">
                  <i class="ni ni-calendar-grid-58 text-white"></i>
                </span>
                <div>
                  <div class="fw-bold fs-6 mb-1">${formatearFechaISO(ev.fecha)}</div>
                  <div class="text-xs text-muted"><i class="ni ni-email-83"></i> ${ev.correo}</div>
                </div>
              </div>
              <div class="d-flex flex-column align-items-end">
                
                <i class="ni ni-bold-down text-secondary fs-5"></i>
              </div>
            </div>
          </a>
          <div class="collapse px-4 pb-4" id="${colId}">
            <div class="border-top pt-3 mt-2">
              ${ev.detalles}
            </div>
          </div>
        </div>
      </li>

    `;
      });
    }

    // Utilidad para fecha:
    function formatearFechaISO(fechaISO) {
      if (!fechaISO) return "";
      const d = new Date(fechaISO);
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }

    function formatearNumero(num) {
      return (typeof num === 'number' ? num : parseFloat(num))
        .toLocaleString('es-CO', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        });
    }

    let modalCrearIndicador = null;

    // --- FUNCIONES DINÁMICAS DEL MODAL ---
    function abrirModalIndicador(idPolitica, objetivoIndex, idAccion, anios = []) {
      // Guarda en globales si lo necesitas luego
      window.idPoliticaGlobal = idPolitica;
      window.objetivoIndexGlobal = objetivoIndex;
      window.idAccionGlobal = idAccion;
      window.aniosGlobal = anios.length ? anios : ["2023", "2024", "2025", "2026", "2027", "2028"];

      // Limpiar campos del formulario
      document.getElementById("tipoIndicador").value = "";
      document.getElementById("bloqueHitos").style.display = "none";
      document.getElementById("listaHitos").innerHTML = "";
      document.getElementById("tipoMetrica").value = "";
      document.getElementById("descripcionIndicador").value = "";
      document.getElementById("acumuladoAyuda").style.display = "none";

      // Rellenar los años de la programación
      const tbody = document.getElementById("tbodyProgramacionAnios");
      tbody.innerHTML = "";
      window.aniosGlobal.forEach(anio => {
        tbody.innerHTML += `
          <tr>
            <td>${anio}</td>
            <td>
              <input type="number" min="0" max="100" step="0.01" class="form-control form-control-sm" name="programadoAnio_${anio}" required>
            </td>
          </tr>
        `;
      });

      // Solo inicializa el modal una vez (buena práctica)
      const modalEl = document.getElementById('modalCrearIndicador');
      if (!modalCrearIndicador) {
        modalCrearIndicador = new bootstrap.Modal(modalEl, {
          backdrop: 'static',   // No se cierra al dar clic fuera
          keyboard: false       // No se cierra con Escape
        });
      }
      // Mostrar el modal
      modalCrearIndicador.show();
    }

    // --- LISTENERS DEL MODAL ---
    document.addEventListener("DOMContentLoaded", function () {
      // Mostrar/ocultar bloque hitos
      document.getElementById("tipoIndicador").addEventListener("change", function () {
        document.getElementById("bloqueHitos").style.display = (this.value === "hitos") ? "block" : "none";
      });

      // Agregar hito
      document.getElementById("btnAgregarHito").addEventListener("click", function () {
        const listaHitos = document.getElementById("listaHitos");
        const hitoItem = document.createElement("div");
        hitoItem.className = "row g-2 align-items-end mb-2 hito-item";
        hitoItem.innerHTML = `
      <div class="col-3">
        <input type="number" min="0" max="100" step="0.01" class="form-control" placeholder="% Hito" name="porcentajeHito[]" required>
      </div>
      <div class="col-8">
        <input type="text" class="form-control" placeholder="Descripción del hito" name="descripcionHito[]" required>
      </div>
      <div class="col-1 text-end">
        <button type="button" class="btn btn-outline-danger btn-sm px-2 py-1 rounded-circle btnQuitarHito" title="Quitar hito">
          <i class="fa fa-times"></i>
        </button>
      </div>
    `;
        listaHitos.appendChild(hitoItem);
        // Quitar hito
        hitoItem.querySelector('.btnQuitarHito').onclick = function () {
          hitoItem.remove();
        };
      });

      // Ayuda acumulado
      document.getElementById("tipoMetrica").addEventListener("change", function () {
        document.getElementById("acumuladoAyuda").style.display = (this.value === "acumulado") ? "block" : "none";
      });

      // SUBMIT indicador
      document.getElementById("formCrearIndicador").addEventListener("submit", async function (e) {
        e.preventDefault();

        // --- Validación de programación acumulado
        const tipoMetrica = document.getElementById("tipoMetrica").value;
        if (tipoMetrica === "acumulado") {
          let suma = 0;
          document.querySelectorAll('#tbodyProgramacionAnios input[type="number"]').forEach(inp => {
            suma += Number(inp.value) || 0;
          });
          if (suma > 100) {
            Swal.fire('Error', 'La suma de la programación no puede superar el 100%', 'warning');
            return false;
          }
        }

        // --- Guardar datos
        const tipoIndicador = document.getElementById("tipoIndicador").value;
        const descripcionIndicador = document.getElementById("descripcionIndicador").value;

        // Hitos
        let hitos = [];
        if (tipoIndicador === "hitos") {
          document.querySelectorAll("#listaHitos .hito-item").forEach(hitoEl => {
            const porcentaje = hitoEl.querySelector('input[type="number"]').value;
            const desc = hitoEl.querySelector('input[type="text"]').value;
            hitos.push({ porcentaje: Number(porcentaje), descripcion: desc });
          });
        }

        // Programación por año
        let programacion = {};
        aniosGlobal.forEach(anio => {
          const val = document.querySelector(`[name="programadoAnio_${anio}"]`).value;
          programacion[anio] = Number(val) || 0;
        });

        // --- RUTA RTDB
        const rutaIndicador = `PolariScore/politicas/${idPoliticaGlobal}/objetivos_especificos/${objetivoIndexGlobal}/acciones/${idAccionGlobal}/Indicador/`;



        // Estructura de datos
        let datosIndicador = {
          tipo: tipoIndicador,
          descripcion: descripcionIndicador,
          tipo_metrica: tipoMetrica,
          hitos: tipoIndicador === "hitos" ? hitos : undefined,
          programacion_anual: programacion,
          fecha_creacion: new Date().toISOString(),
          usuario: window.correoUsuario || "desconocido"
        };

        // --- GUARDAR EN RTDB ---
        try {
          await set(ref(database, rutaIndicador), datosIndicador);

          Swal.fire({
            icon: 'success',
            title: '¡Indicador guardado!',
            showConfirmButton: false,
            timer: 1800
          });

          // Cerrar modal
          const miModal = bootstrap.Modal.getInstance(document.getElementById('modalCrearIndicador'));
          miModal.hide();

          get(ref(db, rutaIndicador)).then(snap => {
            const indicador = snap.val();
            renderIndicadorVisual(indicador, ["2023", "2024", "2025", "2026", "2027", "2028"]);
          });

        } catch (err) {
          Swal.fire('Error', 'No se pudo guardar el indicador: ' + err.message, 'error');
        }
      });
    });

    function renderIndicadorVisual(indicador, anios = ["2024", "2025", "2026", "2027", "2028", "2029"]) {
      const cont = document.getElementById('indicadorVisual');
      const containerIndicador = document.getElementById('containerIndicador')
      if (!indicador) {
        cont.innerHTML = `
      <div class="alert alert-info mb-0 rounded-3 text-white py-3 px-4 d-inline-block border-0" style="max-width: 50%;">
        <i class="fa fa-info-circle me-2"></i> No hay indicador registrado para esta acción.
      </div>`;
        containerIndicador.style.display = 'none';
        return;
      }

      // Chips tipo y métrica
      const tipoIcon = { hitos: 'fa-medal', cumplimiento: 'fa-percent', productos: 'fa-boxes-stacked' }[indicador.tipo] || 'fa-chart-bar';
      const metricIcon = { acumulado: 'fa-layer-group', flujo: 'fa-retweet' }[indicador.tipo_metrica] || '';

      const chipTipo = `
    <span class="chip-indicador me-1">
      <i class="fa ${tipoIcon} me-1"></i>${indicador.tipo ? indicador.tipo.charAt(0).toUpperCase() + indicador.tipo.slice(1) : "Indicador"}
    </span>`;
      const chipMetrica = indicador.tipo_metrica ? `
    <span class="chip-indicador bg-body-secondary">
      <i class="fa ${metricIcon} me-1"></i>${indicador.tipo_metrica.charAt(0).toUpperCase() + indicador.tipo_metrica.slice(1)}
    </span>` : '';

      // Descripción
      const desc = `<div class="mb-2"><div class="text-muted" style="font-size:1.08em;">${indicador.descripcion || "(Sin descripción)"}</div></div>`;

      // Hitos
      let bloqueHitos = '';
      if (indicador.tipo === 'hitos' && Array.isArray(indicador.hitos)) {
        let totalHitos = indicador.hitos.reduce((a, b) => a + Number(b.porcentaje || 0), 0);
        bloqueHitos = `
      <div class="mb-2 mt-2">
        <div class="fw-semibold text-success" style="font-size:.98em;">
          <i class="fa fa-flag-checkered me-1"></i> Hitos (${totalHitos}%)
        </div>
        <ul class="list-unstyled timeline-soft ms-1">
          ${indicador.hitos.map(hito => `
            <li class="mb-1 d-flex align-items-center gap-2">
              <span class="badge bg-light text-dark px-2 py-1 border">${hito.porcentaje}%</span>
              <span style="font-size:.97em;">${hito.descripcion}</span>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
      }

      // Productos
      let bloqueProductos = '';
      if (indicador.tipo === 'productos' && Array.isArray(indicador.productos)) {
        bloqueProductos = `
      <div class="mb-2 mt-2">
        <div class="fw-semibold text-primary" style="font-size:.99em;">
          <i class="fa fa-box-open me-1"></i> Productos
        </div>
        <div class="d-flex flex-wrap gap-2">
          ${indicador.productos.map(p => `<span class="badge bg-light text-dark border px-2 py-1">${p}</span>`).join('')}
        </div>
      </div>
    `;
      }

      // Responsive scrollable gauges
      const progAnual = indicador.programacion_anual || {};
      const sumProg = Object.values(progAnual).reduce((a, b) => a + Number(b || 0), 0);

      // Cada gauge tiene su propio div
      const gaugesHTML = anios.map((anio, i) => `
    <div class="gauge-mini-wrapper text-center flex-shrink-0" style="width:94px;">
      <div class="gauge-mini" id="gauge_${anio}" style="width:88px;height:63px;margin:auto;"></div>
      <div class="gauge-label small text-muted">${anio}</div>
    </div>
  `).join('');

      let metaInfo = `
    <div class="mt-2 text-end small text-muted">
      <i class="fa fa-user"></i> <b>${indicador.usuario || 'N/A'}</b>
      <span class="mx-2">|</span>
      <i class="fa fa-calendar-alt"></i> <b>${indicador.fecha_creacion ? formatearFecha(indicador.fecha_creacion) : 'N/A'}</b>
    </div>
  `;

      // Render principal (NO card)
      cont.innerHTML = `
    <div>
      <div class="d-flex gap-2 flex-wrap mb-2">${chipTipo}${chipMetrica}</div>
      ${desc}
      ${bloqueHitos}
      ${bloqueProductos}
      <div class="d-flex flex-row flex-nowrap overflow-auto gap-2 mb-2 mt-3 gauges-responsive">
        ${gaugesHTML}
      </div>
      <div class="small text-muted ms-1 mb-2">
        Total programado: <span class="fw-bold">${sumProg}%</span>
        ${indicador.tipo_metrica === "acumulado" ? '<span class="text-success ms-2">(Acumulado)</span>' : '<span class="text-info ms-2">(Flujo / anual)</span>'}
      </div>
      ${metaInfo}
    </div>
  `;

      // Inicializa los donuts 180° ECharts
      setTimeout(() => {
        anios.forEach(anio => {
          const valor = Number(progAnual[anio] || 0);
          const el = document.getElementById(`gauge_${anio}`);
          if (!el) return;
          const myChart = echarts.init(el);
          myChart.setOption({
            series: [{
              type: 'gauge',
              startAngle: 180,
              endAngle: 0,
              min: 0,
              max: 100,
              radius: '90%',
              pointer: { show: false },
              progress: {
                show: true,
                width: 12,
                roundCap: true,
                itemStyle: {
                  color: valor < 40 ? "#f8bb65" : valor < 70 ? "#49baff" : "#40db9b"
                }
              },
              axisLine: {
                lineStyle: {
                  width: 12,
                  color: [[1, "#f0f3f6"]]
                }
              },
              splitLine: { show: false },
              axisTick: { show: false },
              axisLabel: { show: false },
              anchor: { show: false },
              detail: {
                show: true,
                offsetCenter: [0, '35%'],
                fontSize: 15,
                color: "#242a35",
                valueAnimation: true,
                formatter: '{value}%'
              },
              data: [{ value: valor }]
            }]
          });
          window.addEventListener("resize", () => myChart.resize());
        });
      }, 10);
    }


    // -- Extra: timeline CSS para hitos --
    const style = document.createElement('style');
    style.textContent = `
  .timeline-hitos .timeline-item { position: relative; padding-left: 0.5rem; }
  .timeline-hitos .timeline-item::before {
    content:''; position:absolute; left:0.15rem; top:0.7em; width:3px; height:1.5em; background:#b5a16044;
  }
  .timeline-hitos .timeline-item:last-child::before { display:none; }
`;
    document.head.appendChild(style);

    document.getElementById("btnEliminarIndicador").addEventListener("click", async function () {
      Swal.fire({
        title: '¿Eliminar indicador?',
        html: `<div class="text-danger mb-2"><i class="fa-solid fa-triangle-exclamation fa-lg"></i></div>
       <b>Esta acción es irreversible.</b><br>¿Seguro que desea eliminar el indicador de esta acción?<br>
       <span class="small text-muted">Esta operación no se puede deshacer.</span>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '<i class="fa fa-trash"></i> Sí, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#00897b',
        background: '#fff',
        reverseButtons: true,
        focusCancel: true
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            // ¡Función dinámica, 100% seguro!
            await window.eliminarIndicadorActual();

            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'El indicador ha sido eliminado correctamente.',
              confirmButtonColor: '#00897b',
              timer: 1800,
              showConfirmButton: false
            });

            document.getElementById('indicadorVisual').innerHTML = `
          <div class="alert alert-info mb-0 rounded-3 py-3 px-4 d-inline-block border-0" style="max-width: 400px;">
            <i class="fa fa-info-circle me-2"></i> No hay indicador registrado para esta acción.
          </div>`;
            document.getElementById('btnEliminarIndicador').style.display = 'none';
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo eliminar el indicador. Intenta de nuevo.',
              confirmButtonColor: '#d33'
            });
          }
        }
      });
    });


    // === Utils simples ===
    function fmtFecha(fechaISO) {
      if (!fechaISO) return '—';
      const d = new Date(fechaISO);
      return isNaN(d) ? fechaISO : d.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: '2-digit' });
    }
    function fmtSize(bytes) {
      const b = Number(bytes);
      if (!b) return '';
      if (b < 1024) return `${b} B`;
      if (b < 1024 * 1024) return `${(b / 1024).toFixed(1)} KB`;
      if (b < 1024 * 1024 * 1024) return `${(b / 1024 / 1024).toFixed(1)} MB`;
      return `${(b / 1024 / 1024 / 1024).toFixed(1)} GB`;
    }
    function iconoPorMimeOMombre(doc) {
      const t = (doc.mime || '').toLowerCase();
      const n = (doc.nombre || doc.titulo || '').toLowerCase();
      if (t.includes('pdf') || n.endsWith('.pdf')) return 'fa-file-pdf text-danger';
      if (t.includes('spreadsheet') || /\.(xls|xlsx|csv)$/i.test(n)) return 'fa-file-excel text-success';
      if (t.includes('presentation') || /\.(ppt|pptx)$/i.test(n)) return 'fa-file-powerpoint text-warning';
      if (t.includes('word') || /\.(doc|docx)$/i.test(n)) return 'fa-file-word text-primary';
      if (t.startsWith('image/') || /\.(png|jpg|jpeg|gif|webp|svg)$/i.test(n)) return 'fa-file-image text-primary';
      if (t.startsWith('video/') || /\.(mp4|mov|avi|mkv|webm)$/i.test(n)) return 'fa-file-video text-info';
      if (t.startsWith('audio/') || /\.(mp3|wav|ogg)$/i.test(n)) return 'fa-file-audio text-info';
      if (/\.(zip|rar|7z)$/i.test(n)) return 'fa-file-archive text-secondary';
      return 'fa-file text-secondary';
    }





    /* =========================================================
   DOCUMENTOS DE POLÍTICA – BLOQUE CORREGIDO Y COMPLETO
   ========================================================= */

    // === Render de documentos en el modal ===
    function renderDocumentosPolitica(politica) {
      const wrap = document.getElementById('modalDocumentos');
      const btnDescargarTodo = document.getElementById('descargar_todo');
      if (!wrap) return;

      // Asegurar UL interno
      let cont = wrap.querySelector('ul.list-group');
      if (!cont) {
        wrap.innerHTML = `<ul class="list-group list-group-flush"></ul>`;
        cont = wrap.querySelector('ul.list-group');
      }

      // Normalizar documentos (array u objeto)
      const docsObj = politica?.documentos || {};
      const docs = Array.isArray(docsObj) ? docsObj : Object.values(docsObj || {});

      // Guardar política actual (para subida)
      window.politicaDocsActual = politica?.id ? politica : window.politicaDocsActual;

      // Botón "Descargar todo"
      if (btnDescargarTodo) {
        btnDescargarTodo.disabled = docs.length === 0;
        btnDescargarTodo.onclick = () => descargarTodoDocumentos(docs);
      }

      if (!docs.length) {
        cont.innerHTML = `
      <li class="list-group-item border-0 text-center text-muted py-4">
        No hay documentos registrados para esta política.
      </li>`;
        return;
      }

      // Helpers con fallback
      const getIcon = (doc) => {
        try {
          if (typeof iconoPorMime === 'function') return iconoPorMime(doc?.type || doc?.mime || '');
          if (typeof iconoPorMimeONombre === 'function') return iconoPorMimeONombre(doc?.nombre || doc?.titulo || '');
          // Compatibilidad por si existía el typo histórico
          if (typeof iconoPorMimeOMombre === 'function') return iconoPorMimeOMombre(doc);
        } catch (e) { }
        return 'fa-regular fa-file';
      };
      const fmtFechaSafe = (f) => {
        try { return (typeof fmtFecha === 'function') ? fmtFecha(f) : (f ? new Date(f).toLocaleDateString('es-CO') : '—'); }
        catch { return '—'; }
      };
      const fmtSizeSafe = (s) => {
        try { return (typeof fmtSize === 'function') ? fmtSize(s) : (s ? `${Math.round(s / 1024)} KB` : ''); }
        catch { return ''; }
      };

      cont.innerHTML = docs.map((doc, idx) => {
        const icon = getIcon(doc);
        const fecha = fmtFechaSafe(doc?.fecha || doc?.fecha_subida);
        const size = doc?.size ? ` · ${fmtSizeSafe(doc.size)}` : '';
        const nombre = doc?.nombre || doc?.titulo || `Documento ${idx + 1}`;
        const url = doc?.url || doc?.enlace || '#';

        return `
      <li class="list-group-item border-0 d-flex justify-content-between align-items-center ps-0 mb-2 border-radius-lg">
        <div class="d-flex flex-column">
          <h6 class="mb-1 text-dark text-sm" title="${nombre}">${nombre}</h6>
          <span class="text-xs text-muted">${fecha}${size}</span>
        </div>
        <div class="d-flex align-items-center text-sm">
          <a class="btn btn-link text-dark text-sm mb-0 px-0 ms-3" href="${url}" target="_blank" rel="noopener">
            <i class="fas ${icon} text-lg me-1"></i> Ver
          </a>
          <a class="btn btn-link text-primary text-sm mb-0 px-0 ms-4" href="${url}" download>
            <i class="fa-solid fa-download me-1"></i> Descargar
          </a>
        </div>
      </li>`;
      }).join('');
    }

    /* === Descargar todo (secuencial) === */
    function descargarTodoDocumentos(docs) {
      if (!Array.isArray(docs) || docs.length === 0) return;

      const list = docs
        .map((d, i) => ({
          url: d?.url || d?.enlace || null,
          name: d?.nombre || d?.titulo || `documento_${i + 1}`
        }))
        .filter(d => !!d.url);

      let i = 0;
      const tick = () => {
        if (i >= list.length) return;
        const { url, name } = list[i];
        try {
          const a = document.createElement('a');
          a.href = url;
          a.setAttribute('download', name);
          a.target = '_blank';
          a.rel = 'noopener';
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch (e) {
          console.error('[Descargar todo] Error:', e);
          typeof mostrarToast === 'function' && mostrarToast(`No se pudo descargar: ${name}`, 'danger');
        } finally {
          i++;
          setTimeout(tick, 300);
        }
      };
      tick();
    }

    /* === Visibilidad del botón Subir según window.esAdmin === */
    function updateSubirVisibility() {
      const btn = document.getElementById('btnSubirDocumento');
      if (!btn) return;
      btn.classList.toggle('d-none', !window.esAdmin);
    }
    document.addEventListener('DOMContentLoaded', updateSubirVisibility);
    document.getElementById('DocumentosModal')?.addEventListener('show.bs.modal', updateSubirVisibility);

    /* === Abrir modal programáticamente (opcional) === */
    async function openDocumentosModal(politicaAsociada) {
      if (!politicaAsociada || !politicaAsociada.id) {
        console.error('[Docs] politicaAsociada inválida:', politicaAsociada);
        return;
      }
      window.politicaDocsActual = politicaAsociada;

      const progressWrap = document.getElementById('docsUploadProgress');
      if (progressWrap) progressWrap.innerHTML = '';

      try {
        const snap = await get(ref(db, `PolariScore/politicas/${politicaAsociada.id}`));
        if (snap.exists()) {
          const pol = snap.val();
          pol.id = politicaAsociada.id;
          renderDocumentosPolitica(pol);
        } else {
          renderDocumentosPolitica(politicaAsociada);
        }
      } catch (e) {
        console.warn('[Docs] No se pudo refrescar la política, se usa el objeto recibido.', e);
        renderDocumentosPolitica(politicaAsociada);
      }

      updateSubirVisibility();
      new bootstrap.Modal(document.getElementById('DocumentosModal')).show();
    }

    /* === Subida: listeners (doble guardia admin) === */
    document.getElementById('btnSubirDocumento')?.addEventListener('click', () => {
      if (!window.esAdmin) return;
      document.getElementById('inputArchivoDocumento')?.click();
    });
    document.getElementById('inputArchivoDocumento')?.addEventListener('change', async (e) => {
      if (!window.esAdmin) return;
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const pol = window.politicaDocsActual;
      if (!pol?.id) {
        typeof mostrarToast === 'function'
          ? mostrarToast('No hay política asociada para subir documentos.', 'warning')
          : Swal.fire('Atención', 'No hay política asociada para subir documentos.', 'warning');
        return;
      }

      await uploadSelectedFiles(files, pol.id);
      e.target.value = '';
    });

    /* === Subir varios archivos con progreso y refrescar === */
    async function uploadSelectedFiles(files, politicaId) {
      const progressWrap = document.getElementById('docsUploadProgress');
      if (progressWrap) progressWrap.innerHTML = '';

      for (const file of files) {
        if (!window.esAdmin) break;
        await subirUnArchivo(file, politicaId, progressWrap);
      }

      try {
        const snap = await get(ref(db, `PolariScore/politicas/${politicaId}`));
        if (snap.exists()) {
          const pol = snap.val();
          pol.id = politicaId;
          renderDocumentosPolitica(pol);
        }
      } catch (e) {
        console.error('[Docs] No se pudo refrescar la lista después de subir.', e);
      }
    }

    /* === Subir un archivo a Storage + guardar metadata en RTDB === */
    async function subirUnArchivo(file, politicaId, progressWrap) {
      return new Promise((resolve) => {
        // UI progreso
        const row = document.createElement('div');
        row.className = 'mb-2';
        row.innerHTML = `
      <div class="small text-muted mb-1">${file.name} (${Math.round(file.size / 1024)} KB)</div>
      <div class="progress" style="height:8px;">
        <div class="progress-bar" role="progressbar" style="width:0%" aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>`;
        progressWrap?.appendChild(row);
        const bar = row.querySelector('.progress-bar');

        // Ruta y ref en Storage
        const safeName = (file.name || 'archivo')
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^\w.\- ]/g, '_');
        const storagePath = `PlanItOne/PolariScore/politicas/documentos/${politicaId}/${Date.now()}_${safeName}`;
        const sRef = storageRef(storage, storagePath);

        const uploadTask = uploadBytesResumable(sRef, file, { contentType: file.type || undefined });

        uploadTask.on('state_changed',
          (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            if (bar) { bar.style.width = pct + '%'; bar.textContent = pct + '%'; }
          },
          (err) => {
            console.error('[Upload] Error', err);
            if (bar) { bar.classList.add('bg-danger'); bar.textContent = 'Error'; }
            typeof mostrarToast === 'function'
              ? mostrarToast(`Error subiendo ${file.name}`, 'danger')
              : Swal.fire('Error', `Error subiendo ${file.name}`, 'error');
            resolve();
          },
          async () => {
            try {
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              const meta = {
                nombre: file.name,
                size: file.size,
                type: file.type || null,
                url,
                fecha_subida: Date.now(),
                uploader: auth?.currentUser?.email || null,
                storage_path: storagePath
              };

              const docsRef = ref(db, `PolariScore/politicas/${politicaId}/documentos`);
              await push(docsRef, meta);

              if (bar) { bar.classList.add('bg-success'); bar.textContent = 'Listo'; }
              typeof mostrarToast === 'function'
                ? mostrarToast(`Subido: ${file.name}`, 'success')
                : Swal.fire('Listo', `Subido: ${file.name}`, 'success');
            } catch (e) {
              console.error('[Upload] No se pudo guardar metadata', e);
              if (bar) { bar.classList.add('bg-warning'); bar.textContent = 'Guardado parcial'; }
              typeof mostrarToast === 'function'
                ? mostrarToast(`Guardado parcial: ${file.name}`, 'warning')
                : Swal.fire('Atención', `Guardado parcial: ${file.name}`, 'warning');
            } finally {
              resolve();
            }
          }
        );
      });
    }


  </script>
  <script>

    function exportarElementoComoImagen(idElemento, nombreArchivo = "exportacion.png") {
      const elemento = document.getElementById(idElemento);
      if (!elemento) {
        console.error("❌ No se encontró el elemento:", idElemento);
        return;
      }

      // Forzar fuentes e íconos a cargarse correctamente si están ocultos
      elemento.style.display = 'block';

      html2canvas(elemento, {
        useCORS: true,         // Para cargar imágenes externas como SVG con href
        allowTaint: true,
        backgroundColor: null, // Fondo transparente
        scale: 3               // Mayor calidad
      }).then((canvas) => {
        const enlace = document.createElement("a");
        enlace.href = canvas.toDataURL("image/png");
        enlace.download = nombreArchivo;
        enlace.click();
      }).catch(error => {
        console.error("❌ Error al exportar imagen:", error);
      });
    }



    function obtenerIconoArchivo(formato, clase = "") {
      if (typeof formato !== "string") {
        return `<i class="fa-solid fa-file-question text-muted ${clase}"></i>`;
      }

      switch (formato.toLowerCase()) {
        case "pdf":
          return `<i class="fa-solid fa-file-pdf text-danger ${clase}"></i>`;
        case "word":
        case "doc":
        case "docx":
          return `<i class="fa-solid fa-file-word text-blue ${clase}"></i>`;
        case "excel":
        case "xls":
        case "xlsx":
          return `<i class="fa-solid fa-file-excel text-success ${clase}"></i>`;
        case "png":
        case "jpg":
        case "jpeg":
        case "webp":
          return `<i class="fa-solid fa-file-image text-warning ${clase}"></i>`;
        case "mp4":
        case "mov":
        case "avi":
          return `<i class="fa-solid fa-file-video text-purple ${clase}"></i>`; // puedes definir text-purple en tu CSS si quieres
        default:
          return `<i class="fa-solid fa-file text-muted ${clase}"></i>`;
      }
    }


    // Función para mostrar una notificación (Toast)
    function mostrarToast(mensaje, tipo = "info") {
      const toastContainer = document.getElementById("toastContainer");

      // Crear toast
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${tipo} border-0 show`;
      toast.role = "alert";
      toast.ariaLive = "assertive";
      toast.ariaAtomic = "true";
      toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${mensaje}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        `;

      toastContainer.appendChild(toast);

      // Mostrar el toast
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      // Eliminar el toast después de 5 segundos
      setTimeout(() => {
        bsToast.hide();
        setTimeout(() => toast.remove(), 500);
      }, 2000);
    }


    function abrirEvaluarModal(idEvidencia) {
      // Verifica que el usuario tenga el rol adecuado
      const roles = window.rolesUsuarioActual || [];

      if (!roles.includes("evaluador-polariscore") && !roles.includes("admin-polariscore")) {
        mostrarToast("🚫 No tienes permiso para acceder a la evaluación.", "danger");
        return;
      }

      // Cierra cualquier modal abierto
      const modalAbierto = document.querySelector(".modal.show");
      if (modalAbierto) {
        const modalInstance = bootstrap.Modal.getInstance(modalAbierto);
        modalInstance.hide();
      }

      // Guarda el ID
      window.idEvidenciaSeleccionadaParaEvaluar = idEvidencia;

      // Abre el modal tras un pequeño delay
      setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById("evaluarModal"));
        modal.show();
      }, 300);
    }







    function actualizarNombresTabsEvaluar() {
      const fecha = window.fechaInicioPolitica;

      if (!fecha) {
        console.warn("❌ No se ha definido la fechaInicioPolitica");
        return;
      }

      let anioInicio;

      // Detectar si es formato dd/mm/yyyy o ISO
      if (fecha.includes('/')) {
        const partes = fecha.split('/');
        anioInicio = parseInt(partes[2]);
      } else {
        anioInicio = new Date(fecha).getFullYear();
      }

      const anioActual = new Date().getFullYear();
      let primerTabActivoId = null;

      for (let i = 1; i <= 6; i++) {
        const tab = document.getElementById(`tab${i}-tab`);
        const tabPane = document.getElementById(`tab${i}`);

        if (tab && tabPane) {
          const anio = anioInicio + (i - 1);
          tab.innerText = `${anio}`; // ✅ Solo el año (sin "Año ")

          // Resetear clases
          tab.classList.remove('active');
          tab.disabled = false;
          tab.removeAttribute('title');
          tab.style.opacity = 1;
          tab.removeEventListener('click', () => { });
          tab.classList.remove('disabled');
          tab.setAttribute('data-bs-toggle', 'tab');

          if (anio > anioActual) {
            tab.classList.add('disabled');
            tab.setAttribute('title', 'Este año aún no está habilitado');
            tab.style.opacity = 0.5;
            tab.removeAttribute('data-bs-toggle');

            tab.addEventListener('click', function (e) {
              e.preventDefault();
              mostrarToast("⏳ Este año aún no está habilitado.", "warning");
            });

            tabPane.classList.remove('show', 'active');
          } else {
            if (!primerTabActivoId) primerTabActivoId = i;

            tab.addEventListener('click', function () {
              for (let j = 1; j <= 6; j++) {
                document.getElementById(`tab${j}-tab`)?.classList.remove('active');
                document.getElementById(`tab${j}`)?.classList.remove('active', 'show');
              }

              tab.classList.add('active');
              tabPane.classList.add('active', 'show');
            });

            tabPane.classList.remove('active', 'show');
          }
        }
      }

      // Activar el primer tab habilitado
      if (primerTabActivoId) {
        const primerTab = document.getElementById(`tab${primerTabActivoId}-tab`);
        const primerPane = document.getElementById(`tab${primerTabActivoId}`);

        primerTab?.classList.add('active');
        primerPane?.classList.add('active', 'show');
      }
    }



    function actualizarNombresTabsEvidencias() {
      const fecha = window.fechaInicioPolitica;

      if (!fecha) {
        console.warn("❌ No se ha definido la fechaInicioPolitica");
        return;
      }

      let anioInicio;

      // Detectar si es dd/mm/yyyy o ISO
      if (fecha.includes('/')) {
        const partes = fecha.split('/');
        anioInicio = parseInt(partes[2]);
      } else {
        anioInicio = new Date(fecha).getFullYear();
      }

      const anioActual = new Date().getFullYear();
      let primerTabActivoId = null;

      for (let i = 1; i <= 6; i++) {
        const tab = document.getElementById(`anio${i}-tab`);
        const tabPane = document.getElementById(`anio${i}`);

        if (tab && tabPane) {
          const anio = anioInicio + (i - 1);
          tab.innerText = `${anio}`; // ✅ Solo el año

          // Limpiar clases previas
          tab.classList.remove('active');
          tab.disabled = false;
          tab.removeAttribute('title');
          tab.style.opacity = 1;
          tab.removeEventListener('click', () => { });
          tab.classList.remove('disabled');
          tab.setAttribute('data-bs-toggle', 'tab');

          if (anio > anioActual) {
            tab.classList.add('disabled');
            tab.setAttribute('title', 'Este año aún no está habilitado');
            tab.style.opacity = 0.5;
            tab.removeAttribute('data-bs-toggle');

            tab.addEventListener('click', function (e) {
              e.preventDefault();
              mostrarToast("⏳ Este año aún no está habilitado.", "warning");
            });

            tabPane.classList.remove('show', 'active');
          } else {
            if (!primerTabActivoId) primerTabActivoId = i;

            tab.addEventListener('click', function () {
              for (let j = 1; j <= 6; j++) {
                document.getElementById(`anio${j}-tab`)?.classList.remove('active');
                document.getElementById(`anio${j}`)?.classList.remove('active', 'show');
              }

              tab.classList.add('active');
              tabPane.classList.add('active', 'show');
            });

            tabPane.classList.remove('active', 'show');
          }
        }
      }

      if (primerTabActivoId) {
        const primerTab = document.getElementById(`anio${primerTabActivoId}-tab`);
        const primerPane = document.getElementById(`anio${primerTabActivoId}`);

        primerTab?.classList.add('active');
        primerPane?.classList.add('active', 'show');
      }
    }



    function formatearFecha(fechaIso) {
      if (!fechaIso) return '';
      const d = new Date(fechaIso);
      return d.toLocaleDateString("es-CO", { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

  </script>

  <!-- Librería ECharts oficial -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- Tu theme personalizado -->
  <script src="../assets/js/polariscore-charts.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Choices.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- CSS de flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- JS de flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


  <style>
    .inline-editor-row {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .inline-editor-row .form-control {
      min-width: 0;
    }

    /* evita overflow en flex */

    .inline-date-editor {
      position: absolute;
      z-index: 1080;
      /* sobre dropdowns */
      background: #1f2a31;
      /* tu esquema oscuro */
      border: 1px solid #334048;
      border-radius: .5rem;
      padding: .5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
    }

    .inline-date-editor .actions {
      display: flex;
      gap: .5rem;
      margin-top: .5rem;
      justify-content: end;
    }

    .inline-date-editor button {
      white-space: nowrap;
    }

    :root {
      --brand: #00594E;
      --gold: #B5A160;
      --bg-1: #f8f9fa;
      /* fondo base claro */
      --bg-2: #ffffff;
      /* tarjeta */
      --bg-3: #f1f3f5;
      /* contrastes suaves */
      --muted: #6c757d;
      --line: #dee2e6;
    }

    /* Modal XXL */
    .modal-xxl {
      max-width: 1280px;
    }

    .modal-full-h {
      height: 90vh;
    }

    .modal-full-h .modal-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-2);
      border: 1px solid var(--line);
      border-radius: 18px;
    }

    .modal-full-h .modal-header {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #ffffff;
      border-bottom: 1px solid var(--line);
    }

    .modal-full-h .modal-footer {
      position: sticky;
      bottom: 0;
      z-index: 2;
      background: #ffffff;
      border-top: 1px solid var(--line);
    }

    .modal-full-h .modal-body {
      overflow: auto;
    }

    /* Tabs */
    .nav-tabs .nav-link {
      color: var(--brand);
      border: 0;
      border-bottom: 2px solid transparent;
    }

    .nav-tabs .nav-link.active {
      color: var(--brand);
      font-weight: 600;
      border-bottom-color: var(--gold);
      background: transparent;
    }

    /* Tarjeta de evidencia */
    .evi-card {
      width: 100%;
      background: var(--bg-2);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px 16px;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s;
    }

    .evi-card:hover {
      transform: translateY(-1px);
      border-color: rgba(181, 161, 96, .35);
      box-shadow: 0 8px 20px rgba(0, 0, 0, .08);
    }

    .evi-icon {
      width: 46px;
      height: 46px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: rgba(181, 161, 96, .08);
      color: var(--gold);
      font-size: 1.2rem;
      flex: 0 0 46px;
    }

    .evi-title {
      color: #212529;
      font-weight: 600;
      line-height: 1.15;
    }

    .evi-meta {
      color: var(--muted);
      font-size: .82rem;
    }

    .evi-chip {
      font-size: .75rem;
      padding: .22rem .5rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, .1);
      background: rgba(0, 0, 0, .03);
      color: var(--muted);
    }

    .evi-actions {
      gap: .5rem;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(0, 0, 0, .12);
      color: var(--brand);
    }

    .btn-ghost:hover {
      border-color: rgba(0, 0, 0, .22);
      background: rgba(0, 0, 0, .04);
    }

    /* Badge estado + dropdown */
    .badge-estado-base {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .35rem .7rem;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid rgba(0, 0, 0, .14);
      text-transform: capitalize;
    }

    .badge-estado.aprobado {
      background: #1f8f5f;
      color: #fff;
    }

    .badge-estado.parcial {
      background: #996c16;
      color: #fff;
    }

    .badge-estado.rechazado {
      background: #8d2a2a;
      color: #fff;
    }

    .badge-estado.revision {
      background: #2a4b8d;
      color: #fff;
    }

    .badge-soft {
      background: rgba(0, 0, 0, .06);
      color: var(--muted);
    }

    /* cuando Bootstrap agrega .show (click) o lo forzamos con JS/hover */
    .estado-dropdown .dropdown-menu.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* si prefieres puro CSS al pasar el mouse por el contenedor */
    .estado-dropdown:hover>.dropdown-menu {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* hacer que el badge comunique “se abre” */
    .badge-estado-base.dropdown-toggle {
      cursor: pointer;
      transition: box-shadow .14s ease, background-color .14s ease, border-color .14s ease;
    }

    .estado-dropdown:hover .badge-estado-base,
    .badge-estado-base:focus {
      box-shadow: 0 0 0 3px rgba(0, 89, 78, .12);
      border-color: rgba(0, 0, 0, .18);
    }

    /* gira el caret cuando está abierto */
    .badge-estado-base.dropdown-toggle::after {
      transition: transform .14s ease;
    }

    .estado-dropdown .dropdown-menu.show~.badge-estado-base.dropdown-toggle::after,
    .estado-dropdown:hover .badge-estado-base.dropdown-toggle::after {
      transform: rotate(180deg);
    }

    /* contraste claro de items */
    .dropdown-menu .dropdown-item {
      font-size: .92rem;
      color: #343a40;
      padding: .5rem .9rem;
    }

    .dropdown-menu .dropdown-item:hover {
      background: rgba(0, 89, 78, .08);
      color: #0b3d36;
    }

    .dropdown-menu .dropdown-item.active,
    .dropdown-menu .dropdown-item:active {
      background-color: var(--brand);
      color: #fff;
    }

    .dropdown-menu {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #ffffff;
    }

    .dropdown-item {
      font-size: .92rem;
    }

    .dropdown-item.active,
    .dropdown-item:active {
      background-color: var(--brand);
      color: #fff;
    }

    /* Utilidades */
    .text-gold {
      color: var(--gold) !important;
    }

    .text-brand {
      color: var(--brand) !important;
    }

    .border-dashed {
      border-style: dashed;
    }
  </style>

  <style>
    .text-blue {
      color: #1959bc !important;
    }

    .iconoUpload {
      color: gray;
      cursor: pointer;
    }

    .iconoUpload:hover {
      color: #00584e;
    }

    /* Aplicar estilos solo a la tabla con el id tableObjetivos_ */
    #tableObjetivos_ {
      width: 100%;
      /* Hacer que la tabla ocupe el 100% del ancho del contenedor */
      table-layout: fixed;
      /* Hacer que las celdas tengan un ancho fijo */
      border-collapse: collapse;
      /* Combina bordes adyacentes entre celdas */
    }

    #tableObjetivos_ th,
    #tableObjetivos_ td {
      padding: 8px;
      /* Espaciado interno (padding) */
      text-align: justify;
      /* Justificar el texto */
      vertical-align: top;
      /* Alinear el texto en la parte superior */
      border: 1px solid #ddd;
      /* Aplicar bordes entre las celdas */
      border-top: none;
      /* Eliminar el borde superior */
      border-left: none;
      /* Eliminar el borde izquierdo */
      word-wrap: break-word;
      /* Permitir que las palabras largas se rompan y ajusten */
      white-space: normal;
      /* Permitir saltos de línea en el texto */
      font-size: 0.8em;
    }

    /* Estilos para las cabeceras */
    #tableObjetivos_ th {
      background-color: #f2f2f2;
      /* Color de fondo de los encabezados */
      border: 1px solid #ddd;
      /* Aplicar bordes internos para las cabeceras */
      border-left: none;
      /* Sin borde izquierdo */
      border-top: none;
      /* Sin borde superior */
    }



    #tableObjetivos_ td:last-child,
    #tableObjetivos_ th:last-child {
      border-right: none;
      /* Eliminar el borde derecho de la última columna */
    }

    #tableObjetivos_ tr {
      line-height: 1.5;
      /* Ajustar la altura de línea */
    }

    /* Agrega un overlay con el degradado */
    #carrusel_img .carousel-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 50%);
      z-index: 1;
    }

    /* Imágenes del carrusel */
    #carrusel_img .carousel-item img {
      display: block;
      width: 100%;
      height: auto;
      opacity: 1;
      z-index: 0;
      /* Asegura que la imagen esté detrás del overlay */
    }

    /* Texto en el carrusel */
    #carrusel_img .carousel-caption {
      position: absolute;
      z-index: 2;
      /* Asegura que el texto esté sobre el overlay */
      color: white;
    }

    #progresoContainer {
      width: 100%;
      max-width: 600px;
      /* Ajusta según sea necesario */
      margin: auto;
      /* Centrar */

    }

    .fixed-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #00594e;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      border: none;
      border-radius: 4px;
      z-index: 1000;
    }

    .fixed-btn:hover {
      background-color: #00453e;
      /* Un tono más oscuro al hacer hover */
    }

    /* Estilo para que los hitos y la tabla sean más agradables y claros */
    #listaHitos .hito-item {
      background: #f6f7fa;
      border-radius: 8px;
      padding: 8px 5px 2px 5px;
      border: 1px solid #e7f3ef;
      margin-bottom: 4px;
      transition: box-shadow 0.15s;
    }

    #listaHitos .hito-item:hover {
      box-shadow: 0 2px 14px #00594e12;
    }

    .chip-indicador {
      display: inline-flex;
      align-items: center;
      gap: 0.4em;
      font-size: 1em;
      border-radius: 16px;
      padding: 3px 13px 3px 11px;
      font-weight: 500;
      background: #f7f7fa;
      box-shadow: 0 1px 4px #e2e5ea25;
      margin-bottom: 2px;
    }

    .timeline-soft li {
      border-left: 2px solid #ececec;
      padding-left: 0.7em;
      position: relative;
      font-size: .97em;
    }

    .timeline-soft li::before {
      content: '';
      position: absolute;
      left: -7px;
      top: 7px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #eee5c6;
      border: 2px solid #efefef;
    }

    .gauges-responsive {
      overflow-x: auto;
      padding-bottom: 5px;
      -webkit-overflow-scrolling: touch;
    }

    .gauge-mini-wrapper {
      min-width: 94px;
      max-width: 94px;
    }

    .gauge-mini {
      min-width: 76px;
      min-height: 54px;
      max-width: 94px;
      max-height: 65px;
    }

    .gauge-label {
      font-size: .98em;
    }

    @media (max-width: 600px) {
      .gauge-mini-wrapper {
        min-width: 74px;
        max-width: 80px;
      }

      .gauge-mini {
        min-width: 56px;
        max-width: 80px;
        min-height: 38px;
        max-height: 45px;
      }
    }
  </style>

</body>

</html>