<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/polariscore/icono.png">
  <title>
    Acciones e Indicadores
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/aa4ade8d2d.js" crossorigin="anonymous"></script>
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
</head>

<body class="g-sidenav-show   bg-gray-100">
  <div class="min-height-300 position-absolute w-100"
    style="background: url('../assets/img/polariscore/bg-gradient.png') no-repeat center center/cover;">
  </div>
  <aside
    class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4 navbar-"
    id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
        aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0 d-flex justify-content-center" href="../index.html">
        <img src="../assets/img/logo-ct-dark.png" class="navbar-brand-img h-100" alt="main_logo">
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <!-- Pol칤ticas -->
        <li class="nav-item">
          <a class="nav-link  d-flex justify-content-between align-items-center" href="#" data-bs-toggle="collapse"
            data-bs-target="#submenuPoliticas" aria-expanded="false">
            <div class="d-flex align-items-center">
              <img src="../assets/img/polariscore/logo.png" class="navbar-brand-img h-100" alt="main_logo">
            </div>
          </a>
          <ul class="collapse list-unstyled ms-4" id="submenuPoliticas"> <!-- 游댠 Agregado "show" -->
            <li class="nav-item"><a class="nav-link" href="../polariscore/dashboard.html"><i
                  class="ni ni-chart-pie-35 text-success"></i> <span class="ms-1">Dashboard</span></a></li>
            <li class="nav-item"><a class="nav-link" href="../polariscore/politicas.html"><i
                  class="ni ni-bullet-list-67 text-primary"></i> <span class="ms-1">Lista de Pol칤ticas</span></a></li>
            <li class="nav-item"><a class="nav-link" href="../polariscore/politicas.html?t="><i
                  class="ni ni-single-copy-04 text-info"></i> <span class="ms-1">Mis Pol칤ticas</span></a></li>
            <li class="nav-item"><a class="nav-link" href="../polariscore/observaciones.html"><i
                  class="ni ni-single-copy-04 text-info"></i> <span class="ms-1">Observaciones</span></a></li>
          </ul>
        </li>

        <!-- Cargar las Pol칤ticas -->
        <li class="nav-item">
          <a class="nav-link active d-flex justify-content-between align-items-center" href="#"
            data-bs-toggle="collapse" data-bs-target="#cargarPoliticas" aria-expanded="true">
            <div class="d-flex align-items-center">
              <span class="nav-link-text ms-1"><i class="fa fa-gavel me-2"></i> Seleccionar pol칤tica</span>
            </div>
          </a>
          <ul class="collapse show list-unstyled ms-4" id="cargarPoliticas"> <!-- 游댠 Agregado "show" -->

          </ul>
        </li>

        <!-- Contenido exclusivo para administradores -->
        <li class="nav-item">
          <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#"
            data-bs-toggle="collapse" data-bs-target="#submenuPdi" aria-expanded="false">
            <div class="d-flex align-items-start">
              <span class="nav-link-text ms-1"><i class="fa-solid fa-rocket me-2"></i>Otras Aplicaciones</span>
            </div>
          </a>
          <ul class="collapse list-unstyled ms-1" id="submenuPdi">

            <li class="nav-item">
              <a class="nav-link" href="https://sigunitropico.com"
                onclick="window.open(this.href, '_blank'); return false;">
                <div
                  class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                  <i class="ni ni-world-2 text-danger text-sm opacity-10"></i>
                </div>
                <span class="nav-link-text ms-1">SIG Unitr칩pico</span>
              </a>

            </li>
            <li class="nav-item"><a class="nav-link" href="https://sigunitropico.com/planeacion"
                onclick="window.open(this.href, '_blank'); return false;">
                <div
                  class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                  <i class="ni ni-chart-bar-32 text-info text-sm opacity-10"></i>
                </div>
                <span class="nav-link-text ms-1">Planeaci칩n</span>
              </a></li>
          </ul>
        </li>


        <li class="nav-item mt-3 admin-only admin-polariscore" style="display: none;">
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Administraci칩n</h6>
        </li>
        <li class="nav-item admin-only admin-polariscore" style="display: none;">
          <a class="nav-link" href="../pages/usuarios.html" onclick="window.open(this.href); return false;">
            <div
              class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fa-solid fa-users text-danger text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1 ">Usuarios</span>
          </a>
        </li>

      </ul>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          let navLinks = document.querySelectorAll(".nav-link[data-bs-toggle='collapse']");

          navLinks.forEach(link => {
            link.addEventListener("click", function () {
              let target = document.querySelector(this.getAttribute("data-bs-target"));

              // Cierra todos los submen칰s excepto el que se est치 abriendo
              document.querySelectorAll(".collapse.show").forEach(openMenu => {
                if (openMenu !== target) {
                  new bootstrap.Collapse(openMenu, { toggle: false }).hide();
                }
              });
            });
          });
        });
      </script>

    </div>
    <div class="sidenav-footer mx-3 ">
      <div class="card card-plain shadow-none" id="sidenavCard">
        <img class="w-80 mx-auto" src="../assets/img/illustrations/logo-simbolo-unitropico-1.png"
          alt="sidebar_illustration">
        <div class="card-body text-center p-3 w-100 pt-0">
          <div class="docs-info">
            <h6 class="mb-0">쯅ecesitas ayuda?</h6>
            <p class="text-xs font-weight-bold mb-0">Por favor revisa nuestras gu칤as</p>
          </div>
        </div>
      </div>
      <a href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard" target="_blank"
        class="btn btn-dark btn-sm w-100 mb-3">Documentaci칩n</a>
      <a class="btn btn-primary btn-sm mb-0 w-100" href="mailto:innovacionplaneacion@unitropico.edu.co"
        type="button">Contactar al equipo t칠cnico</a>
    </div>
  </aside>
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->

    <style>
      @media (max-width: 768px) {
        .ocultar {
          display: none !important;
        }

        .margin-top-5 {
          margin-top: 5%;
        }

        .resaltar {
          background-color: #00594e;
          border-radius: 0px;
          margin: 0px auto !important;
        }

        .fecha_actualizacion {
          font-size: 0.9rem;
          color: #fff;

        }

        .ocultarPc {
          display: block;
        }
      }

      @media (min-width: 1200px) {
        .ocultarPc {
          display: none;
        }
      }
    </style>
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl resaltar" id="navbarBlur"
      data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm ocultar"><a class="opacity-5 text-white "
                href="politicas.html">Pol칤ticas</a></li>
            <li class="breadcrumb-item text-sm ocultar"><a class="opacity-5 text-white fecha_actualizacion"
                href="politicas.html" id="namePolitica">Pol칤tica</a></li>
            <li class="breadcrumb-item text-sm text-white active ocultar" id="idName" aria-current="page"> IAP-000</li>

          </ol>
          <li class="breadcrumb-item text-sm text-white active ocultarPc" onclick="history.back()" aria-current="page">
            <i class="fa-solid fa-angle-left"></i> Volver
          </li>
          <h6 class="font-weight-bolder text-white mb-0 ocultar">Detalles de la Acci칩n</h6>
        </nav>
        <div class="ms-md-auto pe-md-3 d-flex align-items-center">

        </div>


        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">

          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>

            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="dropdownMenuButton" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fa fa-bell cursor-pointer"></i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New message</span> from Laur
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          13 minutes ago
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/small-logos/logo-spotify.svg"
                          class="avatar avatar-sm bg-gradient-dark  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New album</span> by Travis Scott
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          1 day
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background"
                                    d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z"
                                    opacity="0.593633743"></path>
                                  <path class="color-background"
                                    d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z">
                                  </path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          Payment successfully completed
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          2 days
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <div id="perfilUsuario" class="d-flex align-items-center gap-2" data-bs-toggle="dropdown" role="button"
                aria-expanded="false">
                <img id="imgPerfilUsuario" src="https://ui-avatars.com/api/?name=Usuario" alt="Foto"
                  class="rounded-circle border" width="40" height="40" style="object-fit:cover;">
              </div>
              <ul class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4" aria-labelledby="perfilUsuario">
                <li>
                  <a class="dropdown-item border-radius-md" href="../pages/profile.html">
                    <div class="d-flex py-1 align-items-center">
                      <div class="my-auto">
                        <img id="imgPerfilUsuarioDropdown" src="https://ui-avatars.com/api/?name=Usuario"
                          class="avatar avatar-sm me-3 rounded-circle border" style="object-fit:cover;">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm text-default fw-bold" id="nombrePerfilUsuario"> Usuario</h6>
                        <small class="text-xs text-muted mb-0" id="correoPerfilUsuario">2</small>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" id="rolesUsuario">
                    <i class="fas fa-user-circle text-primary me-2"></i> Usuario
                  </a>
                </li>
                <li>
                  <button id="logButton" class="dropdown-item border-radius-md text-danger d-flex align-items-center">
                    <span><i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar sesi칩n</span>
                  </button>
                  <style>
                    /* Soluciona contraste para bot칩n rojo dentro de dropdown Bootstrap */
                    #logButton.dropdown-item.text-danger:hover,
                    #logButton.dropdown-item.text-danger:focus {
                      background-color: #dc3545 !important;
                      /* danger */
                      color: #fff !important;
                      /* blanco */
                      border-radius: .5rem;
                    }

                    #logButton.dropdown-item.text-danger:hover i,
                    #logButton.dropdown-item.text-danger:focus i {
                      color: #fff !important;
                    }
                  </style>
                </li>
              </ul>
            </li>


          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->

    <!----------------- INICIO del contenido --------------->


    <div class="container-fluid py-4">
      <div class="row mb-4 gx-3">
        <div class="col-lg-12">
          <h3 class="text-center text-uppercase font-weight-bold mb-3 text-white">
            Seguimiento de Cumplimiento de la Acci칩n
          </h3>
        </div>
      </div>

      <!-- Secci칩n de detalles generales -->
      <div class="row text-center mb-4 gx-3">
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Pol칤tica</h6>
              <h4 class="font-weight-bolder" id="titulo_politica" style="line-height: 98%;">Cargando...</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Objetivo General</h6>
              <p id="objetivo_general" class="mb-0">Cargando...</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Indicador</h6>
              <p id="indicador_politica" class="mb-0">Cargando...</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted mb-2">Fecha de Inicio</h6>
              <p id="fecha_inicio" class="mb-0">Cargando...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Secci칩n de gr치ficas -->
      <div class="row text-center mb-3 gx-3">
        <div class="col-md-8 mb-2">
          <div class="card shadow-sm ">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="text-uppercase text-muted mb-2 text-center w-100">Cumplimiento por a침os Programado vs
                  Ejecutado</h6>


              </div>
              <div id="grafica_tiempo" style="width: 100%; max-height: 400px;"></div>
            </div>

            <!-- Estilos para los botones -->
            <style>
              .btn-export {
                background: none;
                border: none;
                color: #adb5bd;
                /* Gris claro */
                font-size: 18px;
              }

              .btn-export:hover {
                color: #6c757d;
                /* Gris oscuro */
              }
            </style>

          </div>
        </div>
        <div class="col-md-4 mb-3" id="exportarGraficaAccion">
          <div class="card shadow-sm h-100" style="cursor: pointer;">
            <div class="card-body">

              <!-- Cabecera con bot칩n a la derecha -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="text-center w-100">
                  <h6 class="text-uppercase text-muted mb-1">Cumplimiento de la acci칩n</h6>
                  <p class="mb-0">Gr치fica de cumplimiento total de la acci칩n</p>
                </div>

                <!-- Bot칩n para Exportar Imagen -->
                <div class="ms-auto">
                  <button onclick="exportarElementoComoImagen('exportarGraficaAccion', 'cumplimiento_total_accion.png')"
                    class="btn-export">
                    <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" fill="currentColor"
                      class="bi bi-download" viewBox="0 0 16 16">
                      <path
                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5" />
                      <path
                        d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Contenedor de la gr치fica -->
              <div id="grafica_cumplimiento" style="max-height: 400px;" class="text-center"
                onclick="abrirEvaluarModal('${evidenciaId}')">
                <svg viewBox="0 0 100 160"
                  style="width: 100%; height: auto; max-width: 150px; margin: 0 auto; display: block;">
                  <image class="stat-svg" href="../assets/img/stat.svg" x="0" y="0" width="100" height="160"
                    opacity="0.6" />
                  <defs>
                    <clipPath id="clip-overlay">
                      <rect id="clip-rect" x="0" y="0" width="100" height="400" />
                    </clipPath>
                    <filter id="colorFilter" x="0" y="0" width="100%" height="100%">
                      <feColorMatrix id="matrix" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1 0" />
                    </filter>
                  </defs>
                  <image class="stat-svg" id="overlay" href="../assets/img/stat1.svg" x="0" y="0" width="100"
                    height="160" clip-path="url(#clip-overlay)" />
                </svg>
                <p id="porcentaje" style="font-weight: bold;">0%</p>
              </div>

            </div>
          </div>

        </div>
      </div>



      <!-- Secci칩n de acci칩n y resumen -->
      <div class="row text-center mb-2 gx-3">
        <div class="col-md-8 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-gradient-success text-white text-uppercase font-weight-bold">
              Detalles de la Acci칩n
            </div>
            <div class="card-body" id="detalle_politica">
              Cargando detalles...
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-gradient-secondary text-white text-uppercase font-weight-bold">
              Resumen de Evaluaci칩n
            </div>
            <div class="card-body" id="resumen_politica">
              Cargando resumen...
            </div>
          </div>
        </div>
      </div>

      <!-- Secci칩n de tabla (visible solo para responsables y admins) -->
      <div class="row mt-4 gx-3 admin-only admin-polariscore-only responsable-polariscore-only" style="display: none;">
        <div class="col-lg-12">
          <div class="card shadow-sm">
            <div class="card-header bg-gradient-success text-white text-uppercase font-weight-bold">
              Documentos y Evidencias <small>(Visible solo para responsables y administradores)</small>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover table-bordered text-center" id="tabla_cumplimiento">
                  <thead class="bg-light">
                    <tr>
                      <th>Evidencia</th>
                      <th>Responsables</th>
                      <th>Formatos permitidos</th>
                      <th>Acci칩n</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="4">Cargando...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- Bot칩n para abrir el modal -->
              <div class="text-start admin-only admin-polariscore-only" style="display: none;">
                <button type="button" class="btn btn-outline-success btn-sm me-2" data-bs-toggle="modal"
                  data-bs-target="#modalAgregarEvidencia">
                  <i class="fa-solid fa-plus"></i> A침adir Evidencia
                </button>
                <button class="btn btn-outline-info btn-sm me-2" title="Evaluar"
                  onclick="abrirEvaluarModal('${evidenciaId}')">
                  <i class="fa-solid fa-file-pen"></i> Evaluar Acci칩n
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bloque visual del indicador de la acci칩n -->
      <div class="row mt-4 gx-3 admin-only admin-polariscore-only responsable-polariscore-only" style="display: none;">
        <div class="col-lg-12">
          <div class="card shadow-sm">
            <div class="card-header bg-gradient-success text-white text-uppercase font-weight-bold">
              <i class="fa-solid fa-chart-line me-2"></i>
              Desglose del Indicador <small class="text-white-50">(Visible solo para responsables y
                administradores)</small>
            </div>
            <div class="card-body pb-3 pt-3">
              <h2>Proyecci칩n</h2>
              <!-- Aqu칤 se renderiza visualmente el indicador -->
              <div id="indicadorVisual" class="w-100"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex gap-2 align-items-center mb-3 admin-polariscore-only" style="margin-top: 2%; display: none;">
        <button class="btn btn-outline-secondary fw-semibold rounded-pill shadow-sm px-4 py-2" onclick="history.back()">
          <i class="fa-solid fa-arrow-left me-2"></i> Volver atr치s
        </button>
        <button class="btn btn-outline-success fw-semibold rounded-pill shadow-sm px-4 py-2 " id="btnCrearIndicador">
          <i class="fa-solid fa-plus me-2"></i> Crear indicador
        </button>
        <button class="btn btn-outline-danger fw-semibold rounded-pill shadow-sm px-4 py-2 " id="btnEliminarIndicador">
          <i class="fa-solid fa-trash me-2"></i> Eliminar indicador
        </button>
      </div>

    </div>
    <!--- FIN del contenido --->

    <!-- Modal Crear Indicador -->
    <div class="modal fade" id="modalCrearIndicador" tabindex="-1" aria-labelledby="labelModalCrearIndicador"
      aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <form class="modal-content" id="formCrearIndicador">
          <div class="modal-header">
            <h5 class="modal-title" id="labelModalCrearIndicador">
              <i class="fas fa-chart-line me-2"></i> Crear indicador de acci칩n
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- 1. Selecci칩n tipo indicador -->
            <div class="mb-3">
              <label class="form-label fw-bold">Tipo de indicador</label>
              <select id="tipoIndicador" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="hitos">Hitos</option>
                <option value="cumplimiento">Cumplimiento</option>
                <option value="productos">Productos</option>
              </select>
            </div>
            <!-- 2. Si es hitos: agregar hitos -->
            <div id="bloqueHitos" class="mb-3" style="display:none;">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="fw-semibold text-success">Hitos de la acci칩n</span>
                <button type="button" class="btn btn-outline-success btn-sm rounded-pill px-3 py-1" id="btnAgregarHito">
                  <i class="fa fa-plus me-1"></i> Agregar hito
                </button>
              </div>
              <div id="listaHitos"></div>
            </div>
            <!-- 3. Tipo de m칠trica -->
            <div class="mb-3">
              <label class="form-label fw-bold">Tipo de m칠trica</label>
              <select id="tipoMetrica" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="acumulado">Acumulado</option>
                <option value="flujo">Flujo</option>
              </select>
              <small id="acumuladoAyuda" class="text-muted" style="display:none;">
                <i class="fa fa-info-circle"></i> La suma de la programaci칩n por a침o no puede superar el 100%.
              </small>
            </div>
            <!-- 4. Descripci칩n del indicador -->
            <div class="mb-3">
              <label class="form-label fw-bold">Descripci칩n del indicador</label>
              <textarea class="form-control" id="descripcionIndicador" required></textarea>
            </div>
            <!-- 5. Programaci칩n por a침o -->
            <div class="mb-3">
              <label class="form-label fw-bold">Programaci칩n de cumplimiento anual (%) del indicador</label>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0" id="tablaProgramacionAnios">
                  <thead class="table-light">
                    <tr>
                      <th>A침o</th>
                      <th>Programado (%)</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyProgramacionAnios"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary px-4" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-success px-4 fw-semibold" type="submit">
              <i class="fa fa-save me-1"></i> Guardar indicador
            </button>
          </div>
        </form>
      </div>
    </div>



    <footer class="footer pt-3  ">
      <div class="container-fluid">
        <div class="row align-items-center justify-content-lg-between">
          <div class="col-lg-6 mb-lg-0 mb-4">
            <div class="copyright text-center text-sm text-muted text-lg-start">
              춸
              <script>
                document.write(new Date().getFullYear())
              </script>,
              desarrollado por la <a style="font-weight: 600; color: #00584e;"
                href="https://sigunitropico.com/planeacion-estrategica">Oficina Asesora de Planeaci칩n</a> - Unitr칩pico

            </div>
          </div>
          <div class="col-lg-6">
            <ul class="nav nav-footer justify-content-center justify-content-lg-end">
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Synaris Corp</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Nosotros</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Blog</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link pe-0 text-muted" target="_blank">Licencia</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    </div>


    <!--------- Fin del contenido ----------->
  </main>
  <div class="fixed-plugin">
    <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
      <i class="fa fa-cog py-2"> </i>
    </a>

    <style>
      /* Estilo base para botones flotantes */
      .boton-politica {
        position: fixed;
        right: 1.8%;
        z-index: 5;
        background-color: #ffffff;
        color: #00594E;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
        border: 2px solid #00594E;
      }

      @media (max-width: 768px) {

        .boton-politica {
          right: 5%;
        }

      }

      .boton-politica:hover {
        background-color: #00594E;
        color: #ffffff;
        transform: scale(1.1);
      }

      .boton-politica svg {
        pointer-events: none;
      }

      /* Posiciones individuales */
      #anteriorBtn {
        bottom: 10%;
      }

      #siguienteBtn {
        bottom: 16%;
      }

      #documentosBtn {
        bottom: 22%;
        border: 2px solid #b5a160;
        color: #b5a160;
      }

      #documentosBtn:hover {
        background-color: #b5a160;
        color: #fff;
      }

      /* Estilo para deshabilitado visual */
      .boton-politica.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
    </style>

    <a id="anteriorBtn" class="boton-politica" title="Pol칤tica Anterior" href="#">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-left"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
      </svg>
    </a>

    <a id="siguienteBtn" class="boton-politica" title="Pol칤tica Siguiente" href="#">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-right"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8" />
      </svg>
    </a>
    <a id="documentosBtn" class="boton-politica" title="Ver Documentos" href="#" data-bs-toggle="modal"
      data-bs-target="#DocumentosModal">
      <i class="fa-solid fa-folder-open"></i>
    </a>

    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3 ">
        <div class="float-start">
          <h5 class="mt-3 mb-0">PolariScore</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="fa fa-close"></i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0 overflow-auto">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-gradient-primary active" data-color="primary"
              onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between 2 different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn bg-gradient-primary w-100 px-3 mb-2 active me-2" data-class="bg-white"
            onclick="sidebarType(this)">White</button>
          <button class="btn bg-gradient-primary w-100 px-3 mb-2" data-class="bg-default"
            onclick="sidebarType(this)">Dark</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="d-flex my-3">
          <h6 class="mb-0">Navbar Fixed</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
          </div>
        </div>
        <hr class="horizontal dark my-sm-4">
        <div class="mt-2 mb-5 d-flex">
          <h6 class="mb-0">Light / Dark</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version" onclick="darkMode(this)">
          </div>
        </div>
        <a class="btn bg-gradient-dark w-100" href="https://www.creative-tim.com/product/argon-dashboard">Free
          Download</a>
        <a class="btn btn-outline-dark w-100"
          href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard">View documentation</a>
        <div class="w-100 text-center">
          <a class="github-button" href="https://github.com/creativetimofficial/argon-dashboard"
            data-icon="octicon-star" data-size="large" data-show-count="true"
            aria-label="Star creativetimofficial/argon-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="https://twitter.com/intent/tweet?text=Check%20Argon%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fargon-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/argon-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal DOCUMENTOS -->
  <div class="modal fade" id="DocumentosModal" tabindex="-1" role="dialog" aria-labelledby="DocumentosLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="DocumentosLabel">Documentos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Contenido de la tarjeta aqu칤 -->

          <div class="col-lg-12">
            <div class="card h-100">
              <div class="card-header pb-0 p-3">
                <div class="row">
                  <div class="col-6 d-flex align-items-center">
                    <h6 class="mb-0">Documentos del proyecto</h6>
                  </div>
                  <div class="col-6 text-end">
                    <button class="btn btn-outline-primary btn-sm mb-0" id="descargar_todo">Descargar todo</button>
                  </div>
                </div>
              </div>
              <div class="card-body p-3 pb-0" id="modalDocumentos">
                <ul class="list-group">
                  <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
                    <div class="d-flex flex-column">
                      <h6 class="mb-1 text-dark font-weight-bold text-sm">March, 01, 2020</h6>
                      <span class="text-xs">#MS-415646</span>
                    </div>
                    <div class="d-flex align-items-center text-sm">
                      $180
                      <button class="btn btn-link text-dark text-sm mb-0 px-0 ms-4"><i
                          class="fas fa-file-pdf text-lg me-1"></i> PDF</button>
                    </div>
                  </li>

                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Limita la altura del modal y permite scroll solo en el contenido */
    .modal-dialog.custom-modal-height {
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-content {
      flex: 1 1 auto;
      overflow: hidden;
    }

    .modal-body {
      overflow-y: auto;
      max-height: calc(90vh - 120px);
      /* Ajusta seg칰n tu header/footer */
    }
  </style>


  <!-- Modal EVIDENCIAS -->
  <div class="modal fade" id="evidenciasModal" tabindex="-1" role="dialog" aria-labelledby="evidenciasLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg custom-modal-width custom-modal-height" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="evidenciasLabel">Evidencias Subidas - <span id="tituloEvidencias">Pol칤tica</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Nav principal -->
          <ul class="nav nav-tabs nav-fill mb-3" id="navTabCargaMasiva" role="tablist">
            <li class="nav-item">
              <button class="nav-link active small" id="tab-acciones-tab" data-bs-toggle="tab"
                data-bs-target="#tab-acciones" type="button" role="tab">Evidencias</button>
            </li>
            <li class="nav-item">
              <button class="nav-link small" id="tab-resumen-tab" data-bs-toggle="tab" data-bs-target="#tab-resumen"
                type="button" role="tab">Resumen</button>
            </li>
            <li class="nav-item responsable-polariscore-only" style="display: none;">
              <button class="nav-link small" id="tab-evidencias-tab" data-bs-toggle="tab"
                data-bs-target="#tab-evidencias" type="button" role="tab">Cargar Evidencias</button>
            </li>
          </ul>

          <!-- Contenido de tabs -->
          <div class="tab-content" id="navTabCargaMasivaContent">
            <!-- TAB: Acciones -->
            <div class="tab-pane fade show active" id="tab-acciones" role="tabpanel">
              <!-- Sub-tabs por a침o -->
              <ul class="nav nav-tabs mb-3" id="evidenciasTabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="anio1-tab"
                    data-bs-toggle="tab" data-bs-target="#anio1" type="button" role="tab">A침o 1</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio2-tab" data-bs-toggle="tab"
                    data-bs-target="#anio2" type="button" role="tab">A침o 2</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio3-tab" data-bs-toggle="tab"
                    data-bs-target="#anio3" type="button" role="tab">A침o 3</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio4-tab" data-bs-toggle="tab"
                    data-bs-target="#anio4" type="button" role="tab">A침o 4</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio5-tab" data-bs-toggle="tab"
                    data-bs-target="#anio5" type="button" role="tab">A침o 5</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="anio6-tab" data-bs-toggle="tab"
                    data-bs-target="#anio6" type="button" role="tab">A침o 6</button></li>
              </ul>

              <!-- Contenido sub-tabs -->
              <div class="tab-content" id="evidenciasTabContent">
                <div class="tab-pane fade show active" id="anio1" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio2" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio3" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio4" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio5" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
                <div class="tab-pane fade" id="anio6" role="tabpanel">
                  <ul class="list-group"></ul>
                </div>
              </div>
            </div>

            <!-- TAB: Resumen -->
            <div class="tab-pane fade" id="tab-resumen" role="tabpanel" style="max-height: 120vh; overflow: hidden;">
              <p>hola</p>
            </div>

            <!-- TAB: Cargar Evidencias -->
            <div class="tab-pane fade responsable-polariscore-only" style="display: none;" id="tab-evidencias"
              role="tabpanel">
              <div class="mb-4">
                <h6>Subir nuevo intento de evidencia</h6>
                <form id="uploadForm">
                  <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripci칩n</label>
                    <input type="text" class="form-control" id="descripcion" placeholder="Ingrese una descripci칩n">
                  </div>
                  <div class="mb-3">
                    <label for="archivo" class="form-label">Seleccionar archivo</label>
                    <input type="file" class="form-control" id="archivo">
                  </div>
                  <div class="mb-3">
                    <label for="anioEvidencia" class="form-label">A침o de la evidencia</label>
                    <select class="form-select" id="anioEvidencia" name="anioEvidencia">
                      <option value="1655305200">2022</option>
                      <option value="1686831600">2023</option>
                      <option value="1718367600">2024</option>
                      <option value="1749999600">2025</option>
                      <option value="1781535600">2026</option>
                      <option value="1813071600">2027</option>
                      <option value="1844696400">2028</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">Subir Evidencia</button>
                </form>
                <p class="mt-3 text-danger">Fecha l칤mite para subir la evidencia:
                  <strong id="fechaLimiteEvidencias">Cargando...</strong>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- END Modal EVIDENCIAS -->





  <!-- Modal para agregar evidencia -->
  <div class="modal fade" id="modalAgregarEvidencia" tabindex="-1" aria-labelledby="modalAgregarEvidenciaLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAgregarEvidenciaLabel">A침adir Nueva Evidencia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formAgregarEvidencia">
            <!-- Campo de T칤tulo -->
            <div class="mb-3">
              <label for="tituloEvidencia" class="form-label">T칤tulo de la Evidencia</label>
              <input type="text" class="form-control" id="tituloEvidencia" required>
            </div>

            <!-- Campo de Formato -->
            <div class="mb-3">
              <label for="formatoEvidencia" class="form-label">Formato</label>
              <select class="form-select" id="formatoEvidencia" required>
                <option value="PDF">PDF</option>
                <option value="Excel">Excel</option>
                <option value="Word">Word</option>
                <option value="Otro">Otro (Especificar)</option>
              </select>
            </div>

            <!-- Campo para otro formato (oculto por defecto) -->
            <div class="mb-3" id="otroFormatoContainer" style="display: none;">
              <label for="otroFormato" class="form-label">Especificar Formato</label>
              <input type="text" class="form-control" id="otroFormato">
            </div>

            <!-- Peso M치ximo (Oculto si es PDF, Excel o Word) -->
            <div class="mb-3" id="pesoMaxContainer" style="display: none;">
              <label for="pesoMax" class="form-label">Peso M치ximo (MB)</label>
              <input type="number" class="form-control" id="pesoMax" value="80" readonly>
            </div>

            <!-- Bot칩n de Guardar -->
            <div class="text-end">
              <button type="submit" class="btn btn-success">
                <i class="fa-solid fa-floppy-disk"></i> Guardar Evidencia
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- End Modal para agregar evidencia -->


  <!-- Modal EVALUAR -->
  <div class="modal fade" id="evaluarModal" tabindex="-1" aria-labelledby="evaluarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content shadow-sm">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title text-white" id="evaluarLabel">
            <i class="fa-solid fa-scale-balanced me-2"></i> Evaluar Acci칩n
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">

          <!-- Nav Tabs -->
          <ul class="nav nav-tabs" id="navTabEjemplo" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1" type="button"
                role="tab" aria-controls="tab1" aria-selected="true">A침o 1</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2" type="button"
                role="tab" aria-controls="tab2" aria-selected="false">A침o 2</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button"
                role="tab" aria-controls="tab3" aria-selected="false">A침o 3</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab4-tab" data-bs-toggle="tab" data-bs-target="#tab4" type="button"
                role="tab" aria-controls="tab4" aria-selected="false">A침o 4</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab5-tab" data-bs-toggle="tab" data-bs-target="#tab5" type="button"
                role="tab" aria-controls="tab5" aria-selected="false">A침o 5</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab6-tab" data-bs-toggle="tab" data-bs-target="#tab6" type="button"
                role="tab" aria-controls="tab6" aria-selected="false">A침o 6</button>
            </li>
          </ul>

          <!-- Contenido de las pesta침as -->
          <div class="tab-content mt-3" id="navTabEjemploContent">
            <!-- Plantilla repetida para cada a침o -->
            <!-- A침o 1 -->
            <div class="tab-pane fade show active p-3 border rounded-3 bg-light" id="tab1" role="tabpanel"
              aria-labelledby="tab1-tab">
              <!-- Instrucci칩n -->
              <p class="mb-3 text-muted text-center">Completa el campo para evaluar la ejecuci칩n:</p>

              <!-- Secci칩n de evaluaci칩n -->
              <div class="d-flex justify-content-center align-items-center gap-3 mb-4">

                <!-- Ejecutado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" class="form-control text-center input-ejecutado" value="5" style="width: 80px;">
                </div>

                <!-- Separador -->
                <span class="fs-4">/</span>

                <!-- Programado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" class="form-control text-center input-programado" value="6" readonly
                    style="width: 80px; background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Nota -->
              <p class="text-center text-sm text-muted">* Solo se modifica el Ejecutado (avance actual)</p>
            </div>

            <!-- A침os 2 al 6 (id칠ntico contenido, sin clase `active`) -->
            <!-- A침o 2 -->
            <div class="tab-pane fade show active p-3 border rounded-3 bg-light" id="tab2" role="tabpanel"
              aria-labelledby="tab2-tab">
              <!-- Instrucci칩n -->
              <p class="mb-3 text-muted text-center">Completa el campo para evaluar la ejecuci칩n:</p>

              <!-- Secci칩n de evaluaci칩n -->
              <div class="d-flex justify-content-center align-items-center gap-3 mb-4">

                <!-- Ejecutado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" class="form-control text-center input-ejecutado" value="5" style="width: 80px;">
                </div>

                <!-- Separador -->
                <span class="fs-4">/</span>

                <!-- Programado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" class="form-control text-center input-programado" value="6" readonly
                    style="width: 80px; background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Nota -->
              <p class="text-center text-sm text-muted">* Solo se modifica el Ejecutado (avance actual)</p>
            </div>

            <!-- A침o 3 -->
            <div class="tab-pane fade show active p-3 border rounded-3 bg-light" id="tab3" role="tabpanel"
              aria-labelledby="tab3-tab">
              <!-- Instrucci칩n -->
              <p class="mb-3 text-muted text-center">Completa el campo para evaluar la ejecuci칩n:</p>

              <!-- Secci칩n de evaluaci칩n -->
              <div class="d-flex justify-content-center align-items-center gap-3 mb-4">

                <!-- Ejecutado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" class="form-control text-center input-ejecutado" value="5" style="width: 80px;">
                </div>

                <!-- Separador -->
                <span class="fs-4">/</span>

                <!-- Programado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" class="form-control text-center input-programado" value="6" readonly
                    style="width: 80px; background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Nota -->
              <p class="text-center text-sm text-muted">* Solo se modifica el Ejecutado (avance actual)</p>
            </div>
            <!-- A침o 4 -->
            <div class="tab-pane fade show active p-3 border rounded-3 bg-light" id="tab4" role="tabpanel"
              aria-labelledby="tab4-tab">
              <!-- Instrucci칩n -->
              <p class="mb-3 text-muted text-center">Completa el campo para evaluar la ejecuci칩n:</p>

              <!-- Secci칩n de evaluaci칩n -->
              <div class="d-flex justify-content-center align-items-center gap-3 mb-4">

                <!-- Ejecutado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" class="form-control text-center input-ejecutado" value="5" style="width: 80px;">
                </div>

                <!-- Separador -->
                <span class="fs-4">/</span>

                <!-- Programado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" class="form-control text-center input-programado" value="6" readonly
                    style="width: 80px; background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Nota -->
              <p class="text-center text-sm text-muted">* Solo se modifica el Ejecutado (avance actual)</p>
            </div>

            <!-- A침o 5 -->
            <div class="tab-pane fade show active p-3 border rounded-3 bg-light" id="tab5" role="tabpanel"
              aria-labelledby="tab5-tab">
              <!-- Instrucci칩n -->
              <p class="mb-3 text-muted text-center">Completa el campo para evaluar la ejecuci칩n:</p>

              <!-- Secci칩n de evaluaci칩n -->
              <div class="d-flex justify-content-center align-items-center gap-3 mb-4">

                <!-- Ejecutado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" class="form-control text-center input-ejecutado" value="5" style="width: 80px;">
                </div>

                <!-- Separador -->
                <span class="fs-4">/</span>

                <!-- Programado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" class="form-control text-center input-programado" value="6" readonly
                    style="width: 80px; background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Nota -->
              <p class="text-center text-sm text-muted">* Solo se modifica el Ejecutado (avance actual)</p>
            </div>

            <!-- A침o 6 -->
            <div class="tab-pane fade show active p-3 border rounded-3 bg-light" id="tab6" role="tabpanel"
              aria-labelledby="tab6-tab">
              <!-- Instrucci칩n -->
              <p class="mb-3 text-muted text-center">Completa el campo para evaluar la ejecuci칩n:</p>

              <!-- Secci칩n de evaluaci칩n -->
              <div class="d-flex justify-content-center align-items-center gap-3 mb-4">

                <!-- Ejecutado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Ejecutado</label>
                  <input type="number" class="form-control text-center input-ejecutado" value="5" style="width: 80px;">
                </div>

                <!-- Separador -->
                <span class="fs-4">/</span>

                <!-- Programado -->
                <div class="text-center">
                  <label class="fw-bold mb-1">Programado</label>
                  <input type="number" class="form-control text-center input-programado" value="6" readonly
                    style="width: 80px; background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Nota -->
              <p class="text-center text-sm text-muted">* Solo se modifica el Ejecutado (avance actual)</p>
            </div>
          </div>

          <hr>

          <!-- Historial de Evaluaciones -->
          <h6 class="text-uppercase text-muted mb-3 mt-4">Historial de Evaluaciones</h6>
          <ul class="list-group small" id="historialEvaluaciones">
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>游딉 25/03/2025</strong><br>
                  <span class="text-muted">游닎 apoyoAmbiental@unitropico.edu.co</span>
                </div>
                <div class="text-end">
                  <strong>6 / 5</strong><br>
                  <span class="badge bg-success rounded-pill mt-1">120%</span>
                </div>
              </div>
            </li>
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>游딉 15/02/2025</strong><br>
                  <span class="text-muted">游닎 apoyoAmbientalunitropico.edu.co</span>
                </div>
                <div class="text-end">
                  <strong>5 / 5</strong><br>
                  <span class="badge bg-info rounded-pill mt-1">100%</span>
                </div>
              </div>
            </li>
          </ul>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-info text-white" onclick="guardarEvaluacion()">Guardar
            Evaluaci칩n</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Modal OBSERVACIONES -->
  <div class="modal fade" id="observacionesModal" tabindex="-1" role="dialog" aria-labelledby="observacionesLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title d-flex align-items-center text-white" id="observacionesLabel">
            <i class="fa-regular fa-comments me-2 text-white"></i> Observaciones
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <!-- Chat de Observaciones -->
          <div id="chatObservaciones" class="overflow-auto px-2"
            style="max-height: 500px; min-height: 300px; display: flex; flex-direction: column-reverse;">
            <ul class="list-unstyled mb-0" id="listaMensajes">
              <li class="text-center text-muted">Cargando mensajes...</li>
            </ul>
          </div>

          <!-- Campo de entrada y bot칩n de env칤o -->
          <div class="mt-3">
            <div class="input-group">
              <input type="text" id="mensajeObservacion" class="form-control rounded-start-pill"
                placeholder="Escribe un mensaje..." style="height: 45px;">
              <button class="btn btn-primary rounded-end-pill d-flex align-items-center justify-content-center"
                style="width: 50px; height: 45px;" onclick="enviarMensajeObservacion()">
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- end Modal OBSERVACIONES -->

  <!-- Modal de Confirmaci칩n para Eliminar Evidencia -->
  <div class="modal fade" id="modalEliminarEvidencia" tabindex="-1" aria-labelledby="modalEliminarEvidenciaLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title text-white" id="modalEliminarEvidenciaLabel">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> Confirmar Eliminaci칩n
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body text-center">
          <p class="mb-0 fs-6">쮼st치s seguro de eliminar esta evidencia?</p>
          <small class="text-muted">Esta acci칩n no se puede deshacer.</small>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmarEliminarEvidencia">
            <i class="fa-solid fa-trash me-1"></i> Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal de Confirmaci칩n de Cierre de Sesi칩n -->
  <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutLabel">Cerrar sesi칩n</h5>
        </div>
        <div class="modal-body text-center">
          <p>쮼st치s seguro de que quieres cerrar sesi칩n?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmLogout">Cerrar sesi칩n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor de notificaciones (Toasts) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="toastContainer"></div>
  </div>

  <!--   Core JS Files   -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- html2canvas primero -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- canvg despu칠s -->
  <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.9/lib/umd.min.js"></script>


  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example /pages etc -->
  <script src="../assets/js/argon-dashboard.min.js?v=2.0.4"></script>
  <script type="module">
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, get, update, remove } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
    import { getStorage, ref as storageRef, listAll, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-storage.js";



    // Configuraci칩n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyADKfjkB9LO1k1smRJ31sOb-7rrxOrQ7lc",
      authDomain: "sigunitropico.firebaseapp.com",
      databaseURL: "https://sigunitropico-default-rtdb.firebaseio.com/",
      projectId: "sigunitropico",
      storageBucket: "sigunitropico.appspot.com",
      messagingSenderId: "32992004482",
      appId: "1:32992004482:web:bd4d5e9a2b7a8b976e279b",
      measurementId: "G-B95VYWYDJT"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage();
    const database = getDatabase(app); // 九 Esta l칤nea es clave

    // Obtener el ID de la acci칩n desde la URL
    const idAccion = getQueryParam("id");

    if (idAccion) {
      cargarDatosAccion(idAccion);
    }

    function limitarTexto(texto, max) {
      if (typeof texto !== "string") return "";
      return texto.length > max ? texto.substring(0, max) + "..." : texto;
    }

    let objetivoIndex = null; // Variable global para almacenar el 칤ndice del objetivo

    // Variables globales para almacenar los datos de la gr치fica de tiempo de la acci칩n
    window.labelsAccion = [];
    window.aniosDataAccionEjecutados = [];
    window.aniosDataAccionProgramados = [];
    window.fechaInicioPolitica = "";
    window.idAccionSeleccionada = "";


    document.addEventListener("DOMContentLoaded", () => {
      // Tu l칩gica de inicializaci칩n

      // 游녢 Aqu칤 puedes poner el listener global para el modal
      const evidenciasModal = document.getElementById('evidenciasModal');
      if (evidenciasModal) {
        evidenciasModal.addEventListener('hidden.bs.modal', function () {
          console.log("游띔 Modal de evidencias cerrado.");
          cargarDatosAccion(idAccionSeleccionada);
        });
      }

      // ...otros listeners globales, como botones, etc.
    });

    // Obtener fecha actual en formato dd-mm-aaaa
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const anio = hoy.getFullYear();
    const fechaFormateada = `${dia}-${mes}-${anio}`;

    window.fechaFormateada = fechaFormateada;

    function cargarDatosAccion(idAccion) {
      const dbRef = ref(db, "PolariScore/politicas");

      get(dbRef)
        .then((snapshot) => {
          if (snapshot.exists()) {
            let politicas = snapshot.val();
            let accionEncontrada = null;
            let politicaAsociada = null;
            let evidencias = [];

            // Recorrer la estructura: pol칤tica > objetivos_especificos > acciones
            Object.values(politicas).forEach((politica) => {

              if (politica.objetivos_especificos && typeof politica.objetivos_especificos === "object") {
                Object.entries(politica.objetivos_especificos).forEach(([index, objetivo]) => {

                  if (!objetivo || !objetivo.acciones || typeof objetivo.acciones !== "object") return;

                  let acciones = Object.values(objetivo.acciones);

                  acciones.forEach((accion) => {
                    if (accion.id_accion === idAccion) {
                      window.fechaInicioPolitica = politica.fecha_politica;
                      actualizarNombresTabsEvidencias();
                      actualizarNombresTabsEvaluar();


                      accionEncontrada = accion;
                      politicaAsociada = politica;
                      objetivoIndex = index; // Guardar el 칤ndice del objetivo actual
                      cargarDatosEvaluacionEnTabs(
                        politicaAsociada.id,
                        objetivoIndex,
                        accionEncontrada.id_accion,
                        politicaAsociada.fecha_politica
                      );


                      document.getElementById("btnCrearIndicador").onclick = function () {
                        abrirModalIndicador(politicaAsociada.id, objetivoIndex, accionEncontrada.id_accion);
                      }

                      // --- RUTA RTDB
                      const rutaIndicador = `PolariScore/politicas/${politicaAsociada.id}/objetivos_especificos/${objetivoIndex}/acciones/${idAccion}/Indicador/`;


                      get(ref(db, rutaIndicador)).then(snap => {
                        const indicador = snap.val();
                        renderIndicadorVisual(indicador, ["2023", "2024", "2025", "2026", "2027", "2028"]);

                      });

                      // Funci칩n interna, lista para ser llamada por el listener externo
                      window.eliminarIndicadorActual = async function () {
                        try {
                          await remove(ref(db, rutaIndicador));
                          return true;
                        } catch (err) {
                          console.error("仇 Error eliminando indicador:", err);
                          throw err;
                        }
                      };



                      var tituloPolitica = limitarTexto(politica.titulo, 20);
                      document.getElementById("namePolitica").textContent = tituloPolitica;
                      document.getElementById("namePolitica").href = "politica.html?id=" + politicaAsociada.id;
                    }
                  });
                });
              }
            });


            // Si se encontr칩 la acci칩n, cargar los datos en la interfaz
            if (accionEncontrada && politicaAsociada) {
              document.getElementById("titulo_politica").textContent = politicaAsociada.titulo;
              document.getElementById("objetivo_general").textContent = limitarTexto(politicaAsociada.objetivo_general, 70);
              document.getElementById("objetivo_general").title = politicaAsociada.objetivo_general;
              document.getElementById("indicador_politica").textContent = limitarTexto(accionEncontrada.indicador, 70);
              document.getElementById("indicador_politica").title = accionEncontrada.indicador;
              document.getElementById("fecha_inicio").textContent = politicaAsociada.fecha_politica;
              document.getElementById("idName").textContent = accionEncontrada.id_accion;
              document.getElementById("detalle_politica").textContent = accionEncontrada.accion;

              var programacionFisica = accionEncontrada.anios;

              async function evaluarCumplimiento() {
                const anioInicio = politicaAsociada.fecha_politica.includes('/')
                  ? parseInt(politicaAsociada.fecha_politica.split('/')[2])
                  : new Date(politicaAsociada.fecha_politica).getFullYear();

                let cumplimientoAccion = await calcularCumplimientoAccion(accionEncontrada, anioInicio);

                document.getElementById("resumen_politica").textContent = `
                  La presente acci칩n cuenta con el indicador: ${accionEncontrada.indicador},
                  una Importancia de ${(accionEncontrada.importancia_accion * 100).toFixed(2)}%,
                  y a la fecha tiene un cumplimiento del ${cumplimientoAccion}%`;

                animarCumplimiento(cumplimientoAccion);
              }

              evaluarCumplimiento();

              // Llamar a la funci칩n para generar la gr치fica de tiempo
              generarGraficaTiempoAccion(accionEncontrada, politicaAsociada.fecha_politica);


              // Llenar la tabla de cumplimiento con evidencias
              let tablaCumplimiento = document.getElementById("tabla_cumplimiento");
              tablaCumplimiento.innerHTML = ""; // Limpiar la tabla antes de llenarla

              let filas = "";

              const dbRef = ref(db, `PolariScore/evidencias/${idAccion}`);

              onValue(dbRef, (snapshot) => {
                const evidencias = snapshot.val();
                let filas = "";


                if (evidencias && typeof evidencias === "object") {
                  let hayEvidencias = false;

                  Object.entries(evidencias).forEach(([idEvidencia, evidencia]) => {
                    hayEvidencias = true;

                    const objetivoEspecificoTitulo = politicaAsociada.objetivos_especificos?.[objetivoIndex]?.objetivo_especifico || "Sin t칤tulo";

                    filas += `
                      <tr class="align-middle hover-effect">
                        <td title="${evidencia.titulo}" class="p-3" style="text-align: start;">${limitarTexto(evidencia.titulo || '', 100)}</td>
                        <td title="${politicaAsociada?.responsables || ''}" class="p-3">${limitarTexto(politicaAsociada?.responsables || '', 50)}</td>
                        <td title="${evidencia.formato}" class="p-3 text-center">
                          <span class="me-2">${obtenerIconoArchivo(evidencia.formato || "", "fa-lg")}</span> 
                        </td>
                        <td class="text-center p-3">
                          <div class="d-flex justify-content-center gap-2">
                            <!-- ADMIN bot칩n ABRIR -->
                            <button 
                              class="btn btn-outline-primary btn-sm btnAbrirEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore-only" 
                              style="display: none;" 
                              data-id="${idEvidencia}" 
                              data-titulo="${evidencia.titulo}" 
                              data-id-accion="${idAccion}" 
                              data-id-politica="${politicaAsociada.id}" 
                              data-titulo-politica="${politicaAsociada.titulo}"
                              data-fecha-inicio-politica="${politicaAsociada.fecha_politica}"  
                              data-formato="${evidencia.formato}" 
                              data-objetivo-index="${objetivoIndex}" 
                              data-objetivo-especifico="${objetivoEspecificoTitulo}"
                              data-bs-toggle="modal" 
                              data-bs-target="#evidenciasModal">
                              <i class="fa-solid fa-file-pen me-1"></i>
                            </button>

                            <!-- ADMIN bot칩n ELIMINAR -->
                            <button 
                              class="btn btn-outline-danger btn-sm btnEliminarEvidencia fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore-only" 
                              style="display: none;"
                              data-id="${idEvidencia}" 
                              data-id-accion="${idAccion}" 
                              data-id-politica="${politicaAsociada.id}" 
                              data-objetivo-index="${objetivoIndex}">
                              <i class="fa-solid fa-trash"></i>
                            </button>

                            <!-- RESPONSABLE bot칩n ABRIR -->
                            <button 
                              class="btn btn-outline-primary btn-sm btnAbrirEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm responsable-polariscore-only" 
                              data-id="${idEvidencia}" 
                              data-titulo="${evidencia.titulo}" 
                              data-id-accion="${idAccion}" 
                              data-id-politica="${politicaAsociada.id}" 
                              data-titulo-politica="${politicaAsociada.titulo}" 
                              data-fecha-inicio-politica="${politicaAsociada.fecha_politica}"  
                              data-formato="${evidencia.formato}" 
                              data-objetivo-index="${objetivoIndex}" 
                              data-objetivo-especifico="${objetivoEspecificoTitulo}"
                              data-bs-toggle="modal" 
                              data-bs-target="#evidenciasModal">
                              <i class="fa-solid fa-cloud-arrow-up me-1"></i>
                            </button>
                          </div>
                        </td>
                      </tr>`;
                  });

                  if (hayEvidencias) {
                    const encabezado = `
                      <thead class="sticky-top bg-transparent">
                        <tr class="text-center text-uppercase fw-semibold text-primary border-bottom">
                          <th class="py-3">Evidencia</th>
                          <th class="py-3">Responsables</th>
                          <th class="py-3">Formato</th>
                          <th class="py-3">Acci칩n</th>
                        </tr>
                      </thead>`;

                    tablaCumplimiento.innerHTML = `
                      <table class="table table-hover bg-transparent text-dark">
                        ${encabezado}
                        <tbody class="shadow-sm rounded-3">${filas}</tbody>
                      </table>`;
                    inicializarBotonesAbrirEvidencias();

                  } else {
                    renderTablaSinEvidencias();
                  }

                } else {
                  renderTablaSinEvidencias();
                }
              });

              function renderTablaSinEvidencias() {
                let encabezadoAlternativo = `
                  <thead class="sticky-top bg-transparent">
                    <tr class="text-center text-uppercase fw-semibold text-primary border-bottom">
                      <th class="py-3">Indicador</th>
                      <th class="py-3">Evidencia</th>
                      <th class="py-3">Responsables</th>
                      <th class="py-3">Acci칩n</th>
                    </tr>
                  </thead>`;

                let filas = `
                  <tr class="align-middle hover-effect">
                    <td title="${accionEncontrada.indicador}" class="p-3">${limitarTexto(accionEncontrada.indicador, 50)}</td>
                    <td class="text-muted text-center p-3">No se encontraron documentos</td>
                    <td title="${politicaAsociada.responsables}" class="p-3">${limitarTexto(politicaAsociada.responsables, 50)}</td>
                    <td class="text-center p-3">
                      <button class="btn btn-outline-success btn-sm fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore-only" style="display: none;"
                        data-bs-toggle="modal" data-bs-target="#evidenciasModal">
                        <i class="fa-solid fa-check me-1"></i> Completar
                      </button>
                      <button class="btn btn-outline-success btn-sm fw-semibold px-3 py-2 rounded-pill shadow-sm responsable-polariscore-only" style="display: none;"
                        data-bs-toggle="modal" data-bs-target="#evidenciasModal">
                        <i class="fa-solid fa-check me-1"></i> Analizar
                      </button>
                    </td>
                  </tr>`;

                tablaCumplimiento.innerHTML = `
                  <table class="table table-hover bg-transparent text-dark">
                    ${encabezadoAlternativo}
                    <tbody class="shadow-sm rounded-3">${filas}</tbody>
                  </table>`;
              }


              let listenerFormularioEvidenciaAgregado = false;




              if (!listenerFormularioEvidenciaAgregado) {
                document.getElementById("formAgregarEvidencia").addEventListener("submit", function (event) {
                  event.preventDefault(); // Prevenir env칤o del formulario

                  const titulo = document.getElementById("tituloEvidencia").value.trim();
                  const formato = document.getElementById("formatoEvidencia").value;
                  const otroFormato = document.getElementById("otroFormato").value.trim();
                  const pesoMax = document.getElementById("pesoMax").value;

                  const formatoFinal = (formato === "Otro") ? otroFormato : formato;

                  // Validaciones
                  if (!titulo || !formatoFinal) {
                    mostrarToast("丘멆잺 Por favor, completa todos los campos requeridos.", "warning");
                    return;
                  }

                  if (!accionEncontrada || !politicaAsociada) {
                    mostrarToast("仇 No se ha encontrado la acci칩n para registrar la evidencia.", "danger");
                    return;
                  }

                  // Desactivar bot칩n mientras se guarda
                  const botonGuardar = document.querySelector('#formAgregarEvidencia button[type="submit"]');
                  botonGuardar.disabled = true;
                  botonGuardar.innerHTML = `
                    <span class="spinner-border spinner-border-sm text-white me-2" role="status"></span>Guardando...
                  `;
                  location.reload(true); // En navegadores modernos ya no se usa "true", pero se mantiene por compatibilidad



                  let ultimaEvidencia = null;

                  function guardarNuevaEvidencia(evidenciaId, accionId, datosEvidencia) {
                    const nuevaEvidenciaRef = ref(db, `PolariScore/evidencias/${accionId}/${evidenciaId}`);
                    return set(nuevaEvidenciaRef, { id_evidencia: evidenciaId, id_accion: accionId, ...datosEvidencia })
                      .then(() => {
                        mostrarToast("九 Evidencia agregada con 칠xito.", "success");
                        setTimeout(() => {
                          document.getElementById("formAgregarEvidencia").reset();
                          botonGuardar.disabled = false;
                          botonGuardar.innerHTML = `<i class="fa-solid fa-floppy-disk me-1"></i> Guardar Evidencia`;
                          const modal = bootstrap.Modal.getInstance(document.getElementById("modalAgregarEvidencia"));
                          modal.hide();
                          cargarDatosAccion(accionId);
                        }, 1500);
                      })
                      .catch((error) => {
                        console.error("Error al guardar evidencia:", error);
                        mostrarToast("仇 Error al guardar la evidencia.", "danger");
                        botonGuardar.disabled = false;
                        botonGuardar.innerHTML = `<i class="fa-solid fa-floppy-disk me-1"></i> Guardar Evidencia`;
                        throw error; // Re-lanza el error para que el bloque .catch() principal tambi칠n lo capture si es necesario
                      });
                  }

                  get(dbRef)
                    .then((snapshot) => {
                      let siguienteIdEvidencia;
                      if (snapshot.exists()) {
                        const evidencias = snapshot.val();
                        const keys = Object.keys(evidencias);
                        const ultimaEvidenciaId = keys.length > 0 ? keys[keys.length - 1] : null;
                        siguienteIdEvidencia = obtenerSiguienteConsecutivo(ultimaEvidenciaId);
                      } else {
                        siguienteIdEvidencia = "EV-001";
                      }

                      const nuevaEvidenciaData = {
                        titulo: titulo,
                        formato: formatoFinal,
                        peso_max: `${pesoMax}MB`,
                        fecha_entrega1: "Por definir",
                        uploads: [],
                        estado: "En revisi칩n"
                      };

                      return guardarNuevaEvidencia(siguienteIdEvidencia, accionEncontrada.id_accion, nuevaEvidenciaData);
                    })
                    .catch((error) => {
                      // Este bloque catch ahora manejar치 cualquier error ocurrido durante la lectura o escritura.
                      console.error("Error en el proceso de agregar evidencia:", error);
                    });

                  function obtenerSiguienteConsecutivo(ultimaEvidenciaId) {
                    if (ultimaEvidenciaId && ultimaEvidenciaId.startsWith("EV-")) {
                      const numero = parseInt(ultimaEvidenciaId.split("-")[1], 10);
                      const siguienteNumero = numero + 1;
                      return `EV-${siguienteNumero.toString().padStart(3, '0')}`;
                    } else {
                      return "EV-001";
                    }
                  }
                });

                listenerFormularioEvidenciaAgregado = true;
              }


              // Funci칩n auxiliar para calcular el progreso de cada a침o, aplicando toFixed(2)
              // Si el tipo es "porcentaje": (yearValue / divisor)
              // Si el tipo es "entero": (yearValue / divisor) * 100
              function computeProgress(yearValue, divisor, tipo) {
                if (divisor === 0) {
                  return 0;
                }
                let result;
                if (tipo === "porcentaje") {
                  result = yearValue / divisor * 10000;
                } else if (tipo === "entero") {
                  result = (yearValue / divisor) * 100;
                } else {
                  result = 0;
                }
                return parseFloat(result.toFixed(2));
              }



              async function generarGraficaTiempoAccion(accionEncontrada, fecha_inicio) {
                if (!accionEncontrada.anios || accionEncontrada.anios.length === 0) return;

                const db = getDatabase();
                const idAccion = accionEncontrada.id_accion;

                const startingYear = fecha_inicio.includes('/')
                  ? parseInt(fecha_inicio.split('/')[2])
                  : new Date(fecha_inicio).getFullYear();

                const labels = accionEncontrada.anios.map((_, index) => (startingYear + index).toString());
                window.labelsAccion = labels;

                // Contenedor ECharts
                const graficaTiempoContainer = document.getElementById("grafica_tiempo");
                graficaTiempoContainer.innerHTML = '<div id="grafica_tiempo_canvas" style="height: 300px; width: 100%;"></div>';

                // Total programado de toda la acci칩n
                const totalProgramado = accionEncontrada.anios.reduce((acc, v) => acc + parseFloat(v || 0), 0);

                try {
                  const ejecutadoSnap = await get(ref(db, `PolariScore/seguimientos/${idAccion}/ejecutado`));
                  const ejecutadoData = ejecutadoSnap.exists() ? ejecutadoSnap.val() : {};

                  const aniosEjecutados = labels.map(anio => {
                    const ejecutado = parseFloat(ejecutadoData[anio] || 0);
                    return totalProgramado > 0 ? (ejecutado / totalProgramado) * 100 : 0;
                  });

                  const aniosProgramados = accionEncontrada.anios.map(v =>
                    totalProgramado > 0 ? (parseFloat(v || 0) / totalProgramado) * 100 : 0
                  );

                  window.aniosDataAccionEjecutados = aniosEjecutados;
                  window.aniosDataAccionProgramados = aniosProgramados;

                  // M치ximo del eje Y
                  const maxY = Math.max(...aniosProgramados.concat(aniosEjecutados)) > 30
                    ? 100
                    : Math.max(...aniosProgramados.concat(aniosEjecutados)) * 1.2;

                  // Configuraci칩n ECharts
                  const chartDom = document.getElementById('grafica_tiempo_canvas');
                  const myChart = echarts.init(chartDom);

                  const option = {
                    tooltip: {
                      trigger: 'axis',
                      formatter: params => {
                        return params.map(p => `${p.marker} ${p.seriesName}: ${p.value.toFixed(2)}%`).join('<br>');
                      }
                    },
                    legend: {
                      data: ['Ejecutado', 'Programado']
                    },
                    grid: {
                      left: '5%',
                      right: '5%',
                      bottom: '18%',
                      containLabel: true
                    },
                    xAxis: {
                      type: 'category',
                      data: labels,
                      axisLine: { lineStyle: { color: '#ccc' } }
                    },
                    yAxis: {
                      type: 'value',
                      min: 0,
                      max: maxY,
                      axisLabel: {
                        formatter: value => value.toFixed(2) + '%'
                      }
                    }
                    ,
                    series: [
                      {
                        name: 'Ejecutado',
                        type: 'line',
                        smooth: false,
                        data: aniosEjecutados,
                        lineStyle: {
                          color: '#00594E',
                          width: 2
                        },
                        areaStyle: {
                          color: 'rgba(0, 89, 78, 0.1)'
                        }
                      },
                      {
                        name: 'Programado',
                        type: 'line',
                        smooth: true,
                        data: aniosProgramados,
                        lineStyle: {
                          color: '#B5A160',
                          width: 2
                        },
                        areaStyle: {
                          color: 'rgba(181, 161, 96, 0.05)'
                        }
                      }
                    ]
                  };

                  myChart.setOption(option);
                  window.addEventListener('resize', () => myChart.resize());
                  aplicarFirmaSPlan(myChart, window.fechaFormateada);

                } catch (error) {
                  console.error("仇 Error al cargar datos ejecutados:", error);
                  mostrarToast("Error al cargar ejecuci칩n de la acci칩n.", "danger");
                }
              }



            } else {
              console.error("Acci칩n no encontrada en Firebase.");
            }
          } else {
            console.error("No se encontraron datos en Firebase.");
          }
        })
        .catch((error) => {
          console.error("Error al obtener datos:", error);
        });
    }

    function animarCumplimiento(valorFinal) {
      let clipRect = document.getElementById("clip-rect");
      let porcentajeTexto = document.getElementById("porcentaje");
      let overlay = document.getElementById("overlay");
      let colorMatrix = document.getElementById("matrix");

      // Actualiza la matriz de color para simular el mapa de calor:
      // 0% = rojo (rgb(255,0,0)) y 100% = verde (rgb(0,255,0))
      function updateColorMatrix(porcentaje) {
        const r = Math.max(255 - (porcentaje * 2.55), 0) / 255;
        const g = Math.min(porcentaje * 2.55, 255) / 255;
        const b = 0; // sin componente azul
        const values = `${r} 0 0 0 0  0 ${g} 0 0 0  0 0 ${b} 0 0  0 0 0 1 0`;
        colorMatrix.setAttribute("values", values);
      }

      function animarRect(from, to, duration, callback) {
        let startTime = null;
        function animar(timestamp) {
          if (!startTime) startTime = timestamp;
          let progress = (timestamp - startTime) / duration;
          if (progress > 1) progress = 1;

          let newHeight = from + (to - from) * progress;
          let porcentaje = ((newHeight / 160) * 100).toFixed(2);
          clipRect.setAttribute("y", 160 - newHeight);
          clipRect.setAttribute("height", newHeight);
          porcentajeTexto.textContent = porcentaje + "%";

          updateColorMatrix(parseFloat(porcentaje));

          if (progress < 1) {
            requestAnimationFrame(animar);
          } else if (callback) {
            setTimeout(callback, 500);
          }
        }
        requestAnimationFrame(animar);
      }

      // Secuencia de animaci칩n:
      // 1. De 0 a 100% en 2 segundos.
      // 2. De 100 a 0 en 2 segundos.
      // 3. De 0 al valor final en 2 segundos.
      animarRect(0, 160, 800, () => {
        animarRect(160, 0, 800, () => {
          animarRect(0, (valorFinal / 100) * 160, 1600);
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const idAccion = getQueryParam("id");
      const anteriorBtn = document.getElementById("anteriorBtn");
      const siguienteBtn = document.getElementById("siguienteBtn");

      if (idAccion) {
        cargarNavegacion(idAccion);
      }

      function cargarNavegacion(idAccion) {
        const dbRef = ref(db, "PolariScore/politicas");

        get(dbRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              let politicas = snapshot.val();
              let listaAcciones = [];
              let indexActual = -1;

              // Recorrer todas las pol칤ticas y extraer sus acciones
              Object.values(politicas).forEach((politica) => {
                if (politica.objetivos_especificos && typeof politica.objetivos_especificos === "object") {
                  Object.values(politica.objetivos_especificos).forEach((objetivo) => {

                    if (objetivo.acciones && typeof objetivo.acciones === "object") {
                      // 游댠 Convertir `acciones` en un array antes de recorrerlo
                      Object.values(objetivo.acciones).forEach((accion) => {
                        listaAcciones.push(accion.id_accion);
                      });
                    }
                  });
                }
              });

              // Encontrar el 칤ndice de la acci칩n actual en el array
              indexActual = listaAcciones.indexOf(idAccion);

              if (indexActual !== -1) {
                // Asignar eventos de clic a los botones de navegaci칩n
                anteriorBtn.addEventListener("click", () => {
                  if (indexActual > 0) {
                    window.location.href = `accion.html?id=${listaAcciones[indexActual - 1]}`;
                  }
                });

                siguienteBtn.addEventListener("click", () => {
                  if (indexActual < listaAcciones.length - 1) {
                    window.location.href = `accion.html?id=${listaAcciones[indexActual + 1]}`;
                  }
                });

                // Deshabilitar botones si no hay m치s acciones
                anteriorBtn.disabled = indexActual === 0;
                siguienteBtn.disabled = indexActual === listaAcciones.length - 1;
              }
            }
          })
          .catch((error) => {
            console.error("Error al obtener datos de Firebase:", error);
          });
      }
    });


    function exportarDatosAGrafica(labels, datos, nombreColumnas = ["Etiqueta", "Valor"], nombreArchivo = "datos_grafica.xlsx") {
      if (!labels || !datos || labels.length !== datos.length) {
        console.error("Error: Los datos y etiquetas deben tener la misma longitud.");
        return;
      }

      // Crear los datos para el archivo Excel
      let datosExcel = labels.map((label, index) => ({
        [nombreColumnas[0]]: label,
        [nombreColumnas[1]]: datos[index].toFixed(2) // Formatear a dos decimales
      }));

      // Convertir datos a hoja de Excel
      const ws = XLSX.utils.json_to_sheet(datosExcel);

      // Crear libro de trabajo
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Datos");

      // Descargar el archivo
      XLSX.writeFile(wb, nombreArchivo);
    }
    window.exportarDatosAGrafica = exportarDatosAGrafica;

    function exportarGrafica(idCanvas, nombreArchivo = "grafica.png", scaleFactor = 4) {
      const canvas = document.getElementById(idCanvas);
      if (!canvas) {
        console.error("El canvas no se encontr칩.");
        return;
      }

      // Crear un canvas temporal con mayor resoluci칩n
      const canvasExport = document.createElement("canvas");
      const ctxExport = canvasExport.getContext("2d");

      // Ajustar tama침o del nuevo canvas para mayor resoluci칩n
      canvasExport.width = canvas.width * scaleFactor;
      canvasExport.height = canvas.height * scaleFactor;

      // Mejorar la calidad del renderizado
      ctxExport.imageSmoothingEnabled = true;
      ctxExport.imageSmoothingQuality = "high";

      // Dibujar la gr치fica en el nuevo canvas con mayor resoluci칩n
      ctxExport.scale(scaleFactor, scaleFactor);
      ctxExport.drawImage(canvas, 0, 0);

      // Convertir a imagen en formato PNG con calidad m치xima
      const imagen = canvasExport.toDataURL("image/png", 1.0);

      // Crear un enlace de descarga
      const link = document.createElement("a");
      link.href = imagen;
      link.download = nombreArchivo;

      // Simular clic para descargar la imagen
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.exportarGrafica = exportarGrafica;

    const auth = getAuth(app);

    // Obtener el bot칩n de login/logout
    const logButton = document.getElementById("logButton");

    // Variable para evitar agregar m칰ltiples event listeners
    let logoutListenerAdded = false;

    // Funci칩n para mostrar elementos seg칰n los roles del usuario (disponible globalmente)
    window.mostrarElementosDinamicos = function (rolesUsuario = []) {
      if (!Array.isArray(rolesUsuario)) {
        console.error("丘멆잺 Error: rolesUsuario no es un array. Valor recibido:", rolesUsuario);
        rolesUsuario = []; // Asignar un array vac칤o si es incorrecto
      }

      setTimeout(() => {
        // Ocultar todos los elementos antes de mostrarlos seg칰n el rol
        document.querySelectorAll(".admin-only, .admin-polariscore-only, .responsable-polariscore-only").forEach(el => {
          el.style.display = "none";
        });

        // Mostrar solo los elementos que coincidan con los roles del usuario
        if (rolesUsuario.includes("admin")) {
          document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
        }
        if (rolesUsuario.includes("admin-polariscore")) {
          document.querySelectorAll(".admin-polariscore-only").forEach(el => el.style.display = "block");
        }
        if (rolesUsuario.includes("responsable-polariscore")) {
          document.querySelectorAll(".responsable-polariscore-only").forEach(el => el.style.display = "block");
        }
      }, 50);
    };

    // Escuchar cambios en el estado de autenticaci칩n
    onAuthStateChanged(auth, (user) => {
      console.log("Usuario autenticado:", user); // 游 Verifica si el usuario est치 autenticado

      if (user) {
        logButton.textContent = "Cerrar sesi칩n";
        logButton.classList.remove("btn-primary");
        logButton.classList.add("btn-danger");

        // Mostrar foto y nombre de perfil
        const nombreCompleto = user.displayName || user.email || "Usuario";
        window.correoUsuario = user.email;
        const nombreCorto = obtenerNombreCorto(nombreCompleto);
        const foto = user.photoURL
          ? user.photoURL
          : `https://ui-avatars.com/api/?name=${encodeURIComponent(nombreCorto)}&background=0D8ABC&color=fff&rounded=true&size=64`;

        if (document.getElementById("nombrePerfilUsuario")) {
          document.getElementById("nombrePerfilUsuario").textContent = nombreCompleto;
          document.getElementById("nombrePerfilUsuario").classList.add("text-dark");
          document.getElementById("nombrePerfilUsuario").classList.remove("text-white");
          document.getElementById("correoPerfilUsuario").textContent = user.email;

        }


        if (document.getElementById("imgPerfilUsuario")) {
          document.getElementById("imgPerfilUsuario").src = foto;
          document.getElementById("imgPerfilUsuario").alt = nombreCorto;
          document.getElementById("imgPerfilUsuario").title = nombreCorto;
        }

        if (document.getElementById("imgPerfilUsuarioDropdown")) {
          document.getElementById("imgPerfilUsuarioDropdown").src = foto;
          document.getElementById("imgPerfilUsuarioDropdown").alt = nombreCorto;
          document.getElementById("imgPerfilUsuarioDropdown").title = nombreCorto;
        }



        // Manejo del logout (evita agregar m칰ltiples eventos)
        if (!logoutListenerAdded) {
          logButton.addEventListener("click", () => {
            let logoutModal = new bootstrap.Modal(document.getElementById("logoutModal"));
            logoutModal.show();

            document.getElementById("confirmLogout").addEventListener("click", () => {
              signOut(auth).then(() => {
                window.location.href = "../pages/sign-in.html";
              }).catch((error) => {
                console.error("Error al cerrar sesi칩n:", error);
                mostrarToast("Error al cerrar sesi칩n.", "danger");
              });
            });
          });
          logoutListenerAdded = true;
        }

        // Obtener los roles del usuario desde Firebase Database
        const correoSanitizado = user.email.replace(/\./g, '_');
        const userRef = ref(database, `usuarios/${correoSanitizado}`);

        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            const userRoles = Array.isArray(userData.roles) ? userData.roles : [];

            window.rolesUsuarioActual = userRoles; // 九 Esto permite acceder a los roles desde cualquier lugar

            mostrarElementosDinamicos(userRoles);


            if (userRoles.includes("admin")) {
              document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
            }

            if (userRoles.includes("admin-polariscore")) {
              document.querySelectorAll(".admin-polariscore").forEach(el => el.style.display = "block");
            }

            if (userRoles.includes("admin-polariscore") || userRoles.includes("responsable-polariscore")) {
              document.querySelectorAll(".admin-responsable-only").forEach(el => el.style.display = "block");
            }

            if (document.getElementById("rolesUsuario")) {
              let rolSimplificado = "Usuario"; // valor por defecto

              // Normaliza los roles a min칰sculas para evitar problemas de comparaci칩n
              const rolesMinusculas = userRoles.map(r => r.toLowerCase());

              // Verifica por orden de prioridad: admin > responsable > observador
              if (rolesMinusculas.some(r => r.includes("admin"))) {
                rolSimplificado = "Admin";
              } else if (rolesMinusculas.some(r => r.includes("responsable"))) {
                rolSimplificado = "Responsable";
              } else if (rolesMinusculas.some(r => r.includes("observador"))) {
                rolSimplificado = "Observador";
              }

              document.getElementById("rolesUsuario").textContent = rolSimplificado;
            }

            // Observar cambios en el DOM
            const observer = new MutationObserver(() => {
              mostrarElementosDinamicos(userRoles);
            });
            observer.observe(document.body, { childList: true, subtree: true });

          } else {
            console.error("丘멆잺 No se encontr칩 informaci칩n del usuario en la base de datos.");
            mostrarToast("No se encontr칩 la informaci칩n del usuario.", "warning");
          }
        }).catch((error) => {
          console.error("仇 Error al obtener datos del usuario:", error);
          mostrarToast("Error al obtener los datos del usuario.", "danger");
        });

      } else {
        console.log("No hay usuario autenticado");

        logButton.textContent = "Iniciar Sesi칩n";
        logButton.classList.remove("btn-danger");
        logButton.classList.remove("text-danger");
        logButton.classList.add("btn-primary");
        logButton.classList.add("text-white");

        logButton.style.backgroundColor = "#00594e";
        logButton.style.color = "#fff!important";
        logButton.addEventListener("click", () => {
          window.location.href = "../pages/sign-in.html";
        });

        mostrarElementosDinamicos([]);
      }
    });


    function obtenerNombreCorto(nombreCompleto) {
      if (!nombreCompleto) return "";
      const partes = nombreCompleto.trim().split(" ");
      if (partes.length === 1) return partes[0];
      return partes[0] + " " + partes[1];
    }



    let idEvidenciaEliminar = null;
    let idAccionEliminar = null;

    document.addEventListener("click", function (e) {
      if (e.target.closest(".btnEliminarEvidencia")) {
        const boton = e.target.closest(".btnEliminarEvidencia");

        // Obtener valores directamente desde el bot칩n
        idEvidenciaEliminar = boton.getAttribute("data-id");
        idAccionEliminar = boton.getAttribute("data-id-accion");

        const modalAbierto = document.querySelector(".modal.show");
        if (modalAbierto) {
          bootstrap.Modal.getInstance(modalAbierto).hide();
        }

        // Mostrar modal de confirmaci칩n
        setTimeout(() => {
          const modal = new bootstrap.Modal(document.getElementById("modalEliminarEvidencia"));
          modal.show();
        }, 300);
      }
    });

    document.getElementById("confirmarEliminarEvidencia").addEventListener("click", () => {
      if (!idEvidenciaEliminar || !idAccionEliminar) {
        mostrarToast("丘멆잺 No se puede eliminar la evidencia. Datos incompletos.", "danger");
        return;
      }

      // Crear la referencia a la evidencia con la nueva estructura de rutas
      const evidenciaRef = ref(db, `PolariScore/evidencias/${idAccionEliminar}/${idEvidenciaEliminar}`);

      set(evidenciaRef, null)
        .then(() => {
          mostrarToast("游딈勇 Evidencia eliminada con 칠xito.", "success");

          const modal = bootstrap.Modal.getInstance(document.getElementById("modalEliminarEvidencia"));
          modal.hide();

          // Actualizar la tabla
          cargarDatosAccion(idAccionEliminar);
        })
        .catch((error) => {
          console.error("仇 Error al eliminar evidencia:", error);
          mostrarToast("仇 Error al eliminar la evidencia.", "danger");
        });
    });



    function cargarResumenPoliticaYAccion({
      idPolitica = "",
      tituloPolitica = "",
      fechaInicioPolitica = "",
      idAccion = "",
      tituloEvidencia = "",
      objetivoIndex = null,
      objetivoEspecifico = ""
    }) {
      const contenedorResumen = document.getElementById("tab-resumen");

      if (!contenedorResumen) {
        console.warn("丘멆잺 No se encontr칩 el contenedor #tab-resumen.");
        return;
      }

      const resumenHTML = `
    <div class="mt-4 mx-2 p-4 bg-light border rounded-4 shadow-sm">
      <p class="mb-4">
        Esta acci칩n (<span class="fw-semibold text-primary">${idAccion}</span>) hace parte de la pol칤tica institucional 
        <strong class="text-success">"${tituloPolitica}"</strong> (<em>${idPolitica}</em>), con fecha de inicio 
        <strong>${fechaInicioPolitica}</strong>. La acci칩n aborda el tema <em class="text-muted">"${tituloEvidencia}"</em>, 
        perteneciente al objetivo espec칤fico <strong>#${objetivoIndex + 1}</strong>. Este resumen describe el contexto estrat칠gico de la acci칩n.
      </p>

      <div class="mb-4 p-3 border-start border-4 border-primary bg-white rounded-3">
        <h5 class="mb-3 text-primary fw-bold"><i class="fa-solid fa-bolt me-2"></i>Resumen de la Acci칩n</h5>
        <p><strong>C칩digo de Acci칩n:</strong> ${idAccion}</p>
        <p><strong>Nombre de la Acci칩n:</strong> ${tituloEvidencia}</p>
        <p><strong>Indicador:</strong> ${tituloEvidencia}</p>
        ${objetivoIndex !== null ? `<p><strong>Objetivo Espec칤fico:</strong> ${objetivoEspecifico}</p>` : ""}
      </div>

      <div class="mb-4 p-3 border-start border-4 border-warning bg-white rounded-3">
        <h5 class="mb-3 text-warning fw-bold"><i class="fa-solid fa-file-lines me-2"></i>Resumen de la Evidencia</h5>
        <p><strong>Nombre de la Evidencia:</strong> ${tituloEvidencia}</p>
        <p><strong>Formato:</strong> ${tituloEvidencia}</p>
      </div>

      <div class="mb-3 p-3 border-start border-4 border-success bg-white rounded-3">
        <h5 class="mb-3 text-success fw-bold"><i class="fa-solid fa-scale-balanced me-2"></i>Resumen de la Pol칤tica</h5>
        <p><strong>C칩digo:</strong> ${idPolitica}</p>
        <p><strong>T칤tulo:</strong> ${tituloPolitica}</p>
        <p><strong>Fecha de Inicio:</strong> ${fechaInicioPolitica}</p>
      </div>
    </div>
  `;

      contenedorResumen.innerHTML = resumenHTML;
    }


    // Limpia el contenido de todos los tabs de a침o del modal
    function limpiarTabsEvidencias(maxAnios = 6) {
      for (let i = 1; i <= maxAnios; i++) {
        const container = document.querySelector(`#anio${i} ul.list-group`);
        if (container) {
          container.innerHTML = `
        <li class="list-group-item border-0 text-center text-muted">
          Cargando evidencias...
        </li>`;
        }
      }
    }

    // Render simple de un item de evidencia (li)
    function liUploadItem({ upload, idEvidencia, cicloKey, formato }) {
      const fechaISO = upload.fecha_subida || upload.fechaSubida || null;
      const fecha = fechaISO ? new Date(fechaISO) : null;
      const fechaStr = fecha ? fecha.toLocaleDateString("es-CO") : "";
      const horaStr = fecha ? fecha.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true }) : "";

      const nombre = upload.nombre || upload.nombre_archivo || "Archivo";
      const url = upload.url || "#";
      const mime = upload.type || "";
      const icono = mime ? iconoPorMime(mime) : iconoPorFormato(formato);

      const estado = upload.estado || "Subida";
      const estadoHTML = (typeof obtenerBadgeEstado === "function")
        ? obtenerBadgeEstado(estado)
        : `<span class="badge bg-success">Subida</span>`;

      return `
    <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-3">
      <div class="d-flex align-items-center">
        <div class="me-3" style="font-size:1.2rem;"><i class="${icono}"></i></div>
        <div class="d-flex flex-column">
          <p class="text-sm mb-1"><strong title="${nombre}">${typeof limitarTexto === 'function' ? limitarTexto(nombre, 64) : nombre}</strong></p>
          ${upload.descripcion ? `<p class="text-sm mb-1">${upload.descripcion}</p>` : ""}
          <span class="text-xs" style="margin-bottom:3%;">游늬 ${idEvidencia}  游댃 ${cicloKey}</span>
          <span class="text-xs" style="margin-bottom:3%;">游늰 ${fechaStr} | 游 ${horaStr}</span>
          <div style="max-width:25%;">${estadoHTML}</div>
        </div>
      </div>
      <div class="d-flex align-items-center text-sm">
        
          <button class="btn btn-outline-secondary btn-sm me-2" title="Observaciones"
                  onclick="abrirObservacionesModal && abrirObservacionesModal('${idEvidencia}','${cicloKey}')">
            <i class="fa-regular fa-comments"></i>
          </button>
        <a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm" title="Ver / Descargar">
          <i class="fa-solid fa-eye"></i>
        </a>
      </div>
    </li>`;
    }

    /**
     * Carga SOLO la evidencia seleccionada en el modal, repartiendo sus uploads por a침o (tabs #anio1..#anio6).
     * params: { idPolitica, objetivoIndex, idAccion, idEvidencia, tituloEvidencia, formatoEvidencia, tituloPolitica, fechaInicioPolitica, objetivoEspecifico }
     */
    async function cargarEvidenciasEnModalFirebase(params) {
      const {
        idAccion,
        idEvidencia,
        tituloEvidencia,
        formatoEvidencia,
        fechaInicioPolitica
      } = params || {};

      // T칤tulo del modal
      document.getElementById("tituloEvidencias").textContent =
        (typeof limitarTexto === 'function' ? limitarTexto(tituloEvidencia || "Evidencia", 50) : (tituloEvidencia || "Evidencia"));

      // Limpia tabs y muestra modal
      limpiarTabsEvidencias(6);
      const modalEl = document.getElementById('evidenciasModal');
      if (modalEl && typeof bootstrap !== 'undefined') {
        const m = bootstrap.Modal.getOrCreateInstance(modalEl);
        m.show();
      }

      // Validaciones m칤nimas
      if (!idAccion || !idEvidencia || !fechaInicioPolitica) {
        console.warn("Faltan par치metros para cargar la evidencia en el modal.");
        // pinta vac칤o amigable
        for (let i = 1; i <= 6; i++) {
          const container = document.querySelector(`#anio${i} ul.list-group`);
          if (container) {
            container.innerHTML = `
          <li class="list-group-item border-0 text-center text-muted">
            No hay evidencias registradas para este a침o.
          </li>`;
          }
        }
        return;
      }

      // A침o de inicio de la pol칤tica (dd/mm/aaaa)
      const partes = fechaInicioPolitica.split("/");
      const anioInicio = parseInt(partes[2], 10);
      if (isNaN(anioInicio)) {
        console.warn("fechaInicioPolitica inv치lida:", fechaInicioPolitica);
        return;
      }

      // Leer SOLO la evidencia seleccionada
      // /PolariScore/evidencias/{idAccion}/{idEvidencia}/uploads
      const uploadsSnap = await get(ref(db, `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads`));

      // Construye buffers por tab
      const tabs = { anio1: "", anio2: "", anio3: "", anio4: "", anio5: "", anio6: "" };

      let mensajes = [];

      if (uploadsSnap.exists()) {
        const uploadsAll = uploadsSnap.val(); // { "2025_1": {...}, "2025_2": {...}, ... }

        // Recorre cicloKey (AAAA_N)
        for (const cicloKey in uploadsAll) {
          const [anioStr] = cicloKey.split("_");
          const anio = parseInt(anioStr, 10);
          if (isNaN(anio)) continue;

          const diff = anio - anioInicio; // 0=>anio1, 1=>anio2...
          const tabKey = `anio${diff + 1}`;
          if (!tabs.hasOwnProperty(tabKey)) continue; // fuera de rango 1..6

          const nodo = uploadsAll[cicloKey];

          mensajes = nodo;

          // Detecta si es objeto directo (url/nombre) o m칰ltiples hijos
          const esDirecto = nodo && typeof nodo === "object" &&
            ("url" in nodo || "nombre" in nodo || "fecha_subida" in nodo || "fechaSubida" in nodo);

          if (esDirecto) {
            tabs[tabKey] += liUploadItem({ upload: nodo, idEvidencia, cicloKey, formato: formatoEvidencia });
          } else {
            for (const sub in nodo) {
              const up = nodo[sub];
              if (up && typeof up === "object") {
                tabs[tabKey] += liUploadItem({ upload: up, idEvidencia, cicloKey, formato: formatoEvidencia });
              }
            }
          }
        }
      }

      // Pintar en DOM
      for (let i = 1; i <= 6; i++) {
        const container = document.querySelector(`#anio${i} ul.list-group`);
        if (!container) continue;
        const key = `anio${i}`;
        container.innerHTML = tabs[key] || `
      <li class="list-group-item border-0 text-center text-muted">
        No hay evidencias registradas para este a침o.
      </li>`;
      }

      // Opcional: activar autom치ticamente el tab del primer a침o con contenido
      const firstWithData = Object.keys(tabs).find(k => tabs[k] && tabs[k].trim() !== "");
      if (firstWithData) {
        const idx = parseInt(firstWithData.replace("anio", ""), 10);
        // activar bot칩n y pane
        const btn = document.getElementById(`anio${idx}-tab`);
        if (btn) new bootstrap.Tab(btn).show();
      } else {
        // si no hay datos, deja A침o 1 activo (default del HTML)
      }

      // Cualquier post-procesamiento visual
      if (typeof mostrarElementosDinamicos === "function") {
        setTimeout(() => mostrarElementosDinamicos(), 50);
      }

      // Funci칩n global para abrir el modal
      window.abrirObservacionesModal = function (idEvidencia) {
        let modalAbierto = document.querySelector('.modal.show');
        if (modalAbierto) {
          let modalInstance = bootstrap.Modal.getInstance(modalAbierto);
          modalInstance.hide();
        }

        setTimeout(() => {
          let modal = new bootstrap.Modal(document.getElementById('observacionesModal'));
          modal.show();
          cargarMensajesObservaciones(idEvidencia, mensajes);
        }, 500);
      };
    }






    function obtenerBadgeEstado(estado) {
      const estadoLimpio = estado.toLowerCase();
      const clasesBase = 'badge rounded-pill text-xs px-1.5 py-0.5';
      switch (estadoLimpio) {
        case "aprobado":
          return `<span class="${clasesBase} bg-success"><i class="fa-solid fa-check-circle me-1"></i> ${estado}</span>`;
        case "entrega parcial":
          return `<span class="${clasesBase} bg-yellow"><i class="fa-solid| fa-check-circle me-1"></i> ${estado}</span>`;
        case "rechazado":
          return `<span class="${clasesBase} bg-danger"><i class="fa-solid fa-times-circle me-1"></i> ${estado}</span>`;
        case "en revisi칩n":
          return `<span class="${clasesBase} bg-warning text-white"><i class="fa-solid fa-hourglass-half me-1"></i> ${estado}</span>`;
        default:
          return `<span class="${clasesBase} bg-info"><i class="fa-solid fa-clock me-1"></i> ${estado}</span>`;
      }
    }



    function inicializarBotonesAbrirEvidencias() {

      const botones = document.querySelectorAll(".btnAbrirEvidencias");

      botones.forEach(boton => {

        boton.addEventListener("click", function () {

          const idEvidencia = this.dataset.id;
          const tituloEvidencia = this.dataset.titulo || "";
          const formatoEvidencia = this.dataset.formato || "";
          const idAccion = this.dataset.idAccion || "";
          const idPolitica = this.dataset.idPolitica || "";
          const tituloPolitica = this.dataset.tituloPolitica || "";
          const objetivoIndex = this.dataset.objetivoIndex;
          const fechaInicioPolitica = this.dataset.fechaInicioPolitica || "";
          const objetivoEspecifico = this.dataset.objetivoEspecifico || "";

          console.table({ idEvidencia, tituloEvidencia, idAccion, idPolitica, tituloPolitica, objetivoIndex, fechaInicioPolitica, objetivoEspecifico });

          if (!idEvidencia || !idAccion || !idPolitica || !tituloEvidencia || !objetivoIndex) {
            mostrarToast("仇 Faltan datos para abrir la evidencia.", "danger");
            console.error("游뛂 Faltan datos:", { idEvidencia, idAccion, idPolitica, tituloEvidencia, objetivoIndex, objetivoEspecifico });
            return;
          }

          document.getElementById("tituloEvidencias").textContent = limitarTexto(tituloEvidencia || "Pol칤tica", 50);

          cargarEvidenciasEnModalFirebase({
            idPolitica,
            objetivoIndex,
            idAccion,
            idEvidencia,
            tituloEvidencia,
            formatoEvidencia,
            tituloPolitica,
            fechaInicioPolitica,
            objetivoEspecifico
          });
        });
      });
    }


    // Helpers de 칤cono (aj칰stalos a tus clases/fa si quieres m치s granularidad)
    function iconoPorMime(type = "", sizeClass = "fa-lg") {
      const t = type.toLowerCase();
      if (t.includes("pdf")) return `fas fa-file-pdf ${sizeClass} text-danger`;
      if (t.includes("spreadsheet") || t.includes("excel") || t.includes("csv")) return `fas fa-file-excel ${sizeClass} text-success`;
      if (t.includes("word") || t.includes("document")) return `fas fa-file-word ${sizeClass} text-primary`;
      if (t.startsWith("image/")) return `fas fa-file-image ${sizeClass} text-info`;
      if (t.startsWith("video/")) return `fas fa-file-video ${sizeClass} text-warning`;
      if (t.startsWith("audio/")) return `fas fa-file-audio ${sizeClass} text-warning`;
      return `fas fa-file ${sizeClass} text-secondary`;
    }

    function iconoPorFormato(formato = "", sizeClass = "fa-lg") {
      const f = (formato || "").toLowerCase();
      if (f === "pdf") return `fas fa-file-pdf ${sizeClass} text-danger`;
      if (["xls", "xlsx", "excel"].includes(f)) return `fas fa-file-excel ${sizeClass} text-success`;
      if (["doc", "docx", "word"].includes(f)) return `fas fa-file-word ${sizeClass} text-primary`;
      if (["jpg", "jpeg", "png", "imagen", "image"].includes(f)) return `fas fa-file-image ${sizeClass} text-info`;
      return `fas fa-file ${sizeClass} text-secondary`;
    }

    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const descripcion = document.getElementById("descripcion").value.trim();
      const archivoInput = document.getElementById("archivo");
      const archivo = archivoInput.files[0];
      const anioTimestamp = document.getElementById("anioEvidencia").value;

      if (!descripcion || !archivo || !anioTimestamp) {
        mostrarToast("丘멆잺 Por favor completa todos los campos.", "warning");
        return;
      }

      // Mostrar spinner de carga (opcional)
      const submitBtn = this.querySelector("button[type='submit']");
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...`;

      try {
        await subirArchivoYGuardarRegistro(descripcion, archivo, anioTimestamp);
        mostrarToast("九 Archivo subido correctamente.", "success");

        //this.reset(); // Limpiar el formulario
        // Recargar evidencias del modal actual (si aplica)
        const modal = bootstrap.Modal.getInstance(document.getElementById("evidenciasModal"));
        //modal.hide();

      } catch (error) {
        console.error("Error al subir el archivo:", error);
        mostrarToast("仇 Hubo un error al subir el archivo.", "danger");
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = "Subir Evidencia";
    });

    async function calcularCumplimientoAccion(accion, anioInicio) {
      const db = getDatabase();
      const ejecutadoRef = ref(db, `PolariScore/seguimientos/${accion.id_accion}/ejecutado`);

      try {
        const snapshot = await get(ejecutadoRef);
        const ejecutadoData = snapshot.exists() ? snapshot.val() : {};
        const aniosProgramados = accion.anios || [];

        let sumaProgramado = 0;
        let sumaEjecutado = 0;

        for (let i = 0; i < aniosProgramados.length; i++) {
          const anio = anioInicio + i;
          const programado = parseFloat(aniosProgramados[i]) || 0;
          const ejecutado = parseFloat(ejecutadoData[anio]) || 0;

          sumaProgramado += programado;
          sumaEjecutado += ejecutado;
        }

        const cumplimientoTotal = sumaProgramado > 0
          ? (sumaEjecutado / sumaProgramado) * 100
          : 0;

        return parseFloat(cumplimientoTotal.toFixed(2));

      } catch (error) {
        console.error("仇 Error al calcular cumplimiento:", error);
        return 0;
      }
    }



    async function subirArchivoYGuardarRegistro(descripcion, archivo, anioTimestamp) {
      const idPolitica = document.querySelector(".btnAbrirEvidencias").dataset.idPolitica;
      const idAccion = document.querySelector(".btnAbrirEvidencias").dataset.idAccion;
      const idEvidencia = document.querySelector(".btnAbrirEvidencias").dataset.id;
      const objetivoIndex = document.querySelector(".btnAbrirEvidencias").dataset.objetivoIndex;

      console.table({ idPolitica, idAccion, idEvidencia, objetivoIndex });

      if (!idPolitica || !idAccion || !idEvidencia || !objetivoIndex) {
        throw new Error("Faltan datos clave para ubicar la evidencia en Firebase.");
      }

      const storage = getStorage();
      const db = getDatabase();

      const nombreArchivo = archivo.name;

      // 九 Convertir timestamp a a침o
      const anio = new Date(parseInt(anioTimestamp) * 1000).getFullYear();


      // 九 Ruta en Storage con a침o incluido
      const rutaStorage = `PlanItOne/PolariScore/politicas/${idPolitica}/objetivos_especificos/${objetivoIndex}/acciones/${idAccion}/evidencias/${idEvidencia}/uploads/${anio}/${nombreArchivo}`;
      const archivoRef = storageRef(storage, rutaStorage);

      // Subir archivo
      await uploadBytes(archivoRef, archivo);

      // Obtener URL
      const url = await getDownloadURL(archivoRef);

      // Crear registro en Realtime Database
      const uploadData = {
        descripcion: descripcion,
        nombre_archivo: nombreArchivo,
        url: url,
        fechaEvidencia: anioTimestamp, // este ya lo tienes como timestamp del a침o seleccionado
        fechaSubida: Math.floor(Date.now() / 1000), // 낌勇 timestamp del momento actual
        estado: "En revisi칩n",
        observaciones: "Sin observaciones",
      };


      // 九 Ruta con a침o incluido
      const uploadsRef = ref(db, `PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${anio}`);
      const nuevaRef = push(uploadsRef);

      await set(nuevaRef, uploadData);
    }

    async function cargarDatosEvaluacionEnTabs(idPolitica, objetivoIndex, idAccion, fechaInicioPolitica) {
      const db = getDatabase();

      const aniosRef = ref(db, `PolariScore/politicas/${idPolitica}/objetivos_especificos/${objetivoIndex}/acciones/${idAccion}/anios`);
      const ejecutadoRef = ref(db, `PolariScore/seguimientos/${idAccion}/ejecutado`);

      try {
        const [aniosSnap, ejecutadoSnap] = await Promise.all([
          get(aniosRef),
          get(ejecutadoRef)
        ]);

        const anios = aniosSnap.exists() ? aniosSnap.val() : [];
        const ejecutadoObj = ejecutadoSnap.exists() ? ejecutadoSnap.val() : {};

        // A침o base desde fechaInicioPolitica
        let anioInicio = fechaInicioPolitica.includes('/')
          ? parseInt(fechaInicioPolitica.split('/')[2])
          : new Date(fechaInicioPolitica).getFullYear();

        const programadoPorAnio = programadoArrayToObj(anios, anioInicio);

        cargarHistorialEvaluaciones(idAccion, anioInicio, programadoPorAnio);


        for (let i = 1; i <= 6; i++) {
          const anio = anioInicio + (i - 1);
          const programado = anios[i - 1] || 0;
          const ejecutado = ejecutadoObj[anio] ?? '';

          const tabPane = document.getElementById(`tab${i}`);
          if (tabPane) {
            const inputEjecutado = tabPane.querySelector("input.input-ejecutado");
            const inputProgramado = tabPane.querySelector("input.input-programado");

            if (inputEjecutado && inputProgramado) {
              inputEjecutado.value = ejecutado;
              inputProgramado.value = programado;
            } else {
              console.warn(`丘멆잺 Faltan inputs en tab${i}`);
            }
          } else {
            console.warn(`丘멆잺 No existe el panel #tab${i}`);
          }
        }



      } catch (error) {
        console.error("仇 Error al cargar datos de evaluaci칩n:", error);
        mostrarToast("Error al cargar los datos de evaluaci칩n", "danger");
      }
    }

    function obtenerProgramado(anios, anio, indice) {
      if (Array.isArray(anios)) {
        // array: 칤ndice
        return anios[indice] || 0;
      } else if (typeof anios === "object" && anios !== null) {
        // objeto: clave a침o
        return anios[anio] || 0;
      }
      return 0;
    }


    window.guardarEvaluacion = async function guardarEvaluacion() {
      const db = getDatabase();
      const idAccion = window.idAccionSeleccionada || getQueryParam("id");

      if (!idAccion) {
        mostrarToast("仇 No se encontr칩 el ID de la acci칩n.", "danger");
        return;
      }

      const fechaInicio = window.fechaInicioPolitica;
      if (!fechaInicio) {
        mostrarToast("仇 No se ha definido la fecha de inicio de la pol칤tica.", "danger");
        return;
      }

      const anioInicio = fechaInicio.includes('/')
        ? parseInt(fechaInicio.split('/')[2])
        : new Date(fechaInicio).getFullYear();

      const datosEjecutado = {};
      for (let i = 1; i <= 6; i++) {
        const anio = anioInicio + (i - 1);
        const programado = obtenerProgramado(anios, anio, i - 1);
        const ejecutado = ejecutadoObj[anio] ?? '';
        const input = document.querySelector(`#tab${i} input.input-ejecutado`);
        if (input) {
          const anio = anioInicio + (i - 1);
          datosEjecutado[anio] = parseFloat(input.value) || 0;
        }
      }

      try {
        const fechaActual = new Date();
        const fechaFormateada = `${String(fechaActual.getDate()).padStart(2, '0')}-${String(fechaActual.getMonth() + 1).padStart(2, '0')}-${fechaActual.getFullYear()}`;
        const user = auth.currentUser;
        const correoSanitizado = user.email.replace(/\./g, '_');


        // Buscar si ya hay evaluaciones hoy
        const refHistorial = ref(db, `PolariScore/seguimientos/${idAccion}/historialEvaluacion`);
        const snapshotHistorial = await get(refHistorial);

        let contador = 0;
        if (snapshotHistorial.exists()) {
          Object.keys(snapshotHistorial.val()).forEach(key => {
            if (key.startsWith(fechaFormateada)) contador++;
          });
        }

        const claveFinal = contador === 0 ? fechaFormateada : `${fechaFormateada}_${contador}`;

        const updates = {};
        updates[`PolariScore/seguimientos/${idAccion}/ejecutado`] = datosEjecutado;
        updates[`PolariScore/seguimientos/${idAccion}/historialEvaluacion/${claveFinal}`] = {
          fecha: fechaActual.toISOString(),
          id_usuario: correoSanitizado,
          ejecutado: datosEjecutado
        };

        await update(ref(db), updates);

        mostrarToast("九 Evaluaci칩n guardada con 칠xito.", "success");

        const modal = bootstrap.Modal.getInstance(document.getElementById("evaluarModal"));
        if (modal) modal.hide();

        cargarDatosAccion(idAccion);

        location.reload();

      } catch (error) {
        console.error("仇 Error al guardar evaluaci칩n:", error);
        mostrarToast("仇 Error al guardar la evaluaci칩n.", "danger");
      }
    };

    // Convierte anios a objeto {2025: 5, 2026: 6, ...}
    function programadoArrayToObj(anios, anioInicio) {
      const obj = {};
      if (Array.isArray(anios)) {
        for (let i = 0; i < anios.length; i++) {
          obj[anioInicio + i] = anios[i];
        }
      } else if (typeof anios === "object" && anios !== null) {
        return anios;
      }
      return obj;
    }


    async function cargarHistorialEvaluaciones(idAccion, anioInicio, programadoPorAnio) {
      const db = getDatabase();
      const refHistorial = ref(db, `PolariScore/seguimientos/${idAccion}/historialEvaluacion`);
      const snapshot = await get(refHistorial);

      const historial = [];
      if (snapshot.exists()) {
        const valores = snapshot.val();
        for (const key of Object.keys(valores)) {
          const evaluacion = valores[key];
          let aniosEvaluados = Object.keys(evaluacion.ejecutado || {});

          // Resumen global (suma todos los a침os)
          let totalEjecutado = 0;
          let totalProgramado = 0;
          let resumenPorc = 0;
          aniosEvaluados.forEach(anio => {
            const ejecutado = parseFloat(evaluacion.ejecutado[anio]) || 0;
            const programado = programadoPorAnio[anio] ? parseFloat(programadoPorAnio[anio]) : 0;
            totalEjecutado += ejecutado;
            totalProgramado += programado;
          });
          if (totalProgramado > 0) resumenPorc = (totalEjecutado / totalProgramado) * 100;

          // Detalles de cada a침o (para el colapsable)
          let detalles = `
        <ul class="list-group list-group-flush ms-3 mb-3 mt-2">
          ${aniosEvaluados.map(anio => {
            const ejecutado = parseFloat(evaluacion.ejecutado[anio]) || 0;
            const programado = programadoPorAnio[anio] ? parseFloat(programadoPorAnio[anio]) : 0;
            const porcentaje = programado > 0 ? (ejecutado / programado) * 100 : 0;
            return `
            <li class="list-group-item px-0 py-1 d-flex justify-content-between align-items-center small">
              <span>
                <i class="ni ni-calendar-grid-58 text-warning"></i>
                <b>${anio}</b>
                <span class="ms-1">Ejecutado:</span>
                <span class="text-success fw-bold">${formatearNumero(ejecutado)}</span>
                <span class="ms-1">Programado:</span>
                <span class="fw-bold">${formatearNumero(programado)}</span>
              </span>
              <span class="badge ${porcentaje >= 100 ? 'bg-success' : (porcentaje >= 80 ? 'bg-info' : 'bg-warning text-dark')}">
                ${formatearNumero(porcentaje)}%
              </span>
            </li>`;
          }).join('')}
        </ul>
      `;

          historial.push({
            fecha: evaluacion.fecha,
            correo: evaluacion.id_usuario ? evaluacion.id_usuario.replace(/_/g, '.') : "",
            resumenPorc,
            totalEjecutado,
            totalProgramado,
            detalles
          });
        }
      }

      // Ordena por fecha descendente
      historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      // Renderizar como men칰 colapsable Argon
      const ul = document.getElementById("historialEvaluaciones");
      ul.innerHTML = "";
      if (historial.length === 0) {
        ul.innerHTML = `<li class="list-group-item text-muted text-center">No hay evaluaciones registradas a칰n.</li>`;
        return;
      }
      historial.forEach((ev, idx) => {
        const colId = `colEval${idx}`;
        ul.innerHTML += `
      <li class="nav-item mb-3" style="list-style:none;">
        <div class="card shadow border-0 rounded-4 transition-ease position-relative" style="overflow:hidden;">
          <a class="stretched-link text-decoration-none" data-bs-toggle="collapse" href="#${colId}" aria-expanded="false">
            <div class="card-body py-3 px-4 d-flex flex-row align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <span class="icon icon-shape icon-md border-radius-md bg-gradient-warning text-center me-3 shadow-sm">
                  <i class="ni ni-calendar-grid-58 text-white"></i>
                </span>
                <div>
                  <div class="fw-bold fs-6 mb-1">${formatearFechaISO(ev.fecha)}</div>
                  <div class="text-xs text-muted"><i class="ni ni-email-83"></i> ${ev.correo}</div>
                </div>
              </div>
              <div class="d-flex flex-column align-items-end">
                
                <i class="ni ni-bold-down text-secondary fs-5"></i>
              </div>
            </div>
          </a>
          <div class="collapse px-4 pb-4" id="${colId}">
            <div class="border-top pt-3 mt-2">
              ${ev.detalles}
            </div>
          </div>
        </div>
      </li>

    `;
      });
    }

    // Utilidad para fecha:
    function formatearFechaISO(fechaISO) {
      if (!fechaISO) return "";
      const d = new Date(fechaISO);
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }

    function formatearNumero(num) {
      return (typeof num === 'number' ? num : parseFloat(num))
        .toLocaleString('es-CO', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        });
    }

    let modalCrearIndicador = null;

    // --- FUNCIONES DIN츼MICAS DEL MODAL ---
    function abrirModalIndicador(idPolitica, objetivoIndex, idAccion, anios = []) {
      // Guarda en globales si lo necesitas luego
      window.idPoliticaGlobal = idPolitica;
      window.objetivoIndexGlobal = objetivoIndex;
      window.idAccionGlobal = idAccion;
      window.aniosGlobal = anios.length ? anios : ["2023", "2024", "2025", "2026", "2027", "2028"];

      // Limpiar campos del formulario
      document.getElementById("tipoIndicador").value = "";
      document.getElementById("bloqueHitos").style.display = "none";
      document.getElementById("listaHitos").innerHTML = "";
      document.getElementById("tipoMetrica").value = "";
      document.getElementById("descripcionIndicador").value = "";
      document.getElementById("acumuladoAyuda").style.display = "none";

      // Rellenar los a침os de la programaci칩n
      const tbody = document.getElementById("tbodyProgramacionAnios");
      tbody.innerHTML = "";
      window.aniosGlobal.forEach(anio => {
        tbody.innerHTML += `
      <tr>
        <td>${anio}</td>
        <td>
          <input type="number" min="0" max="100" class="form-control form-control-sm" step="0.01" name="programadoAnio_${anio}" required>
        </td>
      </tr>
    `;
      });

      // Solo inicializa el modal una vez (buena pr치ctica)
      const modalEl = document.getElementById('modalCrearIndicador');
      if (!modalCrearIndicador) {
        modalCrearIndicador = new bootstrap.Modal(modalEl, {
          backdrop: 'static',   // No se cierra al dar clic fuera
          keyboard: false       // No se cierra con Escape
        });
      }
      // Mostrar el modal
      modalCrearIndicador.show();
    }

    // --- LISTENERS DEL MODAL ---
    document.addEventListener("DOMContentLoaded", function () {
      // Mostrar/ocultar bloque hitos
      document.getElementById("tipoIndicador").addEventListener("change", function () {
        document.getElementById("bloqueHitos").style.display = (this.value === "hitos") ? "block" : "none";
      });

      // Agregar hito
      document.getElementById("btnAgregarHito").addEventListener("click", function () {
        const listaHitos = document.getElementById("listaHitos");
        const hitoItem = document.createElement("div");
        hitoItem.className = "row g-2 align-items-end mb-2 hito-item";
        hitoItem.innerHTML = `
      <div class="col-3">
        <input type="number" min="0" max="100" class="form-control" placeholder="% Hito" name="porcentajeHito[]" required>
      </div>
      <div class="col-8">
        <input type="text" class="form-control" placeholder="Descripci칩n del hito" name="descripcionHito[]" required>
      </div>
      <div class="col-1 text-end">
        <button type="button" class="btn btn-outline-danger btn-sm px-2 py-1 rounded-circle btnQuitarHito" title="Quitar hito">
          <i class="fa fa-times"></i>
        </button>
      </div>
    `;
        listaHitos.appendChild(hitoItem);
        // Quitar hito
        hitoItem.querySelector('.btnQuitarHito').onclick = function () {
          hitoItem.remove();
        };
      });

      // Ayuda acumulado
      document.getElementById("tipoMetrica").addEventListener("change", function () {
        document.getElementById("acumuladoAyuda").style.display = (this.value === "acumulado") ? "block" : "none";
      });

      // SUBMIT indicador
      document.getElementById("formCrearIndicador").addEventListener("submit", async function (e) {
        e.preventDefault();

        // --- Validaci칩n de programaci칩n acumulado
        const tipoMetrica = document.getElementById("tipoMetrica").value;
        if (tipoMetrica === "acumulado") {
          let suma = 0;
          document.querySelectorAll('#tbodyProgramacionAnios input[type="number"]').forEach(inp => {
            suma += Number(inp.value) || 0;
          });
          if (suma > 100) {
            Swal.fire('Error', 'La suma de la programaci칩n no puede superar el 100%', 'warning');
            return false;
          }
        }

        // --- Guardar datos
        const tipoIndicador = document.getElementById("tipoIndicador").value;
        const descripcionIndicador = document.getElementById("descripcionIndicador").value;

        // Hitos
        let hitos = [];
        if (tipoIndicador === "hitos") {
          document.querySelectorAll("#listaHitos .hito-item").forEach(hitoEl => {
            const porcentaje = hitoEl.querySelector('input[type="number"]').value;
            const desc = hitoEl.querySelector('input[type="text"]').value;
            hitos.push({ porcentaje: Number(porcentaje), descripcion: desc });
          });
        }

        // Programaci칩n por a침o
        let programacion = {};
        aniosGlobal.forEach(anio => {
          const val = document.querySelector(`[name="programadoAnio_${anio}"]`).value;
          programacion[anio] = Number(val) || 0;
        });

        // --- RUTA RTDB
        const rutaIndicador = `PolariScore/politicas/${idPoliticaGlobal}/objetivos_especificos/${objetivoIndexGlobal}/acciones/${idAccionGlobal}/Indicador/`;



        // Estructura de datos
        let datosIndicador = {
          tipo: tipoIndicador,
          descripcion: descripcionIndicador,
          tipo_metrica: tipoMetrica,
          hitos: tipoIndicador === "hitos" ? hitos : undefined,
          programacion_anual: programacion,
          fecha_creacion: new Date().toISOString(),
          usuario: window.correoUsuario || "desconocido"
        };

        // --- GUARDAR EN RTDB ---
        try {
          await set(ref(database, rutaIndicador), datosIndicador);

          Swal.fire({
            icon: 'success',
            title: '춰Indicador guardado!',
            showConfirmButton: false,
            timer: 1800
          });

          // Cerrar modal
          const miModal = bootstrap.Modal.getInstance(document.getElementById('modalCrearIndicador'));
          miModal.hide();

          get(ref(db, rutaIndicador)).then(snap => {
            const indicador = snap.val();
            renderIndicadorVisual(indicador, ["2023", "2024", "2025", "2026", "2027", "2028"]);
          });

        } catch (err) {
          Swal.fire('Error', 'No se pudo guardar el indicador: ' + err.message, 'error');
        }
      });
    });

    function renderIndicadorVisual(indicador, anios = ["2024", "2025", "2026", "2027", "2028", "2029"]) {
      const cont = document.getElementById('indicadorVisual');
      if (!indicador) {
        cont.innerHTML = `
      <div class="alert alert-info mb-0 rounded-3 text-white py-3 px-4 d-inline-block border-0" style="max-width: 50%;">
        <i class="fa fa-info-circle me-2"></i> No hay indicador registrado para esta acci칩n.
      </div>`;
        return;
      }

      // Chips tipo y m칠trica
      const tipoIcon = { hitos: 'fa-medal', cumplimiento: 'fa-percent', productos: 'fa-boxes-stacked' }[indicador.tipo] || 'fa-chart-bar';
      const metricIcon = { acumulado: 'fa-layer-group', flujo: 'fa-retweet' }[indicador.tipo_metrica] || '';

      const chipTipo = `
    <span class="chip-indicador me-1">
      <i class="fa ${tipoIcon} me-1"></i>${indicador.tipo ? indicador.tipo.charAt(0).toUpperCase() + indicador.tipo.slice(1) : "Indicador"}
    </span>`;
      const chipMetrica = indicador.tipo_metrica ? `
    <span class="chip-indicador bg-body-secondary">
      <i class="fa ${metricIcon} me-1"></i>${indicador.tipo_metrica.charAt(0).toUpperCase() + indicador.tipo_metrica.slice(1)}
    </span>` : '';

      // Descripci칩n
      const desc = `<div class="mb-2"><div class="text-muted" style="font-size:1.08em;">${indicador.descripcion || "(Sin descripci칩n)"}</div></div>`;

      // Hitos
      let bloqueHitos = '';
      if (indicador.tipo === 'hitos' && Array.isArray(indicador.hitos)) {
        let totalHitos = indicador.hitos.reduce((a, b) => a + Number(b.porcentaje || 0), 0);
        bloqueHitos = `
      <div class="mb-2 mt-2">
        <div class="fw-semibold text-success" style="font-size:.98em;">
          <i class="fa fa-flag-checkered me-1"></i> Hitos (${totalHitos}%)
        </div>
        <ul class="list-unstyled timeline-soft ms-1">
          ${indicador.hitos.map(hito => `
            <li class="mb-1 d-flex align-items-center gap-2">
              <span class="badge bg-light text-dark px-2 py-1 border">${hito.porcentaje}%</span>
              <span style="font-size:.97em;">${hito.descripcion}</span>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
      }

      // Productos
      let bloqueProductos = '';
      if (indicador.tipo === 'productos' && Array.isArray(indicador.productos)) {
        bloqueProductos = `
      <div class="mb-2 mt-2">
        <div class="fw-semibold text-primary" style="font-size:.99em;">
          <i class="fa fa-box-open me-1"></i> Productos
        </div>
        <div class="d-flex flex-wrap gap-2">
          ${indicador.productos.map(p => `<span class="badge bg-light text-dark border px-2 py-1">${p}</span>`).join('')}
        </div>
      </div>
    `;
      }

      // Responsive scrollable gauges
      const progAnual = indicador.programacion_anual || {};
      const sumProg = Object.values(progAnual).reduce((a, b) => a + Number(b || 0), 0);

      // Cada gauge tiene su propio div
      const gaugesHTML = anios.map((anio, i) => `
    <div class="gauge-mini-wrapper text-center flex-shrink-0" style="width:94px;">
      <div class="gauge-mini" id="gauge_${anio}" style="width:88px;height:63px;margin:auto;"></div>
      <div class="gauge-label small text-muted">${anio}</div>
    </div>
  `).join('');

      let metaInfo = `
    <div class="mt-2 text-end small text-muted">
      <i class="fa fa-user"></i> <b>${indicador.usuario || 'N/A'}</b>
      <span class="mx-2">|</span>
      <i class="fa fa-calendar-alt"></i> <b>${indicador.fecha_creacion ? formatearFecha(indicador.fecha_creacion) : 'N/A'}</b>
    </div>
  `;

      // Render principal (NO card)
      cont.innerHTML = `
    <div>
      <div class="d-flex gap-2 flex-wrap mb-2">${chipTipo}${chipMetrica}</div>
      ${desc}
      ${bloqueHitos}
      ${bloqueProductos}
      <div class="d-flex flex-row flex-nowrap overflow-auto gap-2 mb-2 mt-3 gauges-responsive">
        ${gaugesHTML}
      </div>
      <div class="small text-muted ms-1 mb-2">
        Total programado: <span class="fw-bold">${sumProg}%</span>
        ${indicador.tipo_metrica === "acumulado" ? '<span class="text-success ms-2">(Acumulado)</span>' : '<span class="text-info ms-2">(Flujo / anual)</span>'}
      </div>
      ${metaInfo}
    </div>
  `;

      // Inicializa los donuts 180춿 ECharts
      setTimeout(() => {
        anios.forEach(anio => {
          const valor = Number(progAnual[anio] || 0);
          const el = document.getElementById(`gauge_${anio}`);
          if (!el) return;
          const myChart = echarts.init(el);
          myChart.setOption({
            series: [{
              type: 'gauge',
              startAngle: 180,
              endAngle: 0,
              min: 0,
              max: 100,
              radius: '90%',
              pointer: { show: false },
              progress: {
                show: true,
                width: 12,
                roundCap: true,
                itemStyle: {
                  color: valor < 40 ? "#f8bb65" : valor < 70 ? "#49baff" : "#40db9b"
                }
              },
              axisLine: {
                lineStyle: {
                  width: 12,
                  color: [[1, "#f0f3f6"]]
                }
              },
              splitLine: { show: false },
              axisTick: { show: false },
              axisLabel: { show: false },
              anchor: { show: false },
              detail: {
                show: true,
                offsetCenter: [0, '35%'],
                fontSize: 15,
                color: "#242a35",
                valueAnimation: true,
                formatter: '{value}%'
              },
              data: [{ value: valor }]
            }]
          });
          window.addEventListener("resize", () => myChart.resize());
        });
      }, 10);
    }


    // -- Extra: timeline CSS para hitos --
    const style = document.createElement('style');
    style.textContent = `
  .timeline-hitos .timeline-item { position: relative; padding-left: 0.5rem; }
  .timeline-hitos .timeline-item::before {
    content:''; position:absolute; left:0.15rem; top:0.7em; width:3px; height:1.5em; background:#b5a16044;
  }
  .timeline-hitos .timeline-item:last-child::before { display:none; }
`;
    document.head.appendChild(style);

    document.getElementById("btnEliminarIndicador").addEventListener("click", async function () {
      Swal.fire({
        title: '쮼liminar indicador?',
        html: `<div class="text-danger mb-2"><i class="fa-solid fa-triangle-exclamation fa-lg"></i></div>
       <b>Esta acci칩n es irreversible.</b><br>쯉eguro que desea eliminar el indicador de esta acci칩n?<br>
       <span class="small text-muted">Esta operaci칩n no se puede deshacer.</span>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '<i class="fa fa-trash"></i> S칤, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#00897b',
        background: '#fff',
        reverseButtons: true,
        focusCancel: true
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            // 춰Funci칩n din치mica, 100% seguro!
            await window.eliminarIndicadorActual();

            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'El indicador ha sido eliminado correctamente.',
              confirmButtonColor: '#00897b',
              timer: 1800,
              showConfirmButton: false
            });

            document.getElementById('indicadorVisual').innerHTML = `
          <div class="alert alert-info mb-0 rounded-3 py-3 px-4 d-inline-block border-0" style="max-width: 400px;">
            <i class="fa fa-info-circle me-2"></i> No hay indicador registrado para esta acci칩n.
          </div>`;
            document.getElementById('btnEliminarIndicador').style.display = 'none';
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo eliminar el indicador. Intenta de nuevo.',
              confirmButtonColor: '#d33'
            });
          }
        }
      });
    });

  </script>
  <script>

    function exportarElementoComoImagen(idElemento, nombreArchivo = "exportacion.png") {
      const elemento = document.getElementById(idElemento);
      if (!elemento) {
        console.error("仇 No se encontr칩 el elemento:", idElemento);
        return;
      }

      // Forzar fuentes e 칤conos a cargarse correctamente si est치n ocultos
      elemento.style.display = 'block';

      html2canvas(elemento, {
        useCORS: true,         // Para cargar im치genes externas como SVG con href
        allowTaint: true,
        backgroundColor: null, // Fondo transparente
        scale: 3               // Mayor calidad
      }).then((canvas) => {
        const enlace = document.createElement("a");
        enlace.href = canvas.toDataURL("image/png");
        enlace.download = nombreArchivo;
        enlace.click();
      }).catch(error => {
        console.error("仇 Error al exportar imagen:", error);
      });
    }



    function obtenerIconoArchivo(formato, clase = "") {
      if (typeof formato !== "string") {
        return `<i class="fa-solid fa-file-question text-muted ${clase}"></i>`;
      }

      switch (formato.toLowerCase()) {
        case "pdf":
          return `<i class="fa-solid fa-file-pdf text-danger ${clase}"></i>`;
        case "word":
        case "doc":
        case "docx":
          return `<i class="fa-solid fa-file-word text-blue ${clase}"></i>`;
        case "excel":
        case "xls":
        case "xlsx":
          return `<i class="fa-solid fa-file-excel text-success ${clase}"></i>`;
        case "png":
        case "jpg":
        case "jpeg":
        case "webp":
          return `<i class="fa-solid fa-file-image text-warning ${clase}"></i>`;
        case "mp4":
        case "mov":
        case "avi":
          return `<i class="fa-solid fa-file-video text-purple ${clase}"></i>`; // puedes definir text-purple en tu CSS si quieres
        default:
          return `<i class="fa-solid fa-file text-muted ${clase}"></i>`;
      }
    }


    // Funci칩n para mostrar una notificaci칩n (Toast)
    function mostrarToast(mensaje, tipo = "info") {
      const toastContainer = document.getElementById("toastContainer");

      // Crear toast
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${tipo} border-0 show`;
      toast.role = "alert";
      toast.ariaLive = "assertive";
      toast.ariaAtomic = "true";
      toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${mensaje}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        `;

      toastContainer.appendChild(toast);

      // Mostrar el toast
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      // Eliminar el toast despu칠s de 5 segundos
      setTimeout(() => {
        bsToast.hide();
        setTimeout(() => toast.remove(), 500);
      }, 2000);
    }


    function abrirEvaluarModal(idEvidencia) {
      // Verifica que el usuario tenga el rol adecuado
      const roles = window.rolesUsuarioActual || [];

      if (!roles.includes("evaluador-polariscore") && !roles.includes("admin-polariscore")) {
        mostrarToast("游뛂 No tienes permiso para acceder a la evaluaci칩n.", "danger");
        return;
      }

      // Cierra cualquier modal abierto
      const modalAbierto = document.querySelector(".modal.show");
      if (modalAbierto) {
        const modalInstance = bootstrap.Modal.getInstance(modalAbierto);
        modalInstance.hide();
      }

      // Guarda el ID
      window.idEvidenciaSeleccionadaParaEvaluar = idEvidencia;

      // Abre el modal tras un peque침o delay
      setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById("evaluarModal"));
        modal.show();
      }, 300);
    }





    // Cargar los mensajes en el modal
    function cargarMensajesObservaciones(idEvidencia, mensajes) {
      let listaMensajes = document.getElementById("listaMensajes");
      listaMensajes.innerHTML = ""; // Limpiar la lista antes de agregar nuevos mensajes

      // Ordenar los mensajes por timestamp (fecha m치s antigua primero)
      mensajes.sort((a, b) => a.timestamp - b.timestamp);

      mensajes.forEach(msg => {
        let li = document.createElement("li");
        li.classList.add("d-flex", "mb-3", msg.tipo === "admin" ? "justify-content-end" : "justify-content-start");

        // Definir imagen y estilos seg칰n el tipo de usuario
        let imagenPerfil = msg.tipo === "admin" ? "../assets/img/admin.jpg" : "../assets/img/responsable.jpg";
        let estiloMensaje = msg.tipo === "admin" ? "bg-primary text-white" : "bg-light text-dark";

        let mensajeHTML = `
          <div class="d-flex align-items-end" style="max-width: 75%;">
            ${msg.tipo !== "admin" ? `<img src="${imagenPerfil}" alt="Perfil" class="rounded-circle shadow-sm me-2" style="width: 40px; height: 40px; object-fit: cover;">` : ""}
            
            <div class="p-2 rounded-3 shadow-sm ${estiloMensaje}">
              <small class="fw-bold">${msg.nombre}</small>
              <p class="mb-1">${msg.mensaje}</p>
              <small class="text-muted d-block text-end" style="font-size: 0.8rem;">${msg.fecha}</small>
            </div>

            ${msg.tipo === "admin" ? `<img src="${imagenPerfil}" alt="Perfil" class="rounded-circle shadow-sm ms-2" style="width: 40px; height: 40px; object-fit: cover;">` : ""}
          </div>
        `;

        li.innerHTML = mensajeHTML;
        listaMensajes.appendChild(li);
      });

      // Desplazar la vista hacia el 칰ltimo mensaje
      let chatBox = document.getElementById("chatObservaciones");
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Enviar un nuevo mensaje
    function enviarMensajeObservacion() {
      let inputMensaje = document.getElementById("mensajeObservacion");
      let listaMensajes = document.getElementById("listaMensajes");

      if (inputMensaje.value.trim() === "") return;

      let fechaActual = new Date();
      let fechaFormato = fechaActual.toLocaleString("es-CO", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit", hour12: true
      });

      let timestamp = Math.floor(fechaActual.getTime() / 1000); // Convertir a timestamp UNIX

      let nuevoMensaje = {
        nombre: "T칰",
        mensaje: inputMensaje.value,
        fecha: fechaFormato,
        tipo: "admin", // Aqu칤 puedes cambiar si es responsable o admin
        timestamp: timestamp
      };

      mensajesPrueba.push(nuevoMensaje); // Agregar al array global
      cargarMensajesObservaciones(); // Volver a cargar mensajes en el orden correcto

      inputMensaje.value = ""; // Limpiar campo de entrada

      // Desplazar la vista hacia el 칰ltimo mensaje
      let chatBox = document.getElementById("chatObservaciones");
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function actualizarNombresTabsEvaluar() {
      const fecha = window.fechaInicioPolitica;

      if (!fecha) {
        console.warn("仇 No se ha definido la fechaInicioPolitica");
        return;
      }

      let anioInicio;

      // Detectar si es formato dd/mm/yyyy o ISO
      if (fecha.includes('/')) {
        const partes = fecha.split('/');
        anioInicio = parseInt(partes[2]);
      } else {
        anioInicio = new Date(fecha).getFullYear();
      }

      const anioActual = new Date().getFullYear();
      let primerTabActivoId = null;

      for (let i = 1; i <= 6; i++) {
        const tab = document.getElementById(`tab${i}-tab`);
        const tabPane = document.getElementById(`tab${i}`);

        if (tab && tabPane) {
          const anio = anioInicio + (i - 1);
          tab.innerText = `${anio}`; // 九 Solo el a침o (sin "A침o ")

          // Resetear clases
          tab.classList.remove('active');
          tab.disabled = false;
          tab.removeAttribute('title');
          tab.style.opacity = 1;
          tab.removeEventListener('click', () => { });
          tab.classList.remove('disabled');
          tab.setAttribute('data-bs-toggle', 'tab');

          if (anio > anioActual) {
            tab.classList.add('disabled');
            tab.setAttribute('title', 'Este a침o a칰n no est치 habilitado');
            tab.style.opacity = 0.5;
            tab.removeAttribute('data-bs-toggle');

            tab.addEventListener('click', function (e) {
              e.preventDefault();
              mostrarToast("낍 Este a침o a칰n no est치 habilitado.", "warning");
            });

            tabPane.classList.remove('show', 'active');
          } else {
            if (!primerTabActivoId) primerTabActivoId = i;

            tab.addEventListener('click', function () {
              for (let j = 1; j <= 6; j++) {
                document.getElementById(`tab${j}-tab`)?.classList.remove('active');
                document.getElementById(`tab${j}`)?.classList.remove('active', 'show');
              }

              tab.classList.add('active');
              tabPane.classList.add('active', 'show');
            });

            tabPane.classList.remove('active', 'show');
          }
        }
      }

      // Activar el primer tab habilitado
      if (primerTabActivoId) {
        const primerTab = document.getElementById(`tab${primerTabActivoId}-tab`);
        const primerPane = document.getElementById(`tab${primerTabActivoId}`);

        primerTab?.classList.add('active');
        primerPane?.classList.add('active', 'show');
      }
    }



    function actualizarNombresTabsEvidencias() {
      const fecha = window.fechaInicioPolitica;

      if (!fecha) {
        console.warn("仇 No se ha definido la fechaInicioPolitica");
        return;
      }

      let anioInicio;

      // Detectar si es dd/mm/yyyy o ISO
      if (fecha.includes('/')) {
        const partes = fecha.split('/');
        anioInicio = parseInt(partes[2]);
      } else {
        anioInicio = new Date(fecha).getFullYear();
      }

      const anioActual = new Date().getFullYear();
      let primerTabActivoId = null;

      for (let i = 1; i <= 6; i++) {
        const tab = document.getElementById(`anio${i}-tab`);
        const tabPane = document.getElementById(`anio${i}`);

        if (tab && tabPane) {
          const anio = anioInicio + (i - 1);
          tab.innerText = `${anio}`; // 九 Solo el a침o

          // Limpiar clases previas
          tab.classList.remove('active');
          tab.disabled = false;
          tab.removeAttribute('title');
          tab.style.opacity = 1;
          tab.removeEventListener('click', () => { });
          tab.classList.remove('disabled');
          tab.setAttribute('data-bs-toggle', 'tab');

          if (anio > anioActual) {
            tab.classList.add('disabled');
            tab.setAttribute('title', 'Este a침o a칰n no est치 habilitado');
            tab.style.opacity = 0.5;
            tab.removeAttribute('data-bs-toggle');

            tab.addEventListener('click', function (e) {
              e.preventDefault();
              mostrarToast("낍 Este a침o a칰n no est치 habilitado.", "warning");
            });

            tabPane.classList.remove('show', 'active');
          } else {
            if (!primerTabActivoId) primerTabActivoId = i;

            tab.addEventListener('click', function () {
              for (let j = 1; j <= 6; j++) {
                document.getElementById(`anio${j}-tab`)?.classList.remove('active');
                document.getElementById(`anio${j}`)?.classList.remove('active', 'show');
              }

              tab.classList.add('active');
              tabPane.classList.add('active', 'show');
            });

            tabPane.classList.remove('active', 'show');
          }
        }
      }

      if (primerTabActivoId) {
        const primerTab = document.getElementById(`anio${primerTabActivoId}-tab`);
        const primerPane = document.getElementById(`anio${primerTabActivoId}`);

        primerTab?.classList.add('active');
        primerPane?.classList.add('active', 'show');
      }
    }



    function formatearFecha(fechaIso) {
      if (!fechaIso) return '';
      const d = new Date(fechaIso);
      return d.toLocaleDateString("es-CO", { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

  </script>

  <!-- Librer칤a ECharts oficial -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- Tu theme personalizado -->
  <script src="../assets/js/polariscore-charts.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Choices.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    .text-blue {
      color: #1959bc !important;
    }

    .iconoUpload {
      color: gray;
      cursor: pointer;
    }

    .iconoUpload:hover {
      color: #00584e;
    }

    /* Aplicar estilos solo a la tabla con el id tableObjetivos_ */
    #tableObjetivos_ {
      width: 100%;
      /* Hacer que la tabla ocupe el 100% del ancho del contenedor */
      table-layout: fixed;
      /* Hacer que las celdas tengan un ancho fijo */
      border-collapse: collapse;
      /* Combina bordes adyacentes entre celdas */
    }

    #tableObjetivos_ th,
    #tableObjetivos_ td {
      padding: 8px;
      /* Espaciado interno (padding) */
      text-align: justify;
      /* Justificar el texto */
      vertical-align: top;
      /* Alinear el texto en la parte superior */
      border: 1px solid #ddd;
      /* Aplicar bordes entre las celdas */
      border-top: none;
      /* Eliminar el borde superior */
      border-left: none;
      /* Eliminar el borde izquierdo */
      word-wrap: break-word;
      /* Permitir que las palabras largas se rompan y ajusten */
      white-space: normal;
      /* Permitir saltos de l칤nea en el texto */
      font-size: 0.8em;
    }

    /* Estilos para las cabeceras */
    #tableObjetivos_ th {
      background-color: #f2f2f2;
      /* Color de fondo de los encabezados */
      border: 1px solid #ddd;
      /* Aplicar bordes internos para las cabeceras */
      border-left: none;
      /* Sin borde izquierdo */
      border-top: none;
      /* Sin borde superior */
    }



    #tableObjetivos_ td:last-child,
    #tableObjetivos_ th:last-child {
      border-right: none;
      /* Eliminar el borde derecho de la 칰ltima columna */
    }

    #tableObjetivos_ tr {
      line-height: 1.5;
      /* Ajustar la altura de l칤nea */
    }

    /* Agrega un overlay con el degradado */
    #carrusel_img .carousel-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 50%);
      z-index: 1;
    }

    /* Im치genes del carrusel */
    #carrusel_img .carousel-item img {
      display: block;
      width: 100%;
      height: auto;
      opacity: 1;
      z-index: 0;
      /* Asegura que la imagen est칠 detr치s del overlay */
    }

    /* Texto en el carrusel */
    #carrusel_img .carousel-caption {
      position: absolute;
      z-index: 2;
      /* Asegura que el texto est칠 sobre el overlay */
      color: white;
    }

    #progresoContainer {
      width: 100%;
      max-width: 600px;
      /* Ajusta seg칰n sea necesario */
      margin: auto;
      /* Centrar */

    }

    .fixed-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #00594e;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      border: none;
      border-radius: 4px;
      z-index: 1000;
    }

    .fixed-btn:hover {
      background-color: #00453e;
      /* Un tono m치s oscuro al hacer hover */
    }

    /* Estilo para que los hitos y la tabla sean m치s agradables y claros */
    #listaHitos .hito-item {
      background: #f6f7fa;
      border-radius: 8px;
      padding: 8px 5px 2px 5px;
      border: 1px solid #e7f3ef;
      margin-bottom: 4px;
      transition: box-shadow 0.15s;
    }

    #listaHitos .hito-item:hover {
      box-shadow: 0 2px 14px #00594e12;
    }

    .chip-indicador {
      display: inline-flex;
      align-items: center;
      gap: 0.4em;
      font-size: 1em;
      border-radius: 16px;
      padding: 3px 13px 3px 11px;
      font-weight: 500;
      background: #f7f7fa;
      box-shadow: 0 1px 4px #e2e5ea25;
      margin-bottom: 2px;
    }

    .timeline-soft li {
      border-left: 2px solid #ececec;
      padding-left: 0.7em;
      position: relative;
      font-size: .97em;
    }

    .timeline-soft li::before {
      content: '';
      position: absolute;
      left: -7px;
      top: 7px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #eee5c6;
      border: 2px solid #efefef;
    }

    .gauges-responsive {
      overflow-x: auto;
      padding-bottom: 5px;
      -webkit-overflow-scrolling: touch;
    }

    .gauge-mini-wrapper {
      min-width: 94px;
      max-width: 94px;
    }

    .gauge-mini {
      min-width: 76px;
      min-height: 54px;
      max-width: 94px;
      max-height: 65px;
    }

    .gauge-label {
      font-size: .98em;
    }

    @media (max-width: 600px) {
      .gauge-mini-wrapper {
        min-width: 74px;
        max-width: 80px;
      }

      .gauge-mini {
        min-width: 56px;
        max-width: 80px;
        min-height: 38px;
        max-height: 45px;
      }
    }
  </style>

</body>

</html>