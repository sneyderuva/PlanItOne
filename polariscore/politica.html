<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/polariscore/icono.png">
  <title id="page_title">
    Políticas
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/aa4ade8d2d.js" crossorigin="anonymous"></script>
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />

</head>

<body class="g-sidenav-show bg-gray-100">

  <div id="loadingOverlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999999; justify-content:center; align-items:center;">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
  </div>

  <div class="min-height-300 position-absolute w-100"
    style="background: url('../assets/img/polariscore/bg-gradient.png') no-repeat center center/cover;">
  </div>
  <aside
    class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4"
    id="sidenav-main" style="z-index:1040;">
    <div class="sidenav-header mb-3">
      <a class="navbar-brand m-0 d-flex flex-column align-items-center" href="../index.html">
        <!-- Logo institucional Argon -->
        <img src="../assets/img/polariscore/logo.png" class="navbar-brand-img mb-0" style="max-height:60px;"
          alt="main_logo">

      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <!-- INICIO -->

        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2" href="index.html">
            <i class="fa-solid fa-home text-muted"></i>
            <span class="nav-link-text">Inicio</span>
          </a>

        </li>

        <!-- Políticas -->
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2" href="#" data-bs-toggle="collapse"
            data-bs-target="#submenuPoliticas" aria-expanded="false">
            <i class="fa-solid fa-landmark text-success"></i>
            <span class="nav-link-text">Políticas</span>
          </a>
          <ul class="collapse list-unstyled ms-4" id="submenuPoliticas">
            <li><a class="nav-link" href="../polariscore/dashboard.html"><i
                  class="fa-solid fa-chart-pie text-success"></i> Análisis General</a></li>
            <li><a class="nav-link" href="../polariscore/politicas.html"><i
                  class="fa-solid fa-list-ul text-primary"></i> Lista de Políticas</a></li>
            <li class="admin-responsable-only" style="display: none;"><a class="nav-link"
                href="../polariscore/politicas.html?t="><i class="fa-regular fa-folder-open text-info"></i> Mis
                Políticas</a></li>
            <li><a class="nav-link" href="../polariscore/observaciones.html"><i
                  class="fa-regular fa-comment-dots text-info"></i> Observaciones</a></li>
          </ul>
        </li>

        <!-- Seleccionar Política -->
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2 " href="#" data-bs-toggle="collapse"
            data-bs-target="#cargarPoliticas" aria-expanded="true">
            <i class="fa-solid fa-gavel text-warning"></i>
            <span class="nav-link-text">Seleccionar política</span>
          </a>
          <ul class="collapse show list-unstyled ms-4" id="cargarPoliticas"></ul>
        </li>

        <!-- Otras Apps -->
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center gap-2 collapsed" href="#" data-bs-toggle="collapse"
            data-bs-target="#submenuPdi" aria-expanded="false">
            <i class="fa-solid fa-rocket text-danger"></i>
            <span class="nav-link-text">Otras Apps</span>
          </a>
          <ul class="collapse list-unstyled ms-4" id="submenuPdi">
            <li>
              <a class="nav-link" href="https://sigunitropico.com" target="_blank">
                <i class="fa-solid fa-globe text-danger"></i> SIG Unitrópico
              </a>
            </li>
            <li>
              <a class="nav-link" href="https://sigunitropico.com/planeacion" target="_blank">
                <i class="fa-solid fa-chart-line text-info"></i> Planeación
              </a>
            </li>
          </ul>
        </li>

        <!-- Admin (solo visible para admins) -->
        <li class="nav-item mt-3 admin-only admin-polariscore" style="display: none;">
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Administración</h6>
        </li>
        <li class="nav-item admin-only admin-polariscore" style="display: none;">
          <a class="nav-link d-flex align-items-center gap-2" href="../pages/usuarios.html" target="_blank">
            <i class="fa-solid fa-users text-danger"></i>
            <span class="nav-link-text">Usuarios</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Login/Logout Aside: centrado y sin overlap -->
    <div class="sidenav-footer w-100 text-center mt-auto pb-3">

      <div class="card card-plain shadow-none mb-2" id="sidenavCard">
        <img class="w-80 mx-auto" src="../assets/img/illustrations/logo-simbolo-unitropico-1.png"
          alt="sidebar_illustration">
        <div class="card-body text-center p-2 w-100 pt-0">
          <div class="docs-info">
            <h6 class="mb-0">¿Necesitas ayuda?</h6>
            <p class="text-xs font-weight-bold mb-0">Por favor revisa nuestras guías</p>
          </div>
        </div>
      </div>
      <div id="asideAuthBtn" class="mb-2 d-flex flex-column align-items-center"></div>
      <a href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard" target="_blank"
        class="btn btn-dark btn-sm w-70 mb-2"><i class="fa-solid fa-book me-2"></i>Manual de uso</a>
      <a class="btn btn-primary btn-sm w-70 mb-0" href="mailto:innovacionplaneacion@unitropico.edu.co" type="button">
        <i class="fa-solid fa-envelope me-2"></i> Soporte técnico
      </a>

    </div>
  </aside>

  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    <style>
      @media (max-width: 768px) {
        .ocultar {
          display: none !important;
        }

        .margin-top-5 {
          margin-top: 5%;
        }

        .resaltar {
          background-color: #00594e;
          border-radius: 0px;
          margin: 0px auto !important;
          padding-top: 2%;
          padding-bottom: 4%;


        }

        .fecha_actualizacion {
          font-size: 0.9rem;
        }
      }
    </style>
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl resaltar" id="navbarBlur"
      data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb resaltar">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm "><a class="opacity-5 text-white" href="politicas.html">Políticas</a>
            </li>
            <li class="breadcrumb-item text-sm text-white active ocultar" id="idName" aria-current="page"> P-000</li>

          </ol>
          <h6 class="font-weight-bolder text-white mb-0 ocultar">Detalles de la Política</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">

          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>

            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>

            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="dropdownMenuButton" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fa fa-bell cursor-pointer"></i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New message</span> from Laur
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          13 minutes ago
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/small-logos/logo-spotify.svg"
                          class="avatar avatar-sm bg-gradient-dark  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New album</span> by Travis Scott
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          1 day
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background"
                                    d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z"
                                    opacity="0.593633743"></path>
                                  <path class="color-background"
                                    d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z">
                                  </path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          Payment successfully completed
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          2 days
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <div id="perfilUsuario" class="d-flex align-items-center gap-2" data-bs-toggle="dropdown" role="button"
                aria-expanded="false">
                <img id="imgPerfilUsuario" src="https://ui-avatars.com/api/?name=Usuario" alt="Foto"
                  class="rounded-circle border" width="40" height="40" style="object-fit:cover;">
              </div>
              <ul class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4" aria-labelledby="perfilUsuario">
                <li>
                  <a class="dropdown-item border-radius-md" href="../pages/profile.html">
                    <div class="d-flex py-1 align-items-center">
                      <div class="my-auto">
                        <img id="imgPerfilUsuarioDropdown" src="https://ui-avatars.com/api/?name=Usuario"
                          class="avatar avatar-sm me-3 rounded-circle border" style="object-fit:cover;">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm text-dark fw-bold" id="nombrePerfilUsuario"> Usuario</h6>
                        <small class="text-xs text-muted mb-0" id="correoPerfilUsuario"> Correo</small>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" id="rolesUsuario">
                    <i class="fas fa-user-circle text-primary me-2"></i> Usuario
                  </a>
                </li>
                <li>
                  <button id="logButton" class="dropdown-item border-radius-md text-danger d-flex align-items-center">
                    <span><i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar sesión</span>
                  </button>
                  <style>
                    /* Soluciona contraste para botón rojo dentro de dropdown Bootstrap */
                    #logButton.dropdown-item.text-danger:hover,
                    #logButton.dropdown-item.text-danger:focus {
                      background-color: #dc3545 !important;
                      /* danger */
                      color: #fff !important;
                      /* blanco */
                      border-radius: .5rem;
                    }

                    #logButton.dropdown-item.text-danger:hover i,
                    #logButton.dropdown-item.text-danger:focus i {
                      color: #fff !important;
                    }
                  </style>
                </li>
              </ul>
            </li>


          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->

    <!----------------- INICIO del contenido --------------->
    <div class="container-fluid py-4">
      <div class="row mt-1 d-flex align-items-stretch">
        <!-- Columna izquierda (Título + KPIs en una sola columna) -->
        <div class="col-md-9 d-flex flex-column">
          <!-- Fila 1: Título, Objetivo, Resumen -->
          <div class="card shadow-sm flex-fill mb-3  " id="politicaContainer"
            style="background: url('../assets/img/polariscore/P-001.png') no-repeat center center/cover;">
            <div class="card-body">
              <h6 class="text-uppercase text-white">Título</h6>
              <h2 class="text text-white" style="font-weight: bolder;" id="titulo_politica">Cargando...</h2>
              <h6 class="text-uppercase text-white mb-2">Objetivo General</h6>
              <p style="text-align: justify;" id="objetivo_general" class="mb-1 text-white">Cargando...</p>
              <!-- Acciones: Suscripción + Cambiar foto -->
              <div class="d-flex justify-content-end align-items-center gap-1 flex-wrap" id="accionesPolitica">
                <style>
                  /* Fondo de la tarjeta con blur controlado por variable CSS --bg-url */
                  #politicaContainer {
                    position: relative;
                    overflow: hidden;
                    background: none !important;
                    /* anula el inline background */
                  }

                  /* Capa de la imagen con blur */
                  #politicaContainer::before {
                    content: "";
                    position: absolute;
                    inset: 0;
                    background-image: var(--bg-url, url('../assets/img/polariscore/P-001.png'));
                    background-size: cover;
                    background-position: center;
                    filter: blur(2px) brightness(0.6) saturate(0.9);
                    transform: scale(1.06);
                    /* evita bordes por el blur */
                    z-index: 0;
                  }

                  /* Capa de oscurecimiento suave (opcional pero ayuda al contraste del texto) */
                  #politicaContainer::after {
                    content: "";
                    position: absolute;
                    inset: 0;
                    background: linear-gradient(180deg, hsla(171, 100%, 8%, 0.664), hsla(173, 97%, 47%, 0.432));
                    z-index: 0;
                  }

                  /* El contenido real arriba de las capas */
                  #politicaContainer>.card-body {
                    position: relative;
                    z-index: 1;
                  }

                  /* Switch visible en fondo oscuro */
                  #chkSubPolitica.form-check-input {
                    width: 2.4em;
                    height: 1.2em;
                    cursor: pointer;
                    border-color: #e9ecef;
                  }

                  #chkSubPolitica.form-check-input:checked {
                    background-color: #B5A160;
                    border-color: #B5A160;
                  }

                  /* Botón más compacto cuando el panel está expandido */
                  #accionesPolitica .btn.btn-sm {
                    padding: .35rem .6rem;
                    border-radius: .5rem;
                  }
                </style>
                <!-- Suscribirse -->
                <div class="d-flex align-items-center gap-2 text-white">
                  <label for="chkSubPolitica" class="mb-0 small text-white" id="estadoSuscrito">Suscribirme a la
                    política</label>
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="chkSubPolitica"
                      aria-label="Suscribirme a la política" disabled>
                  </div>
                </div>


                <!-- Cambiar foto -->
                <button type="button" class="btn btn-sm admin-only admin-polariscore" style="display: none;"
                  id="btnCambiarFotoPolitica" title="Cambiar imagen de la política" data-bs-toggle="tooltip">
                  <i class="fa-solid fa-camera text-white"></i>

                </button>
                <input type="file" id="fileFotoPolitica" accept="image/*" class="d-none">
              </div>

              <small id="lblSubMsg" class="d-block text-end text-white-50"></small>
            </div>
          </div>

          <!-- Fila 2: KPIs -->
          <div class="row text-center flex-fill">
            <div class="col-md-3 mb-3">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h6>Total Objetivos Específicos</h6>
                  <h2 id="totalObjetivos" class="text-muted fw-bold">...</h2>

                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h6>Total Acciones</h6>
                  <h2 id="totalAcciones" class="text-muted fw-bold">...</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h6>Total Acciones Completadas</h6>
                  <h2 id="totalAccionesCompletadas" class="text-muted fw-bold">...</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h6>Total Evidencias</h6>
                  <h2 id="totalEvidencias" class="text-muted fw-bold">...</h2>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Columna derecha (Gráfica que iguala en altura a todo lo de la izquierda) -->
        <div class="col-md-3 d-flex mb-3">
          <div class="card shadow-sm w-100 flex-fill">
            <div class="card-header text-center py-2 bg-gradient-warning ">
              <h4 class="text-white">Avance General de la política</h3>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">

              <!-- Contenedor de la gráfica (reemplaza todo el SVG y p#porcentaje) -->
              <div id="grafica_cumplimiento_Politica" style="width: 100%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de gráficas -->
      <h5 class="text text-muted">Dashboard de la Política</h5>
      <div class="row mt-4">
        <!-- Panel lateral de tabs -->
        <div class="col-md-3" id="panelTabs">
          <!-- Botón toggle -->
          <div class="d-flex justify-content-end mb-2">
            <button id="toggleTabs" class="btn btn-sm btn-outline-secondary" title="Contraer/expandir panel">
              <i class="fa-solid fa-angles-left"></i>
            </button>
          </div>

          <div class="nav flex-column nav-pills gap-2 fancy-tabs" id="graficaTabs" role="tablist"
            aria-orientation="vertical">
            <!-- AVANCES -->
            <button class="nav-link active" id="graf1-tab" data-bs-toggle="pill" data-bs-target="#graf1" type="button"
              onclick="scrollToSection('panelTabs')" title="Avance General">
              <div class="tile">
                <div class="icono"><i class="fa-solid fa-chart-line"></i></div>
                <div class="meta">
                  <div class="titulo">Avance General</div>
                  <div class="detalle">Avance anual de la política en %.</div>
                  <div class="info-extra">
                    <span id="graf1-años">Cálculo en tiempo real</span>
                  </div>
                </div>
              </div>
            </button>

            <button class="nav-link" id="graf2-tab" data-bs-toggle="pill" data-bs-target="#graf2" type="button"
              onclick="scrollToSection('panelTabs')" title="Avance Objetivos">
              <div class="tile">
                <div class="icono"><i class="fa-solid fa-chart-line"></i></div>
                <div class="meta">
                  <div class="titulo">Avance Objetivos</div>
                  <div class="detalle">Avance acumulado ponderado por objetivo.</div>
                  <div class="info-extra">
                    <span>2023–2025</span><span>6 Objetivos</span>
                  </div>
                </div>
              </div>
            </button>

            <button class="nav-link" id="graf3-tab" data-bs-toggle="pill" data-bs-target="#graf3" type="button"
              style="display:none" onclick="scrollToSection('panelTabs')" title="Tabla de Cumplimiento">
              <div class="tile">
                <div class="icono"><i class="fa-solid fa-table"></i></div>
                <div class="meta">
                  <div class="titulo">Tabla de Cumplimiento</div>
                  <div class="detalle">Ejecutado, programado y proporcional.</div>
                  <div class="info-extra">
                    <span>Indicadores reales</span><span>Por objetivo</span>
                  </div>
                </div>
              </div>
            </button>

            <!-- CUMPLIMIENTOS -->
            <button class="nav-link" id="graf4-tab" data-bs-toggle="pill" data-bs-target="#graf4" type="button"
              onclick="scrollToSection('panelTabs')" title="Cumplimiento Objetivos">
              <div class="tile">
                <div class="icono"><i class="fa-solid fa-table"></i></div>
                <div class="meta">
                  <div class="titulo">Cumplimiento Objetivos</div>
                  <div class="detalle">Cumplimiento acumulado ponderado.</div>
                  <div class="info-extra">
                    <span>2023–2025</span><span>6 Objetivos</span>
                  </div>
                </div>
              </div>
            </button>

            <button class="nav-link" id="graf5-tab" data-bs-toggle="pill" data-bs-target="#graf5" type="button"
              onclick="scrollToSection('panelTabs')" title="Acciones Ejecutadas">
              <div class="tile">
                <div class="icono"><i class="fa-solid fa-chart-line"></i></div>
                <div class="meta">
                  <div class="titulo">Acciones Ejecutadas</div>
                  <div class="detalle">100% ejecutadas vs programadas por año.</div>
                  <div class="info-extra">
                    <span>Cálculo en tiempo real</span>
                  </div>
                </div>
              </div>
            </button>

            <button class="nav-link mb-3 admin-responsable-only" id="graf6-tab" data-bs-toggle="pill"
              data-bs-target="#graf6" type="button" style="display:none" onclick="scrollToSection('panelTabs')"
              title="Registro General de la Política">
              <div class="tile">
                <div class="icono"><i class="fa-solid fa-table"></i></div>
                <div class="meta">
                  <div class="titulo">Registro General de la Política</div>
                  <div class="detalle">Avance por objetivo y acción, año a año.</div>
                  <div class="info-extra">
                    <span>Cálculo en tiempo real</span>
                  </div>
                </div>
              </div>
            </button>
          </div>

        </div>

        <style>
          /* --- Mostrar detalles SOLO cuando el botón-tab esté activo --- */
          /* Estado por defecto: oculto */
          #graficaTabs .nav-link .detalle,
          #graficaTabs .nav-link .info-extra {
            display: none;
          }

          /* Mostrar cuando el botón está activo (o aria-selected=true) y el panel NO está colapsado */
          #panelTabs:not(.collapsed-tabs) #graficaTabs .nav-link.active .detalle,
          #panelTabs:not(.collapsed-tabs) #graficaTabs .nav-link[aria-selected="true"] .detalle {
            display: block;
          }

          #panelTabs:not(.collapsed-tabs) #graficaTabs .nav-link.active .info-extra,
          #panelTabs:not(.collapsed-tabs) #graficaTabs .nav-link[aria-selected="true"] .info-extra {
            display: flex;
          }

          /* Si el panel está colapsado, aunque esté activo, se mantienen ocultos */
          #panelTabs.collapsed-tabs .titulo,
          #panelTabs.collapsed-tabs .detalle,
          #panelTabs.collapsed-tabs .info-extra {
            display: none;
          }
        </style>


        <!-- Panel de contenido de gráficas -->
        <div class="col-md-9 mb-4" id="panelGraficas">
          <div class="tab-content p-3 border rounded shadow-sm bg-white" id="graficaTabsContent"
            style="border-radius: 15px!important;">

            <!-- AVANCES -->
            <div class="tab-pane fade show active" id="graf1">
              <h5 class="mb-3">Porcentaje de Avance por Año</h5>
              <div class="grafica-container">
                <canvas id="grafica_curva_s" class="grafica-limite"
                  style="width: 100%; height: 400px!important;"></canvas>
              </div>
              <!-- Botones horizontales para graf1 -->
              <div id="graf1-actions" class="d-flex flex-wrap gap-2 mt-3"></div>
            </div>

            <div class="tab-pane fade" id="graf2">
              <h5 class="mb-3">Avance Proporcional por Objetivos</h5>
              <div id="contenedor_grafica_objetivos">
                <div id="grafica_objetivos" style="height: 500px;"></div>
              </div>
              <!-- Botones horizontales para graf2 -->
              <div id="graf2-actions" class="d-flex flex-wrap gap-2 mt-3"></div>
            </div>

            <div class="tab-pane fade" id="graf3" style="display: none;">
              <h5 class="mb-3">Tabla de Cumplimiento Detallado por Objetivo</h5>
              <div id="contenedor_tabla_objetivos" class="table-responsive"></div>
            </div>

            <!-- CUMPLIMIENTOS -->
            <div class="tab-pane fade" id="graf4">
              <h5 class="mb-3">Cumplimiento de objetivos por año</h5>
              <!-- Gantt chart container -->
              <div class="" id="objetivosPorAnio">
                <!-- Aquí se cargan dinámicamente los objetivos y acciones -->
                <div style="display: flex; align-items: center; justify-content: center;">
                  <img src="../assets/img/polariscore/animacion.gif" alt="S-PLAN" style="width: 40%;">
                </div>
              </div>
              <!-- Botones horizontales para graf4 -->
              <div id="graf4-actions" class="d-flex flex-wrap gap-2 mt-3"></div>
            </div>

            <div class="tab-pane fade" id="graf5">
              <h5 class="mb-3">Cantidad de Acciones Ejecutadas vs Programadas</h5>
              <div class="grafica-container">
                <canvas id="grafica_cumplimiento_anios" class="grafica-limite"
                  style="width: 100%; height: 400px!important;"></canvas>
              </div>
              <!-- Botones horizontales para graf5 -->
              <div id="graf5-actions" class="d-flex flex-wrap gap-2 mt-3"></div>
            </div>

            <div class="tab-pane fade" id="graf6">
              <h5 class="text-uppercase text-dark font-weight-bold mb-1" style="line-height: 98%;">OBJETIVOS Y
                ACCIONES</h2>
                <p class="mb-0 small mb-4" style="line-height: 98%; margin-bottom: -1%;" id="descGantt">
                  Visualiza la programación anual de las acciones por objetivo.
                </p>
                <div style="overflow-x: auto; min-width: 310px;">
                  <!-- Gantt chart container -->
                  <div class="accordion" id="acordeonCronograma">
                    <!-- Aquí se cargan dinámicamente los objetivos y acciones -->
                  </div>

                </div>
                <!-- Botones horizontales para graf5 -->
                <div id="graf5-actions" class="d-flex flex-wrap gap-2 mt-3"></div>
            </div>



          </div>
        </div>
      </div>

      <script>
        (function () {
          const toggleBtn = document.getElementById("toggleTabs");
          const panelTabs = document.getElementById("panelTabs");
          const panelGraficas = document.getElementById("panelGraficas");

          // IDs de ECharts conocidos (ajústalos si tienes más)
          const ECHART_IDS = ["grafica_objetivos", "grafica_cumplimiento_objetivos"];

          // ---- REFRESH CORE ----
          let raf1 = null, raf2 = null, tmo = null;

          function refreshProgressBars() {
            // Si usas barras con data-percent o data-value, reasigna el width
            // Ejemplos de selectores: .progress-bar[data-percent], .barra-ejecutado[data-value]
            document.querySelectorAll('.progress-bar[data-percent]').forEach(el => {
              const p = parseFloat(el.getAttribute('data-percent'));
              if (isFinite(p)) el.style.width = p + '%';
            });
            document.querySelectorAll('.barra-ejecutado[data-value]').forEach(el => {
              const p = parseFloat(el.getAttribute('data-value'));
              if (isFinite(p)) el.style.width = p + '%';
            });
          }

          function triggerResizeNow() {
            // 1) ECharts
            try {
              if (window.echarts) {
                ECHART_IDS.forEach(id => {
                  const el = document.getElementById(id);
                  if (!el) return;
                  const inst = window.echarts.getInstanceByDom(el);
                  if (inst) inst.resize();
                });
              }
            } catch (_) { }

            // 2) Chart.js
            try {
              if (window.myCharts && Array.isArray(window.myCharts)) {
                window.myCharts.forEach(ch => ch && ch.resize && ch.resize());
              }
            } catch (_) { }

            // 3) Barras/medidores propios (opcional)
            refreshProgressBars();

            // 4) Notificar a listeners propios
            window.dispatchEvent(new Event('resize'));
            document.dispatchEvent(new Event('ui:refreshed'));
          }

          function scheduleUIRefresh(delay = 0) {
            if (tmo) clearTimeout(tmo);
            if (raf1) cancelAnimationFrame(raf1);
            if (raf2) cancelAnimationFrame(raf2);

            tmo = setTimeout(() => {
              raf1 = requestAnimationFrame(() => {
                // Primer frame: el layout ya aplicó clases .show/.collapsed-tabs
                raf2 = requestAnimationFrame(() => {
                  // Segundo frame: ahora sí redimensionamos todo
                  triggerResizeNow();
                });
              });
            }, delay);
          }

          // ---- TOGGLE LATERAL ----
          if (toggleBtn && panelTabs && panelGraficas) {
            toggleBtn.addEventListener("click", () => {
              panelTabs.classList.toggle("collapsed-tabs");
              panelGraficas.classList.toggle("expanded-graf");

              // Cambiar icono
              const icon = toggleBtn.querySelector("i");
              if (icon) {
                if (panelTabs.classList.contains("collapsed-tabs")) {
                  icon.classList.replace("fa-angles-left", "fa-angles-right");
                } else {
                  icon.classList.replace("fa-angles-right", "fa-angles-left");
                }
              }

              // Refrescar UI tras el cambio de layout
              scheduleUIRefresh(50);
            });
          }

          // ---- Bootstrap: tabs y accordions ----
          // 1) Tabs (pills)
          document.querySelectorAll('#graficaTabs [data-bs-toggle="pill"], #graficaTabs [data-bs-toggle="tab"]')
            .forEach(el => {
              el.addEventListener('shown.bs.tab', () => scheduleUIRefresh(0));
            });

          // 2) Collapses (acordeón): escuchar de forma delegada
          document.addEventListener('shown.bs.collapse', () => scheduleUIRefresh(0));
          document.addEventListener('hidden.bs.collapse', () => scheduleUIRefresh(0));

          // ---- MutationObserver: cuando el acordeón se rellena dinámicamente ----
          const targets = [
            document.getElementById('acordeonCronograma'),
            document.getElementById('objetivosPorAnio'),
            document.getElementById('graficaTabsContent'),
            document.getElementById('panelGraficas')
          ].filter(Boolean);

          const mo = new MutationObserver((mutations) => {
            // si se insertan nodos o cambian clases (show/hidden), refrescamos
            const relevant = mutations.some(m =>
              (m.type === 'childList' && (m.addedNodes?.length || m.removedNodes?.length)) ||
              (m.type === 'attributes' && m.attributeName === 'class')
            );
            if (relevant) scheduleUIRefresh(0);
          });

          targets.forEach(t => mo.observe(t, { childList: true, subtree: true, attributes: true }));

          // ---- Disparos iniciales ----
          window.addEventListener('load', () => scheduleUIRefresh(0));
          window.addEventListener('orientationchange', () => scheduleUIRefresh(0));

          // Si tu contenido tarda en llegar (fetch async), un pequeño “seguro”:
          setTimeout(() => scheduleUIRefresh(0), 400);
          setTimeout(() => scheduleUIRefresh(0), 1000);
        })();
      </script>


      <style>
        :root {
          --brand: #00594e;
          --brand-2: #004d43;
          --ink: #212529;
          --muted: #6c757d;
          --surface: #f8f9fa;
          --surface-2: #eef2f3;
          --ring: #dde3e5;
        }

        .fancy-tabs .nav-link {
          /* base */
          padding: .6rem .65rem;
          /* más compacto */
          border: 1px solid var(--ring);
          border-radius: 12px;
          background: linear-gradient(180deg, #fff, var(--surface));
          color: var(--ink);
          transition: border-color .2s ease, transform .12s ease, background .2s ease, box-shadow .2s ease;
          box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
        }

        .fancy-tabs .nav-link .tile {
          display: flex;
          align-items: center;
          gap: .7rem;
          min-width: 0;
        }

        .fancy-tabs .icono {
          flex: 0 0 auto;
          width: 36px;
          height: 36px;
          border-radius: 10px;
          display: grid;
          place-items: center;
          background: radial-gradient(100% 100% at 0% 0%, #e8f3f1 0%, #dfeceb 100%);
          font-size: 16px;
          color: var(--brand);
        }

        .fancy-tabs .meta {
          display: flex;
          flex-direction: column;
          gap: .2rem;
          min-width: 0;
        }

        .fancy-tabs .titulo {
          font-weight: 700;
          font-size: .98rem;
          /* más pequeño */
          line-height: 1.1;
          white-space: nowrap;
          text-overflow: ellipsis;
          overflow: hidden;
        }

        .fancy-tabs .detalle {
          font-size: .82rem;
          color: var(--muted);
          white-space: nowrap;
          text-overflow: ellipsis;
          overflow: hidden;
        }

        .fancy-tabs .info-extra {
          display: flex;
          gap: .4rem;
          flex-wrap: wrap;
          font-size: .72rem;
          color: #8a949b;
        }

        .fancy-tabs .info-extra span {
          background: #eef3f2;
          color: #5f6f6c;
          padding: .14rem .5rem;
          border-radius: 999px;
          border: 1px solid #e3ebe9;
        }

        /* Hover */
        .fancy-tabs .nav-link:hover {
          transform: translateY(-1px);
          border-color: #cfd7da;
          background: linear-gradient(180deg, #fff, var(--surface-2));
          box-shadow: 0 3px 8px rgba(0, 0, 0, .06);
        }

        /* Active state */
        .fancy-tabs .nav-link.active {
          background: linear-gradient(180deg, #0a7a6c, var(--brand));
          color: #fff;
          border-color: var(--brand-2);
          box-shadow: 0 6px 16px rgba(0, 89, 78, .18);
          position: relative;
        }

        .fancy-tabs .nav-link.active .icono {
          background: rgba(255, 255, 255, .18);
          color: #fff;
        }

        /* Indicador lateral */
        .fancy-tabs .nav-link.active::before {
          content: "";
          position: absolute;
          inset: 0 auto 0 0;
          width: 4px;
          border-radius: 12px 0 0 12px;
          background: linear-gradient(180deg, #b5a160, #fff);
          box-shadow: 0 0 0 1px rgba(0, 0, 0, .08) inset;
        }

        /* Estado colapsado: solo iconos */
        #panelTabs.collapsed-tabs .fancy-tabs .nav-link {
          padding: .5rem;
          border-radius: 12px;
          display: grid;
          place-items: center;
        }

        #panelTabs.collapsed-tabs .fancy-tabs .nav-link .tile {
          gap: 0;
        }

        #panelTabs.collapsed-tabs .fancy-tabs .icono {
          width: 38px;
          height: 38px;
          border-radius: 12px;
        }

        #panelTabs.collapsed-tabs .fancy-tabs .titulo,
        #panelTabs.collapsed-tabs .fancy-tabs .detalle,
        #panelTabs.collapsed-tabs .fancy-tabs .info-extra {
          display: none !important;
        }

        /* Modo expandido (panel no colapsado): aún más compacto en pantallas grandes */
        @media (min-width: 992px) {
          #panelTabs:not(.collapsed-tabs) .fancy-tabs .nav-link {
            padding: .55rem .6rem;
            /* reduce más cuando está expandido */
          }

          #panelTabs:not(.collapsed-tabs) .fancy-tabs .titulo {
            font-size: .95rem;
          }

          #panelTabs:not(.collapsed-tabs) .fancy-tabs .detalle {
            font-size: .8rem;
          }
        }

        /* Accesibilidad: focus visible */
        .fancy-tabs .nav-link:focus-visible {
          outline: 2px solid #b5a160;
          outline-offset: 2px;
          box-shadow: 0 0 0 4px rgba(181, 161, 96, .25);
        }

        /* Mantén tu expansión de gráficas */
        #graficaTabs {
          gap: .5rem !important;
        }

        #panelGraficas.expanded-graf {
          width: calc(100% - 60px) !important;
          flex: 1;
        }

        /* Resalta el año actual en chips si lo muestras como texto */
        .year-chip {
          font-size: .74rem;
          padding: .15rem .5rem;
          border-radius: 999px;
          background: #fff2cc;
          color: #7a631a;
          border: 1px solid #f1e0a6;
        }


        #graficaTabs .titulo {
          font-weight: bold;
          font-size: 1.1rem;
          margin-top: 0.25rem;
        }

        #graficaTabs .detalle {
          font-size: 0.95rem;
          color: #6c757d;
        }

        #graficaTabs .nav-link.active .detalle {
          color: #fff;
        }

        #graficaTabs .info-extra {
          font-size: 0.8rem;
          color: #adb5bd;
          display: flex;
          justify-content: space-between;
        }

        .grafica-container {
          width: 100%;
          overflow-x: auto;
          border-radius: 15px;
        }

        canvas.grafica-limite {
          width: 100% !important;
          max-height: 60vh !important;
        }

        /* === NUEVO: comportamiento colapsado/expandido === */
        #panelTabs.collapsed-tabs {
          width: 60px !important;
          min-width: 60px;
          max-width: 60px;
          overflow: hidden;
        }

        #panelTabs.collapsed-tabs .titulo,
        #panelTabs.collapsed-tabs .detalle,
        #panelTabs.collapsed-tabs .info-extra {
          display: none;
        }

        /* Mantén visibles los iconos y los botones de tab */
        #panelTabs.collapsed-tabs .nav-link {
          align-items: center;
          padding: 0.65rem;
        }

        #panelTabs.collapsed-tabs .icono {
          font-size: 22px;
        }

        /* Expansión del panel de gráficas cuando el lateral está colapsado */
        #panelGraficas.expanded-graf {
          width: calc(100% - 60px) !important;
          flex: 1;
        }

        /* Cards de responsables */
        .resp-card {
          position: relative;
          height: 100%;
        }

        .resp-badge {
          margin-top: 5%;
          position: absolute;
          bottom: .5rem;
          right: .5rem;
          z-index: 1;
        }

        .resp-body {
          display: flex;
          align-items: flex-start;
          gap: .75rem;
          min-width: 0;
          /* clave para que text-truncate funcione dentro de flex */
        }

        .resp-avatar {
          width: 42px;
          height: 42px;
          border-radius: 50%;
          flex: 0 0 42px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .resp-meta {
          flex: 1 1 auto;
          min-width: 0;
          /* permite elipsis */
        }

        .resp-name {
          font-weight: 600;
          line-height: 1.1;
        }

        /* opcional: igualar altura visual si hay cards con menos líneas */
        .resp-card .card-body {
          padding-right: 3.25rem;
          padding-bottom: 4rem;
          /* deja aire a la derecha por el badge */
        }
      </style>



      <!-- Responsables (en un row) -->
      <div class="row" id="responsablesSection">
        <!-- Encabezado + acciones -->
        <div class="col-12">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <h2 class="h6 text-dark mb-0">
              Líder de la Política
              <span id="responsablesPolitica" class="fw-bold d-none"></span>
            </h2>

            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button id="btnInvitarColaborador" class="btn btn-sm btn-outline-info">
                <i class="fa-solid fa-user-plus me-1"></i>
                Invitar colaborador
              </button>

              <button id="btnAddResponsable" class="btn btn-sm btn-outline-warning">
                <i class="fa-solid fa-plus me-1"></i>
                Agregar líder
              </button>
            </div>
          </div>
        </div>

        <!-- Cards en fila (responsive) -->
        <div class="col-12">
          <div id="responsablesRow" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
            <!-- Estado inicial -->
            <div class="col" id="responsablesLoading">
              <div class="text-muted small">Cargando responsables…</div>
            </div>
          </div>
        </div>
      </div>

    </div>




    <!-- INFORME PDF INSTITUCIONAL - PLANTILLA BASE -->
    <div id="contenedorInformePDF"
      style="background: #fff; color: #222; font-family: 'Arial', sans-serif; max-width: 850px; margin: 0 auto; padding: 36px 36px 56px 36px; box-shadow: 0 2px 15px #0002; border-radius: 12px; display: none;">
      <!-- Encabezado Fijo -->
      <table style="width: 100%; margin-bottom: 22px;">
        <tr>
          <td style="width: 90px;">
            <img src="../assets/img/unitropico-logo-color.png" alt="Logo" style="height: 80px; border-radius: 8px;">
          </td>
          <td style="vertical-align: middle;">
            <h1 style="margin: 0; color: #00594E; font-size: 1.8rem;">INFORME DE CUMPLIMIENTO DE POLÍTICA</h1>
            <div style="font-size: 1.02em; color: #444;">
              Fecha: <span id="fechaInforme"></span><br>
              Elaborado por: <span id="usuarioInforme"></span>
            </div>
          </td>
        </tr>
      </table>

      <!-- Título y Objetivo -->
      <h2 id="tituloInforme" style="color:#B5A160;">Título de la Política</h2>
      <div style="margin-bottom: 15px; ">
        <strong>Objetivo General:</strong>
        <span id="objetivo_general_pdf"></span>
      </div>

      <!-- KPIs -->
      <table style="width: 100%; margin: 0 0 28px 0; border-collapse: separate; border-spacing: 0 7px;">
        <tr>
          <td style="background: #f5f5f5; border-radius: 8px; text-align:center; padding: 18px;">
            <div style="font-size: 1.15em; color: #888;">Total Objetivos Específicos</div>
            <div id="totalObjetivos_pdf" style="font-size: 2em; color: #00594E; font-weight:bold;">-</div>
          </td>
          <td style="background: #f5f5f5; border-radius: 8px; text-align:center; padding: 18px;">
            <div style="font-size: 1.15em; color: #888;">Total Acciones</div>
            <div id="totalAcciones_pdf" style="font-size: 2em; color: #00594E; font-weight:bold;">-</div>
          </td>
          <td style="background: #f5f5f5; border-radius: 8px; text-align:center; padding: 18px;">
            <div style="font-size: 1.15em; color: #888;">Acciones Completadas</div>
            <div id="totalAccionesCompletadas_pdf" style="font-size: 2em; color: #00594E; font-weight:bold;">-</div>
          </td>
          <td style="background: #f5f5f5; border-radius: 8px; text-align:center; padding: 18px;">
            <div style="font-size: 1.15em; color: #888;">Total Evidencias</div>
            <div id="totalEvidencias_pdf" style="font-size: 2em; color: #00594E; font-weight:bold;">-</div>
          </td>
        </tr>
      </table>

      <!-- Gráfica de Termómetro -->
      <div style="width:100%; text-align: center; margin-bottom: 18px;">

        <div style="font-size:1.3em; color:#00594E; font-weight:bold;">
          Cumplimiento global: <span id="porcentaje_pdf">-</span>%
        </div>
      </div>

      <!-- Gráficas -->
      <div style="margin: 26px 0;">
        <h4 style="color: #B5A160; font-weight: bold; margin-top: 3%;">Gráficas de Curva S de la Política</h4>
        <h4 style="color: #00594e; font-weight: bold; text-align: center;" class="text-sm">Cumplimiento por año</h4>
        <div style="display:flex; gap:28px; flex-wrap: wrap;">
          <div class="grafica-container">
            <canvas id="grafica_curva_s_pdf"
              style="width: 100%!important; height: 300px!important; margin: auto 5%;"></canvas>
          </div>


        </div>
        <h4 style="color: #00594e; font-weight: bold; text-align: center!important;  margin-top: 5%;"
          class="text-sm text-align-center">
          Acciones Ejecutadas por completo vs Acciones programadas</h4>
        <div style="display:flex; gap:28px; flex-wrap: wrap;">

          <div class="grafica-container">
            <canvas id="grafica_cumplimiento_anios_pdf"
              style="width: 100%!important; height: 300px!important; margin: auto 5%;"></canvas>
          </div>
        </div>

        <h4 style="color: #B5A160; font-weight: bold; margin-top: 3%;">Gráfica de barras</h4>
        <div id="contenedor_grafica_objetivos">
          <div id="grafica_objetivos_pdf" style="width: 100%!important; height: 500px!important; margin: auto 2%;">
          </div>
        </div>

        <h4 style="color: #00594e; font-weight: bold; text-align: center!important;  margin-top: 5%;"
          class="text-sm text-align-center">
          Acciones Ejecutadas por completo vs Acciones programadas</h4>
        <div id="contenedor_tabla_objetivos_pdf" class="table-responsive">
          <!-- La tabla será insertada dinámicamente desde la función JS -->
        </div>

        <h4 style="color: #B5A160;">Resumen de Acciones y Cumplimiento</h4>

      </div>

      <!-- Tabla de Cumplimiento de Acciones -->
      <div style="margin: 28px 0;">

      </div>

      <!-- Observaciones -->
      <div style="margin: 34px 0;">
        <h4 style="color: #B5A160;">Observaciones y Recomendaciones</h4>
        <div id="observaciones_pdf" style="border-left: 3px solid #B5A160; padding-left: 12px; color: #444;">
          <!-- Observaciones aquí -->
        </div>
      </div>

      <!-- Firmas -->
      <table style="width: 100%; margin-top: 42px;">
        <tr>
          <td style="text-align: center; padding: 30px 0 0 0;">
            ___________________________<br>
            <b>Elaboró</b>
          </td>
          <td style="text-align: center; padding: 30px 0 0 0;">
            ___________________________<br>
            <b>Revisó</b>
          </td>
          <td style="text-align: center; padding: 30px 0 0 0;">
            ___________________________<br>
            <b>Aprobó</b>
          </td>
        </tr>
      </table>

      <!-- Pie de página -->
      <div
        style="position: fixed; bottom: 24px; left: 0; right: 0; width: 100%; text-align: center; color: #888; font-size: 0.98em;">
        Unitrópico • Informe de Cumplimiento • Generado automáticamente
      </div>
    </div>


    <!--------- Fin del contenido ----------->
    <!-- Contenedor de notificaciones (Toasts) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
      <div id="toastContainer"></div>
    </div>

    <footer class="footer pt-3  ">
      <div class="container-fluid">
        <div class="row align-items-center justify-content-lg-between">
          <div class="col-lg-6 mb-lg-0 mb-4">
            <div class="copyright text-center text-sm text-muted text-lg-start">
              ©
              <script>
                document.write(new Date().getFullYear())
              </script>,
              desarrollado por la <a style="font-weight: 600; color: #00584e;"
                href="https://sigunitropico.com/planeacion-estrategica">Oficina Asesora de Planeación</a> - Unitrópico

            </div>
          </div>
          <div class="col-lg-6">
            <ul class="nav nav-footer justify-content-center justify-content-lg-end">
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Synaris Corp</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Nosotros</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Blog</a>
              </li>
              <li class="nav-item">
                <a href="synariscorp.com" class="nav-link pe-0 text-muted" target="_blank">Licencia</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    </div>



  </main>
  <div class="fixed-plugin">
    <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
      <i class="fa fa-cog py-2"> </i>
    </a>

    <style>
      #responsablesSection .btn {
        white-space: nowrap;
      }

      /* Estilo base para botones flotantes */
      .boton-politica {
        position: fixed;
        right: 1.8%;
        z-index: 5;
        background-color: #ffffff;
        color: #00594E;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
        border: 2px solid #00594E;
      }

      @media (max-width: 768px) {

        .boton-politica {
          right: 5%;
        }

      }

      .boton-politica:hover {
        background-color: #00594E;
        color: #ffffff;
        transform: scale(1.1);
      }

      .boton-politica svg {
        pointer-events: none;
      }

      /* Posiciones individuales */
      #anteriorBtn {
        bottom: 10%;
      }

      #siguienteBtn {
        bottom: 16%;
      }

      #documentosBtn {
        bottom: 22%;
        border: 2px solid #b5a160;
        color: #b5a160;
      }

      #documentosBtn:hover {
        background-color: #b5a160;
        color: #fff;
      }

      /* Estilo para deshabilitado visual */
      .boton-politica.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
    </style>
    <a id="anteriorBtn" class="boton-politica" title="Política Anterior" href="#">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-left"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
      </svg>
    </a>

    <a id="siguienteBtn" class="boton-politica" title="Política Siguiente" href="#">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-right"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8" />
      </svg>
    </a>
    <a id="documentosBtn" class="boton-politica" title="Ver Documentos" href="#" data-bs-toggle="modal"
      data-bs-target="#DocumentosModal">
      <i class="fa-solid fa-folder-open"></i>
    </a>


    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3 ">
        <div class="float-start">
          <h5 class="mt-3 mb-0">Argon Configurator</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="fa fa-close"></i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0 overflow-auto">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-gradient-primary active" data-color="primary"
              onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between 2 different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn bg-gradient-primary w-100 px-3 mb-2 active me-2" data-class="bg-white"
            onclick="sidebarType(this)">White</button>
          <button class="btn bg-gradient-primary w-100 px-3 mb-2" data-class="bg-default"
            onclick="sidebarType(this)">Dark</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="d-flex my-3">
          <h6 class="mb-0">Navbar Fixed</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
          </div>
        </div>
        <hr class="horizontal dark my-sm-4">
        <div class="mt-2 mb-5 d-flex">
          <h6 class="mb-0">Light / Dark</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version" onclick="darkMode(this)">
          </div>
        </div>
        <a class="btn bg-gradient-dark w-100" href="https://www.creative-tim.com/product/argon-dashboard">Free
          Download</a>
        <a class="btn btn-outline-dark w-100"
          href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard">View documentation</a>
        <div class="w-100 text-center">
          <a class="github-button" href="https://github.com/creativetimofficial/argon-dashboard"
            data-icon="octicon-star" data-size="large" data-show-count="true"
            aria-label="Star creativetimofficial/argon-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="https://twitter.com/intent/tweet?text=Check%20Argon%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fargon-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/argon-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>




  <!-- Modal -->
  <div class="modal fade" id="DocumentosModal" tabindex="-1" role="dialog" aria-labelledby="DocumentosLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="DocumentosLabel">Documentos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Contenido de la tarjeta aquí -->
          <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Documentos de la Política</h6>
              <button class="btn btn-outline-primary btn-sm mb-0" id="descargar_todo">Descargar todo</button>
            </div>

            <div id="modalDocumentos">
              <p class="text-muted text-center">Cargando documentos...</p>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Cierre de Sesión -->
  <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutLabel">Cerrar sesión</h5>
        </div>
        <div class="modal-body text-center">
          <p>¿Estás seguro de que quieres cerrar sesión?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmLogout">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </div>




  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9/firebase-storage.js"></script>
  <!--   Core JS Files   -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>

  <!-- Librería ECharts oficial -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- Tu theme personalizado -->
  <script src="../assets/js/polariscore-charts.js"></script>
  </script>

  <script type="module">
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
    import { getFirestore, limit, collection, query, where, getDocs, getDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyADKfjkB9LO1k1smRJ31sOb-7rrxOrQ7lc",
      authDomain: "sigunitropico.firebaseapp.com",
      projectId: "sigunitropico",
      storageBucket: "sigunitropico.appspot.com",
      messagingSenderId: "32992004482",
      appId: "1:32992004482:web:bd4d5e9a2b7a8b976e279b"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const dbFS = getFirestore(app);

    // Obtener el botón de login/logout
    const logButton = document.getElementById("logButton");
    const totalObjetivos = document.getElementById('totalObjetivos');
    const totalObjetivos_pdf = document.getElementById('totalObjetivos_pdf');
    const totalAcciones = document.getElementById('totalAcciones');
    const totalAcciones_pdf = document.getElementById('totalAcciones_pdf');
    const totalAccionesCompletadas = document.getElementById('totalAccionesCompletadas');
    const totalAccionesCompletadas_pdf = document.getElementById('totalAccionesCompletadas_pdf');
    const totalEvidencias = document.getElementById('totalEvidencias');
    const totalEvidencias_pdf = document.getElementById('totalEvidencias_pdf');

    const tituloPolitica = document.getElementById('tituloPolitica');

    let cantidadAcciones = 0;
    let cantidadAccionesCompletadas = 0;
    let cantidadEvidencias = 0;

    const id = getQueryParam('id');
    const idName = document.getElementById("idName");
    let porcentajeTexto_pdf = document.getElementById("porcentaje_pdf");
    if (idName) idName.textContent = id;
    window.politica_id = id;
    const idPolitica = id;
    const RUTA_RESPONSABLES_POLITICA = `/PolariScore/politicas/${idPolitica}/responsables`;

    let esAdmin = false;

    let accionesData = []; // Array global de las acciones con su cumplimiento

    // Variable para evitar agregar múltiples event listeners
    let logoutListenerAdded = false;

    // Verificar si el usuario está autenticado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        logButton.textContent = "Cerrar sesión";
        logButton.classList.remove("btn-primary");
        logButton.classList.add("btn-danger");

        // Mostrar foto y nombre de perfil
        const nombreCompleto = user.displayName || user.email || "Usuario";
        window.userCorreo = user.email;
        const nombreCorto = obtenerNombreCorto(nombreCompleto);
        const foto = user.photoURL
          ? user.photoURL
          : `https://ui-avatars.com/api/?name=${encodeURIComponent(nombreCorto)}&background=0D8ABC&color=fff&rounded=true&size=64`;

        if (document.getElementById("nombrePerfilUsuario")) {
          document.getElementById("nombrePerfilUsuario").textContent = nombreCompleto;
          document.getElementById("nombrePerfilUsuario").classList.add("text-dark");
          document.getElementById("nombrePerfilUsuario").classList.remove("text-white");
          document.getElementById("correoPerfilUsuario").textContent = user.email;

        }


        if (document.getElementById("imgPerfilUsuario")) {
          document.getElementById("imgPerfilUsuario").src = foto;
          document.getElementById("imgPerfilUsuario").alt = nombreCorto;
          document.getElementById("imgPerfilUsuario").title = nombreCorto;
        }

        if (document.getElementById("imgPerfilUsuarioDropdown")) {
          document.getElementById("imgPerfilUsuarioDropdown").src = foto;
          document.getElementById("imgPerfilUsuarioDropdown").alt = nombreCorto;
          document.getElementById("imgPerfilUsuarioDropdown").title = nombreCorto;
        }


        // Prevenir múltiples listeners
        if (!logoutListenerAdded) {
          logButton.addEventListener("click", () => {
            const logoutModal = new bootstrap.Modal(document.getElementById("logoutModal"));
            logoutModal.show();

            const confirmBtn = document.getElementById("confirmLogout");
            const clonedBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(clonedBtn, confirmBtn);

            clonedBtn.addEventListener("click", () => {
              signOut(auth).then(() => {
                window.location.href = "https://sigunitropico.com/plan-it-one/pages/sign-in.html";
              }).catch((error) => {
                console.error("Error al cerrar sesión:", error);
              });
            });
          });

          logoutListenerAdded = true;
        }

        // Buscar por correo sanitizado
        const correoSanitizado = user.email.replace(/\./g, "_");
        const userRef = ref(db, 'usuarios/' + correoSanitizado);

        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            const roles = userData.roles || [];

            console.log("Roles del usuario:", roles);


            // Detectar si es admin (si cualquier rol contiene "admin", case-insensitive)
            let esAdmin = roles.some(r => r.toLowerCase().includes('admin'));
            window.esAdmin = esAdmin;


            if (roles.includes("admin")) {
              document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
            }

            if (roles.includes("admin-polariscore")) {
              document.querySelectorAll(".admin-polariscore").forEach(el => el.style.display = "block");
            }

            if (roles.includes("admin-polariscore") || roles.includes("responsable-polariscore")) {
              document.querySelectorAll(".admin-responsable-only").forEach(el => el.style.display = "block");
            }

            if (document.getElementById("rolesUsuario")) {
              let rolSimplificado = "Usuario"; // valor por defecto

              // Normaliza los roles a minúsculas para evitar problemas de comparación
              const rolesMinusculas = roles.map(r => r.toLowerCase());

              // Verifica por orden de prioridad: admin > responsable > observador
              if (rolesMinusculas.some(r => r.includes("admin"))) {
                rolSimplificado = "Admin";
              } else if (rolesMinusculas.some(r => r.includes("responsable"))) {
                rolSimplificado = "Responsable";
              } else if (rolesMinusculas.some(r => r.includes("observador"))) {
                rolSimplificado = "Observador";
              }

              document.getElementById("rolesUsuario").textContent = rolSimplificado;
            }


          } else {
            console.warn("Usuario autenticado pero no registrado en la base de datos.");
          }
        }).catch((error) => {
          console.error("Error al obtener datos del usuario:", error);
        });

      } else {
        logButton.textContent = "Iniciar Sesión";
        logButton.classList.remove("btn-danger");
        logButton.classList.add("btn-primary");

        logButton.addEventListener("click", () => {
          window.location.href = "https://sigunitropico.com/plan-it-one/pages/sign-in.html";
        });
      }
    });

    async function verificarYcargarAcciones(id) {
      const db = getDatabase();
      const politicaRef = ref(db, `PolariScore/politicas/${id}`);




      try {
        const snapshot = await get(politicaRef);

        if (!snapshot.exists()) {
          console.warn(`⚠️ No existe la política con id: ${id}`);

          return;
        }

        const politica = snapshot.val();
        console.log("✅ Política encontrada:", politica);

        const fechaInicioPolitica = politica.fecha_politica;

        // ⬇️ Esto ya calcula métricas y llama internamente a renderAcordeonCronograma
        await renderAcordeonDesdePolitica(politica);

        // Resto de tu flujo
        iniciarGaugeAvance(politica.totalPolitica ?? 0);

        if (typeof porcentajeTexto_pdf !== 'undefined' && porcentajeTexto_pdf) {
          const val = Number(politica.totalPolitica ?? 0);
          porcentajeTexto_pdf.textContent = isNaN(val) ? '0.00' : val.toFixed(2);
        }

        await cargarAccionesConCumplimiento(id, fechaInicioPolitica);
        await configurarBotonesNavegacionPoliticas(id);
        await ensureSeguimientosCargados();
        renderTablaObjetivosPorAnio(politica);

      } catch (error) {
        console.error("❌ Error al buscar la política:", error);
        mostrarToast("Error al buscar la política", "danger");
      }
    }

    verificarYcargarAcciones(id);


    function obtenerNombreCorto(nombreCompleto) {
      if (!nombreCompleto) return "";
      const partes = nombreCompleto.trim().split(" ");
      if (partes.length === 1) return partes[0];
      return partes[0] + " " + partes[1];
    }

    // Función para mostrar una notificación (Toast)
    function mostrarToast(mensaje, tipo = "info") {
      const toastContainer = document.getElementById("toastContainer");

      // Crear toast
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${tipo} border-0 show`;
      toast.role = "alert";
      toast.ariaLive = "assertive";
      toast.ariaAtomic = "true";
      toast.innerHTML = `
              <div class="d-flex">
                  <div class="toast-body">${mensaje}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
              </div>
          `;

      toastContainer.appendChild(toast);

      // Mostrar el toast
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      // Eliminar el toast después de 5 segundos
      setTimeout(() => {
        bsToast.hide();
        setTimeout(() => toast.remove(), 500);
      }, 2000);
    }











    const dbRef = ref(db, 'PolariScore/politicas');

    const iconosPoliticas = {
      "P-001": "fas fa-chalkboard-teacher text-primary",         // Formación Profesoral
      "P-002": "fas fa-flask text-success",                      // Investigación y Convocatorias
      "P-003": "fas fa-tasks text-info",                         // Autoevaluación, Autorregulación y Mejoramiento
      "P-004": "fas fa-lightbulb text-warning",                  // Propiedad Intelectual
      "P-005": "fas fa-university text-danger",                  // Académica
      "P-006": "fas fa-graduation-cap text-secondary",           // Innovación Educativa y Buenas Prácticas Pedagógicas
      "P-007": "fas fa-leaf text-success",                       // Ambiental
      "P-008": "fas fa-language text-primary",                   // Lingüística
      "P-009": "fas fa-users text-info",                         // Inclusiva e Intercultural (PESII)
      "P-010": "fas fa-heart text-primary",                       // Bienestar Universitario
      "P-011": "fas fa-user-graduate text-warning",               // Egresados
      "P-012": "fas fa-globe-americas text-primary",              // Internacionalización
      "P-013": "fas fa-user-tie text-dark",                       // Gestión Estratégica de Talento Humano
      "P-014": "fas fa-award text-warning",                       // Incentivos y Estímulos del Personal
      "P-015": "fas fa-chart-bar text-success",                   // Gestión de la Información Estadística
      "P-016": "fas fa-balance-scale text-danger",                 // Transparencia y Lucha contra la Corrupción
      "P-017": "fas fa-headset text-info",                        // Atención al Ciudadano
      "P-018": "fas fa-archive text-secondary",                   // Gestión Documental
      "P-019": "fas fa-tools text-dark",                          // Mantenimiento y Renovación de Infraestructura
      "P-020": "fas fa-handshake text-success",                   // Integridad
      "P-021": "fas fa-hands-helping text-primary"                 // Proyección Social
    };

    get(ref(db, "PolariScore/politicas"))
      .then((snapshot) => {
        if (snapshot.exists()) {
          const politicas = snapshot.val();

          let totalPoliticas = 0;
          let totalObjetivos = 0;
          let totalAcciones = 0;

          const ulPoliticas = document.getElementById('cargarPoliticas');
          ulPoliticas.innerHTML = "";

          for (const idPolitica in politicas) {
            totalPoliticas++;
            const politica = politicas[idPolitica];
            const nombrePolitica = politica.titulo || "Sin nombre";

            // Obtener el icono o usar uno por defecto
            const icono = iconosPoliticas[idPolitica] || "fas fa-file-alt text-secondary";

            const li = document.createElement("li");
            li.className = "nav-item";

            li.innerHTML = `
                  <a class="nav-link ${idPolitica === window.politica_id ? 'active' : ''} d-flex align-items-center" 
                    href="#" 
                    title="${nombrePolitica}" 
                    data-id="${idPolitica}">
                    <i class="${icono} me-2"></i> 
                    ${limitarTexto(nombrePolitica, 23)}
                  </a>
                `;

            li.querySelector("a").addEventListener("click", (e) => {
              e.preventDefault();
              window.location.href = `politica.html?id=${idPolitica}`;
            });

            ulPoliticas.appendChild(li);
          }
        }

      });

    function mostrarLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
    }

    function ocultarLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
    }

    // Función para redirigir usando un elemento <a>
    function redirigirConElementoA(url) {
      const a = document.createElement('a');
      a.href = url;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    async function configurarBotonesNavegacionPoliticas() {
      const id = new URLSearchParams(window.location.search).get('id');
      if (!id) return;

      let todasLasPoliticas = JSON.parse(localStorage.getItem('lista_politicas_unitropico'));

      // Si no hay lista en cache, traer de Firebase
      if (!todasLasPoliticas || !Array.isArray(todasLasPoliticas)) {
        const snapshot = await get(dbRef);
        if (!snapshot.exists()) return;

        todasLasPoliticas = Object.keys(snapshot.val()).sort();
        localStorage.setItem('lista_politicas_unitropico', JSON.stringify(todasLasPoliticas));
      }

      const posicionActual = todasLasPoliticas.indexOf(id);
      if (posicionActual === -1) return; // Por si alguien pone un ID inexistente

      const idAnterior = posicionActual > 0 ? todasLasPoliticas[posicionActual - 1] : null;
      const idSiguiente = posicionActual < todasLasPoliticas.length - 1 ? todasLasPoliticas[posicionActual + 1] : null;

      const anteriorBtn = document.getElementById('anteriorBtn');
      const siguienteBtn = document.getElementById('siguienteBtn');

      anteriorBtn.classList.toggle('disabled', !idAnterior);
      siguienteBtn.classList.toggle('disabled', !idSiguiente);

      anteriorBtn.onclick = (e) => {
        e.preventDefault();
        if (idAnterior) {
          mostrarLoading();
          redirigirConElementoA(`politica.html?id=${idAnterior}`);
        }
      };

      siguienteBtn.onclick = (e) => {
        e.preventDefault();
        if (idSiguiente) {
          mostrarLoading();
          redirigirConElementoA(`politica.html?id=${idSiguiente}`);
        }
      };
      document.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowLeft') {
          const anteriorBtn = document.getElementById('anteriorBtn');
          if (anteriorBtn && !anteriorBtn.classList.contains('disabled')) {
            anteriorBtn.click();
          }
        }

        if (event.key === 'ArrowRight') {
          const siguienteBtn = document.getElementById('siguienteBtn');
          if (siguienteBtn && !siguienteBtn.classList.contains('disabled')) {
            siguienteBtn.click();
          }
        }
      });

    }

    // Llamar después de cargar el DOM
    document.addEventListener('DOMContentLoaded', () => {
      configurarBotonesNavegacionPoliticas();
    });





    function exportarGrafica(idCanvas, nombreArchivo = "grafica.png", scaleFactor = 4, fondo = "#ffffff") {
      const canvas = document.getElementById(idCanvas);
      if (!canvas) {
        console.error("El canvas no se encontró.");
        return;
      }

      const canvasExport = document.createElement("canvas");
      const ctxExport = canvasExport.getContext("2d");

      const width = canvas.width;
      const height = canvas.height;

      // Aumentar resolución real
      canvasExport.width = width * scaleFactor;
      canvasExport.height = height * scaleFactor;

      canvasExport.style.width = width + "px";
      canvasExport.style.height = height + "px";

      // Fondo (opcional: blanco o transparente)
      ctxExport.fillStyle = fondo;
      ctxExport.fillRect(0, 0, canvasExport.width, canvasExport.height);

      // Mejorar calidad de imagen al escalar
      ctxExport.imageSmoothingEnabled = true;
      ctxExport.imageSmoothingQuality = "high";

      // Escalar para mantener proporciones
      ctxExport.scale(scaleFactor, scaleFactor);

      // Dibujar imagen original
      ctxExport.drawImage(canvas, 0, 0);

      // Generar imagen en PNG
      const imagen = canvasExport.toDataURL("image/png", 1.0);

      const link = document.createElement("a");
      link.href = imagen;
      link.download = nombreArchivo;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    window.exportarGrafica = exportarGrafica;

    function limitarTexto(texto, limite) {
      return texto.length > limite ? texto.substring(0, limite) + "..." : texto;
    }

    const ejecutadosSnapshot = await get(ref(db, `PolariScore/seguimientos`));
    const ejecutadosData = ejecutadosSnapshot.exists() ? ejecutadosSnapshot.val() : {};
    window.ejecutadosData = ejecutadosData;



    async function cargarAccionesConCumplimiento(idPolitica, fechaInicioPolitica) {
      const db = getDatabase();
      const auth = getAuth(); // ya importado
      const politicasRef = ref(db, `PolariScore/politicas/${idPolitica}`);

      const sanitizeEmail = (email) => String(email || '').replace(/\./g, '_');

      try {
        const snapshot = await get(politicasRef);
        const politica = snapshot.val() || {};

        document.getElementById('page_title').textContent = politica.titulo || '';
        document.getElementById('titulo_politica').textContent = politica.titulo || '';
        document.getElementById('tituloInforme').textContent = politica.titulo || '';
        document.getElementById('objetivo_general').textContent = politica.objetivo_general || '';
        document.getElementById('objetivo_general_pdf').textContent = politica.objetivo_general || '';

        // === Checkbox de suscripción + label ===
        const $chk = document.getElementById('chkSubPolitica');
        const $lbl = document.getElementById('estadoSuscrito');
        if ($chk) {
          // estado base
          $chk.checked = false;
          $chk.disabled = true;
          if ($lbl) $lbl.textContent = "Suscribirme a la política";

          // si no hay sesión, redirige al tocar el switch
          const handleNoSessionClick = () => (window.location.href = "../pages/sign-in.html");
          $chk.addEventListener("click", handleNoSessionClick, { once: true });

          onAuthStateChanged(auth, async (user) => {
            if (!user) return; // sin sesión: queda bloqueado y con label por defecto

            // hay usuario: habilita y quita el listener de redirección
            $chk.disabled = false;
            $chk.removeEventListener("click", handleNoSessionClick);

            const correoSan = sanitizeEmail(user.email);
            const pathSus = `usuarios/${correoSan}/PolariScore/politicas-suscritas`;
            const susRef = ref(db, pathSus);

            // helper: normalizar valor de RTDB a array de ids
            const normalizeSubs = (v) => {
              if (Array.isArray(v)) return [...new Set(v.map(x => String(x || '').trim()).filter(Boolean))];
              if (v && typeof v === 'object') return Object.values(v).map(x => String(x || '').trim()).filter(Boolean);
              return [];
            };

            try {
              // estado inicial desde RTDB
              const susSnap = await get(susRef);
              const ids = normalizeSubs(susSnap.val());
              const suscrito = ids.includes(idPolitica);

              $chk.checked = suscrito;
              if ($lbl) $lbl.textContent = suscrito ? "Suscrito" : "Suscribirme a la política";
            } catch (e) {
              console.warn('[suscripción] No se pudo leer suscripciones:', e);
              $chk.checked = false;
              if ($lbl) $lbl.textContent = "Suscribirme a la política";
            }

            // handler de toggle (sin {once:true} para permitir múltiples cambios)
            $chk.addEventListener('change', async function () {
              try {
                // leer estado actual
                const snap = await get(susRef);
                let ids = normalizeSubs(snap.val());

                if (this.checked) {
                  if (!ids.includes(idPolitica)) ids.push(idPolitica);
                } else {
                  ids = ids.filter(x => x !== idPolitica);
                }

                // guardar de vuelta como array
                await set(susRef, ids);

                // actualizar label
                if ($lbl) $lbl.textContent = this.checked ? "Suscrito" : "Suscribirme a la política";
              } catch (err) {
                console.error('[suscripción] Error al actualizar:', err);
                // revertir UI si falló
                this.checked = !this.checked;
                if ($lbl) $lbl.textContent = this.checked ? "Suscrito" : "Suscribirme a la política";
              }
            });
          });
        }

        aplicarFondoPolitica(politica.imgUrl);


        // 🔹 Total Acciones Completadas
        const accionesPorFecha = politica.total_acciones_completadas || {};
        const fechasAcciones = Object.keys(accionesPorFecha);

        if (fechasAcciones.length > 0) {
          const fechasAccionesOrdenadas = fechasAcciones.sort((a, b) => {
            const [da, ma, ya] = a.split('-').map(Number);
            const [db, mb, yb] = b.split('-').map(Number);
            return new Date(yb, mb - 1, db) - new Date(ya, ma - 1, da);
          });

          const ultimaFechaAcciones = fechasAccionesOrdenadas[0];
          const totalAcciones = accionesPorFecha[ultimaFechaAcciones]?.total ?? 0;

          totalAccionesCompletadas.textContent = totalAcciones;
          totalAccionesCompletadas_pdf.textContent = totalAcciones;

        } else {
          totalAccionesCompletadas.textContent = '0';
        }

        // 🔹 Total Evidencias
        const evidenciasPorFecha = politica.total_evidencias || {};
        const fechasEvidencias = Object.keys(evidenciasPorFecha);

        if (fechasEvidencias.length > 0) {
          const fechasEvidenciasOrdenadas = fechasEvidencias.sort((a, b) => {
            const [da, ma, ya] = a.split('-').map(Number);
            const [db, mb, yb] = b.split('-').map(Number);
            return new Date(yb, mb - 1, db) - new Date(ya, ma - 1, da);
          });

          const ultimaFechaEvidencias = fechasEvidenciasOrdenadas[0];
          const totalEvidenciasValor = evidenciasPorFecha[ultimaFechaEvidencias]?.total ?? 0;
          totalEvidencias.textContent = totalEvidenciasValor;
          totalEvidencias_pdf.textContent = totalEvidenciasValor;

        } else {
          totalEvidencias.textContent = '0';
        }


        // Llama a la función para crear la gráfica de torta por objetivos
        createChartByObjectives(politica);

        generarGraficaCumplimientoPorAniosPolitica(idPolitica, fechaInicioPolitica);
        generarGraficaCurvaSPolitica(idPolitica, fechaInicioPolitica);

        const acciones = [];

        const objetivos = Object.values(politica.objetivos_especificos || {});
        totalObjetivos.textContent = objetivos.length;
        totalObjetivos_pdf.textContent = objetivos.length;
        objetivos.forEach(objetivo => {
          const accionesObjetivo = objetivo.acciones || {};
          for (const key in accionesObjetivo) {
            acciones.push(accionesObjetivo[key]);
          }
        });


        totalAcciones.textContent = acciones.length;
        totalAcciones_pdf.textContent = acciones.length;



        const anioInicio = fechaInicioPolitica.includes('/')
          ? parseInt(fechaInicioPolitica.split('/')[2])
          : new Date(fechaInicioPolitica).getFullYear();




        // Obtener fecha de hoy en formato yyyy-mm-dd
        const hoy = new Date();
        const fechaHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;

        for (const accion of acciones) {
          const idAccion = accion.id_accion;
          if (!idAccion) continue;

          // 🔍 Evidencias
          try {
            const evidenciasSnapshot = await get(ref(db, `PolariScore/evidencias/${idAccion}`));
            if (evidenciasSnapshot.exists()) {
              const data = evidenciasSnapshot.val();
              const evidenciasKeys = Object.keys(data).filter(key => key !== 'cantidad_evidencias');
              const cantidad = evidenciasKeys.length;
              cantidadEvidencias += cantidad;
            }
          } catch (error) {
            console.error(`❌ Error al consultar evidencias de ${idAccion}:`, error);
          }

          // 📊 Acciones completadas
          try {
            const cumplimiento = await calcularCumplimientoAccion(accion, anioInicio);
            const progreso = parseFloat(cumplimiento.toFixed(2));

            if (progreso >= 99.5) {
              cantidadAccionesCompletadas += 1;

              // Registrar acción completada en histórico (opcional)
              const seguimientoRef = ref(db, `PolariScore/seguimientos/${idAccion}/${fechaHoy}`);
              await update(seguimientoRef, {
                total_acciones_completadas: 1
              });
            }
          } catch (error) {
            console.error(`❌ Error al calcular cumplimiento de ${idAccion}:`, error);
          }
        }

        // ✅ Obtener la fecha actual en formato dd-mm-aaaa
        const dia = String(hoy.getDate()).padStart(2, '0');
        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
        const anio = hoy.getFullYear();
        const fechaFormateada = `${dia}-${mes}-${anio}`;

        // ✅ Guardar totales en Firebase
        await update(ref(db, `PolariScore/politicas/${idPolitica}`), {
          [`total_evidencias/${fechaFormateada}/total`]: cantidadEvidencias,
          [`total_acciones_completadas/${fechaFormateada}/total`]: cantidadAccionesCompletadas
        });


      } catch (error) {
        console.error("❌ Error al cargar las acciones:", error);
        mostrarToast("Error al cargar las acciones", "danger");
        aplicarFondoPolitica('');
      }
    }

    (function bindCambioFotoPolitica() {
      const btn = document.getElementById('btnCambiarFotoPolitica');
      const file = document.getElementById('fileFotoPolitica');
      if (!btn || !file) return;

      btn.addEventListener('click', () => file.click());
      file.addEventListener('change', async (ev) => {
        const f = ev.target.files?.[0];
        if (!f) return;

        const tmpUrl = URL.createObjectURL(f);
        aplicarFondoPolitica(tmpUrl);  // previsualiza

        try {
          // si tienes una función para subir y obtener URL final:
          // const finalUrl = await window.subirFotoPolitica(f);
          // aplicarFondoPolitica(finalUrl);
        } finally {
          setTimeout(() => URL.revokeObjectURL(tmpUrl), 1500);
        }
      });
    })();


    /**
     * Aplica la imagen de fondo (con blur) a #politicaContainer usando una CSS var.
     * Hace pre-carga y usa fallback si falla.
     * @param {string} url - URL de la imagen final (https, dataURL o relativa).
     * @param {string} [fallback='../assets/img/polariscore/P-001.png']
     */
    function aplicarFondoPolitica(url, fallback = '../assets/img/polariscore/P-001.png') {
      const cont = document.getElementById('politicaContainer');
      if (!cont) return;

      const finalUrl = (typeof url === 'string' && url.trim()) ? url.trim() : fallback;

      // Preload para evitar parpadeos y setear solo si carga bien
      const img = new Image();
      img.onload = () => {
        cont.style.setProperty('--bg-url', `url('${finalUrl.replace(/'/g, "\\'")}')`);
      };
      img.onerror = () => {
        cont.style.setProperty('--bg-url', `url('${fallback.replace(/'/g, "\\'")}')`);
      };
      img.src = finalUrl;
    }


    // Función para asignar colores a la barra de progreso
    function getColorClase(porcentaje) {
      if (porcentaje <= 29) return "bg-gradient-danger";
      if (porcentaje <= 60) return "bg-gradient-warning";
      if (porcentaje <= 99.9) return "bg-gradient-info";
      return "bg-gradient-success";
    }

    document.querySelectorAll(".sort-icon").forEach(icon => {
      icon.addEventListener("click", () => {
        const sortKey = icon.dataset.sort;
        const order = icon.dataset.order;

        accionesData.sort((a, b) => {
          if (typeof a[sortKey] === "string") {
            return order === "asc"
              ? a[sortKey].localeCompare(b[sortKey])
              : b[sortKey].localeCompare(a[sortKey]);
          } else {
            return order === "asc" ? a[sortKey] - b[sortKey] : b[sortKey] - a[sortKey];
          }
        });


      });
    });

    async function generarGraficaCumplimientoPorAniosPolitica(idPolitica, fechaInicioPolitica) {
      const db = getDatabase();

      const [ejecutadosSnapshot, politicaSnapshot] = await Promise.all([
        get(ref(db, `PolariScore/seguimientos`)),
        get(ref(db, `PolariScore/politicas/${idPolitica}`))
      ]);

      if (!politicaSnapshot.exists()) {
        console.error("❌ No existe la política.");
        return;
      }

      const ejecutadosData = ejecutadosSnapshot.exists() ? ejecutadosSnapshot.val() : {};
      const politica = politicaSnapshot.val();

      const anioInicio = fechaInicioPolitica.includes('/')
        ? parseInt(fechaInicioPolitica.split('/')[2])
        : new Date(fechaInicioPolitica).getFullYear();

      const labels = [];
      const dataCumplieron = [];
      const dataProgramadas = [];
      const dataBajo = [];
      const dataMuyBajo = [];
      const dataAceptable = [];
      const dataOptimo = [];

      for (let i = 0; i < 6; i++) {
        const anio = anioInicio + i;
        let totalCumplieron = 0;
        let totalProgramadas = 0;

        Object.values(politica.objetivos_especificos || {}).forEach(objetivo => {
          Object.values(objetivo.acciones || {}).forEach(accion => {
            const ejecutadoAnio = ejecutadosData[accion.id_accion]?.ejecutado?.[anio] || 0;
            const programadoAnio = parseFloat(accion.anios?.[i] || 0);

            if (programadoAnio > 0) {
              totalProgramadas++;
              if (ejecutadoAnio >= programadoAnio) {
                totalCumplieron++;
              }
            }
          });
        });




        labels.push(anio.toString());
        dataCumplieron.push(totalCumplieron);
        dataProgramadas.push(totalProgramadas);

        // Curva S proporcional
        dataMuyBajo.push(Math.floor(totalProgramadas * 0.5));     // 50% Muy Bajo
        dataBajo.push(Math.floor(totalProgramadas * 0.80));       // 80% Bajo 
        dataAceptable.push(Math.floor(totalProgramadas * 0.99));  // 99% Aceptable
        dataOptimo.push(totalProgramadas);                        // 100% Óptimo
      }

      function cortarDataEnCerosConsecutivos(data) {
        let corteIndex = data.length; // Por defecto no corta

        for (let i = 0; i < data.length - 1; i++) {
          if (data[i] === 0 && data[i + 1] === 0) {
            const hayValoresPosteriores = data.slice(i + 2).some(v => v !== 0);

            if (!hayValoresPosteriores) {
              // Corta en el nodo anterior al primer 0
              corteIndex = i - 1 >= 0 ? i - 1 : 0;
              break;
            }
          }
        }

        return data.slice(0, corteIndex + 1);
      }


      const dataCumplieronFinal = cortarDataEnCerosConsecutivos(dataCumplieron);

      const ctx = document.getElementById('grafica_cumplimiento_anios').getContext('2d');

      const ctx2 = document.getElementById('grafica_cumplimiento_anios_pdf').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Óptimo',
              data: Array(labels.length).fill(Math.max(...dataProgramadas) + 3),
              fill: true,
              backgroundColor: 'rgba(0, 89, 78, 0.4)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 9
            },
            {
              label: 'Aceptable',
              data: dataAceptable,
              fill: true,
              backgroundColor: 'rgba(255, 250, 164, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 4
            },
            {
              label: 'Muy Bajo',
              data: dataMuyBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 3
            },
            {
              label: 'Bajo',
              data: dataBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.7)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 3
            },
            {
              label: 'Acciones Programadas',
              data: dataProgramadas,
              borderColor: '#b5a160',
              backgroundColor: 'rgba(181, 161, 96, 0.2)',
              borderWidth: 2,
              borderDash: [5, 5], // 👈 Línea punteada (5px línea, 5px espacio)
              fill: false,
              tension: 0.3,
              stepped: false,
              order: 2
            }
            ,
            {
              label: 'Acciones Ejecutadas por Completo',
              data: dataCumplieronFinal,
              borderColor: '#00594e',
              backgroundColor: 'rgba(0, 89, 78, 0.2)',
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              stepped: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              offset: true,
              grid: {
                z: 6 // 👈 Cuadrícula sobre los rellenos, debajo de las líneas
              }
            },
            y: {
              beginAtZero: true,
              max: Math.max(...dataProgramadas) + 3,
              ticks: {
                precision: 0
              },
              grid: {
                z: 6 // 👈 Igual aquí
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                generateLabels: function (chart) {
                  const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                  const semaforo = [];
                  const datos = [];

                  original.forEach(item => {
                    if (['Muy Bajo', 'Bajo', 'Aceptable', 'Óptimo'].includes(item.text)) {
                      semaforo.push(item);
                    } else {
                      datos.push(item);
                    }
                  });

                  // Agregamos separadores visuales (leyenda sin punto)
                  if (semaforo.length > 0) {
                    semaforo.unshift({
                      text: '--- SEMÁFORO ---',
                      fillStyle: 'transparent',
                      strokeStyle: 'transparent',
                      hidden: true,
                      datasetIndex: -1,
                      lineWidth: 0,
                      pointStyle: 'line'
                    });
                  }

                  if (datos.length > 0) {
                    datos.unshift({
                      text: '--- DATOS ---',
                      fillStyle: 'transparent',
                      strokeStyle: 'transparent',
                      hidden: true,

                      lineWidth: 0,
                      pointStyle: 'line'
                    });
                  }

                  return [...datos, ...semaforo];
                },
                filter: function (item) {
                  // Oculta el punto de la línea separadora
                  return item.text !== '--- SEMÁFORO ---' && item.text !== '--- DATOS ---';
                }
              },
              onClick: (e, legendItem, legend) => {
                const legendText = legendItem.text;
                if (
                  ['Muy Bajo', 'Bajo', 'Aceptable', 'Óptimo', '--- SEMÁFORO ---', '--- DATOS ---'].includes(legendText)
                ) {
                  return; // Bloquea clic en regiones de semáforo y separadores
                }

                const ci = legend.chart;
                const index = legendItem.datasetIndex;
                ci.toggleDataVisibility(index);
                ci.update();
              }
            },
            tooltip: {
              callbacks: {
                label: context => `${context.dataset.label}: ${context.parsed.y}`
              }
            }
          }

        }
      });

      new Chart(ctx2, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Óptimo',
              data: Array(labels.length).fill(Math.max(...dataProgramadas) + 3),
              fill: true,
              backgroundColor: 'rgba(0, 89, 78, 0.4)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 9
            },
            {
              label: 'Aceptable',
              data: dataAceptable,
              fill: true,
              backgroundColor: 'rgba(255, 250, 164, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 4
            },
            {
              label: 'Muy Bajo',
              data: dataMuyBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 3
            },
            {
              label: 'Bajo',
              data: dataBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.7)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 3
            },
            {
              label: 'Acciones Programadas',
              data: dataProgramadas,
              borderColor: '#b5a160',
              backgroundColor: 'rgba(181, 161, 96, 0.2)',
              borderWidth: 2,
              borderDash: [5, 5], // 👈 Línea punteada (5px línea, 5px espacio)
              fill: false,
              tension: 0.3,
              stepped: false,
              order: 2
            }
            ,
            {
              label: 'Acciones Ejecutadas por Completo',
              data: dataCumplieronFinal,
              borderColor: '#00594e',
              backgroundColor: 'rgba(0, 89, 78, 0.2)',
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              stepped: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              offset: true,
              grid: {
                z: 6 // 👈 Cuadrícula sobre los rellenos, debajo de las líneas
              }
            },
            y: {
              beginAtZero: true,
              max: Math.max(...dataProgramadas) + 3,
              ticks: {
                precision: 0
              },
              grid: {
                z: 6 // 👈 Igual aquí
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                generateLabels: function (chart) {
                  const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                  const semaforo = [];
                  const datos = [];

                  original.forEach(item => {
                    if (['Muy Bajo', 'Bajo', 'Aceptable', 'Óptimo'].includes(item.text)) {
                      semaforo.push(item);
                    } else {
                      datos.push(item);
                    }
                  });

                  // Agregamos separadores visuales (leyenda sin punto)
                  if (semaforo.length > 0) {
                    semaforo.unshift({
                      text: '--- SEMÁFORO ---',
                      fillStyle: 'transparent',
                      strokeStyle: 'transparent',
                      hidden: true,
                      datasetIndex: -1,
                      lineWidth: 0,
                      pointStyle: 'line'
                    });
                  }

                  if (datos.length > 0) {
                    datos.unshift({
                      text: '--- DATOS ---',
                      fillStyle: 'transparent',
                      strokeStyle: 'transparent',
                      hidden: true,

                      lineWidth: 0,
                      pointStyle: 'line'
                    });
                  }

                  return [...datos, ...semaforo];
                },
                filter: function (item) {
                  // Oculta el punto de la línea separadora
                  return item.text !== '--- SEMÁFORO ---' && item.text !== '--- DATOS ---';
                }
              },
              onClick: (e, legendItem, legend) => {
                const legendText = legendItem.text;
                if (
                  ['Muy Bajo', 'Bajo', 'Aceptable', 'Óptimo', '--- SEMÁFORO ---', '--- DATOS ---'].includes(legendText)
                ) {
                  return; // Bloquea clic en regiones de semáforo y separadores
                }

                const ci = legend.chart;
                const index = legendItem.datasetIndex;
                ci.toggleDataVisibility(index);
                ci.update();
              }
            },
            tooltip: {
              callbacks: {
                label: context => `${context.dataset.label}: ${context.parsed.y}`
              }
            }
          }

        }
      });


    }


    function cortarDataEnCerosConsecutivos(data) {
      let corteIndex = data.length; // Por defecto no corta
      let hayValoresPosteriores = false;

      for (let i = 0; i < data.length - 1; i++) {
        if (data[i] === 0 && data[i + 1] === 0) {
          // Verificar si después existe algún número distinto de 0
          hayValoresPosteriores = data.slice(i + 2).some(v => v !== 0);
          if (!hayValoresPosteriores) {
            corteIndex = i; // Detenerse justo antes del primer 0
            break;
          }
        }
      }

      return data.slice(0, corteIndex + 1); // +1 para incluir el último valor antes del corte
    }


    async function generarGraficaCurvaSPolitica(idPolitica, fechaInicioPolitica) {
      const db = getDatabase();

      const [ejecutadosSnapshot, politicaSnapshot] = await Promise.all([
        get(ref(db, `PolariScore/seguimientos`)),
        get(ref(db, `PolariScore/politicas/${idPolitica}`))
      ]);

      if (!politicaSnapshot.exists()) {
        console.error("❌ No existe la política.");
        return;
      }

      const ejecutadosData = ejecutadosSnapshot.exists() ? ejecutadosSnapshot.val() : {};
      const politica = politicaSnapshot.val();

      const anioInicio = fechaInicioPolitica.includes('/')
        ? parseInt(fechaInicioPolitica.split('/')[2])
        : new Date(fechaInicioPolitica).getFullYear();

      const labels = [];
      const dataCumplimientoPolitica = [];
      const dataProgramadas = [];
      const dataMuyBajo = [];
      const dataBajo = [];
      const dataAceptable = [];
      const dataOptimo = [];
      const dataProgramadoPolitica = [];

      for (let i = 0; i < 6; i++) {
        const anio = anioInicio + i;
        let cumplimientoAnio = 0;
        let programadoAnioTotal = 0;

        Object.values(politica.objetivos_especificos || {}).forEach(objetivo => {
          Object.values(objetivo.acciones || {}).forEach(accion => {
            const ejecutadoAnio = parseFloat(ejecutadosData[accion.id_accion]?.ejecutado?.[anio] || 0);
            const programadoAnio = parseFloat(accion.anios?.[i] || 0);
            const importanciaAccion = parseFloat(accion.importancia_accion || 0);

            if (programadoAnio > 0) {
              const avanceReal = (ejecutadoAnio / programadoAnio) * importanciaAccion;
              const avanceProgramado = importanciaAccion;

              cumplimientoAnio += Math.min(avanceReal, importanciaAccion);
              programadoAnioTotal += avanceProgramado;
            }
          });
        });

        cumplimientoAnio = Math.min(cumplimientoAnio, 1) * 100;
        programadoAnioTotal = Math.min(programadoAnioTotal, 1) * 100;

        labels.push(anio.toString());
        dataCumplimientoPolitica.push(parseFloat(cumplimientoAnio.toFixed(2)));
        dataProgramadoPolitica.push(parseFloat(programadoAnioTotal.toFixed(2)));

        // Curva S proporcional
        dataMuyBajo.push(Math.floor(programadoAnioTotal * 0.5));     // 50% Muy Bajo
        dataBajo.push(Math.floor(programadoAnioTotal * 0.80));       // 80% Bajo 
        dataAceptable.push(Math.floor(programadoAnioTotal * 0.99));  // 99% Aceptable
        dataOptimo.push(programadoAnioTotal);                        // 100% Óptimo
      }

      const dataCumplimientoFinal = cortarDataEjecutadoEnCerosConsecutivos(dataCumplimientoPolitica);

      function cortarDataEjecutadoEnCerosConsecutivos(data) {
        let corteIndex = data.length;

        for (let i = 0; i < data.length - 1; i++) {
          if (data[i] === 0 && data[i + 1] === 0) {
            // Verificar si hay valores mayores a 0 después de este punto
            const hayValoresPosteriores = data.slice(i + 2).some(v => v > 0);

            if (!hayValoresPosteriores) {
              // Buscar el último índice antes de los ceros que fue > 0
              for (let j = i - 1; j >= 0; j--) {
                if (data[j] > 0) {
                  corteIndex = j + 1; // Cortar hasta este punto
                  break;
                }
              }
              break;
            }
          }
        }

        return data.slice(0, corteIndex);
      }


      const ctx = document.getElementById('grafica_curva_s').getContext('2d');
      const ctx2 = document.getElementById('grafica_curva_s_pdf').getContext('2d');


      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Óptimo',
              data: Array(labels.length).fill(150),
              fill: true,
              backgroundColor: 'rgba(0, 89, 78, 0.3)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 9
            },
            {
              label: 'Aceptable',
              data: dataAceptable,
              fill: true,
              backgroundColor: 'rgba(255, 250, 164, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 5
            },
            {
              label: 'Muy Bajo',
              data: dataMuyBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 3
            },
            {
              label: 'Bajo',
              data: dataBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.7)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 4
            },
            {
              label: 'Programado %',
              data: dataProgramadoPolitica,
              borderColor: '#b5a160',
              backgroundColor: 'rgba(181, 161, 96, 0.2)',
              borderWidth: 2,
              fill: false,

              tension: 0.2,
              stepped: false,
              order: 2
            },
            {
              label: 'Ejecutado %',
              data: dataCumplimientoFinal,
              borderColor: '#00594e',
              backgroundColor: 'rgba(0, 89, 78, 0.2)',
              borderWidth: 2,
              fill: false,
              tension: 0.4,
              stepped: false,
              order: 1
            }
          ]

        },
        options: {
          responsive: true,
          scales: {
            x: {
              offset: true,
              grid: {
                z: 6
              }
            },

            y: {
              beginAtZero: true,
              min: 0,
              max: 140,
              ticks: {
                callback: function (value) { return value + '%' },
                precision: 0
              },
              grid: {
                z: 6 // 👈 Esto lo pone por encima de los fondos (orden 3-5) pero debajo de Programado/Ejecutado (orden 1-2)
              }
            }

          },
          plugins: {
            legend: {
              position: 'top',
              onClick: (e, legendItem, legend) => {
                const legendText = legendItem.text;
                if (legendText === 'Bajo' || legendText === 'Aceptable' || legendText === 'Óptimo') {
                  return;
                }
                const ci = legend.chart;
                const index = legendItem.datasetIndex;
                ci.toggleDataVisibility(index);
                ci.update();
              }
            },
            tooltip: {
              callbacks: {
                label: context => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
              }
            }
          }
        }
      });

      new Chart(ctx2, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Óptimo',
              data: Array(labels.length).fill(150),
              fill: true,
              backgroundColor: 'rgba(0, 89, 78, 0.3)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 9
            },
            {
              label: 'Aceptable',
              data: dataAceptable,
              fill: true,
              backgroundColor: 'rgba(255, 250, 164, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 5
            },
            {
              label: 'Muy Bajo',
              data: dataMuyBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.9)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 3
            },
            {
              label: 'Bajo',
              data: dataBajo,
              fill: true,
              backgroundColor: 'rgba(255, 143, 119, 0.7)',
              borderColor: 'transparent',
              pointRadius: 0,
              order: 4
            },
            {
              label: 'Programado %',
              data: dataProgramadoPolitica,
              borderColor: '#b5a160',
              backgroundColor: 'rgba(181, 161, 96, 0.2)',
              borderWidth: 2,
              fill: false,

              tension: 0.2,
              stepped: false,
              order: 2
            },
            {
              label: 'Ejecutado %',
              data: dataCumplimientoFinal,
              borderColor: '#00594e',
              backgroundColor: 'rgba(0, 89, 78, 0.2)',
              borderWidth: 2,
              fill: false,
              tension: 0.4,
              stepped: false,
              order: 1
            }
          ]

        },
        options: {
          responsive: true,
          scales: {
            x: {
              offset: true,
              grid: {
                z: 6
              }
            },

            y: {
              beginAtZero: true,
              min: 0,
              max: 140,
              ticks: {
                callback: function (value) { return value + '%' },
                precision: 0
              },
              grid: {
                z: 6 // 👈 Esto lo pone por encima de los fondos (orden 3-5) pero debajo de Programado/Ejecutado (orden 1-2)
              }
            }

          },
          plugins: {
            legend: {
              position: 'top',
              onClick: (e, legendItem, legend) => {
                const legendText = legendItem.text;
                if (legendText === 'Bajo' || legendText === 'Aceptable' || legendText === 'Óptimo') {
                  return;
                }
                const ci = legend.chart;
                const index = legendItem.datasetIndex;
                ci.toggleDataVisibility(index);
                ci.update();
              }
            },
            tooltip: {
              callbacks: {
                label: context => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
              }
            }
          }
        }
      });

    }


    function iniciarGaugeAvance(
      valorFinal,
      {
        fondoURL = 'https://sigunitropico.com/wp-content/uploads/2025/09/Identidad-Visual-PlanItOne-21-1.png',
        altura = 320
      } = {}
    ) {
      const dom = document.getElementById('grafica_cumplimiento_Politica');
      if (!dom) {
        console.error('Error: no se encontró el contenedor con id "grafica_cumplimiento_Politica".');
        return;
      }

      // Altura mínima para que sea visible
      dom.style.height = typeof altura === 'number' ? `${altura}px` : altura;

      // Limpia el listener de resize previo si existiera
      if (dom._onGaugeResize) {
        window.removeEventListener('resize', dom._onGaugeResize);
        dom._onGaugeResize = null;
      }

      // Re-inicializa limpiamente si ya existe una instancia
      const previa = echarts.getInstanceByDom(dom);
      if (previa) previa.dispose();

      const chart = echarts.init(dom);

      const avanceReal = Math.max(0, Math.min(100, Number(valorFinal) || 0));

      const getBgSize = () => {
        const w = dom.clientWidth || 380;
        const h = dom.clientHeight || w;
        return Math.floor(Math.min(w, h) * 0.80); // 80% del lado menor
      };
      let bgSize = getBgSize();

      const option = {
        tooltip: {
          trigger: 'item',
          backgroundColor: '#fff',
          borderColor: '#B5A160',
          borderWidth: 1,
          textStyle: { color: '#00594E', fontWeight: 'bold' },
          formatter: (p) => `<b>${(p.value ?? 0).toFixed(2)}%</b>`
        },

        
        graphic: [{
          id: 'bg',
          type: 'image',
          left: 'center',
          top: 'middle',
          z: -2,
          silent: true,
          style: {
            image: fondoURL,
            width: bgSize,
            height: bgSize,
            opacity: 0.9
          }
        }],

        series: [{
          name: '',
          type: 'gauge',
          radius: '100%',
          startAngle: 90,
          endAngle: -270, // anillo completo

          // Anillo base (fondo)
          axisLine: {
            lineStyle: {
              width: 18,
              color: [[1, '#d3d3d3']]
            }
          },

          // Sin marcas/labels ni puntero
          splitLine: { show: false },
          axisTick: { show: false },
          axisLabel: { show: false },
          pointer: { show: false },

          // Progreso con gradiente
          progress: {
            show: true,
            roundCap: true,
            width: 18,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0.00, color: '#0cc0df' },
                { offset: 1.00, color: '#ffde59' }
              ])
            }
          },

          // Título y detalle al centro
          title: {
            show: true,
            offsetCenter: [0, '20%'],
            color: '#ffffff',
            fontSize: 14,
            fontWeight: 600
          },
          detail: {
            valueAnimation: true,
            formatter: (v) => `${(v ?? 0).toFixed(2)}%`,
            color: '#ffffff',
            fontSize: 28,
            fontWeight: 'bold',
            offsetCenter: [0, '46%']
          },

          // Arranca en 0 para animar
          data: [{ value: 0, name: '' }]
        }],

        animationDuration: 1200,
        animationEasing: 'cubicOut'
      };

      chart.setOption(option);

      // Anima hasta el valor real
      setTimeout(() => {
        chart.setOption({
          series: [{ data: [{ value: avanceReal, name: '' }] }]
        });
      }, 400);

      // Ajuste responsivo (incluye redimensionar la imagen de fondo)
      const onResize = () => {
        bgSize = getBgSize();
        chart.setOption({ graphic: [{ id: 'bg', style: { width: bgSize, height: bgSize } }] });
        chart.resize();
      };
      window.addEventListener('resize', onResize, { passive: true });
      dom._onGaugeResize = onResize; // guarda referencia para poder limpiarla en reinicios
    }

    // Variables globales asignadas a window para asegurar su accesibilidad
    window.labelsAnios = [];
    window.aniosSegumiento = [];


    function computeProgress(yearValue, divisor, tipo) {
      if (divisor === 0) {
        return 0;
      }
      let result;
      if (tipo === "porcentaje") {
        result = (yearValue / divisor) * 10000;
      } else if (tipo === "entero") {
        result = (yearValue / divisor) * 100;
      } else {
        result = 0;
      }
      return parseFloat(result.toFixed(2));
    }

    // Variables globales en window para almacenar los datos de la gráfica de torta
    window.objectiveLabels = [];
    window.objectiveData = [];




    window.objectiveData = '';

    async function createChartByObjectives(politica, anioActual = new Date().getFullYear()) {
      const db = getDatabase();
      const anioInicio = politica.fecha_politica.includes('/')
        ? parseInt(politica.fecha_politica.split('/')[2])
        : new Date(politica.fecha_politica).getFullYear();

      const etiquetas = [];
      const etiquetasOriginales = [];
      const avancesProporcionales = [];
      const pesosRelativos = [];
      const cumplimientoInterno = [];
      const colores = ['#4CAF50', '#2196F3', '#FFC107', '#E91E63', '#9C27B0', '#00BCD4', '#8BC34A', '#FF9800'];

      const objetivos = Object.values(politica.objetivos_especificos || {});
      let cumplimientoTotalPolitica = 0;

      for (let i = 0; i < objetivos.length; i++) {
        const objetivo = objetivos[i];
        let sumaProgramado = 0;
        let sumaEjecutado = 0;

        const acciones = Object.values(objetivo.acciones || {});

        for (const accion of acciones) {
          const ejecutadoRef = ref(db, `PolariScore/seguimientos/${accion.id_accion}/ejecutado`);
          const snapshot = await get(ejecutadoRef);
          const ejecutadoData = snapshot.exists() ? snapshot.val() : {};

          accion.anios.forEach((programado, index) => {
            const anio = anioInicio + index;
            const ejecutado = parseFloat(ejecutadoData[anio]) || 0;
            const valorProgramado = parseFloat(programado) || 0;

            sumaProgramado += valorProgramado;
            sumaEjecutado += Math.min(ejecutado, valorProgramado); // limitar exceso
          });
        }

        const cumplimiento = sumaProgramado > 0 ? (sumaEjecutado / sumaProgramado) * 100 : 0;
        const pesoRelativo = parseFloat(objetivo.importancia_objetivo || 0) * 100;
        const avanceProporcional = (cumplimiento / 100) * pesoRelativo;

        etiquetas.push(limitarTexto(objetivo.objetivo_especifico || `Objetivo ${i + 1}`, 50));
        etiquetasOriginales.push(objetivo.objetivo_especifico || `Objetivo ${i + 1}`);
        avancesProporcionales.push(avanceProporcional);
        pesosRelativos.push(pesoRelativo);
        cumplimientoInterno.push(cumplimiento);

        cumplimientoTotalPolitica += avanceProporcional;
      }

      // Ruta principal del total
      const totalRef = ref(db, `PolariScore/politicas/${politica.id}/totalPolitica`);
      const totalSnap = await get(totalRef);
      const totalActual = totalSnap.exists() ? parseFloat(totalSnap.val()) : null;

      // Obtener fecha actual en formato dd-mm-aaaa
      const hoy = new Date();
      const dia = String(hoy.getDate()).padStart(2, '0');
      const mes = String(hoy.getMonth() + 1).padStart(2, '0');
      const anio = hoy.getFullYear();
      const fechaFormateada = `${dia}-${mes}-${anio}`;

      window.fechaFormateada = fechaFormateada;

      // Solo actualizar si cambia significativamente
      if (totalActual === null || Math.abs(totalActual - cumplimientoTotalPolitica) > 0.01) {
        // ✅ Actualizar el valor actual
        await set(totalRef, cumplimientoTotalPolitica);

        // ✅ Guardar en historial por fecha
        const historialRef = ref(db, `PolariScore/politicas/${politica.id}/historial_total_politica/${fechaFormateada}`);
        await set(historialRef, cumplimientoTotalPolitica);

        console.log("✅ Cumplimiento total actualizado:", cumplimientoTotalPolitica);
      } else {
        console.log("ℹ️ El cumplimiento total no cambió, no se actualiza.");
      }


      // Mostrar total de la política
      console.log(`✅ Cumplimiento total de la política: ${cumplimientoTotalPolitica.toFixed(2)}%`);

      const chart = echarts.init(document.getElementById('grafica_objetivos'), 'S-PLAN');
      const chart2 = echarts.init(document.getElementById('grafica_objetivos_pdf'), 'S-PLAN');

      chart.setOption({
        title: {
          text: `Avance Proporcional vs Peso Relativo por Objetivo Estratégico\nTotal política: ${cumplimientoTotalPolitica.toFixed(2)}%`,
          left: 'left',
          top: 10
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function (params) {
            const index = params[0].dataIndex;
            const peso = params.find(p => p.seriesName === 'Peso relativo');
            const avance = params.find(p => p.seriesName === 'Avance');
            return `
              <b>${avance.name}</b><br/>
              🧱 Peso relativo: <b>${peso.value.toFixed(2)}%</b><br/>
              🚀 Cumplimiento interno: <b>${cumplimientoInterno[index].toFixed(2)}%</b><br/>
              📊 Avance proporcional: <b>${avance.value.toFixed(2)}%</b>
            `;
          }
        },
        grid: {
          left: '50%',
          right: '5%',
          top: 80,
          bottom: 80
        },
        xAxis: {
          type: 'value',
          max: 100,
          axisLabel: { formatter: '{value}%' },
          splitLine: {
            lineStyle: { type: 'dashed', color: '#ccc' }
          }
        },
        yAxis: {
          type: 'category',
          data: etiquetas,
          inverse: true,
          axisLabel: { fontSize: 14 }
        },
        toolbox: {
          top: '8%',
          show: true,
          orient: 'horizontal',
          left: 'right',

          feature: {
            dataView: {
              show: true,
              readOnly: false,
              title: 'Ver Datos',
              lang: ['Vista de Datos', 'Cerrar', 'Actualizar']
            },
            myExcel: {
              show: true,
              title: 'Descargar Excel',
              icon: 'path://M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zM384 384h128v128H384V384zm0 192h128v192H384V576z',
              onclick: function () {
                const datos = [["Objetivo", "Cumplimiento Interno (%)", "Peso Relativo (%)", "Avance Proporcional (%)"]];

                for (let i = 0; i < etiquetas.length; i++) {
                  datos.push([
                    etiquetasOriginales[i],
                    cumplimientoInterno[i].toFixed(2),
                    pesosRelativos[i].toFixed(2),
                    avancesProporcionales[i].toFixed(2)
                  ]);
                }

                // Crear una hoja y un libro de trabajo con SheetJS
                const ws = XLSX.utils.aoa_to_sheet(datos);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Avance Política");

                // Descargar el archivo .xlsx
                XLSX.writeFile(wb, "avance_proporcional_politica.xlsx");
              }
            },
            saveAsImage: {
              show: true,
              title: 'Descargar Imagen'
            }
          }
        },
        series: [
          {
            name: 'Peso relativo',
            type: 'bar',
            data: pesosRelativos,
            barWidth: 40,
            itemStyle: {
              color: '#eeeeee',
              borderColor: '#aaa',
              borderWidth: 1,
              borderRadius: 5
            },
            label: {
              show: true,
              position: 'right',
              formatter: params => `Peso: ${params.value.toFixed(2)}%`,
              fontSize: 12,
              color: 'gray',
              padding: [0, 8, 0, 0]
            },
            z: 1
          },
          {
            name: 'Avance',
            type: 'bar',
            data: avancesProporcionales.map((valor, i) => ({
              value: valor,
              itemStyle: {
                color: colores[i % colores.length],
                borderRadius: 5
              }
            })),
            barWidth: 40,
            label: {
              show: true,
              position: 'insideRight',
              formatter: params => (params.value >= 10 ? `${params.value.toFixed(2)}%` : ''),
              fontSize: 15,
              color: '#fff'
            },
            barGap: '-100%',
            z: 2
          }

        ]

      });

      chart2.setOption({
        title: {
          text: `Avance Proporcional vs Peso Relativo por Objetivo Estratégico\nTotal política: ${cumplimientoTotalPolitica.toFixed(2)}%`,
          left: 'left',
          top: 10
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function (params) {
            const index = params[0].dataIndex;
            const peso = params.find(p => p.seriesName === 'Peso relativo');
            const avance = params.find(p => p.seriesName === 'Avance');
            return `
              <b>${avance.name}</b><br/>
              🧱 Peso relativo: <b>${peso.value.toFixed(2)}%</b><br/>
              🚀 Cumplimiento interno: <b>${cumplimientoInterno[index].toFixed(2)}%</b><br/>
              📊 Avance proporcional: <b>${avance.value.toFixed(2)}%</b>
            `;
          }
        },
        grid: {
          left: '50%',
          right: '5%',
          top: 80,
          bottom: 80
        },
        xAxis: {
          type: 'value',
          max: 100,
          axisLabel: { formatter: '{value}%' },
          splitLine: {
            lineStyle: { type: 'dashed', color: '#ccc' }
          }
        },
        yAxis: {
          type: 'category',
          data: etiquetas,
          inverse: true,
          axisLabel: { fontSize: 14 }
        },
        toolbox: {
          show: true,
          orient: 'horizontal',
          left: 'right',
          top: 'start',
          feature: {
            dataView: {
              show: true,
              readOnly: false,
              title: 'Ver Datos',
              lang: ['Vista de Datos', 'Cerrar', 'Actualizar']
            },
            myExcel: {
              show: true,
              title: 'Descargar Excel',
              icon: 'path://M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zM384 384h128v128H384V384zm0 192h128v192H384V576z',
              onclick: function () {
                const datos = [["Objetivo", "Cumplimiento Interno (%)", "Peso Relativo (%)", "Avance Proporcional (%)"]];

                for (let i = 0; i < etiquetas.length; i++) {
                  datos.push([
                    etiquetasOriginales[i],
                    cumplimientoInterno[i].toFixed(2),
                    pesosRelativos[i].toFixed(2),
                    avancesProporcionales[i].toFixed(2)
                  ]);
                }

                // Crear una hoja y un libro de trabajo con SheetJS
                const ws = XLSX.utils.aoa_to_sheet(datos);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Avance Política");

                // Descargar el archivo .xlsx
                XLSX.writeFile(wb, "avance_proporcional_politica.xlsx");
              }
            },
            saveAsImage: {
              show: true,
              title: 'Descargar Imagen'
            }
          }
        },
        series: [
          {
            name: 'Peso relativo',
            type: 'bar',
            data: pesosRelativos,
            barWidth: 40,
            itemStyle: {
              color: '#eeeeee',
              borderColor: '#aaa',
              borderWidth: 1,
              borderRadius: 5
            },
            label: {
              show: true,
              position: 'right',
              formatter: params => `Peso: ${params.value.toFixed(2)}%`,
              fontSize: 12,
              color: 'gray',
              padding: [0, 8, 0, 0]
            },
            z: 1
          },
          {
            name: 'Avance',
            type: 'bar',
            data: avancesProporcionales.map((valor, i) => ({
              value: valor,
              itemStyle: {
                color: colores[i % colores.length],
                borderRadius: 5
              }
            })),
            barWidth: 40,
            label: {
              show: true,
              position: 'insideRight',
              formatter: params => (params.value >= 10 ? `${params.value.toFixed(2)}%` : ''),
              fontSize: 15,
              color: '#fff'
            },
            barGap: '-100%',
            z: 2
          }

        ]

      });


      aplicarFirmaSPlan(chart, window.fechaFormateada);
      aplicarFirmaSPlan(chart2, window.fechaFormateada);

      // Crear tabla de datos finales
      const tabla = document.createElement('table');
      tabla.className = 'table table-bordered table-striped mt-4';
      tabla.style.fontSize = '14px';
      tabla.style.background = '#f9f9f9';

      const encabezados = ['Objetivo', 'Programado', 'Ejecutado', 'Cumplimiento (%)', 'Peso (%)', 'Avance Proporcional (%)'];
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      encabezados.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      tabla.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i = 0; i < etiquetas.length; i++) {
        const fila = document.createElement('tr');

        const tdObj = document.createElement('td');
        tdObj.textContent = etiquetas[i];
        fila.appendChild(tdObj);

        const tdProg = document.createElement('td');
        tdProg.textContent = pesosRelativos[i] > 0 ? (pesosRelativos[i] / 100 * 100).toFixed(2) : '0.00'; // mantén el valor
        fila.appendChild(tdProg);

        const tdEjec = document.createElement('td');
        tdEjec.textContent = cumplimientoInterno[i] > 0
          ? (cumplimientoInterno[i] / 100 * (pesosRelativos[i])).toFixed(2)
          : '0.00';
        fila.appendChild(tdEjec);

        const tdCumpl = document.createElement('td');
        tdCumpl.textContent = cumplimientoInterno[i].toFixed(2);
        fila.appendChild(tdCumpl);

        const tdPeso = document.createElement('td');
        tdPeso.textContent = pesosRelativos[i].toFixed(2);
        fila.appendChild(tdPeso);

        const tdAvance = document.createElement('td');
        tdAvance.textContent = avancesProporcionales[i].toFixed(2);
        fila.appendChild(tdAvance);

        tbody.appendChild(fila);
      }
      tabla.appendChild(tbody);

      const contenedorTabla = document.getElementById('contenedor_tabla_objetivos');
      const contenedorTabla_pdf = document.getElementById('contenedor_tabla_objetivos_pdf');
      contenedorTabla.innerHTML = ''; // limpiar si ya existe
      contenedorTabla.appendChild(tabla);

      // Crear tabla de datos finales para informe


      const tabla_pdf = document.createElement('table');
      tabla_pdf.className = 'table table-bordered table-striped mt-4';
      tabla_pdf.style.fontSize = '14px';
      tabla_pdf.style.background = '#f9f9f9';

      const encabezados_pdf = ['Objetivo', 'Programado', 'Ejecutado', 'Cumplimiento (%)', 'Avance Proporcional (%)'];
      const thead_pdf = document.createElement('thead');
      const trHead_pdf = document.createElement('tr');
      encabezados_pdf.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        trHead_pdf.appendChild(th);
      });
      thead_pdf.appendChild(trHead_pdf);
      tabla_pdf.appendChild(thead_pdf);

      const tbody_pdf = document.createElement('tbody');
      for (let i = 0; i < etiquetas.length; i++) {
        const fila = document.createElement('tr');

        const tdObj = document.createElement('td');
        tdObj.textContent = limitarTexto(etiquetas[i], 12);
        fila.appendChild(tdObj);

        const tdProg = document.createElement('td');
        tdProg.textContent = pesosRelativos[i] > 0 ? (pesosRelativos[i] / 100 * 100).toFixed(2) : '0.00'; // mantén el valor
        fila.appendChild(tdProg);

        const tdEjec = document.createElement('td');
        tdEjec.textContent = cumplimientoInterno[i] > 0
          ? (cumplimientoInterno[i] / 100 * (pesosRelativos[i])).toFixed(2)
          : '0.00';
        fila.appendChild(tdEjec);

        const tdCumpl = document.createElement('td');
        tdCumpl.textContent = cumplimientoInterno[i].toFixed(2);
        fila.appendChild(tdCumpl);

        const tdAvance = document.createElement('td');
        tdAvance.textContent = avancesProporcionales[i].toFixed(2);
        fila.appendChild(tdAvance);

        tbody_pdf.appendChild(fila);
      }
      tabla_pdf.appendChild(tbody_pdf);

      contenedorTabla_pdf.innerHTML = ''; // limpiar si ya existe
      contenedorTabla_pdf.appendChild(tabla_pdf);



    }




    function exportarDatosAGrafica(labels, datos, nombreColumnas = ["Etiqueta", "Valor"], nombreArchivo = "datos_grafica.xlsx") {
      if (!labels || !datos || labels.length !== datos.length) {
        console.error("Error: Los datos y etiquetas deben tener la misma longitud.");
        return;
      }

      // Crear los datos para el archivo Excel
      let datosExcel = labels.map((label, index) => ({
        [nombreColumnas[0]]: label,
        [nombreColumnas[1]]: datos[index].toFixed(2) // Formatear a dos decimales
      }));

      // Convertir datos a hoja de Excel
      const ws = XLSX.utils.json_to_sheet(datosExcel);

      // Crear libro de trabajo
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Datos");

      // Descargar el archivo
      XLSX.writeFile(wb, nombreArchivo);
    }
    window.exportarDatosAGrafica = exportarDatosAGrafica;

    // Función para cargar documentos en el modal
    function cargarDocumentos(id) {
      const dbRef = ref(db, `PolariScore/politicas/${id}/documentos`);

      get(dbRef).then(snapshot => {
        const modalDocumentos = document.getElementById("modalDocumentos");
        modalDocumentos.innerHTML = ""; // Limpiar contenido previo

        if (snapshot.exists()) {
          const documentos = snapshot.val();
          const docsArray = Object.values(documentos);

          if (docsArray.length > 0) {
            const row = document.createElement("div");
            row.classList.add("row", "g-3");

            docsArray.forEach(doc => {
              const col = document.createElement("div");
              col.classList.add("col-12");

              col.innerHTML = `
                <div class="border rounded-3 p-3 d-flex justify-content-between align-items-center shadow-sm hover-shadow transition">
                  <div>
                    <h6 class="mb-1 fw-semibold text-dark">${doc.titulo}</h6>
                    <small class="text-muted">Documento disponible para descarga.</small>
                  </div>
                  <a href="${doc.url}" target="_blank" class="btn btn-sm btn-link text-decoration-none">
                    <i class="fas fa-download me-1"></i> Descargar
                  </a>
                </div>
              `;

              row.appendChild(col);


            });

            modalDocumentos.appendChild(row);

            document.getElementById("descargar_todo").addEventListener("click", () => {
              docsArray.forEach(doc => {
                const link = document.createElement("a");
                link.href = doc.url;
                link.download = doc.titulo;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              });
            });

          } else {
            modalDocumentos.innerHTML = `<p class="text-muted text-center">No hay documentos disponibles.</p>`;
          }

        } else {
          modalDocumentos.innerHTML = `<p class="text-muted text-center">No hay documentos disponibles.</p>`;
        }

      }).catch(error => {
        console.error("❌ Error al cargar documentos:", error); c
        mostrarToast("Error al cargar documentos.", "danger");
      });
    }

    async function calcularCumplimientoAccion(accion, anioInicio) {
      const db = getDatabase();
      const ejecutadoRef = ref(db, `PolariScore/seguimientos/${accion.id_accion}/ejecutado`);

      try {
        const snapshot = await get(ejecutadoRef);
        const ejecutadoData = snapshot.exists() ? snapshot.val() : {};
        const aniosProgramados = accion.anios || [];

        let sumaProgramado = 0;
        let sumaEjecutado = 0;

        for (let i = 0; i < aniosProgramados.length; i++) {
          const anio = anioInicio + i;
          const programado = parseFloat(aniosProgramados[i]) || 0;
          const ejecutado = parseFloat(ejecutadoData[anio]) || 0;

          sumaProgramado += programado;
          sumaEjecutado += ejecutado;
        }

        const cumplimientoTotal = sumaProgramado > 0
          ? (sumaEjecutado / sumaProgramado) * 100
          : 0;


        return parseFloat(cumplimientoTotal.toFixed(2));

      } catch (error) {
        console.error("❌ Error al calcular cumplimiento:", error);
        return 0;
      }
    }



    // Llamar la función cuando la página cargue
    document.addEventListener("DOMContentLoaded", function () {
      const id = getQueryParam("id");
      if (id) {
        cargarDocumentos(id);
      }
    });



    function llenarInformePDF({
      infoPolitica,
      kpis,
      cumplimientoGlobal,
      observaciones,
      tablaAccionesHTML,
      usuarioActual,
      graficaTermometroImg,
      graficaCurvaSImg,
      graficaAccionesCompletadasImg
    }) {
      // Fecha actual
      const fecha = new Date();
      const fechaStr = fecha.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });

      // Encabezado
      document.getElementById("fechaInforme").textContent = fechaStr;
      document.getElementById("usuarioInforme").textContent = usuarioActual || 'Sistema';

      // Título y objetivo
      document.getElementById("tituloInforme").textContent = infoPolitica.titulo || "-";
      document.getElementById("objetivo_general_pdf").textContent = infoPolitica.objetivo_general || "-";

      // KPIs
      //document.getElementById("totalObjetivos_pdf").textContent = kpis.totalObjetivos ?? "-";
      //document.getElementById("totalAcciones_pdf").textContent = kpis.totalAcciones ?? "-";
      //document.getElementById("totalAccionesCompletadas_pdf").textContent = kpis.totalAccionesCompletadas ?? "-";
      document.getElementById("totalEvidencias_pdf").textContent = kpis.totalEvidencias ?? "-";

      // Cumplimiento global
      //document.getElementById("porcentajeCumplimiento_pdf").textContent = cumplimientoGlobal !== undefined ? Math.round(cumplimientoGlobal) : "-";

      // Imágenes de gráficas
      //document.getElementById("termometroCumplimientoImg").src = graficaTermometroImg || "";
      //document.getElementById("graficaCurvaSImg").src = graficaCurvaSImg || "";
      //document.getElementById("graficaAccionesCompletadasImg").src = graficaAccionesCompletadasImg || "";

      // Tabla de acciones
      //document.getElementById("tablaAcciones_pdf").innerHTML = tablaAccionesHTML || "";

      // Observaciones
      //document.getElementById("observaciones_pdf").textContent = observaciones || "";
    }


    // Supón que tienes los datos listos:
    llenarInformePDF({
      infoPolitica: {
        titulo: "Política de Internacionalización",
        objetivo_general: "Fomentar la proyección global de Unitrópico..."
      },
      kpis: {
        totalObjetivos: totalObjetivos.textContent,
        totalAcciones: 15,
        totalAccionesCompletadas: 8,
        totalEvidencias: 21
      },
      cumplimientoGlobal: 82,
      observaciones: "Se evidencia un avance importante pero aún hay retos en acciones de cooperación...",

      usuarioActual: "Jackson Parra Martínez",
      graficaTermometroImg: obtenerBase64DeSVG('grafica_cumplimiento_Politica'),    // Debes convertir el SVG/canvas a base64
      graficaCurvaSImg: obtenerBase64DeCanvas('grafica_curva_s'),                   // Debes convertir el canvas a base64
      graficaAccionesCompletadasImg: obtenerBase64DeCanvas('grafica_cumplimiento_anios')
    });

    function obtenerBase64DeSVG(svgContainerId) {
      const svg = document.querySelector(`#${svgContainerId} svg`);
      if (!svg) return "";
      const xml = new XMLSerializer().serializeToString(svg);
      return "data:image/svg+xml;base64," + window.btoa(unescape(encodeURIComponent(xml)));
    }

    function obtenerBase64DeCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return "";
      return canvas.toDataURL("image/png");
    }



    // Calcula datos de acordeón + métricas del gráfico por objetivo (v9)
    async function politicaToAcordeonDataConMetricas(politica) {
      const db = getDatabase();
      const objetivos = Object.values(politica.objetivos_especificos || {});
      const fecha = politica.fecha_politica || '';
      const anioInicio = fecha.includes('/')
        ? parseInt(fecha.split('/')[2])
        : new Date(fecha).getFullYear();
      window.anioInicioPolitica = anioInicio;

      // Para cada objetivo, calculamos:
      // - suma programado (6 años) y ejecutado (capado a programado)
      // - cumplimientoInterno (%)
      // - pesoRelativo (%)
      // - avanceProporcional = (cumplimientoInterno/100) * pesoRelativo
      const resultados = [];

      for (let idxObj = 0; idxObj < objetivos.length; idxObj++) {
        const objetivo = objetivos[idxObj];
        const acciones = Object.values(objetivo.acciones || {});

        // 1) Preparamos acciones (y además mantenemos arreglo anual para tu tabla/tarjetas)
        const accionesArr = acciones.map(acc => {
          const aniosArr = [];
          for (let anio = 0; anio <= 5; anio++) {
            let val;
            if (acc.tipo_dato_acumulado === "entero") {
              val = acc.anios && acc.anios[anio] !== undefined ? parseInt(acc.anios[anio]) : 0;
            } else {
              val = acc.anios && acc.anios[anio] !== undefined ? Math.round(parseFloat(acc.anios[anio]) * 100) : 0;
            }
            aniosArr.push(val);
          }
          return {
            nombre: acc.accion || acc.nombre || `Acción ${acc.id_accion || ''}`,
            id_accion: acc.id_accion || '',
            anual: aniosArr,
            tipo: acc.tipo_dato_acumulado || "porcentaje",
            importancia: acc.importancia_accion
          };
        });

        // 2) Leemos ejecutado por acción (en paralelo)
        const lecturas = await Promise.all(acciones.map(async (acc) => {
          if (!acc?.id_accion) return {};
          const ejecutadoRef = ref(db, `PolariScore/seguimientos/${acc.id_accion}/ejecutado`);
          const snap = await get(ejecutadoRef);
          return snap.exists() ? snap.val() : {};
        }));

        // 3) Sumamos programado/ejecutado (capado) para el objetivo
        let sumaProgramado = 0;
        let sumaEjecutado = 0;

        acciones.forEach((acc, idxAcc) => {
          const ejecutadoData = lecturas[idxAcc] || {};
          const arr = Array.isArray(acc.anios) ? acc.anios : Object.values(acc.anios || {});
          for (let i = 0; i < 6; i++) {
            const programadoBruto = parseFloat(arr?.[i]) || 0;
            const programado = (acc.tipo_dato_acumulado === 'entero')
              ? programadoBruto
              : (programadoBruto); // ya viene como 0..1 en tus datos originales del gráfico

            const anio = anioInicio + i;
            const ejecutado = parseFloat(ejecutadoData[anio]) || 0;

            sumaProgramado += programado;
            // capamos ejecutado al programado para no sobrecontar
            sumaEjecutado += Math.min(ejecutado, programado);
          }
        });

        // 4) Métricas tipo gráfico
        const cumplimientoInterno = (sumaProgramado > 0) ? (sumaEjecutado / sumaProgramado) * 100 : 0;
        const pesoRelativo = parseFloat(objetivo.importancia_objetivo || 0) * 100;
        const avanceProporcional = (cumplimientoInterno / 100) * pesoRelativo;

        resultados.push({
          titulo: objetivo.objetivo_especifico || objetivo.nombre || `Objetivo ${idxObj + 1}`,
          acciones: accionesArr,
          // Valores de la barra del header (mismo sentido del gráfico):
          pesoRelativo: Number(pesoRelativo.toFixed(2)),
          cumplimientoInterno: Number(cumplimientoInterno.toFixed(2)),
          avanceProporcional: Number(avanceProporcional.toFixed(2)),
          idObj: objetivo.id_objetivo
        });
      }

      return resultados;
    }


    // Paleta simple; puedes reutilizar la del gráfico

    /**
 * Renderiza el acordeón de cronograma mostrando Ejecutado vs Proyectado.
 * @param {Array} objetivos  Estructura ya normalizada (politicaToAcordeonData*).
 * @param {Object} opts      { anioInicio: Number, politicaId: String }
 */
    function renderAcordeonCronograma(objetivos, opts = {}) {
      if (!Array.isArray(objetivos)) {
        console.warn('renderAcordeonCronograma: objetivos no es un array.');
        document.getElementById('acordeonCronograma')?.insertAdjacentHTML(
          'beforeend',
          `<div class="text-muted small">No hay objetivos para mostrar.</div>`
        );
        return;
      }

      function calcularCumplimientoObjetivoPorAnio(obj, anioInicio) {
        const ejecutadosData = window.ejecutadosData || {};
        const anios = 6; // ajusta si tu política no siempre tiene 6

        return Array.from({ length: anios }, (_, idx) => {
          const year = anioInicio + idx;
          let sumExec = 0;
          let sumProj = 0;

          (obj.acciones || []).forEach(acc => {
            const ejecRaw = Number(ejecutadosData?.[acc.id_accion]?.ejecutado?.[year] ?? 0);
            const proyRaw = Number(acc?.anual?.[idx] ?? 0);

            if (acc.tipo === 'entero') {
              sumExec += Math.max(0, ejecRaw);
              sumProj += Math.max(0, proyRaw);
            } else {
              // Normaliza a 0..100
              const ejecPct = ejecRaw <= 1 ? ejecRaw * 100 : ejecRaw;
              const proyPct = proyRaw <= 1 ? proyRaw * 100 : proyRaw;
              sumExec += Math.max(0, ejecPct);
              sumProj += Math.max(0, proyPct);
            }
          });

          const porcentaje = sumProj > 0 ? Math.min(100, Math.max(0, (sumExec / sumProj) * 100)) : 0;
          return { year, porcentaje, sumExec, sumProj };
        });
      }


      const isMobile = window.matchMedia('(max-width: 767.98px)').matches;
      const anioInicio = window.anioInicioPolitica;
      const politicaId = window.politica_id || '';
      const colores = (typeof BARRA_COLORES_OBJETIVO !== 'undefined' && BARRA_COLORES_OBJETIVO.length)
        ? BARRA_COLORES_OBJETIVO
        : ['#00594e', '#00594e', '#00594e', '#E91E63', '#9C27B0', '#00BCD4', '#8BC34A', '#FF9800'];

      let html = '';

      objetivos.forEach((obj, i) => {
        const color = colores[i % colores.length];
        const barraAnualBg = `${color}cc`;     // color para "proyectado"
        const barraPeso = '#eeeeee';           // base cabecera (peso)
        const barraAvance = color;             // avance proporcional

        // ---------- CABECERA DEL OBJETIVO (Cumplimiento con barra + Avance proporcional como badge) ----------
        html += `
    <div class="accordion-item nav-item nav-link mb-3">
      <h2 class="accordion-header" id="heading${i}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}">
          <span style="border-radius:6px;width:14px;height:14px;display:inline-block;background:${color};margin-right:12px;"></span>
          ${limitarTexto(obj.titulo || `Objetivo ${i + 1}`, 40)}

          <div class="ms-auto d-flex align-items-center gap-3" style="min-width: clamp(280px, 45vw, 560px);">
            

            <!-- Avance proporcional como badge -->
            <span class="badge rounded-pill px-2 py-1" 
                  style="background:${color};color:#fff;" 
                  title="Avance proporcional (ponderado por el peso)">
              Avance ${Number(obj.avanceProporcional || 0).toFixed(1)}%
            </span>
            /
            <!-- Peso relativo -->
            <span class="badge rounded-pill px-2 py-1 text-dark bg-light border" title="Peso relativo del objetivo">
              Aporte ${Number(obj.pesoRelativo || 0).toFixed(1)}%
            </span>

            <!-- Cumplimiento interno como barra -->
            <div class="d-flex align-items-center gap-2 flex-grow-1 admin-only" style="display: none;">
              <span class="text-muted small" style="min-width:128px;">Cumplimiento interno</span>
              <div class="bar-track flex-grow-1" style="height:8px;border-radius:6px;background:rgba(0,0,0,.08);overflow:hidden;">
                <div class="bar-fill" style="height:100%;width:${Math.max(0, Math.min(100, Number(obj.cumplimientoInterno || 0)))}%;background:${color};opacity:.7;"></div>
              </div>
              <span class="small fw-semibold" style="min-width:58px;text-align:right;">
                ${Number(obj.cumplimientoInterno || 0).toFixed(1)}%
              </span>
            </div>
          </div>
        </button>
      </h2>
      <div id="collapse${i}" class="accordion-collapse collapse" data-bs-parent="#acordeonCronograma">
        <div class="accordion-body pt-2">
  `;


        // ---------- CONTENIDO POR ACCIÓN ----------
        if (isMobile) {
          // ------- Tarjeta (móvil) -------
          html += (obj.acciones || []).map(acc => {
            const accUrl = acc.id_accion ? `accion.html?id=${acc.id_accion}` : '#';
            const ejecYears = (window.ejecutadosData?.[acc.id_accion]?.ejecutado) || {};

            return `
            <div class="action-card mb-3 p-3 rounded-3 border" style="border-color:#e8ecef;">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="action-title"><a href="${accUrl}">${limitarTexto(acc.nombre || 'Acción', 50)}</a></div>
                <div class="small">${iconoTipoIndicador(acc.tipo)}</div>
              </div>

              ${acc.anual.map((proyectado, idx) => {
              const year = anioInicio + idx;
              // Normalización: porcentajes pueden venir 0..100 o 0..1
              const ejecutadoRaw = ejecYears[year] ?? 0;
              const ejecutado = acc.tipo === 'entero'
                ? Number(ejecutadoRaw)
                : (Number(ejecutadoRaw) <= 1 ? Number(ejecutadoRaw) * 100 : Number(ejecutadoRaw));
              const proyPct = acc.tipo === 'entero' ? Number(proyectado) : Number(proyectado);

              return `
                <div class="year-row d-flex align-items-center justify-content-between mb-1">
                  <div class="year-label text-muted">Año ${idx + 1}</div>
                  <div class="flex-grow-1 ms-2">
                    ${acc.tipo === 'entero'
                  ? `
                        <span class="badge rounded-pill bg-success px-3 py-2 me-1" title="Ejecutado" >${ejecutado}</span>
                        <span class="badge rounded-pill px-3 py-2" title="Proyectado" style="background:${barraAnualBg}">${proyPct}</span>
                      `
                  : `
                        <div class="year-bar" style="width:100px;height:10px;border-radius:6px;background:#eee;overflow:hidden;display:inline-block;vertical-align:middle;">
                          <div class="year-fill bg-success" style="width:${ejecutado}%;height:100%;"></div>
                        </div>
                        <span class="small ms-1 me-2">${ejecutado}%</span>
                        <div class="year-bar" style="width:100px;height:10px;border-radius:6px;background:#eee;overflow:hidden;display:inline-block;vertical-align:middle;">
                          <div class="year-fill" style="width:${proyPct}%;height:100%;background:${barraAnualBg};"></div>
                        </div>
                        <span class="small ms-1">${proyPct}%</span>
                      `
                }
                  </div>
                </div>`;
            }).join('')}
            </div>
          `;
          }).join('');
        } else {
          // ------- Tabla (desktop) -------
          const currentYear = new Date().getFullYear();

          // 👇 Nuevo: resumen por año a nivel de objetivo
          const resumenAnualObj = calcularCumplimientoObjetivoPorAnio(obj, anioInicio);

          html += `
              <div class="table-wrap">
                <table class="table table-borderless align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Acción</th>
                      <th>Opciones</th>
                      <th>Importancia</th>
                      <th>Tipo</th>
                      ${[1, 2, 3, 4, 5, 6].map((a, idx) => {
            const year = anioInicio + idx;
            const isCurrent = year === currentYear;
            const r = resumenAnualObj[idx]; // { porcentaje, sumProj, ... }
            const pct = r?.sumProj > 0 ? r.porcentaje : 0;
            const pctLabel = r?.sumProj > 0 ? `${Math.round(pct)}%` : '—';

            return `
                        <th class="text-center ${isCurrent ? 'year-current-th' : ''}" style="min-width:130px;">
                          <div class="d-flex flex-column align-items-stretch gap-1 py-1">
                            <div class="fw-semibold" title="Ejecutado / Proyectado">Año ${a}</div>
                            ${isCurrent
                ? `<span class="year-chip" title="Año en curso"><i class="fa-solid fa-calendar-day"></i> hoy · ${year}</span>`
                : `<span class="text-muted small">${year}</span>`
              }
                            <!-- Resumen del OBJETIVO en este año -->
                            <div class="obj-year-track" title="Cumplimiento del objetivo ${pctLabel}">
                              <div class="obj-year-fill" style="width:${pct}%; background:${color};"></div>
                            </div>
                            <div class="small ${r?.sumProj > 0 ? 'text-dark' : 'text-muted'}">${pctLabel}</div>
                          </div>
                        </th>`;
          }).join('')}
                    </tr>
                  </thead>
                  <tbody>
        
        ${(obj.acciones || []).map((acc, idxAcc) => {
            const ejecYears = (window.ejecutadosData?.[acc.id_accion]?.ejecutado) || {};
            const imp = Number((acc.importancia || 0) * 100);

            return `
                    <tr class="tr-acciones" style="border-bottom:1px solid #eaeaea;">
                      <td title="${acc.nombre || ''}" class="small">
                        <a href="accion.html?id=${acc.id_accion}" title="${acc.nombre || ''}">
                          ${limitarTexto(acc.nombre || 'Acción', 48)}
                        </a>
                      </td>
                      <td class="align-items-center small">
                        <button class="btn btn-outline-warning btn-sm btnCargarEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm admin-responsable-only" 
                          title="Cargar evidencias"
                          data-id-politica="${politicaId}"
                          data-objetivo-index="${(obj.idObj ?? i)}"
                          data-id-accion="${acc.id_accion}">
                          <i class="fa-solid fa-cloud-arrow-up me-1"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm btnCargarEvidencias fw-semibold px-3 py-2 rounded-pill shadow-sm admin-only admin-polariscore" style="display:none;" 
                          title="Evaluar política"
                          data-id-politica="${politicaId}"
                          data-objetivo-index="${(obj.idObj ?? i)}"
                          data-id-accion="${acc.id_accion}">
                          <i class="fa-solid fa-pencil me-1"></i>
                        </button>
                      </td>
                      <td title="${imp.toFixed(2)}%" class="small">${imp.toFixed(2)}%</td>
                      <td class="small" title="${acc.tipo === 'entero' ? 'Cantidad' : 'Porcentaje'}">
                        ${iconoTipoIndicador(acc.tipo)}
                      </td>

                      ${acc.anual.map((proyectado, idx) => {
              const year = anioInicio + idx;
              const isFuture = year > currentYear;

              // Ejecutado bruto y normalización a % si aplica
              const ejecutadoRaw = ejecYears[year] ?? 0;
              const ejecutadoPct = acc.tipo === 'entero'
                ? Number(ejecutadoRaw)
                : (Number(ejecutadoRaw) <= 1 ? Number(ejecutadoRaw) * 100 : Number(ejecutadoRaw));

              const proy = acc.tipo === 'entero'
                ? Number(proyectado)
                : Number(proyectado);

              // ========== ENTERO ==========
              if (acc.tipo === 'entero') {
                // ---------- ENTERO: Ejecutado vs Proyectado ----------
                const proyAbs = Number(proyectado);
                const ejecAbs = Number(ejecutadoRaw);
                const cumplioEntero = proyAbs > 0 && ejecAbs >= proyAbs;
                const isPastOrEqual2025 = year <= 2025;
                const isFuture = year > currentYear;
                const isCurrent = year === currentYear;

                if (proyAbs === 0) {
                  return `
            <td class="text-center">
              <div class="d-flex flex-column align-items-center text-muted small">
                <i class="fa-regular fa-circle-xmark mb-1"></i>
                <span>Sin programar</span>
                <span class="small">Ejecutado: ${ejecAbs}</span>
              </div>
            </td>`;
                } else {
                  const showNoCumplido = isPastOrEqual2025 && !cumplioEntero;

                  // Definición de estilos según el caso
                  let badgeBaseClass = "badge rounded-pill px-3 py-2 fs-6";
                  let badgeEjecClass = badgeBaseClass;
                  let badgeProyClass = badgeBaseClass;
                  let badgeEjecStyle = "";
                  let badgeProyStyle = "";

                  if (isFuture) {
                    badgeEjecClass += " bg-light text-muted me-1";
                    badgeProyClass += " bg-light text-muted";
                  } else if (cumplioEntero) {
                    badgeEjecStyle = "background-color:#43e898;";
                    badgeProyStyle = `background:#00594e;`;
                  } else if (isCurrent) {
                    badgeEjecClass += " bg-warning text-white me-1";
                    badgeProyClass += " bg-warning text-white";
                  } else {
                    badgeEjecClass += " bg-danger text-white me-1";
                    badgeProyClass += " bg-danger text-white";
                  }

                  return `
            <td class="text-center">
              <div class="d-flex flex-column align-items-center">
                <div>
                  <span class="${badgeEjecClass}" title="Ejecutado" style="${badgeEjecStyle}">
                    ${ejecAbs}
                  </span>
                  <span class="${badgeProyClass}" title="Proyectado" style="${badgeProyStyle}">
                    ${proyAbs}
                  </span>
                </div>

                ${cumplioEntero && !isFuture ? `
                  <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill mt-1">
                    <i class="fa-solid fa-check-double me-1"></i> Cumplido
                  </span>` : ``}

                ${showNoCumplido && !isFuture && !isCurrent ? `
                  <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill mt-1">
                    <i class="fa-solid fa-circle-exclamation me-1"></i> Sin gestión
                  </span>` : ``}

                ${showNoCumplido && isCurrent ? `
                  <span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill mt-1">
                    <i class="fa-solid fa-hourglass-half me-1"></i> Pendiente
                  </span>` : ``}
              </div>
            </td>`;
                }


              }

              // ========== PORCENTAJE ==========
              else {
                // ---------- PORCENTAJE: Ejecutado vs Proyectado ----------
                const proyAbs = Number(proyectado);
                const ejecAbs = Number(ejecutadoRaw);
                const ejecPctReal = ejecAbs <= 1 ? ejecAbs * 100 : ejecAbs;

                let ejecRel = 0;
                if (proyAbs > 0) ejecRel = (ejecPctReal / proyAbs) * 100;
                ejecRel = Math.max(0, Math.min(100, ejecRel));

                const ejecLabel = `${ejecPctReal.toFixed(1)}%`;
                const proyLabel = `${proyAbs.toFixed(1)}%`;
                const cumplioPct = proyAbs > 0 && ejecPctReal >= proyAbs;
                const isPastOrEqual2025 = year <= 2025;
                const isFuture = year > currentYear;
                const isCurrent = year === currentYear;

                if (proyAbs === 0) {
                  return `
    <td class="text-center">
      <div class="d-flex flex-column align-items-center text-muted small">
        <i class="fa-regular fa-circle-xmark mb-1"></i>
        <span>Sin programar</span>
        <span class="small">Ejecutado: ${ejecLabel}</span>
      </div>
    </td>`;
                } else {
                  const showNoCumplido = isPastOrEqual2025 && !cumplioPct;

                  // Colores dinámicos
                  let ejecColor = "#43e898"; // verde default
                  let proyColor = '#00594e';

                  if (isFuture) {
                    ejecColor = "#ccc";
                    proyColor = "#ddd";
                  } else if (showNoCumplido && isCurrent) {
                    ejecColor = "#f0ad4e"; // warning
                    proyColor = "#00594e";
                  } else if (showNoCumplido) {
                    ejecColor = "red";
                    proyColor = "red";
                  }

                  return `
    <td class="text-center">
      <div class="d-flex flex-column align-items-center">
        <!-- Ejecutado relativo -->
        <div class="barra-anual mb-1" title="Ejecutado ${ejecLabel} de ${proyLabel}"
            style="display:inline-block;width:72px;height:10px;border-radius:6px;background:#eee;overflow:hidden;">
          <div style="background-color:${ejecColor};width:${ejecRel}%;height:100%;"></div>
        </div>
        <span class="small text-muted">${ejecLabel}</span>

        <div style="width:78%;border-top:1px solid #dcdcdc;margin:4px 0;"></div>

        <!-- Proyectado -->
        <div class="barra-anual mt-1" title="Proyectado ${proyLabel}"
            style="display:inline-block;width:72px;height:10px;border-radius:6px;background:#eee;overflow:hidden;">
          <div style="width:100%;height:100%;background:${proyColor};"></div>
        </div>
        <span class="small text-muted">${proyLabel}</span>

        ${cumplioPct && !isFuture ? `
          <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill mt-1">
            <i class="fa-solid fa-check-double me-1"></i> Cumplido
          </span>` : ``}

        ${showNoCumplido && !isFuture && !isCurrent ? `
          <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill mt-1">
            <i class="fa-solid fa-circle-exclamation me-1"></i> Sin gestión
          </span>` : ``}

        ${showNoCumplido && isCurrent ? `
          <span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill mt-1">
            <i class="fa-solid fa-hourglass-half me-1"></i> Pendiente
          </span>` : ``}
      </div>
    </td>`;
                }

              }
            }).join('')}
              
            </tr>`;
          }).join('')}
                </tbody>
              </table>
            </div>
            `;

        }

        html += `</div></div></div>`;
      });

      const cont = document.getElementById('acordeonCronograma');
      if (cont) cont.innerHTML = html;
    }

    // Llama a esto cuando ya tengas el objeto "politica" cargado
    async function renderAcordeonDesdePolitica(politica) {
      const datos = await politicaToAcordeonDataConMetricas(politica);
      // guarda para re-render responsive
      window.__OBJETIVOS_ACORDEON__ = datos;
      renderAcordeonCronograma(datos);
    }


    /* Re-render automático al cambiar tamaño (debounced) */
    (function () {
      let _t;
      window.addEventListener('resize', () => {
        clearTimeout(_t);
        _t = setTimeout(() => {
          // Usa los mismos datos que ya calculaste
          if (window.__OBJETIVOS_ACORDEON__) {
            renderAcordeonCronograma(window.__OBJETIVOS_ACORDEON__);
          }
        }, 150);
      });
    })();

    function iconoTipoIndicador(tipo) {
      if (tipo === "entero") {
        return `<span class="badge rounded-pill px-3 py-2 fs-6 bg-light text-dark d-inline-flex align-items-center ">
                <i class="fa-solid fa-hashtag"></i>
              </span>`;
      }
      if (tipo === "porcentaje") {
        return `<span class="badge rounded-pill px-3 py-2 fs-6 bg-light text-dark d-inline-flex align-items-center">
                <i class="fa-solid fa-percent"></i>
              </span>`;
      }
      return `<span class="badge rounded-pill px-3 py-2 fs-6 bg-light text-dark d-inline-flex align-items-center">
              <i class="fa-solid fa-hashtag"></i> Otro
            </span>`;
    }




    /** Abre un popup centrado en pantalla */
    function openCenteredPopup(url, width = 1500, height = 900) {
      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;

      const w = window.innerWidth || document.documentElement.clientWidth || screen.width;
      const h = window.innerHeight || document.documentElement.clientHeight || screen.height;

      const systemZoom = w / window.screen.availWidth;
      const left = (w - width) / (2 * systemZoom) + dualScreenLeft;
      const top = (h - height) / (2 * systemZoom) + dualScreenTop;

      const features = [
        `width=${width}`, `height=${height}`,
        `top=${top}`, `left=${left}`,
        'resizable=yes', 'scrollbars=yes'
      ].join(',');

      const popup = window.open(url, 'cargarEvidencias', features);
      if (popup && popup.focus) popup.focus();
      return popup;
    }

    /** Espera (promesa) a que el popup se cierre */
    function waitForClose(win) {
      return new Promise(resolve => {
        const iv = setInterval(() => {
          if (!win || win.closed) {
            clearInterval(iv);
            resolve();
          }
        }, 400);
      });
    }

    /** Delegación: click en cualquier .btnCargarEvidencias */
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btnCargarEvidencias');
      if (!btn) return;

      // Construir URL con tus parámetros
      const p = btn.dataset.idPolitica;       // politicaAsociada.id
      const obj = btn.dataset.objetivoIndex;    // objetivoIndex
      const a = btn.dataset.idAccion;         // idAccion

      if (!p || !obj || !a) {
        console.warn('Faltan parámetros para abrir el popup (p/obj/a).');
        return;
      }

      const url = `cargar.html?p=${encodeURIComponent(p)}&obj=${encodeURIComponent(obj)}&a=${encodeURIComponent(a)}`;

      // Abrir popup centrado
      const popup = openCenteredPopup(url);

      // Esperar a que el usuario cierre el popup
      await waitForClose(popup);

      // 👉 Aquí actúas tras el cierre: refresca datos, re-renderiza tabla, etc.
      // Por ejemplo, si quieres re-leer y re-pintar la tabla de cumplimiento:
      // (usa las mismas variables de tu contexto que ya tienes en ese scope)
      try {
        // vuelve a disparar tu lector (onValue ya escucha; si no, puedes forzar un refresh)
        console.log('Popup cerrado. Refrescando evidencias…');
        // Si tienes una función específica: await recargarTablaCumplimiento(); 
        // O cerrar/re-abrir el modal si hace falta, etc.
      } catch (err) {
        console.error('Error al refrescar después del popup:', err);
      }

    });

    // Asegura que window.ejecutadosData esté cargado antes de renderizar
    async function ensureSeguimientosCargados() {
      if (window.ejecutadosData && Object.keys(window.ejecutadosData).length) return;
      try {
        const snap = await get(ref(db, `PolariScore/seguimientos`));
        window.ejecutadosData = snap.exists() ? snap.val() : {};
        console.log('[Obj/Año] Seguimientos cargados:', window.ejecutadosData);
      } catch (e) {
        console.error('[Obj/Año] Error cargando seguimientos:', e);
        window.ejecutadosData = {};
      }
    }
    // Solo se usa para años < currentYear (pasado)
    function colorSemaforoPorcentaje(cumplRelPct) {
      const v = Number(cumplRelPct) || 0; // 0..100 (relativo a lo programado)
      if (v >= 100) return '#2e7d32';   // verde fuerte (cumplido/sobrecumplido)
      if (v >= 75) return '#4caf50';   // verde (alto)
      if (v >= 40) return '#ffc107';   // amarillo (medio)
      return '#dc3545';                 // rojo (bajo)
    }

    function renderTablaObjetivosPorAnio(politica) {
      const cont = document.getElementById('objetivosPorAnio');
      if (!cont) {
        console.warn('[Obj/Año] Contenedor #objetivosPorAño no encontrado');
        return;
      }

      const objetivosMap = politica?.objetivos_especificos || {};
      const objetivos = Object.values(objetivosMap);
      if (!objetivos.length) {
        cont.innerHTML = `<div class="text-muted small">No hay objetivos para mostrar.</div>`;
        return;
      }

      // Año de inicio de la política
      const fecha = politica.fecha_politica || '';
      const anioInicio = fecha.includes('/') ? parseInt(fecha.split('/')[2], 10) : new Date(fecha).getFullYear();
      const currentYear = new Date().getFullYear();

      // Seguimientos: window.ejecutadosData[ID_ACCION].ejecutado[AAAA] => 0..1
      const seg = (window.ejecutadosData || {});

      // --- Helpers ---
      const avg = arr => (arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length) : 0);

      // Semáforo para % (0..100): rojo <40, amarillo 40..74.9, verde 75..99.9, verde fuerte ≥100
      function colorSemaforoPorcentaje(cumplPct) {
        const v = Number(cumplPct) || 0;
        if (v >= 100) return '#2e7d32';  // verde fuerte
        if (v >= 75) return '#4caf50';  // verde
        if (v >= 40) return '#ffc107';  // amarillo
        return '#dc3545';                // rojo
      }

      function tipoAcumulacionObjetivo(obj) {
        // Por ahora todos “Acumulado” (ajusta si luego hay mezcla real de 'flujo')
        return 'Acumulado';
      }

      // Cumplimiento de una acción para un índice de año (0..5) en %
      function cumplimientoAccionAnio(acc, yearIndex) {
        const arr = Array.isArray(acc.anios) ? acc.anios : Object.values(acc.anios || {});
        const programadoRaw = Number(arr?.[yearIndex] ?? 0); // 0..1 (según tu modelo)
        if (!programadoRaw || programadoRaw <= 0) return { tienePlan: false, valor: 0 };

        const y = anioInicio + yearIndex;
        const ejeRaw = Number(seg?.[acc.id_accion]?.ejecutado?.[y] ?? 0); // 0..1
        const val = Math.max(0, Math.min(100, (ejeRaw / programadoRaw) * 100));
        return { tienePlan: true, valor: val, ejecutado: ejeRaw, programado: programadoRaw };
      }

      // --- THEAD ---
      const thead = `
      <thead>
        <tr>
          <th>Objetivo</th>
          <th>Acumulación</th>
          ${[1, 2, 3, 4, 5, 6].map((a, idx) => {
        const year = anioInicio + idx;
        const isCurrent = year === currentYear;
        return `
              <th class="text-center ${isCurrent ? 'year-current-th' : ''}">
                <div class="d-flex flex-column align-items-center gap-1 py-1">
                  <div class="fw-semibold" title="Cumplimiento promedio anual">Año ${a}</div>
                  ${isCurrent
            ? `<span class="year-chip" title="Año en curso">
                        <i class="fa-solid fa-calendar-day"></i> hoy · ${year}
                      </span>`
            : `<span class="text-muted small">${year}</span>`
          }
                </div>
              </th>`;
      }).join('')}
        </tr>
      </thead>`;

      // --- TBODY ---
      let tbody = '<tbody>';

      objetivos.forEach((obj, i) => {
        const titulo = obj.objetivo_especifico || obj.nombre || `Objetivo ${i + 1}`;
        const acumTxt = tipoAcumulacionObjetivo(obj);
        const acciones = Object.values(obj.acciones || {});

        const rowCeldas = [0, 1, 2, 3, 4, 5].map(yearIdx => {
          const year = anioInicio + yearIdx;
          const isCurrent = year === currentYear;
          const isFuture = year > currentYear;
          const isPast = year < currentYear;

          const cumplimientos = [];
          let hayPlan = false;

          acciones.forEach(acc => {
            const met = cumplimientoAccionAnio(acc, yearIdx);
            if (met.tienePlan) {
              hayPlan = true;
              cumplimientos.push(met.valor);
            }
          });

          if (!hayPlan) {
            return `
            <td class="text-center align-middle">
              <div class="d-flex flex-column align-items-center text-muted small">
                <i class="fa-regular fa-circle-xmark mb-1"></i>
                <span>Sin programar</span>
              </div>
            </td>`;
          }

          const prom = Math.max(0, Math.min(100, avg(cumplimientos)));
          const label = `${prom.toFixed(1)}%`;

          // Apariencia (todas las barras mismo ancho; cambia color según temporalidad)
          const barraBg = isFuture ? '#f1f3f5' : '#eee';
          let fillColor, badgeClass;

          if (isCurrent) {
            // Año en curso → warning
            fillColor = '#ffc107';
            badgeClass = 'badge bg-warning-subtle text-warning border border-warning-subtle';
          } else if (isPast) {
            // Pasado → semáforo
            fillColor = colorSemaforoPorcentaje(prom);
            badgeClass = (prom >= 100)
              ? 'badge bg-success-subtle text-success border border-success-subtle'
              : (prom >= 75)
                ? 'badge bg-success-subtle text-success border border-success-subtle'
                : (prom >= 40)
                  ? 'badge bg-warning-subtle text-warning border border-warning-subtle'
                  : 'badge bg-danger-subtle text-danger border border-danger-subtle';
          } else {
            // Futuro → gris claro
            fillColor = '#e2e6ea';
            badgeClass = 'badge bg-light text-muted border';
          }

          return `
          <td class="text-center align-middle">
            <div class="d-flex flex-column align-items-center">
              <div class="barra-anual mb-1"
                  style="display:inline-block;width:90px;height:10px;border-radius:6px;background:${barraBg};overflow:hidden;"
                  title="Cumplimiento ${label} en ${year}">
                <div class="barra-llena-anual"
                    style="width:${prom}%;height:100%;background:${fillColor};"></div>
              </div>
              <span class="${badgeClass}">${label}</span>
            </div>
          </td>`;
        }).join('');

        tbody += `
        <tr style="border-bottom:1px solid #eaeaea;">
          <td class="small" title="${titulo}">
            ${typeof limitarTexto === 'function' ? limitarTexto(titulo, 40) : titulo}
          </td>
          <td class="small">${acumTxt}</td>
          ${rowCeldas}
        </tr>`;
      });

      tbody += '</tbody>';

      // --- Render ---
      cont.innerHTML = `
      <div class="table-wrap">
        <table class="table table-borderless align-middle mb-0">
          ${thead}
          ${tbody}
        </table>
      </div>
    `;

      console.log('[Obj/Año] Render OK', { anioInicio, currentYear, objetivos: objetivos.length });
    }



    /******************** UTILIDADES ********************/
    function sanitizarCorreoParaKey(email) {
      return String(email).trim().toLowerCase().replace(/[.#$\[\]\/]/g, "_");
    }

    function pickNombreRTDB(usuario = {}) {
      const S = v => (typeof v === "string" ? v.trim() : "");
      // Prioridades de nombre en RTDB:
      return (
        S(usuario.nombre) ||
        S(usuario.nombre_completo) ||
        S(usuario.displayName) ||
        // Por partes:
        [S(usuario.primerNombre), S(usuario.segundoNombre), S(usuario.primerApellido), S(usuario.segundoApellido)]
          .filter(Boolean).join(" ").trim() ||
        [S(usuario.nombres), S(usuario.apellidos)].filter(Boolean).join(" ").trim() ||
        ""
      );
    }

    /** Busca en RTDB el usuario por correo (sanitizado). 
     *  Primero /usuarios/{key}, luego /PolariScore/usuarios/{key}. 
     *  Devuelve { nombreRTDB, areaRTDB, cargoRTDB, userRaw } o null si no existe.
     */
    async function leerUsuarioRTDBPorCorreo(db, correo) {
      const key = sanitizarCorreoParaKey(correo);
      const rutas = [
        `/usuarios/${key}`,
        `/PolariScore/usuarios/${key}`
      ];
      for (const ruta of rutas) {
        try {
          const s = await get(ref(db, ruta));
          if (s.exists()) {
            const data = s.val() || {};
            const nombreRTDB = pickNombreRTDB(data);
            const areaRTDB = (data.area && String(data.area).trim()) || "";
            const cargoRTDB = (data.cargo && String(data.cargo).trim()) || "";
            console.log(`[RTDB] Usuario encontrado en ${ruta}:`, { nombreRTDB, areaRTDB, cargoRTDB });
            return { nombreRTDB, areaRTDB, cargoRTDB, userRaw: data };
          }
        } catch (e) {
          console.warn(`[RTDB] No se pudo leer ${ruta}`, e);
        }
      }
      console.log("[RTDB] Usuario no encontrado por correo:", correo);
      return null;
    }

    /** Quita un ID de la cadena de responsables en RTDB */
    async function quitarIdDeResponsablesRTDB(db, ruta, idQuitar) {
      const r = ref(db, ruta);
      const snap = await get(r);

      let ids = [];
      if (snap.exists()) {
        const raw = snap.val();
        if (typeof raw === "string") ids = raw.split(",").map(s => s.trim()).filter(Boolean);
        else if (Array.isArray(raw)) ids = raw.map(x => String(x).trim()).filter(Boolean);
        else if (raw && typeof raw === "object") ids = Object.keys(raw).map(k => String(k).trim());
      }

      const before = ids.length;
      ids = ids.filter(x => x.toUpperCase() !== String(idQuitar).toUpperCase());
      await set(r, ids.join(", "));
      return { updated: ids.length !== before };
    }

    /** Listener delegado para botón eliminar dentro de cada card */
    (function bindEliminarResponsableCards() {
      if (window._delRespBound) return;
      const cont = document.getElementById("responsablesRow");
      if (!cont) return;
      cont.addEventListener("click", async (ev) => {
        const btn = ev.target.closest(".btn-del-resp");
        if (!btn) return;
        if (!window.esAdmin) {
          const msg = "Solo un administrador puede eliminar responsables.";
          if (window.Swal?.fire) await Swal.fire({ icon: "error", title: "Acceso denegado", text: msg, timer: 2000, showConfirmButton: false });
          else alert(msg);
          return;
        }
        const rid = btn.dataset.rid;
        if (!rid) return;

        const confirmar = async () => {
          if (window.Swal?.fire) {
            const { isConfirmed } = await Swal.fire({
              icon: "warning",
              title: "Quitar responsable",
              text: "Se quitará este responsable de la política (no se elimina de Firestore).",
              showCancelButton: true,
              confirmButtonText: "Sí, quitar",
              cancelButtonText: "Cancelar"
            });
            return isConfirmed;
          }
          return confirm("¿Quitar este responsable de la política?");
        };

        if (!(await confirmar())) return;

        btn.disabled = true;
        try {
          const { updated } = await quitarIdDeResponsablesRTDB(db, RUTA_RESPONSABLES_POLITICA, rid);
          if (updated) {
            // Quitar card del DOM
            const col = btn.closest(".col");
            if (col) col.remove();

            // Si no queda ninguna card, muestra vacío
            const cont2 = document.getElementById("responsablesRow");
            if (cont2 && !cont2.querySelector(".col")) {
              const emptyCol = document.createElement("div");
              emptyCol.className = "col";
              emptyCol.innerHTML = `<div class="text-muted small">Sin responsables asignados.</div>`;
              cont2.appendChild(emptyCol);
            }

            // Refrescar span
            if (typeof refrescarResponsablesPoliticaSpan === "function") {
              await refrescarResponsablesPoliticaSpan(db, dbFS, RUTA_RESPONSABLES_POLITICA);
            }

            if (window.Swal?.fire) {
              await Swal.fire({ icon: "success", title: "Responsable quitado", timer: 1400, showConfirmButton: false });
            }
          } else {
            if (window.Swal?.fire) {
              await Swal.fire({ icon: "info", title: "Sin cambios", text: "Ese ID no estaba en la política.", timer: 1400, showConfirmButton: false });
            }
          }
        } catch (e) {
          console.error("Error quitando responsable:", e);
          if (window.Swal?.fire) Swal.fire({ icon: "error", title: "Error", text: "No se pudo quitar el responsable." });
          else alert("No se pudo quitar el responsable.");
        } finally {
          btn.disabled = false;
        }
      });
      window._delRespBound = true;
    })();

    /******************** BLOQUE PRINCIPAL: LECTURA + RENDER ********************/
    try {
      const responsablesRef = ref(db, RUTA_RESPONSABLES_POLITICA);
      const snapResp = await get(responsablesRef);

      // 1) Normalizar a un array de IDs
      let responsablesIds = [];
      if (snapResp.exists()) {
        const raw = snapResp.val();

        if (typeof raw === "string") {
          responsablesIds = raw.split(",").map(s => s.trim()).filter(Boolean);
        } else if (Array.isArray(raw)) {
          responsablesIds = raw.map(x => String(x).trim()).filter(Boolean);
        } else if (raw && typeof raw === "object") {
          const byKeys = Object.keys(raw).map(k => String(k).trim());
          const byValues = Object.values(raw)
            .map(v => (v && typeof v === "object" && (v.id || v.ID || v.Id))
              ? String(v.id || v.ID || v.Id).trim()
              : null)
            .filter(Boolean);
          responsablesIds = Array.from(new Set([...byKeys, ...byValues]));
        }
      }

      console.log("[RESP] IDs normalizados:", responsablesIds);

      // 2) Para cada ID → leer FS (/responsables/{id}) para sacar correo y área.
      //    Con el correo, buscar nombre en RTDB (/usuarios/{correoSanitizado} o /PolariScore/usuarios/{...})
      let responsablesData = [];
      if (responsablesIds.length) {
        responsablesData = await Promise.all(
          responsablesIds.map(async (rid) => {
            try {
              const dref = doc(dbFS, "responsables", rid);
              const dsnap = await getDoc(dref);

              let areaFS = "", correoFS = "", nombreFS = "";
              if (dsnap.exists()) {
                const d = dsnap.data() || {};
                areaFS = d.area ? String(d.area).trim() : "";
                correoFS = d.correo ? String(d.correo).trim().toLowerCase() : "";
                nombreFS =
                  (d.nombre_completo && String(d.nombre_completo).trim()) ||
                  (d.nombre && String(d.nombre).trim()) ||
                  ((d.nombres && d.apellidos) ? `${String(d.nombres).trim()} ${String(d.apellidos).trim()}` : "");
              }

              // Buscar nombre en RTDB por correo (prioridad)
              let nombreRTDB = "", areaRTDB = "", cargoRTDB = "";
              if (correoFS) {
                const u = await leerUsuarioRTDBPorCorreo(db, correoFS);
                if (u) {
                  nombreRTDB = u.nombreRTDB;
                  areaRTDB = u.areaRTDB;
                  cargoRTDB = u.cargoRTDB;
                }
              }

              const nombreFinal = (nombreRTDB || nombreFS || rid).trim();
              const areaFinal = (areaRTDB || areaFS || "").trim();
              const correoFinal = correoFS;

              console.log(`[RESP] ${rid}:`, { correoFS, nombreRTDB, nombreFS, nombreFinal, areaFinal });

              return { id: rid, nombre: nombreFinal, area: areaFinal, correo: correoFinal };
            } catch (e) {
              console.warn("No se pudo leer Firestore para el responsable", rid, e);
              return { id: rid, nombre: rid, area: "", correo: "" };
            }
          })
        );
      }

      // 3) Actualizar el span (Nombre — Área)
      const spanResp = document.getElementById("responsablesPolitica");
      if (spanResp) {
        const displayList = (responsablesData.length ? responsablesData
          : responsablesIds.map(id => ({ id, nombre: "", area: "" })))
          .map(({ nombre, area, id }) => {
            const n = (nombre && String(nombre).trim()) || String(id);
            const a = area && String(area).trim();
            return a ? `${n} — ${a}` : n;
          });

        const texto = displayList.length ? displayList.join(", ") : "—";
        spanResp.textContent = texto;
        spanResp.setAttribute("title", texto);
      }

      // 4) Pintar cards
      const contenedor = document.getElementById("responsablesRow");
      const loadingEl = document.getElementById("responsablesLoading");
      if (loadingEl) loadingEl.remove();
      contenedor.innerHTML = "";

      const dataParaRender = responsablesData.length
        ? responsablesData
        : responsablesIds.map(id => ({ id, nombre: id, area: "", correo: "" }));

      if (!dataParaRender.length) {
        const col = document.createElement("div");
        col.className = "col";
        col.innerHTML = `<div class="text-muted small">Sin responsables asignados.</div>`;
        contenedor.appendChild(col);
      } else {
        dataParaRender.forEach(item => {
          const { id, nombre, area, correo } = item;

          // Iniciales para el avatar
          const initials = (() => {
            const base = (nombre && nombre.trim()) || (correo && correo.split("@")[0]) || id;
            const parts = base.split(/\s+/).filter(Boolean);
            const ini = (parts[0]?.[0] || "") + (parts[1]?.[0] || "");
            return (ini || base.slice(0, 2)).toUpperCase();
          })();

          // Col-Wrapper
          const col = document.createElement("div");
          col.className = "col";

          // Card
          const card = document.createElement("div");
          card.className = "card resp-card shadow-sm border-0 h-100";

          // Badge (absoluto)
          const badge = document.createElement("span");
          const esYo = (id && window.idResponsable &&
            String(id).toUpperCase() === String(window.idResponsable).toUpperCase());
          badge.className = `badge ${esYo ? "bg-primary" : "bg-success"} resp-badge`;
          badge.textContent = esYo ? "Tú" : "Líder";

          // Body
          const body = document.createElement("div");
          body.className = "card-body resp-body";

          // Avatar
          const avatar = document.createElement("div");
          avatar.className = "resp-avatar bg-secondary text-white flex-shrink-0";
          avatar.textContent = initials;

          // Meta
          const meta = document.createElement("div");
          meta.className = "resp-meta";

          const nameEl = document.createElement("div");
          nameEl.className = "resp-name text-truncate";
          nameEl.title = nombre || id;
          nameEl.textContent = nombre || id;
          meta.appendChild(nameEl);

          if (area) {
            const areaEl = document.createElement("div");
            areaEl.className = "text-muted small text-truncate";
            areaEl.title = area;
            areaEl.textContent = area;
            meta.appendChild(areaEl);
          }

          if (correo) {
            const mailEl = document.createElement("a");
            mailEl.className = "small d-block text-truncate";
            mailEl.href = `mailto:${correo}`;
            mailEl.title = correo;
            mailEl.textContent = correo;
            meta.appendChild(mailEl);
          }

          // Botón eliminar (solo admin)
          if (window.esAdmin) {
            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.className = "btn btn-sm btn-outline-danger resp-del btn-del-resp";
            delBtn.dataset.rid = id;
            delBtn.title = "Quitar de la política";
            delBtn.innerHTML = '<i class="fa fa-trash me-1"></i>';
            card.appendChild(delBtn);
          }

          // Ensamblar
          body.appendChild(avatar);
          body.appendChild(meta);
          card.appendChild(badge);
          card.appendChild(body);
          col.appendChild(card);
          contenedor.appendChild(col);
        });
      }
    } catch (err) {
      console.error("Error leyendo responsables de la política:", err);

      const spanResp = document.getElementById("responsablesPolitica");
      if (spanResp) spanResp.textContent = "—";

      const contenedor = document.getElementById("responsablesRow");
      if (contenedor) {
        contenedor.innerHTML = `
        <div class="col"><div class="text-danger small">No fue posible cargar los responsables.</div></div>
      `;
      }
    }

    /******************** OPCIONAL: refrescar span (reutilizable) ********************/
    async function refrescarResponsablesPoliticaSpan(db, dbFS, rutaRTDB) {
      const spanResp = document.getElementById("responsablesPolitica");
      const snap = await get(ref(db, rutaRTDB));

      let ids = [];
      if (snap.exists()) {
        const raw = snap.val();
        if (typeof raw === "string") ids = raw.split(",").map(s => s.trim()).filter(Boolean);
        else if (Array.isArray(raw)) ids = raw.map(x => String(x).trim()).filter(Boolean);
        else if (raw && typeof raw === "object") ids = Object.keys(raw).map(k => String(k).trim());
      }

      if (!ids.length) {
        if (spanResp) { spanResp.textContent = "—"; spanResp.title = "—"; }
        return;
      }

      const items = [];
      for (const rid of ids) {
        try {
          const dsnap = await getDoc(doc(dbFS, "responsables", rid));
          if (dsnap.exists()) {
            const d = dsnap.data() || {};
            const correo = (d.correo || "").toLowerCase();
            let nombre = (d.nombre_completo || d.nombre || "").trim();

            // Si tenemos correo, prioriza nombre desde RTDB
            if (correo) {
              const u = await leerUsuarioRTDBPorCorreo(db, correo);
              if (u?.nombreRTDB) nombre = u.nombreRTDB;
            }

            const area = (u?.areaRTDB || d.area || "").trim?.() || "";
            items.push(area ? `${nombre || rid} — ${area}` : (nombre || rid));
          } else {
            items.push(rid);
          }
        } catch {
          items.push(rid);
        }
      }

      const texto = items.join(", ");
      if (spanResp) {
        spanResp.textContent = texto || "—";
        spanResp.title = texto || "—";
      }
    }


    // (Opcional) Enlazar botón "Agregar" si existe
    (function bindAddResponsableButton() {
      const btn = document.getElementById('btnAddResponsable');
      if (!btn) return;
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        await asignarResponsablePorCorreo();
      });
    })();

    document.addEventListener('DOMContentLoaded', async () => {
      await refrescarResponsablesPoliticaSpan(db, dbFS, RUTA_RESPONSABLES_POLITICA);
    });

    async function crearResponsableFS(dbFS, email, newId) {
      assertFirestore(dbFS);
      const correo = String(email).trim().toLowerCase();

      if (esCompatFS(dbFS)) {
        await dbFS.collection('responsables').doc(newId).set({
          id: newId,
          correo,
          nombre_completo: '',
          area: '',
          creado_en: Date.now()
        }, { merge: true });
        return { id: newId, correo, nombre_completo: '', area: '' };
      }

      await setDoc(doc(dbFS, 'responsables', newId), {
        id: newId,
        correo,
        nombre_completo: '',
        area: '',
        creado_en: Date.now()
      }, { merge: true });

      return { id: newId, correo, nombre_completo: '', area: '' };
    }

    async function asignarResponsablePorCorreo() {
      try {
        if (!window.esAdmin) {
          const msg = 'Solo un administrador puede asignar responsables.';
          if (window.Swal?.fire) {
            await Swal.fire({ icon: 'error', title: 'Acceso denegado', text: msg, timer: 2200, showConfirmButton: false });
          } else {
            alert(msg);
          }
          return;
        }

        // Pedir correo
        let email = null;
        if (window.Swal?.fire) {
          const { value } = await Swal.fire({
            title: 'Agregar responsable',
            input: 'email',
            inputLabel: 'Correo del responsable',
            inputPlaceholder: 'nombre@institucion.edu.co',
            showCancelButton: true,
            confirmButtonText: 'Agregar',
            cancelButtonText: 'Cancelar',
            inputValidator: (val) => {
              if (!val) return 'Escribe un correo';
              const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
              return ok ? undefined : 'Correo inválido';
            }
          });
          email = value || null;
        } else {
          const t = prompt('Correo del responsable:');
          if (t && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)) email = t;
        }
        if (!email) return;

        // 1) Buscar por correo en FS
        let responsable = await buscarResponsablePorCorreoFS(dbFS, email);

        // 2) Si no existe, crear
        if (!responsable) {
          const nuevoId = generarIdCorto(6);
          responsable = await crearResponsableFS(dbFS, email, nuevoId);
        }

        // 3) Agregar ID a la cadena en RTDB
        const { updated, cadena } = await agregarIdAResponsablesRTDB(db, RUTA_RESPONSABLES_POLITICA, responsable.id);

        // 4) Feedback
        if (window.Swal?.fire) {
          await Swal.fire({
            icon: 'success',
            title: updated ? 'Responsable agregado' : 'Ya estaba asignado',
            text: updated
              ? `Se agregó ${responsable.correo} (ID: ${responsable.id}) a la política.`
              : `El responsable con ID ${responsable.id} ya estaba en la política.`,
            timer: 1800,
            showConfirmButton: false
          });
        }

        // 5) Refrescar el span con "Nombre — Área"
        await refrescarResponsablesPoliticaSpan(db, dbFS, RUTA_RESPONSABLES_POLITICA);

      } catch (e) {
        console.error('Error asignando responsable por correo:', e);
        if (window.Swal?.fire) {
          Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo asignar el responsable.' });
        } else {
          alert('No se pudo asignar el responsable.');
        }
      }
    }



    // ========= Enlazar el botón "Agregar responsable" por ID =========
    (function bindAddResponsableButton() {
      const btn = document.getElementById('btnAddResponsable');
      if (!btn) return;

      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        await asignarResponsablePorCorreo();
      });
    })();




    /* === Eliminar responsable (desvincular de la política) === */
    async function eliminarResponsableDePolitica(idResp, btnEl) {
      try {
        if (!window.esAdmin) {
          const msg = 'Solo un administrador puede eliminar responsables.';
          if (window.Swal?.fire) await Swal.fire({ icon: 'error', title: 'Acceso denegado', text: msg, timer: 2200, showConfirmButton: false });
          else alert(msg);
          return;
        }

        // Confirmación
        const confirmar = async () => {
          if (window.Swal?.fire) {
            const { isConfirmed } = await Swal.fire({
              icon: 'warning',
              title: 'Quitar responsable',
              text: 'Se quitará este responsable de la política (no se elimina de Firestore).',
              showCancelButton: true,
              confirmButtonText: 'Sí, quitar',
              cancelButtonText: 'Cancelar'
            });
            return isConfirmed;
          }
          return confirm('¿Quitar este responsable de la política?');
        };

        const ok = await confirmar();
        if (!ok) return;

        btnEl?.setAttribute('disabled', 'disabled');

        const { updated } = await quitarIdDeResponsablesRTDB(db, RUTA_RESPONSABLES_POLITICA, idResp);

        if (updated) {
          // Quitar card del DOM
          const col = btnEl?.closest('.col');
          if (col) col.remove();

          // Si no queda ninguna card, muestra “Sin responsables…”
          const cont = document.getElementById('responsablesRow');
          if (cont && !cont.querySelector('.col')) {
            const emptyCol = document.createElement('div');
            emptyCol.className = 'col';
            emptyCol.innerHTML = `<div class="text-muted small">Sin responsables asignados.</div>`;
            cont.appendChild(emptyCol);
          }

          // Refrescar el span con la lista
          if (typeof refrescarResponsablesPoliticaSpan === 'function') {
            await refrescarResponsablesPoliticaSpan(db, dbFS, RUTA_RESPONSABLES_POLITICA);
          }

          if (window.Swal?.fire) {
            await Swal.fire({ icon: 'success', title: 'Responsable quitado', timer: 1400, showConfirmButton: false });
          }
        } else {
          if (window.Swal?.fire) {
            await Swal.fire({ icon: 'info', title: 'No se realizaron cambios', text: 'Ese ID no estaba asignado.', timer: 1500, showConfirmButton: false });
          }
        }
      } catch (e) {
        console.error('Error al quitar responsable:', e);
        if (window.Swal?.fire) Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo quitar el responsable.' });
        else alert('No se pudo quitar el responsable.');
      } finally {
        btnEl?.removeAttribute('disabled');
      }
    }

    /* === Listener delegado sobre el row de cards === */
    (function bindEliminarResponsableCards() {
      const cont = document.getElementById('responsablesRow');
      if (!cont) return;
      cont.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.btn-del-resp');
        if (!btn) return;
        const rid = btn.dataset.rid;
        if (!rid) return;
        eliminarResponsableDePolitica(rid, btn);
      });
    })();


    // ========= Rutas =========
    // ========= Rutas =========
    const RUTA_COLABORADORES_POLITICA = `/PolariScore/politicas/${idPolitica}/colaboradores`; // ARRAY

    // ========= Utils =========



    function generarIdCorto(len = 6) {
      return Math.random().toString(36).slice(2, 2 + len).toUpperCase();
    }

    // Detecta si dbFS es compat (tiene .collection) o modular
    function esCompatFS(dbFS) {
      return !!(dbFS && typeof dbFS.collection === 'function');
    }

    function assertFirestore(dbFS) {
      if (!dbFS) throw new Error('Firestore (dbFS) no inicializado');
    }

    // Lee RUTA_RESPONSABLES_POLITICA, agrega idNuevo a la cadena (sin duplicar)
    async function agregarIdAResponsablesRTDB(db, ruta, idNuevo) {
      const r = ref(db, ruta);
      const snap = await get(r);

      let ids = [];
      if (snap.exists()) {
        const raw = snap.val();
        if (typeof raw === "string") ids = raw.split(",").map(s => s.trim()).filter(Boolean);
        else if (Array.isArray(raw)) ids = raw.map(x => String(x).trim()).filter(Boolean);
        else if (raw && typeof raw === "object") ids = Object.keys(raw).map(k => String(k).trim());
      }

      const up = String(idNuevo).toUpperCase();
      const exists = ids.some(x => String(x).toUpperCase() === up);

      if (!exists) {
        ids.push(idNuevo);
        await set(r, ids.join(", "));
      }

      return { updated: !exists, cadena: ids.join(", ") };
    }


    // Cache para no leer mil veces el mismo usuario RTDB
    const _cacheNombreRTDB = new Map();
    async function obtenerNombreRTDBPorCorreo(email) {
      if (!email) return undefined;
      const key = sanitizarCorreoParaKey(email);
      if (_cacheNombreRTDB.has(key)) return _cacheNombreRTDB.get(key);

      try {
        const snap = await get(ref(db, `/PolariScore/usuarios/${key}`));
        const nombre = snap.exists() ? (snap.val()?.nombre || snap.val()?.nombre_completo || snap.val()?.displayName) : undefined;
        const limpio = (typeof nombre === 'string' && nombre.trim()) ? nombre.trim() : undefined;
        _cacheNombreRTDB.set(key, limpio);
        return limpio;
      } catch {
        _cacheNombreRTDB.set(key, undefined);
        return undefined;
      }
    }

    function limitarTextoUI(s, n = 48) {
      if (!s) return "";
      return s.length > n ? s.slice(0, n - 1) + "…" : s;
    }

    // Lee IDs de RTDB que podrían venir en string/array/objeto
    function normalizarIdsDesdeRTDBValor(raw) {
      if (typeof raw === "string") {
        return raw.split(",").map(s => s.trim()).filter(Boolean);
      } else if (Array.isArray(raw)) {
        return raw.map(x => String(x).trim()).filter(Boolean);
      } else if (raw && typeof raw === "object") {
        return Object.keys(raw).map(k => String(k).trim());
      }
      return [];
    }

    // ========= RTDB: arrays seguros (transaction) =========
    async function agregarIdUnicoAArrayRTDB(ruta, idNuevo) {
      const rutaRef = ref(db, ruta);
      await runTransaction(rutaRef, (current) => {
        let arr = Array.isArray(current) ? current.slice() : normalizarIdsDesdeRTDBValor(current);
        if (!arr.find(x => String(x).toUpperCase() === String(idNuevo).toUpperCase())) {
          arr.push(idNuevo);
        }
        return arr; // <— se guarda explícitamente como ARRAY
      });
    }

    async function quitarIdDeArrayRTDB(ruta, idEliminar) {
      const rutaRef = ref(db, ruta);
      await runTransaction(rutaRef, (current) => {
        let arr = Array.isArray(current) ? current.slice() : normalizarIdsDesdeRTDBValor(current);
        return arr.filter(x => String(x).toUpperCase() !== String(idEliminar).toUpperCase());
      });
    }

    // ========= Firestore helpers =========
    async function buscarColaboradorPorCorreoFS(dbFS, email) {
      const correo = String(email).trim().toLowerCase();
      const qs = await getDocs(query(collection(dbFS, "colaboradores"), where("correo", "==", correo), limit(1)));
      if (!qs.empty) {
        const d = qs.docs[0];
        return { id: d.id, ...d.data() };
      }
      return null;
    }
    async function upsertColaboradorFS(dbFS, idCol, patch) {
      await setDoc(doc(dbFS, "colaboradores", idCol), patch, { merge: true });
    }

    async function buscarResponsablePorCorreoFS(dbFS, email) {
      const correo = String(email).trim().toLowerCase();
      const qs = await getDocs(query(collection(dbFS, "responsables"), where("correo", "==", correo), limit(1)));
      if (!qs.empty) {
        const d = qs.docs[0];
        return { id: d.id, ...d.data() };
      }
      return null;
    }
    async function upsertResponsableFS(dbFS, idResp, patch) {
      await setDoc(doc(dbFS, "responsables", idResp), patch, { merge: true });
    }

    // ========= Roles RTDB =========
    async function upsertRolColaboradorEnRTDB(db, email, { removerNormal = false } = {}) {
      const key = sanitizarCorreoParaKey(email);
      const uRef = ref(db, `/PolariScore/usuarios/${key}`);
      const snap = await get(uRef);
      if (!snap.exists()) return { exists: false };

      const userData = snap.val() || {};
      let roles = Array.isArray(userData.roles) ? userData.roles.map(String) : [];
      if (!roles.includes("colaborador-polariscore")) roles.push("colaborador-polariscore");
      if (removerNormal) roles = roles.filter(r => r !== "normal");
      await set(ref(db, `/PolariScore/usuarios/${key}/roles`), roles);
      return { exists: true, userData, rolesActualizados: roles };
    }

    // ========= INVITAR COLABORADOR (usa ARRAY en RTDB) =========
    async function invitarColaboradorPorCorreo() {
      try {
        const puede = !!(window.esAdmin || window.esUnResponsable);
        if (!puede) {
          const msg = "No tienes permisos para invitar colaboradores.";
          if (window.Swal?.fire) await Swal.fire({ icon: "error", title: "Acceso denegado", text: msg, timer: 1800, showConfirmButton: false });
          else alert(msg);
          return;
        }

        let email = null;
        if (window.Swal?.fire) {
          const { value } = await Swal.fire({
            title: "Invitar colaborador",
            input: "email",
            inputLabel: "Correo del colaborador",
            inputPlaceholder: "nombre@institucion.edu.co",
            showCancelButton: true,
            confirmButtonText: "Invitar",
            cancelButtonText: "Cancelar",
            inputValidator: (val) => {
              if (!val) return "Escribe un correo";
              return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val) ? undefined : "Correo inválido";
            }
          });
          email = value || null;
        } else {
          const t = prompt("Correo del colaborador:");
          if (t && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)) email = t;
        }
        if (!email) return;

        const emailLower = String(email).trim().toLowerCase();

        // Rol RTDB
        let usuarioRTDB = null;
        try {
          const resRol = await upsertRolColaboradorEnRTDB(db, emailLower);
          if (resRol.exists) usuarioRTDB = resRol.userData || null;
        } catch (e) { console.warn("No se pudo actualizar roles RTDB:", e); }

        const nombreRTDB = await obtenerNombreRTDBPorCorreo(emailLower);
        const areaRTDB = usuarioRTDB?.area ? String(usuarioRTDB.area).trim() : undefined;
        const cargoRTDB = usuarioRTDB?.cargo ? String(usuarioRTDB.cargo).trim() : undefined;

        // Firestore: /colaboradores
        let col = await buscarColaboradorPorCorreoFS(dbFS, emailLower);
        if (!col) {
          const nuevoId = generarIdCorto(6);
          await upsertColaboradorFS(dbFS, nuevoId, {
            id: nuevoId,
            correo: emailLower,
            ...(nombreRTDB ? { nombre: nombreRTDB, nombre_completo: nombreRTDB } : {}),
            ...(areaRTDB ? { area: areaRTDB } : {}),
            ...(cargoRTDB ? { cargo: cargoRTDB } : {}),
            creado_en: Date.now()
          });
          col = { id: nuevoId, correo: emailLower };
        } else {
          const patch = { correo: emailLower };
          if (nombreRTDB) { patch.nombre = nombreRTDB; patch.nombre_completo = nombreRTDB; }
          if (areaRTDB) patch.area = areaRTDB;
          if (cargoRTDB) patch.cargo = cargoRTDB;
          await upsertColaboradorFS(dbFS, col.id, patch);
        }

        // RTDB: agregar a ARRAY de colaboradores
        await agregarIdUnicoAArrayRTDB(RUTA_COLABORADORES_POLITICA, col.id);

        if (window.Swal?.fire) {
          await Swal.fire({ icon: "success", title: "Colaborador agregado", text: `Se agregó ${emailLower} (ID: ${col.id}).`, timer: 1600, showConfirmButton: false });
        }

        await refrescarResponsablesYColaboradoresUI();

      } catch (e) {
        console.error("Error invitando colaborador:", e);
        if (window.Swal?.fire) Swal.fire({ icon: "error", title: "Error", text: "No se pudo invitar al colaborador." });
        else alert("No se pudo invitar al colaborador.");
      }
    }

    // ========= Render unificado (Responsables + Colaboradores en el MISMO row) =========
    async function cargarResponsablesData() {
      // Responsables pueden seguir viniendo como string/array/objeto
      const snap = await get(ref(db, RUTA_RESPONSABLES_POLITICA));
      const ids = snap.exists() ? normalizarIdsDesdeRTDBValor(snap.val()) : [];

      const list = [];
      for (const rid of ids) {
        try {
          const dsnap = await getDoc(doc(dbFS, "responsables", rid));
          if (dsnap.exists()) {
            const d = dsnap.data() || {};
            const correo = d.correo ? String(d.correo).trim() : "";
            const nombreRT = await obtenerNombreRTDBPorCorreo(correo);
            const nombre = nombreRT
              || d.nombre_completo
              || d.nombre
              || ((d.nombres && d.apellidos) ? `${d.nombres} ${d.apellidos}` : rid);
            list.push({
              tipo: "responsable",
              id: rid,
              nombre,
              area: d.area ? String(d.area).trim() : "",
              correo
            });
          } else {
            list.push({ tipo: "responsable", id: rid, nombre: rid, area: "", correo: "" });
          }
        } catch {
          list.push({ tipo: "responsable", id: rid, nombre: rid, area: "", correo: "" });
        }
      }
      return list;
    }

    async function cargarColaboradoresData() {
      // Colaboradores: **array** en RTDB
      const snap = await get(ref(db, RUTA_COLABORADORES_POLITICA));
      let ids = [];
      if (snap.exists()) {
        const raw = snap.val();
        ids = Array.isArray(raw) ? raw : normalizarIdsDesdeRTDBValor(raw);
      }

      const list = [];
      for (const cid of ids) {
        try {
          const dsnap = await getDoc(doc(dbFS, "colaboradores", cid));
          if (dsnap.exists()) {
            const d = dsnap.data() || {};
            const correo = d.correo ? String(d.correo).trim() : "";
            const nombreRT = await obtenerNombreRTDBPorCorreo(correo);
            const nombre = nombreRT
              || d.nombre
              || d.nombre_completo
              || ((d.nombres && d.apellidos) ? `${d.nombres} ${d.apellidos}` : cid);

            list.push({
              tipo: "colaborador",
              id: cid,
              nombre,
              area: d.area ? String(d.area).trim() : "",
              correo
            });
          } else {
            list.push({ tipo: "colaborador", id: cid, nombre: cid, area: "", correo: "" });
          }
        } catch {
          list.push({ tipo: "colaborador", id: cid, nombre: cid, area: "", correo: "" });
        }
      }
      return list;
    }

    // Crea una card bonita como las de responsables
    function crearCardPersona({ tipo, id, nombre, area, correo }) {
      const contenedor = document.getElementById("responsablesRow");
      if (!contenedor) return;

      const initials = (() => {
        const base = (nombre && nombre.trim()) || (correo && correo.split("@")[0]) || id;
        const parts = base.split(/\s+/).filter(Boolean);
        const ini = (parts[0]?.[0] || '') + (parts[1]?.[0] || '');
        return (ini || base.slice(0, 2)).toUpperCase();
      })();

      const col = document.createElement("div");
      col.className = "col";

      const card = document.createElement("div");
      card.className = "card resp-card shadow-sm border-0 h-100";

      // Badge
      const badge = document.createElement("span");
      const esYo = (id && window.idResponsable && String(id).toUpperCase() === String(window.idResponsable).toUpperCase());
      if (tipo === "responsable") {
        badge.className = `badge ${esYo ? "bg-primary" : "bg-success"} resp-badge`;
        badge.textContent = esYo ? "Tú" : "Líder";
      } else {
        badge.className = "badge bg-info resp-badge";
        badge.textContent = "Colaborador";
      }

      // Body
      const body = document.createElement("div");
      body.className = "card-body resp-body";

      const avatar = document.createElement("div");
      avatar.className = "resp-avatar bg-secondary text-white flex-shrink-0";
      avatar.textContent = initials;

      const meta = document.createElement("div");
      meta.className = "resp-meta";

      const nameEl = document.createElement("div");
      nameEl.className = "resp-name text-truncate";
      nameEl.title = nombre || id;
      nameEl.textContent = nombre || id;
      meta.appendChild(nameEl);

      if (area) {
        const areaEl = document.createElement("div");
        areaEl.className = "text-muted small text-truncate";
        areaEl.title = area;
        areaEl.textContent = area;
        meta.appendChild(areaEl);
      }

      if (correo) {
        const mailEl = document.createElement("a");
        mailEl.className = "small d-block text-truncate";
        mailEl.href = `mailto:${correo}`;
        mailEl.title = correo;
        mailEl.textContent = correo;
        meta.appendChild(mailEl);
      }

      // Botón eliminar
      if (window.esAdmin) {
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn btn-sm btn-outline-danger resp-del";
        delBtn.dataset.tipo = tipo;   // "responsable" o "colaborador"
        delBtn.dataset.id = id;
        delBtn.title = tipo === "colaborador" ? "Quitar colaborador de la política" : "Quitar líder de la política";
        delBtn.innerHTML = '<i class="fa fa-trash"></i>';
        card.appendChild(delBtn);
      }

      body.appendChild(avatar);
      body.appendChild(meta);
      card.appendChild(badge);
      card.appendChild(body);
      col.appendChild(card);
      contenedor.appendChild(col);
    }

    async function refrescarResponsablesYColaboradoresUI() {
      const cont = document.getElementById("responsablesRow");
      const loadingEl = document.getElementById('responsablesLoading');
      if (loadingEl) loadingEl.remove();
      if (cont) cont.innerHTML = "";

      // Cargar ambos
      const [resp, colab] = await Promise.all([
        cargarResponsablesData(),
        cargarColaboradoresData()
      ]);

      const data = [...resp, ...colab];

      if (!data.length) {
        const col = document.createElement("div");
        col.className = "col";
        col.innerHTML = `<div class="text-muted small">Sin responsables ni colaboradores.</div>`;
        cont.appendChild(col);
      } else {
        data.forEach(item => crearCardPersona(item));
      }
    }

    // Delegación para eliminar
    document.getElementById("responsablesRow")?.addEventListener("click", async (e) => {
      const btn = e.target.closest(".resp-del");
      if (!btn) return;

      const tipo = btn.dataset.tipo; // "responsable" / "colaborador"
      const id = btn.dataset.id;

      if (!id || !tipo) return;

      const confirmar = window.Swal?.fire
        ? await Swal.fire({ icon: "warning", title: "¿Quitar?", text: `¿Deseas quitar este ${tipo} de la política?`, showCancelButton: true, confirmButtonText: "Sí, quitar", cancelButtonText: "Cancelar" }).then(r => r.isConfirmed)
        : confirm(`¿Quitar ${tipo}?`);

      if (!confirmar) return;

      try {
        if (tipo === "colaborador") {
          await quitarIdDeArrayRTDB(RUTA_COLABORADORES_POLITICA, id);
        } else {
          // Responsables: puede que estén en string; quitamos y escribimos el string/array resultante
          const snap = await get(ref(db, RUTA_RESPONSABLES_POLITICA));
          let ids = snap.exists() ? normalizarIdsDesdeRTDBValor(snap.val()) : [];
          ids = ids.filter(x => String(x).toUpperCase() !== String(id).toUpperCase());
          // Mantén tu formato original (string con comas) para compat
          await set(ref(db, RUTA_RESPONSABLES_POLITICA), ids.join(", "));
        }

        if (window.Swal?.fire) await Swal.fire({ icon: "success", title: "Eliminado", timer: 1200, showConfirmButton: false });

        await refrescarResponsablesYColaboradoresUI();
      } catch (err) {
        console.error("No se pudo eliminar:", err);
        if (window.Swal?.fire) Swal.fire({ icon: "error", title: "Error", text: "No se pudo eliminar." });
        else alert("No se pudo eliminar.");
      }
    });

    // ====== Hook del botón "Invitar colaborador" ======
    document.getElementById("btnInvitarColaborador")?.addEventListener("click", (e) => {
      e.preventDefault();
      invitarColaboradorPorCorreo();
    });

    // ====== LLAMADA INICIAL (cuando cargue la página / después de setear esAdmin/esUnResponsable) ======
    (async () => {
      try {
        await refrescarResponsablesYColaboradoresUI();
      } catch (e) { console.warn("No se pudieron cargar responsables/colaboradores:", e); }
    })();




    const $chkSub = document.getElementById('chkSubPolitica');
    const $lblEstado = document.getElementById('estadoSuscrito');
    const politicaId = String(window.politica_id || '').trim();

    // Helper: sanitizar correo (misma regla que ya usas)
    const sanitizeEmail = (email) => String(email || '').replace(/\./g, '_');

    // Normaliza el valor leído en RTDB a array de strings único
    function normalizeSubs(value) {
      if (Array.isArray(value)) {
        return [...new Set(value.map(v => String(v || '').trim()).filter(Boolean))];
      }
      if (value && typeof value === 'object') {
        // si lo guardaron como objeto { "P-001": true, "P-002": true }
        return Object.keys(value).map(k => String(k || '').trim()).filter(Boolean);
      }
      return [];
    }

    // Devuelve la ruta al nodo de suscripciones del usuario
    function userSubsRefFor(email) {
      const correoSanitizado = sanitizeEmail(email);
      return ref(db, `usuarios/${correoSanitizado}/PolariScore/politicas-suscritas`);
    }

    // Escribe (suscribe/desuscribe) con runTransaction
    async function toggleSubscription(user, subscribe) {
      const refSubs = userSubsRefFor(user.email); // ruta en RTDB
      await runTransaction(refSubs, (current) => {
        const lista = normalizeSubs(current); // normaliza array u objeto en array limpio
        const i = lista.indexOf(politicaId);

        if (subscribe) {
          // Si marcó el checkbox y aún no estaba suscrito -> agregar
          if (i === -1) lista.push(politicaId);
        } else {
          // Si desmarcó el checkbox y sí estaba suscrito -> quitar
          if (i !== -1) lista.splice(i, 1);
        }

        return lista; // siempre devolvemos un array normalizado
      });
    }


    // Lee suscripciones y refleja en UI (usa el elemento que le pases)
    async function initCheckboxState(user, el, labelEl) {
      try {
        const snap = await get(userSubsRefFor(user.email));
        const lista = normalizeSubs(snap.val());
        const suscrito = politicaId && lista.includes(politicaId);
        el.checked = !!suscrito;
        if (labelEl) labelEl.textContent = suscrito ? "Suscrito" : "Suscribirme a la política";
      } catch (e) {
        console.warn('[suscripción] No se pudo leer suscripciones:', e);
        el.checked = false;
        if (labelEl) labelEl.textContent = "Suscribirme a la política";
      } finally {
        el.disabled = false; // habilitar con el estado inicial correcto
      }
    }

    // Listener del checkbox (usa el elemento que le pases)
    function attachCheckboxHandler(user, el, labelEl) {
      el.addEventListener('change', async (ev) => {
        if (!politicaId) {
          console.warn('[suscripción] política_id no definido.');
          ev.target.checked = false;
          if (labelEl) labelEl.textContent = "Suscribirme a la política";
          return;
        }
        el.disabled = true; // bloquear mientras escribe
        try {
          await toggleSubscription(user, ev.target.checked);
          if (labelEl) {
            labelEl.textContent = ev.target.checked ? "Suscrito" : "Suscribirme a la política";
          }
        } catch (e) {
          console.error('[suscripción] Error escribiendo suscripción:', e);
          // revertir UI si falla
          ev.target.checked = !ev.target.checked;
          if (labelEl) {
            labelEl.textContent = ev.target.checked ? "Suscrito" : "Suscribirme a la política";
          }
        } finally {
          el.disabled = false;
        }
      });
    }

    // Bootstrap de la característica
    (function initSuscripcionPolitica() {
      const prev = document.getElementById('chkSubPolitica');
      const labelEl = document.getElementById('estadoSuscrito');
      if (!prev) return;

      if (!politicaId) {
        console.warn('[suscripción] No hay window.politica_id; deshabilitando checkbox.');
        prev.disabled = true;
        if (labelEl) labelEl.textContent = "Suscribirme a la política";
        return;
      }

      // Clonar para evitar listeners previos y trabajar siempre con el nodo actual
      const cloned = prev.cloneNode(true);
      prev.parentNode.replaceChild(cloned, prev);
      const $chk = document.getElementById('chkSubPolitica');

      // Estado base hasta saber sesión/RTDB
      $chk.checked = false;
      $chk.disabled = true;
      if (labelEl) labelEl.textContent = "Suscribirme a la política";

      const handleNoSessionClick = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        window.location.href = "../pages/sign-in.html";
      };
      // En no-auth usaremos este, y lo quitaremos cuando haya sesión
      $chk.addEventListener('click', handleNoSessionClick, { once: true });

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // Sin sesión: deja habilitado para capturar click de redirección
          $chk.disabled = false;
          if (labelEl) labelEl.textContent = "Suscribirme a la política";
          return;
        }

        // Hay usuario: quitar redirección y preparar estado real
        $chk.removeEventListener('click', handleNoSessionClick);
        $chk.disabled = true; // bloqueado mientras leemos RTDB

        await initCheckboxState(user, $chk, labelEl); // set checked + label
        attachCheckboxHandler(user, $chk, labelEl);   // toggle con actualización de label
      });
    })();
  </script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="../assets/js/plugins/chartjs.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <!-- Librería ECharts oficial -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- Tu theme personalizado -->
  <script src="../assets/js/polariscore-charts.js"></script>

  <script src="../assets/js/argon-dashboard.js"></script>


  <script>
    // Función para hacer scroll suave a una sección basada en su ID
    function scrollToSection(sectionId) {
      const seccion = document.getElementById(sectionId);
      seccion.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
    }

    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }

    const BARRA_COLORES_OBJETIVO = [
      '#26cf66',  // Verde
      '#4093ff',  // Azul
      '#ff8c32',  // Naranja
      '#f25f5c',  // Rojo
      '#662e9b',  // Morado
      '#00594E'   // Verde Unitrópico
    ];

  </script>

  <style>
    .obj-year-track {
      width: 100%;
      height: 8px;
      border-radius: 6px;
      background: #e9ecef;
      overflow: hidden;
    }

    .obj-year-fill {
      height: 100%;
      /* color por inline style (usa tu `color`) */
      opacity: .95;
      transition: width .3s ease;
    }


    .resp-del {
      position: absolute;
      bottom: .1rem;
      left: 1.1rem;
      z-index: 2;
    }

    .year-current-th {
      position: relative;
      background: #fffdf5;
      /* leve highlight en el header */
      border-radius: 6px;
    }

    .year-chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      font-size: .75rem;
      padding: .15rem .5rem;
      border-radius: 999px;
      background: #fff3cd;
      /* warning-subtle */
      color: #b58100;
      /* warning text */
      border: 1px solid #ffe69c;
    }

    :root {
      --year-accent: #0d6efd;
      /* azul institucional bootstrap */
      --year-accent-25: #0d6efd40;
      /* 25% */
      --year-accent-10: #0d6efd1a;
      /* 10% */
      --year-accent-06: #0d6efd0f;
      /* 6%  */
    }

    /* Cabecera del año actual */
    .year-current-th {
      position: relative;
      background: linear-gradient(180deg, #fff, #f7faff);
      border: 1px solid var(--year-accent-25) !important;
      border-radius: 10px;
      box-shadow: inset 0 0 0 1px #fff, 0 4px 12px rgba(13, 110, 253, .08);
    }

    .year-current-th .year-chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .18rem .5rem;
      border-radius: 999px;
      font-size: .7rem;
      background: var(--year-accent-10);
      color: var(--year-accent);
      border: 1px solid var(--year-accent-25);
    }

    /* Celdas del año actual */
    .year-current-td {
      background: linear-gradient(180deg, #fff, #fbfdff);
      position: relative;
      border-left: 2px solid var(--year-accent-10);
    }

    .year-current-td::before {
      content: "";
      position: absolute;
      inset: -1px 0 -1px auto;
      width: 4px;
      background: linear-gradient(180deg, var(--year-accent-25), transparent 60%);
      border-radius: 0 8px 8px 0;
    }

    /* Sutil mejora a las barritas (no cambia tus colores) */
    .barra-anual {
      border: 1px solid #e8eef6;
      background: #f3f7fc !important;
    }

    .barra-llena-anual {
      border-radius: 6px;
    }

    /* Sutil línea entre filas */
    .tr-acciones {
      border-bottom: 1px solid #eef2f7 !important;
    }

    /* Contenedor que se estira */
    .obj-head .barra-objetivo {
      min-width: 220px;
      /* no baja de esto */
      max-width: 640px;
      /* límite para pantallas grandes */
    }

    /* Pista con rejilla sutil para legibilidad */
    .barra-track {
      position: relative;
      width: 100%;
      height: 18px;
      border-radius: 10px;
      overflow: hidden;
      background:
        linear-gradient(90deg, rgba(0, 0, 0, 0.04) 0 1px, transparent 1px) 0 0/32px 100%,
        #eef3f7;
      border: 1px solid #d8e1ea;
    }

    /* Relleno (avance proporcional) con ligera animación */
    .barra-fill {
      height: 100%;
      border-radius: 10px 0 0 10px;
      transition: width .35s ease;
    }

    /* Marcador del peso: línea y tag */
    .barra-peso {
      position: absolute;
      top: -2px;
      height: calc(100% + 4px);
      width: 0;
    }

    .barra-peso::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #6b7a8a;
      opacity: .8;
      transform: translateX(-1px);
    }

    .barra-peso-tag {
      position: absolute;
      top: -28px;
      transform: translateX(-50%);
      background: #f7fafc;
      color: #ffffff;
      border: 1px solid #d8e1ea;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      white-space: nowrap;
    }

    /* Etiqueta del avance; si hay poco espacio, aparece fuera a la derecha */
    .barra-label {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: 700;
      color: transparent;
      text-shadow: 0 1px 0 rgba(255, 255, 255, .45);
      /* fallback de contraste cuando el fill es ancho: en ese caso, color cambia a blanco dinámicamente con JS si quieres */
    }

    /* Ajuste en pantallas pequeñas: la barra manda, ocultamos textos secundarios */
    @media (max-width: 576px) {
      .obj-head .barra-objetivo {
        min-width: 160px;
      }

      .barra-peso-tag {
        display: none;
      }
    }

    /* Opcionales para mejor look & feel */
    .obj-head .small {
      line-height: 1;
    }

    .action-card {
      border: 1px solid #e8edf3;
      border-radius: 12px;
      padding: .75rem .9rem;
      margin-bottom: .75rem;
      background: #fff;
    }

    .action-title a {
      text-decoration: none;
    }

    .year-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: .2rem 0;
    }

    .year-label {
      width: 64px;
      font-size: .9rem;
      color: #666;
    }

    .year-badge {
      border-radius: 999px;
      padding: .15rem .5rem;
      color: #212529;
    }

    .year-bar {
      width: 130px;
      height: 10px;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
    }

    .year-fill {
      height: 100%;
    }

    .table-wrap {
      overflow-x: auto;
    }

    /* Aplicar estilos solo a la tabla con el id tableObjetivos_ */
    #tableObjetivos_ {
      width: 100%;
      /* Hacer que la tabla ocupe el 100% del ancho del contenedor */
      table-layout: fixed;
      /* Hacer que las celdas tengan un ancho fijo */
      border-collapse: collapse;
      /* Combina bordes adyacentes entre celdas */
    }

    .tr-acciones:hover {
      background-color: #02dac12b;
    }

    #tableObjetivos_ th,
    #tableObjetivos_ td {
      padding: 8px;
      /* Espaciado interno (padding) */
      text-align: justify;
      /* Justificar el texto */
      vertical-align: top;
      /* Alinear el texto en la parte superior */
      border: 1px solid #ddd;
      /* Aplicar bordes entre las celdas */
      border-top: none;
      /* Eliminar el borde superior */
      border-left: none;
      /* Eliminar el borde izquierdo */
      word-wrap: break-word;
      /* Permitir que las palabras largas se rompan y ajusten */
      white-space: normal;
      /* Permitir saltos de línea en el texto */
      font-size: 0.8em;
    }

    /* Estilos para las cabeceras */
    #tableObjetivos_ th {
      background-color: #f2f2f2;
      /* Color de fondo de los encabezados */
      border: 1px solid #ddd;
      /* Aplicar bordes internos para las cabeceras */
      border-left: none;
      /* Sin borde izquierdo */
      border-top: none;
      /* Sin borde superior */
    }



    #tableObjetivos_ td:last-child,
    #tableObjetivos_ th:last-child {
      border-right: none;
      /* Eliminar el borde derecho de la última columna */
    }

    #tableObjetivos_ tr {
      line-height: 1.5;
      /* Ajustar la altura de línea */
    }

    /* Agrega un overlay con el degradado */
    #carrusel_img .carousel-item::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 50%);
      z-index: 1;
    }

    /* Imágenes del carrusel */
    #carrusel_img .carousel-item img {
      display: block;
      width: 100%;
      height: auto;
      opacity: 1;
      z-index: 0;
      /* Asegura que la imagen esté detrás del overlay */
    }

    /* Texto en el carrusel */
    #carrusel_img .carousel-caption {
      position: absolute;
      z-index: 2;
      /* Asegura que el texto esté sobre el overlay */
      color: white;
    }

    #progresoContainer {
      width: 100%;
      max-width: 600px;
      /* Ajusta según sea necesario */
      margin: auto;
      /* Centrar */

    }

    .fixed-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #00594e;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      border: none;
      border-radius: 4px;
      z-index: 1000;
    }

    .fixed-btn:hover {
      background-color: #00453e;
      /* Un tono más oscuro al hacer hover */
    }

    .sort-icon {
      cursor: pointer;
      margin-left: 5px;
      color: #6c757d;
      /* Color gris inicial */
      transition: color 0.3s ease;
      font-size: 0.7rem;
      /* o el tamaño que prefieras */
      margin-left: 3px;
    }

    .sort-icon:hover {
      color: #b5a160;
      /* Color primary en hover */
    }
  </style>

  <style>
    /* Contenedor de importancia en el header */
    .obj-head {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-left: auto;
    }

    .obj-head .barra-programacion {
      height: 20px;
      min-width: 90px;
      border-radius: 12px;
      background: rgba(0, 0, 0, .06);
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, .06);
    }

    .obj-head .barra-llena {
      height: 100%;
      border-radius: 12px;
      transition: width .8s cubic-bezier(.42, 1.1, .78, 1.2);
    }

    /* Barras anuales (desktop) */
    .barra-anual {
      height: 14px;
      width: 72px;
      border-radius: 8px;
      background: rgba(0, 0, 0, .06);
      overflow: hidden;
    }

    .barra-llena-anual {
      height: 100%;
      border-radius: 8px;
      transition: width .6s cubic-bezier(.42, 1.1, .78, 1.2);
    }

    /* Tarjetas móviles de acción */
    .action-card {
      border: 1px solid rgba(0, 0, 0, .08);
      border-radius: 12px;
      padding: .75rem;
      margin-bottom: .75rem;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .04);
    }

    .action-title {
      font-size: .95rem;
      font-weight: 600;
    }

    .action-meta {
      font-size: .8rem;
      opacity: .8;
    }

    .year-row {
      display: grid;
      grid-template-columns: 84px 1fr auto;
      gap: .5rem;
      align-items: center;
      margin-top: .35rem;
    }

    .year-label {
      font-size: .8rem;
      color: #666;
    }

    .year-badge {
      font-size: .85rem;
      padding: .2rem .6rem;
      border-radius: 999px;
      background: rgba(0, 0, 0, .08);
    }

    .year-bar {
      height: 12px;
      width: 100%;
      border-radius: 999px;
      background: rgba(0, 0, 0, .06);
      overflow: hidden;
    }

    .year-fill {
      height: 100%;
      border-radius: 999px;
      transition: width .6s cubic-bezier(.42, 1.1, .78, 1.2);
    }

    /* Ajustes del header del acordeón en móvil */
    @media (max-width: 767.98px) {
      .accordion-button .obj-head {
        margin-left: 0;
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        margin-top: .35rem;
      }

      .accordion-button {
        flex-direction: column;
        align-items: flex-start;
      }

      .obj-head .barra-programacion {
        height: 16px;
        min-width: 120px;
      }

      .obj-head .barra-llena {
        border-radius: 10px;
      }

      .barra-anual {
        height: 12px;
        width: 64px;
      }
    }

    /* En desktop, tabla scroll horizontal con sticky header opcional */
    .table-wrap {
      overflow-x: auto;
    }

    .table thead th {
      white-space: nowrap;
    }
  </style>



</body>

</html>