<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga de Evidencias - PolariScore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://kit.fontawesome.com/aa4ade8d2d.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="icon" type="image/png" href="../assets/img/polariscore/icono.png">
    <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link id="pagestyle" href="../assets/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />


</head>

<body>


    <!-- Modal de advertencia de inicio de sesi√≥n -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-labelledby="loginRequiredModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title text-white" id="loginRequiredModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> Inicio de sesi√≥n requerido
                    </h5>
                </div>
                <div class="modal-body">
                    Para acceder al m√≥dulo de carga de evidencias necesitas haber iniciado sesi√≥n. Por favor, inicia
                    sesi√≥n o vuelve al inicio.
                </div>
                <div class="modal-footer">
                    <a href="dashboard.html" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Ir al inicio
                    </a>
                    <button id="btnIniciarSesionModal" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Iniciar sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        html,
        body {
            height: 80%;
            width: 100%;
            margin: 0;
            padding: 0;
            background: #f5f7fa url('../assets/img/polariscore/bg-wizard.png') no-repeat center center fixed !important;
            background-size: cover;
        }

        .container.min-vh-100 {
            min-height: 88vh !important;
            min-width: 100vw !important;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent !important;
        }

        .wizard-card-glass {
            width: 75vw;
            height: 75vh;
            min-height: 430px;
            max-width: 1200px;
            max-height: 860px;
            background: rgba(255, 255, 255, 0.89);
            box-shadow: 0 8px 40px #00594e30, 0 1px 16px #b5a16012;
            border-radius: 26px;
            border: 1px solid #b5a16022;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            /* backdrop-filter glass effect */
            backdrop-filter: blur(8px) saturate(160%);
            -webkit-backdrop-filter: blur(8px) saturate(160%);
        }

        #wizardIlustracion,
        #wizardContenido {
            flex: 1 1 50%;
            width: 50%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 2.5vw;
        }

        #wizardIlustracion {
            background: rgba(255, 255, 255, 0.82);
            /* No border, no border-right, solo glass effect */
            box-shadow: inset -3px 0 16px 0 rgba(181, 161, 96, 0.03);
        }

        #wizardContenido {
            background: rgba(255, 255, 255, 0.88);
            align-items: flex-start;
            justify-content: center;
            padding: 40px 3vw 40px 2vw;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .wizard-card-glass {
                flex-direction: column;
                width: 99vw;
                height: auto;
                min-height: 500px;
                max-width: 99vw;
            }

            #wizardIlustracion,
            #wizardContenido {
                width: 100%;
                min-height: 200px;
                padding: 24px 6vw;
            }

            #wizardContenido {
                align-items: center;
            }
        }

        /* Progress bar moderna */
        .progress {
            background: #e7f3ef;
            border-radius: 8px;
            height: 15px;
            width: 400px;
            max-width: 90vw;
        }

        .progress-bar {
            background: linear-gradient(90deg, #07dcc3, #00594e 90%);
            border-radius: 8px;
            transition: width 0.5s cubic-bezier(.4, 2, .2, 1);
        }

        .imgIlustracionWizard {
            width: 95%;
            max-width: 400px;
        }

        /* FORMULARIO WIZARD GLASS-MINIMAL */

        #wizardContenido form {
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin-top: 0;
        }

        #wizardContenido .form-label {
            font-weight: 600;
            color: #00594e;
            margin-bottom: 4px;
            letter-spacing: .02em;
            font-size: 1em;
        }

        #wizardContenido .form-select,
        #wizardContenido textarea.form-control {
            border-radius: 8px;
            border: 1.1px solid #cfe3de;
            background: #f8fafb;
            font-size: 1em;
            padding: 7px 12px;
            margin-bottom: 9px;
            transition: border-color .22s;
            min-height: 38px;
        }

        #wizardContenido .form-select:focus,
        #wizardContenido textarea.form-control:focus {
            border-color: #B5A160;
            box-shadow: 0 0 0 1.5px #b5a16025;
        }

        /* Dropzone */
        #dropzoneWizard {
            background: linear-gradient(120deg, #e7f3ef 60%, #fffde9 100%);
            border: 2px dashed #B5A160;
            border-radius: 10px;
            min-height: 70px;
            cursor: pointer;
            transition: border-color .18s, background .18s;
            padding: 18px 10px 10px 10px;
            margin-bottom: 7px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #dropzoneWizard:hover,
        #dropzoneWizard.dragover {
            background: linear-gradient(120deg, #fffde9 60%, #e7f3ef 100%);
            border-color: #00594E;
        }

        #dropzoneWizard .fa-cloud-upload-alt {
            color: #00594E;
            font-size: 2em;
            margin-bottom: 0;
        }

        #dropzoneWizard p {
            font-size: 0.97em;
            color: #5c6770;
            margin-bottom: 0;
        }

        #listaArchivosWizard {
            margin-top: 6px;
        }

        #listaArchivosWizard .archivo-item {
            background: #f2f8f6;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 0.98em;
            color: #222;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #e8ecea;
        }

        @media (max-width: 600px) {

            #wizardContenido .form-select,
            #wizardContenido textarea.form-control {
                font-size: 0.98em;
                padding: 6px 7px;
            }

            #dropzoneWizard {
                padding: 12px 2px 6px 2px;
            }
        }

        .user-profile-widget {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .user-profile-trigger {
            background: rgba(255, 255, 255, 0.75);
            box-shadow: 0 2px 18px #00594e18;
            border: 1px solid #e0e6e6;
            font-size: 1em;
            transition: background .2s, box-shadow .2s, color .2s;
        }

        .user-profile-trigger:hover,
        .user-profile-trigger:focus {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 22px #00594e1c;
            color: #00594E;
        }

        .user-profile-trigger img {
            border: 2.5px solid #B5A16033;
        }

        .user-dropdown-glass {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(13px) saturate(150%);
            border-radius: 18px;
            box-shadow: 0 8px 30px #00594e28, 0 1px 10px #b5a16012;
            border: 1px solid #f3efe6;
        }

        .user-dropdown-glass .dropdown-item {
            font-size: 1em;
            border-radius: 10px;
            transition: background .17s, color .17s;
        }

        .user-dropdown-glass .dropdown-item:hover,
        .user-dropdown-glass .dropdown-item:focus {
            background: #00594e28 !important;
            color: #fff !important;
        }

        .user-dropdown-glass .dropdown-item.text-danger:hover,
        .user-dropdown-glass .dropdown-item.text-danger:focus {
            background: #dc3545 !important;
            color: #fff !important;
        }

        .user-dropdown-glass .dropdown-item.text-primary:hover,
        .user-dropdown-glass .dropdown-item.text-primary:focus {
            background: #e7f3ef !important;
            color: #00594e !important;
        }

        .user-dropdown-glass hr.dropdown-divider {
            margin: 6px 0;
            border-top: 1px solid #e7f3ef;
        }

        @media (max-width: 600px) {
            .user-profile-widget {
                margin-right: 0 !important;
            }

            .user-profile-trigger span {
                display: none !important;
            }
        }

        .wizard-fade-in {
            animation: wizardFadeIn .65s cubic-bezier(.33, 1, .68, 1) both;
        }

        @keyframes wizardFadeIn {
            0% {
                opacity: 0;
                transform: translateY(36px) scale(.97);
                filter: blur(2px);
            }

            100% {
                opacity: 1;
                transform: none;
                filter: none;
            }
        }

        .wizard-slide-left {
            animation: wizardSlideLeft .7s cubic-bezier(.33, 1, .68, 1) both;
        }

        @keyframes wizardSlideLeft {
            from {
                opacity: 0;
                transform: translateX(60px) scale(.97);
                filter: blur(2px);
            }

            to {
                opacity: 1;
                transform: none;
                filter: none;
            }
        }

        .wizard-slide-right {
            animation: wizardSlideRight .7s cubic-bezier(.33, 1, .68, 1) both;
        }

        @keyframes wizardSlideRight {
            from {
                opacity: 0;
                transform: translateX(-60px) scale(.97);
                filter: blur(2px);
            }

            to {
                opacity: 1;
                transform: none;
                filter: none;
            }
        }

        .wizard-bounce {
            animation: wizardBounce 1.5s infinite alternate cubic-bezier(.66, 0, 0, 1);
        }

        @keyframes wizardBounce {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-12px);
            }
        }

        .archivo-item {
            animation: archivoFadeIn .35s;
        }

        @keyframes archivoFadeIn {
            from {
                opacity: 0;
                transform: translateY(18px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }
    </style>

    <!-- Fila superior: logo izquierda, progress bar centrada, perfil derecha -->
    <div class="d-flex align-items-center justify-content-between w-100 px-4 pt-4 mb-2" style="gap: 0;">
        <!-- Logo S-PLAN a la izquierda -->
        <a href="dashboard.html" class="d-flex align-items-center me-3" style="text-decoration: none;">
            <img src="../assets/img/polariscore/logo.png" alt="PolariScore"
                style="height: 50px; width: auto; border-radius: 10px; ">

        </a>
        <!-- Progress bar centrada (flex-grow para centrar) -->
        <div class="flex-grow-1 d-flex justify-content-center">
            <div class="progress" style="width: 100%; max-width: 540px;">
                <div id="barraProgreso" class="progress-bar" role="progressbar"></div>
            </div>
        </div>
        <!-- Widget de usuario a la derecha -->
        <div class="user-profile-widget ms-3" style="z-index:1031;">
            <div id="perfilUsuario"
                class="d-flex align-items-center gap-2 rounded-pill py-1 px-2 bg-white bg-opacity-70 shadow-sm border user-profile-trigger"
                data-bs-toggle="dropdown" role="button" aria-expanded="false" style="cursor:pointer; min-width:170px;">
                <img id="imgPerfilUsuario" src="https://ui-avatars.com/api/?name=Usuario" alt="Foto de perfil"
                    class="rounded-circle border" width="40" height="40" style="object-fit:cover;">
                <span class="fw-semibold text-dark d-none d-md-inline" id="nombrePerfilUsuarioBarra">Usuario</span>
                <i class="fas fa-chevron-down text-muted ms-1"></i>
            </div>
            <ul class="dropdown-menu dropdown-menu-end user-dropdown-glass px-2 py-3" aria-labelledby="perfilUsuario"
                style="min-width: 240px;">
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2 rounded-3" href="../pages/profile.html">
                        <img id="imgPerfilUsuarioDropdown" src="https://ui-avatars.com/api/?name=Usuario"
                            class="avatar avatar-sm rounded-circle border"
                            style="width:34px;height:34px;object-fit:cover;">
                        <div>
                            <div class="fw-semibold text-dark" id="nombrePerfilUsuario">Usuario</div>
                            <div class="text-xs text-muted" id="correoPerfilUsuario">correo@ejemplo.com</div>
                        </div>
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <span class="dropdown-item text-primary d-flex align-items-center gap-2">
                        <i class="fas fa-user-tag"></i>
                        <span>Rol: <b id="rolesUsuario">Usuario</b></span>
                    </span>
                </li>
                <li>
                    <button id="logButton"
                        class="dropdown-item text-danger d-flex align-items-center gap-2 rounded-3 mt-1">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar sesi√≥n
                    </button>
                </li>
            </ul>
        </div>
    </div>



    <div class="container min-vh-100">



        <div class="card wizard-card-glass">
            <!-- Ilustraci√≥n SVG checklist (cambia seg√∫n el paso) -->
            <div id="wizardIlustracion" class="d-flex flex-column align-items-center justify-content-center">
                <!-- SVG del paso actual se inyecta por JS -->
            </div>
            <!-- Paso de contenido din√°mico -->
            <div id="wizardContenido">
                <!-- Aqu√≠ va el contenido del paso (badge, t√≠tulo, texto, botones) -->
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Cierre de Sesi√≥n -->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutLabel">Cerrar sesi√≥n</h5>
                </div>
                <div class="modal-body text-center">
                    <p>¬øEst√°s seguro de que quieres cerrar sesi√≥n?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmLogout">Cerrar sesi√≥n</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Contenedor de notificaciones (Toasts) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
        <div id="toastContainer"></div>
    </div>


    <footer class="footer  ">
        <div class="container-fluid">
            <div class="row align-items-center justify-content-lg-between">
                <div class="col-lg-6 mb-lg-0 mb-4">
                    <div class="copyright text-center text-sm text-muted text-lg-start">
                        ¬©
                        <script>
                            document.write(new Date().getFullYear())
                        </script>,
                        desarrollado por la <a style="font-weight: 600; color: #00584e;"
                            href="https://sigunitropico.com/planeacion-estrategica">Oficina Asesora de Planeaci√≥n</a> -
                        Unitr√≥pico

                    </div>
                </div>
                <div class="col-lg-6">
                    <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                        <li class="nav-item">
                            <a href="synariscorp.com" class="nav-link text-muted" target="_blank">Synaris Corp</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://sigunitropico.com/planeacion" class="nav-link text-muted"
                                target="_blank">Nosotros</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://sigunitropico.com/planeacion" class="nav-link text-muted"
                                target="_blank">Documentaci√≥n</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://sigunitropico.com/planeacion" class="nav-link pe-0 text-muted"
                                target="_blank">Licencia</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getDatabase, ref, get, update, push, remove, set } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
        import { getAuth, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";
        import { getStorage, ref as refStorage, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-storage.js";


        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyADKfjkB9LO1k1smRJ31sOb-7rrxOrQ7lc",
            authDomain: "sigunitropico.firebaseapp.com",
            projectId: "sigunitropico",
            storageBucket: "sigunitropico.appspot.com",
            messagingSenderId: "32992004482",
            appId: "1:32992004482:web:bd4d5e9a2b7a8b976e279b"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const database = getDatabase(app); // ‚úÖ Esta l√≠nea es clave
        const provider = new GoogleAuthProvider();
        const dbRT = getDatabase(app);
        const dbFS = getFirestore(app);
        const storage = getStorage(app);

        // Variable para evitar agregar m√∫ltiples event listeners
        let logoutListenerAdded = false;

        let datosEvidencias = {};
        window.evidenciasSubidas = [];         // Array de evidencias subidas en esta sesi√≥n
        window.archivosSeleccionados = [];     // Archivos del formulario actual
        window.metaSeleccionada = null;        // Meta seleccionada en el paso
        window.accionSeleccionada = null;      // Acci√≥n seleccionada
        window.descripcionEvidencia = "";      // Descripci√≥n actual

        const params = new URLSearchParams(window.location.search);

        const idPolitica = params.get('p');
        const objetivoIndex = params.get('obj');
        const idAccion = params.get('a');

        let pasoActual = 1;
        const totalPasos = 5;

        const RUTA_BASE_RESPONSABLES = "/responsables";
        const RUTA_RESPONSABLES_POLITICA = `/PolariScore/politicas/${idPolitica}/responsables`;

        let email = "";
        let evidenciasArr = [];

        asignarListenersWizard();

        let esUnResponsable = false;

        let esAdmin = false;


        // Lista de roles permitidos
        const rolesPermitidos = [
            "admin", "admin-polariscore", "admin-datalab", "admin-s-plan", "admin-uniproy",
            "observador", "observador-polariscore", "observador-datalab", "observador-s-plan", "observador-uniproy",
            "responsable", "responsable-polariscore", "responsable-datalab", "responsable-s-plan", "responsable-uniproy"
        ];

        // Escuchar cambios en el estado de autenticaci√≥n
        onAuthStateChanged(auth, async (user) => {
            console.log("Usuario autenticado:", user); // üöÄ Verifica si el usuario est√° autenticado

            if (user) {

                const correoUsuario = user.email;
                window.correoUsuario = correoUsuario;

                if (!correoUsuario) {
                    console.error("El usuario no tiene correo.");
                    return;
                }

                const idResponsable = await obtenerIdResponsablePorCorreoFS(dbFS, correoUsuario);
                window.idResponsable = idResponsable;
                if (idResponsable) {
                    console.log("ID del responsable:", idResponsable);
                    // Aqu√≠ puedes continuar el flujo...

                } else {
                    console.warn("No se encontr√≥ responsable para ese correo.");
                }

                const loginModalElement = document.getElementById("loginRequiredModal");
                if (loginModalElement && bootstrap.Modal.getInstance(loginModalElement)) {
                    bootstrap.Modal.getInstance(loginModalElement).hide();
                }

                logButton.textContent = "Cerrar sesi√≥n";
                logButton.classList.remove("btn-primary");
                logButton.classList.add("btn-danger");


                // Mostrar foto y nombre de perfil
                const nombreCompleto = user.displayName || user.email || "Usuario";
                const nombreCorto = obtenerNombreCorto(nombreCompleto);
                const foto = user.photoURL
                    ? user.photoURL
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(nombreCorto)}&background=0D8ABC&color=fff&rounded=true&size=64`;

                if (document.getElementById("nombrePerfilUsuario")) {
                    document.getElementById("nombrePerfilUsuario").textContent = nombreCompleto;
                    document.getElementById("nombrePerfilUsuario").classList.add("text-dark");
                    document.getElementById("nombrePerfilUsuario").classList.remove("text-white");
                    document.getElementById("correoPerfilUsuario").textContent = user.email;

                }


                if (document.getElementById("imgPerfilUsuario")) {
                    document.getElementById("imgPerfilUsuario").src = foto;
                    document.getElementById("imgPerfilUsuario").alt = nombreCorto;
                    document.getElementById("imgPerfilUsuario").title = nombreCorto;
                }

                if (document.getElementById("imgPerfilUsuarioDropdown")) {
                    document.getElementById("imgPerfilUsuarioDropdown").src = foto;
                    document.getElementById("imgPerfilUsuarioDropdown").alt = nombreCorto;
                    document.getElementById("imgPerfilUsuarioDropdown").title = nombreCorto;
                }



                // Manejo del logout (evita agregar m√∫ltiples eventos)
                if (!logoutListenerAdded) {
                    logButton.addEventListener("click", () => {
                        let logoutModal = new bootstrap.Modal(document.getElementById("logoutModal"));
                        logoutModal.show();

                        document.getElementById("confirmLogout").addEventListener("click", () => {
                            signOut(auth).then(() => {
                                window.location.href = "../pages/sign-in.html";
                            }).catch((error) => {
                                console.error("Error al cerrar sesi√≥n:", error);
                                mostrarToast("Error al cerrar sesi√≥n.", "danger");
                            });
                        });
                    });
                    logoutListenerAdded = true;
                }

                // Obtener los roles del usuario desde Firebase Database
                const correoSanitizado = user.email.replace(/\./g, '_');
                const userRef = ref(db, `usuarios/${correoSanitizado}`);

                get(userRef).then(async (snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();

                        // Aseguramos un arreglo de strings
                        const userRoles = Array.isArray(userData.roles)
                            ? userData.roles.map(r => String(r))
                            : [];

                        console.log(`‚úÖ Usuario autenticado con roles: ${userRoles.join(", ")}`);

                        // Detectar si es admin (si cualquier rol contiene "admin", case-insensitive)
                        let esAdmin = userRoles.some(r => r.toLowerCase().includes('admin'));
                        window.esAdmin = esAdmin;

                        // Aqu√≠ se obtiene el idResponsable SOLO si el rol es responsable
                        let idResponsable = null;
                        if (userRoles.includes('responsable-polariscore')) {
                            // Implementa esta funci√≥n seg√∫n tu sistema (Firestore o RTDB)
                            idResponsable = await obtenerIdResponsablePorCorreoFS(dbFS, user.email);
                            window.idResponsable = idResponsable;
                        }

                        const politicas = await obtenerPoliticasPorResponsable(db, idResponsable, userRoles);
                        window.politicas = politicas;

                        window.userRoles = userRoles;

                        // Observar cambios en el DOM (si lo necesitas para render din√°mico)
                        const observer = new MutationObserver(() => { });
                        observer.observe(document.body, { childList: true, subtree: true });

                    } else {
                        console.error("‚ö†Ô∏è No se encontr√≥ informaci√≥n del usuario en la base de datos.");
                        mostrarToast("No se encontr√≥ la informaci√≥n del usuario.", "warning");
                    }
                }).catch((error) => {
                    console.error("‚ùå Error al obtener datos del usuario:", error);
                    mostrarToast("Error al obtener los datos del usuario.", "danger");
                });


            } else {


                console.log("No hay usuario autenticado");

                logButton.textContent = "Iniciar Sesi√≥n";
                logButton.classList.remove("btn-danger");
                logButton.classList.remove("text-danger");
                logButton.classList.add("btn-primary");
                logButton.classList.add("text-white");

                logButton.style.backgroundColor = "#00594e";
                logButton.style.color = "#fff!important";
                logButton.addEventListener("click", () => {
                    window.location.href = "../pages/sign-in.html";
                });

                // Mostrar modal de advertencia
                let loginModal = new bootstrap.Modal(document.getElementById("loginRequiredModal"));
                loginModal.show();

                // Evento para bot√≥n de iniciar sesi√≥n del modal
                logButton.addEventListener("click", () => {
                    signInWithPopup(auth, provider)
                        .then((result) => {
                            const user = result.user;
                            mostrarToast(`¬°Bienvenido, ${user.displayName}!`, "success");
                            guardarUsuario(user.email, user.displayName);
                        })
                        .catch((error) => {
                            console.error("Error al iniciar sesi√≥n con Google:", error.code, error.message);
                            mostrarToast(obtenerMensajeError(error.code), "danger");
                        });
                });


                document.getElementById("btnIniciarSesionModal").addEventListener("click", () => {
                    signInWithPopup(auth, provider)
                        .then((result) => {
                            const user = result.user;
                            mostrarToast(`¬°Bienvenido, ${user.displayName}!`, "success");
                            guardarUsuario(user.email, user.displayName);
                        })
                        .catch((error) => {
                            console.error("Error al iniciar sesi√≥n con Google:", error.code, error.message);
                            mostrarToast(obtenerMensajeError(error.code), "danger");
                        });
                });
            }
        });

        try {
            const responsablesRef = ref(db, RUTA_RESPONSABLES_POLITICA);
            const snapResp = await get(responsablesRef);

            // Normalizar a un array de IDs
            let responsablesIds = [];
            if (snapResp.exists()) {
                const raw = snapResp.val();

                if (typeof raw === 'string') {
                    responsablesIds = raw.split(',').map(s => s.trim()).filter(Boolean);
                } else if (Array.isArray(raw)) {
                    responsablesIds = raw.map(x => String(x).trim()).filter(Boolean);
                } else if (raw && typeof raw === 'object') {
                    const byKeys = Object.keys(raw).map(k => String(k).trim());
                    const byValues = Object.values(raw)
                        .map(v => (v && typeof v === 'object' && (v.id || v.ID || v.Id))
                            ? String(v.id || v.ID || v.Id).trim()
                            : null)
                        .filter(Boolean);
                    responsablesIds = Array.from(new Set([...byKeys, ...byValues]));
                }
            }

            // üëá Espera a que idResponsable exista (evita race condition)
            const idResp = (await waitForIdResponsable()) || '';
            esUnResponsable = !!idResp && responsablesIds
                .some(id => id.toLowerCase() === idResp.toLowerCase());

            window.esUnResponsable = esUnResponsable;

            console.log('Responsables:', responsablesIds, 'idResponsable:', idResp, 'esUnResponsable:', esUnResponsable);

        } catch (err) {
            console.error('Error leyendo responsables de la pol√≠tica:', err);
            esUnResponsable = false;
            window.esUnResponsable = false;
        }


        // Espera a que window.idResponsable est√© seteado (hasta timeout ms)
        async function waitForIdResponsable(timeout = 3000, step = 50) {
            let id = (window.idResponsable ?? '').toString().trim();
            if (id) return id;

            // Si tienes una funci√≥n para obtenerlo, intenta primero (opcional)
            try {
                if (
                    typeof obtenerIdResponsablePorCorreoFS === 'function' &&
                    window.user?.email &&
                    Array.isArray(window.userRoles) &&
                    window.userRoles.includes('responsable-polariscore')
                ) {
                    const posible = await obtenerIdResponsablePorCorreoFS(dbFS, window.user.email);
                    if (posible) {
                        window.idResponsable = posible;
                        return posible.toString().trim();
                    }
                }
            } catch (_) { }

            // Poll hasta que otro flujo lo asigne
            const start = Date.now();
            return await new Promise(resolve => {
                const iv = setInterval(() => {
                    const val = (window.idResponsable ?? '').toString().trim();
                    if (val || Date.now() - start > timeout) {
                        clearInterval(iv);
                        resolve(val);
                    }
                }, step);
            });
        }


        function obtenerNombreCorto(nombreCompleto) {
            if (!nombreCompleto) return "";
            const partes = nombreCompleto.trim().split(" ");
            if (partes.length === 1) return partes[0];
            return partes[0] + " " + partes[1];
        }


        function mostrarToast(mensaje, tipo = "info", tiempo = 4000) {
            // Busca o crea el contenedor
            let container = document.getElementById("toastContainer");
            if (!container) {
                container = document.createElement("div");
                container.id = "toastContainer";
                container.className = "toast-container position-fixed top-0 end-0 p-3";
                container.style.zIndex = "11000";
                document.body.appendChild(container);
            }

            // Bootstrap 5 Toast template
            const toastDiv = document.createElement('div');
            toastDiv.className = `toast align-items-center text-bg-${tipo} border-0 show mb-2`;
            toastDiv.setAttribute("role", "alert");
            toastDiv.setAttribute("aria-live", "assertive");
            toastDiv.setAttribute("aria-atomic", "true");

            toastDiv.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body text-white">${mensaje}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;

            container.appendChild(toastDiv);

            // Auto-cierre
            setTimeout(() => {
                toastDiv.classList.remove('show');
                setTimeout(() => toastDiv.remove(), 500);
            }, tiempo);
        }

        async function obtenerIdResponsablePorCorreoFS(dbFS, correoBuscado) {
            const responsablesRef = collection(dbFS, "responsables");
            const q = query(responsablesRef, where("correo", "==", correoBuscado));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                // Solo deber√≠a haber uno, pero si hay varios tomamos el primero
                const doc = querySnapshot.docs[0];
                return doc.id; // <-- Este es el ID del responsable
            }
            return null;
        }

        async function obtenerPoliticasPorResponsable(db, idResponsable, userRoles) {
            const politicasRef = ref(db, '/PolariScore/politicas');
            const snapshot = await get(politicasRef);
            let politicas = [];

            if (snapshot.exists()) {
                const data = snapshot.val();

                for (const idPolitica in data) {
                    const politica = data[idPolitica];
                    const responsables = politica.responsables || [];

                    // Si eres admin, puedes ver todas
                    let incluir = false;
                    if (userRoles.includes("admin-polariscore")) {
                        incluir = true;
                    } else if (responsables && Array.isArray(responsables)) {
                        incluir = responsables.includes(idResponsable);
                    }

                    if (incluir) {
                        politicas.push({
                            id: idPolitica,
                            nombre: limitarTexto(politica.titulo, 50) || politica.titulo_politica || idPolitica,
                            objetivos: politica.objetivos_especificos || {}
                        });
                    }
                }
            }
            return politicas;
        }



        function limitarTexto(texto, limite) {
            return texto.length > limite ? texto.substring(0, limite) + "..." : texto;
        }



        function formatearFechaISO(fechaISO) {
            const date = new Date(fechaISO);
            const dia = String(date.getDate()).padStart(2, '0');
            const mes = String(date.getMonth() + 1).padStart(2, '0');
            const anio = date.getFullYear();
            let horas = date.getHours();
            const minutos = String(date.getMinutes()).padStart(2, '0');
            const ampm = horas >= 12 ? 'pm' : 'am';
            horas = horas % 12;
            horas = horas ? horas : 12; // hora '0' debe ser '12'
            return `${dia}/${mes}/${anio} ${horas}:${minutos} ${ampm}`;
        }



        // Renderiza el paso actual
        function renderPasoWizard() {
            // Puedes tener un switch o un array de funciones, aqu√≠ va un ejemplo tipo switch
            switch (pasoActual) {
                case 1:
                    // Ilustraci√≥n (ejemplo)
                    document.getElementById("wizardIlustracion").innerHTML = `
                    <img class="imgIlustracionWizard" src="../assets/img/polariscore/animacion.gif" >
                    <div class="d-none d-md-block text-secondary text-center">¬°Bienvenido!</div>
                `;
                    // Contenido
                    document.getElementById("wizardContenido").innerHTML = `
                    <span class="badge bg-success bg-opacity-10 text-white rounded-pill px-3 py-1 mb-3">
                        Inicio
                    </span>
                
                    <h2 class="fw-bold mb-3" style="font-size:1.7rem;">Bienvenido al m√≥dulo de carga</h2>
                    <div class="mb-4">Gestiona eficientemente tus evidencias de las <a href="dashboard.hmtl" class="text-primary fw-semibold" target="_blank"> Pol√≠ticas Institucionales.</a></div>
                    <div class="d-flex justify-content-end gap-2 w-100">
                        <button class="btn btn-primary px-5 fw-semibold" id="btnSiguienteWizard">Siguiente</button>
                    </div>
                `;
                    break;

                case 2:
                    document.getElementById("wizardIlustracion").innerHTML = `
            <!-- SVG moderno de checklist -->
            <img src="../assets/img/polariscore/paso-1-carga.svg" width="250" alt="Ilustraci√≥n Selecci√≥n" class="mb-3" style="max-width: 90%;">
            <div class="d-none d-md-block text-secondary text-center mt-3" id="textoIlustracionWizard">
                ¬°Selecciona primero la pol√≠tica, luego el objetivo y finalmente la acci√≥n!
            </div>
        `;
                    document.getElementById("wizardContenido").innerHTML = `
            <span class="badge bg-success bg-opacity-10 text-white rounded-pill px-3 py-1 mb-3">
                Paso 1 de ${totalPasos}
            </span>
            <h2 class="fw-bold mb-3" style="font-size:1.7rem;">Selecciona la pol√≠tica, el objetivo y la acci√≥n</h2>
            <div class="mb-4">
                <p>Por favor, selecciona en orden la <b>pol√≠tica</b>, el <b>objetivo espec√≠fico</b> y finalmente la <b>acci√≥n</b> correspondiente.</p>
                <ul style="font-size: 1.1em; color: #555;">
                    <li>Solo se mostrar√°n las pol√≠ticas, objetivos y acciones donde eres responsable.</li>
                    <li>La selecci√≥n es obligatoria para continuar.</li>
                    <li>Verifica que seleccionaste la acci√≥n correcta antes de avanzar.</li>
                    <li>Si tienes dudas, comun√≠cate con tu l√≠der de √°rea.</li>
                </ul>
            </div>
            <div class="d-flex justify-content-between gap-2 w-100">
                <button class="btn btn-outline-secondary px-4" id="btnAnteriorWizard">Anterior</button>
                <button class="btn btn-primary px-5 fw-semibold" id="btnSiguienteWizard">Siguiente</button>
            </div>
        `;
                    break;


                case 3:
                    document.getElementById("wizardIlustracion").innerHTML = `
            <img src="../assets/img/polariscore/paso-3-carga.svg" width="250" alt="Ilustraci√≥n selecci√≥n" class="mb-3" style="max-width: 90%;">
            <div class="text-secondary text-center mt-3">
                <b>Selecciona d√≥nde subir√°s la evidencia</b><br>
                Elige primero la <b>pol√≠tica</b>, luego el <b>objetivo</b> y por √∫ltimo la <b>acci√≥n</b>.
            </div>
        `;

                    document.getElementById("wizardContenido").innerHTML = `
            <span class="badge bg-success bg-opacity-10 text-white rounded-pill px-3 py-1 mb-3">
                Paso 2 de ${totalPasos}
            </span>
            <h2 class="fw-bold mb-3" style="font-size:1.7rem;">
                Selecciona la ubicaci√≥n de tu evidencia
            </h2>
            <form id="formSeleccionUbicacionWizard">
                <div class="mb-3">
                    <label for="selectPoliticaWizard" class="form-label">Pol√≠tica</label>
                    <select class="form-select" id="selectPoliticaWizard" required>
                        <option value="">Seleccione...</option>
                        <!-- Opciones din√°micas -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="selectObjetivoWizard" class="form-label">Objetivo espec√≠fico</label>
                    <select class="form-select" id="selectObjetivoWizard" required disabled>
                        <option value="">Seleccione una pol√≠tica primero</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="selectAccionWizard" class="form-label">Acci√≥n</label>
                    <select class="form-select" id="selectAccionWizard" required disabled>
                        <option value="">Seleccione un objetivo primero</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between gap-2 w-100 mt-3">
                    <button class="btn btn-outline-secondary px-4" id="btnAnteriorWizard" type="button">Anterior</button>
                    <button class="btn btn-primary px-5 fw-semibold" id="btnSiguienteWizard" type="button" disabled>
                        Siguiente <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        `;

                    // Funciones de inicializaci√≥n y listeners:
                    asignarListenersWizard();
                    llenarSelectPoliticas(window.politicas); // Llena el select de pol√≠ticas
                    listenerPoliticaWizard(); // Habilita objetivos al elegir pol√≠tica
                    listenerObjetivoWizard(); // Habilita acciones al elegir objetivo
                    listenerAccionWizard();   // Habilita bot√≥n siguiente si todo est√° seleccionado
                    break;


                case 4: {
                    // Recupera IDs desde selects si existen; si no, usa preselecci√≥n/URL (modo auto)
                    const idPoliticaSel =
                        document.getElementById('selectPoliticaWizard')?.value ||
                        window._wizardPreselection?.p || idPolitica || '';

                    const idObjetivoSel =
                        document.getElementById('selectObjetivoWizard')?.value ||
                        window._wizardPreselection?.obj || objetivoIndex || '';

                    const idAccionSel =
                        document.getElementById('selectAccionWizard')?.value ||
                        window._wizardPreselection?.a || idAccion || '';

                    // Si falta algo cr√≠tico, podr√≠as mostrar un aviso y regresar a Paso 3:
                    if (!idPoliticaSel || !idObjetivoSel || !idAccionSel) {
                        console.warn('Faltan par√°metros para subir evidencias. Volviendo a Paso 3.');
                        pasoActual = 3;
                        if (typeof renderPasoWizard === 'function') renderPasoWizard();
                        break;
                    }

                    // Determina el ciclo activo
                    const cicloActivo = "2025_2"; // o tu funci√≥n: obtenerCicloActivo()

                    // Ilustraci√≥n
                    document.getElementById("wizardIlustracion").innerHTML = `
        <img src="../assets/img/polariscore/paso-2-carga.svg" width="250" alt="Subir evidencias" class="mb-3" style="max-width: 90%;">
        <div class="fw-normal text-center mt-3 text-secondary" style="font-size:1.04em;">
        Sube los archivos requeridos para esta acci√≥n.<br>
        Marca con un <span class="text-success"><i class="fa fa-check-circle"></i></span> cada evidencia subida.
        </div>
    `;

                    // Contenido
                    document.getElementById("wizardContenido").innerHTML = `
                        
        <div class="d-flex gap-2 mb-3">
    <span class="badge bg-success bg-opacity-10 text-white rounded-pill px-3 py-1">
        Paso 3 de ${totalPasos}
    </span>
    <span class="badge bg-info bg-opacity-10 text-white rounded-pill px-3 py-1">
        Ciclo de carga 2025_2
    </span>
    </div>
        <h2 class="fw-bold mb-3" style="font-size:1.65rem;">
        Subida de evidencias requeridas
        </h2>
        <div id="panelEvidenciasWizard" class="row gy-3"></div>
        <div class="d-flex justify-content-between gap-2 w-100 mt-4">
        <button class="btn btn-outline-secondary px-4" id="btnAnteriorWizard" type="button">Elegir otra acci√≥n</button>
        <button class="btn btn-success px-5 fw-semibold" id="btnFinalizarEvidenciasWizard" type="button" disabled>
            <i class="fas fa-check-double me-2"></i>Finalizar subida
        </button>
        </div>
    `;

                    // Cargar evidencias requeridas con el idAccion ya resuelto
                    cargarPanelEvidenciasWizard(idAccionSel, cicloActivo);

                    // Listeners de este paso‚Ä¶
                    asignarListenersWizard();
                    break;
                }



                case 5:
                    // Ilustraci√≥n tipo dashboard de entregas
                    document.getElementById("wizardIlustracion").innerHTML = `
                        <img src="../assets/img/s-plan/paso-3-carga.svg" width="300"  alt="Ilustraci√≥n carga" class="mb-3" style="max-width: 90%;">
                        <div class="fw-normal text-center mt-3 text-secondary" style="font-size:1.04em;">
                            Resumen de tus evidencias<br>
                            Puedes revisar y editar antes de entregar
                        </div>
                    `;

                    // Contenido principal: resumen
                    document.getElementById("wizardContenido").innerHTML = `
                            <span class="badge bg-success bg-opacity-10 text-white rounded-pill px-3 py-1 mb-3">
                                Paso 2 de ${totalPasos}
                            </span>
                            <h2 class="fw-bold mb-3" style="font-size:1.65rem;">
                                Resumen de evidencias subidas
                            </h2>
                            <div class="d-flex flex-wrap gap-4 mb-3">
                                <div class="bg-white shadow-sm rounded-3 text-center px-3 py-2 flex-fill" style="min-width:130px;">
                                    <div class="text-secondary fw-semibold small mb-1">Metas</div>
                                    <div id="resumenTotalMetas" class="fs-3 fw-bold text-warning">0</div>
                                </div>
                                <div class="bg-white shadow-sm rounded-3 text-center px-3 py-2 flex-fill" style="min-width:130px;">
                                    <div class="text-secondary fw-semibold small mb-1">Acciones</div>
                                    <div id="resumenTotalAcciones" class="fs-3 fw-bold text-warning">0</div>
                                </div>
                                <div class="bg-white shadow-sm rounded-3 text-center px-3 py-2 flex-fill" style="min-width:130px;">
                                    <div class="text-secondary fw-semibold small mb-1">Evidencias</div>
                                    <div id="resumenTotalEvidencias" class="fs-3 fw-bold text-warning">0</div>
                                </div>
                            </div>
                            <div class="table-responsive bg-white rounded-3 shadow-sm p-2" style="max-height: 380px; overflow-y:auto;">
                                <table class="table table-sm table-borderless align-middle mb-0">
                                    <thead>
                                        <tr class="bg-light">
                                            <th class="text-start">Meta</th>
                                            <th class="text-start">Acci√≥n</th>
                                            <th class="text-center">Archivo(s)</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaResumenEvidencias">
                                        <!-- Se llena por JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-end gap-2 w-100 mt-4">
                                <button class="btn btn-outline-secondary px-4" id="btnAnteriorWizard" type="button">Anterior</button>
                                <button class="btn btn-success px-5 fw-semibold" id="btnFinalizarEntregaWizard" type="button">
                                    <i class="fas fa-paper-plane me-2"></i>Entregar todo
                                </button>
                            </div>
                        `;

                    // Llenar datos del resumen (ll√°malo aqu√≠ despu√©s del render)
                    renderizarResumenEvidencias();

                    // Listeners botones
                    asignarListenersWizard();

                    break;


                case 6:
                    // Ilustraci√≥n moderna de √©xito/check animado
                    document.getElementById("wizardIlustracion").innerHTML = `
                        <img src="../assets/img/s-plan/completado.svg" width="250"  alt="Ilustraci√≥n Selecci√≥n" class="mb-3" style="max-width: 90%;">
                        <div class="text-success text-center mt-3 fw-bold" style="font-size: 1.2em;">
                            ¬°Entrega exitosa!
                        </div>
                    `;

                    // Contenido del paso 5
                    document.getElementById("wizardContenido").innerHTML = `
                            <span class="badge bg-success bg-opacity-10 text-white rounded-pill px-3 py-1 mb-3">
                                Completado
                            </span>
                            <h2 class="fw-bold mb-3" style="font-size:1.7rem;">
                                ¬°Felicitaciones, evidencia entregada!
                            </h2>
                            <div class="mb-4" style="font-size:1.15rem; color:#555;">
                                <p>
                                    Tus evidencias fueron <b>registradas correctamente</b> en el sistema.<br>
                                    <span class="text-success">¬°Muchas gracias por tu compromiso!</span>
                                </p>
                                <ul class="mb-3" style="font-size:1.08rem;">
                                    <li>Ser√°s notificado(a) cuando la evidencia sea revisada y validada por el l√≠der del √°rea.</li>
                                    <li>Puedes hacer seguimiento al estado desde tu perfil o en el historial de cargas.</li>
                                    <li>Recuerda que si es necesario complementar informaci√≥n, recibir√°s un mensaje en tu correo institucional.</li>
                                </ul>
                                <div class="alert alert-success mt-3 py-2 px-3" style="font-size:1rem; border-radius:9px;">
                                    <i class="fa fa-check-circle me-2"></i>
                                    Proceso completado con √©xito.
                                </div>
                            </div>
                            <div class="d-flex justify-content-end gap-2 w-100 mt-2">
                                <a href="dashboard.html" class="btn btn-outline-primary px-4">
                                    <i class="fas fa-home me-2"></i>Ir al inicio
                                </a>
                                <button class="btn btn-success px-5 fw-semibold" id="btnCerrarWizard" type="button">
                                    Finalizar
                                </button>
                            </div>
                        `;

                    // Listener para finalizar/cerrar
                    document.getElementById("btnCerrarWizard").onclick = () => {
                        window.location.href = "dashboard.html"; // O la p√°gina principal que prefieras
                    };
                    break;


            }

            actualizarBarraProgreso(pasoActual, totalPasos);

            // ...tu render din√°mico
            asignarListenersWizard();



        }

        // Flag de modo auto
        let autoSkip = !!(idPolitica && objetivoIndex && idAccion);

        // Guardamos preselecci√≥n aqu√≠ para usarla en el Paso 4
        function setPreselectionFromParams() {
            window._wizardPreselection = {
                p: String(idPolitica),
                obj: String(objetivoIndex),
                a: String(idAccion),
            };
        }

        function asignarListenersWizard() {
            // Bot√≥n siguiente
            const btnSig = document.getElementById("btnSiguienteWizard");
            if (btnSig) {
                btnSig.onclick = () => {
                    if (pasoActual < totalPasos) {
                        // üöÄ Modo auto: del Paso 1 salta directo al Paso 4 con preselecci√≥n
                        if (autoSkip && pasoActual === 1) {
                            setPreselectionFromParams();
                            pasoActual = 4;
                            autoSkip = false; // evitar que vuelva a saltar
                        } else {
                            pasoActual++;
                        }
                        if (typeof renderPasoWizard === 'function') renderPasoWizard();
                    }
                };
            }

            // Bot√≥n anterior
            const btnAnt = document.getElementById("btnAnteriorWizard");
            if (btnAnt) {
                btnAnt.onclick = () => {
                    if (pasoActual > 1) {
                        pasoActual--;
                        if (typeof renderPasoWizard === 'function') renderPasoWizard();
                    }
                };
            }
        }


        function actualizarBarraProgreso(pasoActual, totalPasos) {
            const porcentaje = Math.round((pasoActual / totalPasos) * 100);
            const barra = document.getElementById("barraProgreso");
            barra.style.width = `${porcentaje}%`;
            barra.setAttribute("aria-valuenow", porcentaje);
            barra.textContent = `${porcentaje}%`;
        }

        // Inicializa el wizard en el primer paso
        renderPasoWizard();



        function llenarSelectPoliticas(politicas) {
            const select = document.getElementById('selectPoliticaWizard');
            if (!select) return;
            select.innerHTML = `<option value="">Seleccione...</option>`;
            politicas.forEach(politica => {
                const option = document.createElement('option');
                option.value = politica.id;
                option.textContent = politica.nombre;
                select.appendChild(option);
            });
        }

        function listenerPoliticaWizard() {
            const selectPolitica = document.getElementById('selectPoliticaWizard');
            const selectObjetivo = document.getElementById('selectObjetivoWizard');
            selectPolitica.addEventListener('change', function () {
                const idPolitica = this.value;
                const politica = window.politicas.find(p => p.id === idPolitica);
                llenarSelectObjetivos(politica ? politica.objetivos : {});
                selectObjetivo.disabled = !politica;
                document.getElementById('selectAccionWizard').disabled = true;
            });
        }

        function llenarSelectObjetivos(objetivosObj) {
            const select = document.getElementById('selectObjetivoWizard');
            select.innerHTML = `<option value="">Seleccione...</option>`;
            if (objetivosObj && typeof objetivosObj === 'object') {
                Object.entries(objetivosObj).forEach(([id, obj]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = limitarTexto(obj.objetivo_especifico, 50) || obj.titulo_objetivo || id;
                    select.appendChild(option);
                });
            }
        }

        function listenerObjetivoWizard() {
            const selectPolitica = document.getElementById('selectPoliticaWizard');
            const selectObjetivo = document.getElementById('selectObjetivoWizard');
            const selectAccion = document.getElementById('selectAccionWizard');

            selectObjetivo.addEventListener('change', function () {
                // Obtener la pol√≠tica seleccionada
                const idPolitica = selectPolitica.value;
                const politica = window.politicas.find(p => p.id === idPolitica);
                if (!politica) {
                    selectAccion.innerHTML = `<option value="">Seleccione un objetivo primero</option>`;
                    selectAccion.disabled = true;
                    return;
                }

                // Obtener el objetivo seleccionado
                const idObjetivo = selectObjetivo.value;
                const objetivo = politica.objetivos[idObjetivo];

                if (objetivo && objetivo.acciones) {
                    llenarSelectAcciones(objetivo.acciones);
                    selectAccion.disabled = false;
                } else {
                    selectAccion.innerHTML = `<option value="">Seleccione un objetivo primero</option>`;
                    selectAccion.disabled = true;
                }
            });
        }

        function llenarSelectAcciones(accionesObj) {
            const select = document.getElementById('selectAccionWizard');
            select.innerHTML = `<option value="">Seleccione...</option>`;
            Object.entries(accionesObj).forEach(([id, accion]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = limitarTexto(accion.accion, 50) || accion.titulo_accion || id;
                select.appendChild(option);
            });
        }

        function listenerAccionWizard() {
            const selectPolitica = document.getElementById('selectPoliticaWizard');
            const selectObjetivo = document.getElementById('selectObjetivoWizard');
            const selectAccion = document.getElementById('selectAccionWizard');
            const btnSiguiente = document.getElementById('btnSiguienteWizard');

            function validarSeleccion() {
                const politicaSeleccionada = selectPolitica.value !== "";
                const objetivoSeleccionado = selectObjetivo.value !== "";
                const accionSeleccionada = selectAccion.value !== "";

                // Solo habilita el bot√≥n si todos los selects tienen un valor seleccionado
                btnSiguiente.disabled = !(politicaSeleccionada && objetivoSeleccionado && accionSeleccionada);
            }

            // Validar cada vez que cambie alg√∫n select
            selectPolitica.addEventListener('change', validarSeleccion);
            selectObjetivo.addEventListener('change', validarSeleccion);
            selectAccion.addEventListener('change', validarSeleccion);

            // Llama una vez para establecer el estado inicial del bot√≥n
            validarSeleccion();
        }




        async function cargarPanelEvidenciasWizard(idAccion, cicloActivo) {
            const panel = document.getElementById('panelEvidenciasWizard');
            panel.innerHTML = `<div class="text-center text-muted my-4">Cargando evidencias requeridas...</div>`;

            // === Gate de autorizaci√≥n ===
            const esAdmin = window.esAdmin === true;
            const esUnResponsable = window.esUnResponsable === true;
            const autorizado = esAdmin || esUnResponsable;

            if (!autorizado) {
                // Aviso en el panel
                panel.innerHTML = `<div class="alert alert-warning text-start">No eres responsable de esta pol√≠tica, no puedes subir evidencias</div>`;
                const msg = 'No eres responsable de esta pol√≠tica, no puedes subir evidencias.';

                // SweetAlert2 (Swal.fire)
                if (window.Swal && typeof window.Swal.fire === 'function') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Acceso denegado',
                        text: msg,
                        showConfirmButton: false,
                        timer: 2200,
                        timerProgressBar: true,
                        position: 'center',
                        didOpen: (popup) => {
                            popup.addEventListener('mouseenter', Swal.stopTimer);
                            popup.addEventListener('mouseleave', Swal.resumeTimer);
                        }
                    }).then(() => {
                        // Si esto est√° en un popup/ventana, intenta cerrarlo
                        try { window.close(); } catch (e) { }
                    });
                }
                // SweetAlert (swal) cl√°sico
                else if (typeof window.swal === 'function') {
                    swal({
                        icon: 'error',
                        title: 'Acceso denegado',
                        text: msg,
                        buttons: false,
                        timer: 2200
                    }).then(() => {
                        try { window.close(); } catch (e) { }
                    });
                }
                // Fallback b√°sico
                else {
                    alert('Acceso denegado: ' + msg);
                    try { window.close(); } catch (e) { }
                }

                // (Opcional) Cerrar modal Bootstrap abierto
                try {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal && window.bootstrap?.Modal) {
                        const inst = bootstrap.Modal.getInstance(openModal) || new bootstrap.Modal(openModal);
                        inst.hide();
                    }
                } catch (e) { }

                return; // detener cualquier flujo posterior de subida
            }

            // === Usuario autorizado: cargar evidencias ===
            const evidenciasSnapshot = await get(ref(db, `/PolariScore/evidencias/${idAccion}`));

            if (evidenciasSnapshot.exists()) {
                const data = evidenciasSnapshot.val();
                evidenciasArr = Object.entries(data).map(([idEvidencia, obj]) => ({
                    id: idEvidencia,
                    nombre: (obj && (obj.nombre || obj.titulo)) || idEvidencia,
                    descripcion: (obj && obj.descripcion) || '',
                    formato: (obj && obj.formato) || '',   // Ej: PDF, Excel, imagen, etc.
                    uploads: (obj && obj.uploads) || {}     // Para saber si ya fue cargado en cicloActivo
                }));
            } else {
                // Autorizado pero no hay evidencias configuradas
                panel.innerHTML = `<div class="alert alert-info text-start">No hay evidencias configuradas para esta pol√≠tica.</div>`;
            }


            // 2. Renderiza visualmente el checklist de evidencias
            panel.innerHTML = evidenciasArr.length === 0
                ? `<div class="alert alert-warning text-center">No hay evidencias requeridas para esta acci√≥n.</div>`
                : `
        <div class="checklist-evidencias-list mx-auto" style="
            max-width: 600px;
            min-width: 270px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            background: rgba(250,252,255,0.77);
            border-radius: 1.1rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.06);
            padding: 1rem 0.6rem 1rem 0.6rem;
            ">
            ${evidenciasArr.map((ev, idx) => {
                    const subido = ev.uploads && ev.uploads[cicloActivo];
                    return `
                    <div class="d-flex align-items-center justify-content-between gap-3 checklist-evidencia-item px-2 py-2 mb-1"
                        style="
                            border-radius:.6rem;
                            background:${subido ? "#e9faee" : "#fff"};
                            border:1px solid ${subido ? "#8de5b7" : "#dde3e9"};
                            font-size:.96em;
                            transition:background .16s;
                        ">
                        <div class="d-flex align-items-center gap-2 flex-grow-1" title="${ev.nombre}">
                            <span style="font-size:1.35em;" class="text-muted">
                                <i class="fas ${iconoPorTipo(ev.formato)}"></i>
                            </span>
                            <div class="flex-grow-1" >
                                <div class="fw-semibold text-truncate" title="${ev.nombre}" style="font-size:.97em;">${limitarTexto(ev.nombre, 35)}</div>
                                <div class="small text-muted text-truncate" title="${ev.descripcion}" style="font-size:.94em;">${ev.descripcion || ''}</div>
                                <div class="small">
                                    <span class="badge rounded-pill bg-light border border-1 text-dark" style="font-size:.80em;">
                                        ${ev.formato ? (ev.formato) : 'Sin tipo'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-center gap-1" style="min-width:100px;">
                            <div class="custom-upload-group position-relative" style="min-width:110px; max-width:185px;">
                        <input type="file"
                            id="inputEvidencia_${ev.id}"
                            class="form-control visually-hidden"
                            accept="${mimePorTipo(ev.formato)}"
                            onchange="subirEvidenciaArchivoWizard('${idAccion}','${ev.id}','${cicloActivo}', this)">
                        <label for="inputEvidencia_${ev.id}" 
                            id="labelEvidencia_${ev.id}"
                            class="btn btn-outline-info btn-sm d-flex align-items-center gap-2 px-2 py-1 w-100 mb-1"
                            style="font-size:.80em; border-radius: .9em;">
                            <i class="fas fa-upload"></i>
                            <span class="text-nowrap">Subir archivo</span>
                            <span class="badge rounded-pill bg-light border border-1 text-warning ms-auto" style="font-size:.78em;">
                                ${ev.formato ? ev.formato : 'Archivo'}
                            </span>
                        </label>

                        <div id="archivoSeleccionado_${ev.id}" class="small text-truncate mt-1" style="font-size:.91em; color:#666;"></div>
                    </div>

                            <div id="checkEvidencia${ev.id}" class="fw-semibold ${subido ? 'text-success' : 'text-muted'}" style="font-size:.93em;">
                                ${subido
                            ? `<i class="fas fa-check-circle"></i> Subido`
                            : `<i class="fas fa-circle"></i> Pendiente`
                        }
                            </div>
                        </div>
                    </div>
                `;
                }).join('')}
        </div>
        `;

            // Luego, habilita el bot√≥n finalizar solo si todas est√°n subidas
            validarEvidenciasCompletas(panel, evidenciasArr, cicloActivo);

        }


        function iconoPorTipo(tipo) {
            switch ((tipo || '').toLowerCase()) {
                case 'pdf': return 'fa-file-pdf text-danger';
                case 'word': return 'fa-file-word text-danger';
                case 'excel': return 'fa-file-excel text-success';
                case 'imagen': case 'jpg': case 'jpeg': case 'png': return 'fa-file-image text-primary';
                default: return 'fa-file-alt text-secondary';
            }
        }
        function mimePorTipo(tipo) {
            switch ((tipo || '').toLowerCase()) {
                case 'pdf': return 'application/pdf';
                case 'excel': return '.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                case 'imagen': case 'jpg': case 'jpeg': case 'png': return 'image/*';
                default: return '';
            }
        }


        window.subirEvidenciaArchivoWizard = async function (idAccion, idEvidencia, ciclo, inputFile) {
            if (!inputFile.files.length) return;
            const archivo = inputFile.files[0];
            const nombreArchivo = archivo.name;

            const checkDiv = document.getElementById(`checkEvidencia${idEvidencia}`);
            const fileNameDiv = document.getElementById(`archivoSeleccionado_${idEvidencia}`);
            if (fileNameDiv) fileNameDiv.textContent = nombreArchivo;

            if (archivo.size > 15 * 1024 * 1024) {
                checkDiv.innerHTML = `<i class="fas fa-times-circle text-danger"></i> Archivo muy grande`;
                checkDiv.classList.remove('text-success', 'text-muted');
                checkDiv.classList.add('text-danger');
                if (fileNameDiv) fileNameDiv.textContent = '';
                mostrarToast("El archivo supera el l√≠mite de 15 MB.", "danger");
                return;
            }

            checkDiv.innerHTML = `<span class="spinner-border spinner-border-sm text-primary"></span> Subiendo...`;
            checkDiv.classList.remove('text-success', 'text-muted', 'text-danger');

            try {
                // Subir archivo a Firebase Storage (MODULAR API)
                const storagePath = `PlanItOne/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${ciclo}/${nombreArchivo}`;
                const fileStorageRef = refStorage(storage, storagePath); // storage viene de getStorage(firebaseApp)
                await uploadBytes(fileStorageRef, archivo);
                const urlArchivo = await getDownloadURL(fileStorageRef);

                // Guardar metadata en DB (Realtime)
                const uploadMeta = {
                    url: urlArchivo,
                    nombre: nombreArchivo,
                    fecha_subida: new Date().toISOString(),
                    usuario: window.correoUsuario || null,
                    size: archivo.size,
                    type: archivo.type,
                };
                const dbPath = `/PolariScore/evidencias/${idAccion}/${idEvidencia}/uploads/${ciclo}`;
                await set(ref(db, dbPath), uploadMeta); // db viene de getDatabase(firebaseApp)

                checkDiv.innerHTML = `<i class="fas fa-check-circle"></i> Subido`;
                checkDiv.classList.remove('text-muted', 'text-danger');
                checkDiv.classList.add('text-success');
                if (fileNameDiv) fileNameDiv.textContent = nombreArchivo;

                mostrarToast("Archivo subido correctamente.", "success");

                // Actualiza el bot√≥n: Cambia color y texto a "Reemplazar archivo"
                const labelBtn = document.getElementById(`labelEvidencia_${idEvidencia}`);
                if (labelBtn) {
                    labelBtn.classList.remove('btn-outline-info');
                    labelBtn.classList.add('btn-outline-warning');
                    labelBtn.querySelector('span.text-nowrap').textContent = "Reemplazar";
                    const icon = labelBtn.querySelector('i.fas');
                    if (icon) icon.className = "fas fa-sync-alt";
                }

                // Actualiza el array evidenciasArr en memoria:
                const evidenciaIndex = evidenciasArr.findIndex(ev => ev.id === idEvidencia);
                if (evidenciaIndex !== -1) {
                    evidenciasArr[evidenciaIndex].uploads = evidenciasArr[evidenciaIndex].uploads || {};
                    evidenciasArr[evidenciaIndex].uploads[ciclo] = {
                        url: urlArchivo,
                        nombre: nombreArchivo,
                    };
                }
                // Panel debe ser tu panel actual (o p√°salo por referencia si no est√° en global)
                const panel = document.getElementById('panelEvidenciasWizard');
                validarEvidenciasCompletas(panel, evidenciasArr, ciclo);

            } catch (error) {
                checkDiv.innerHTML = `<i class="fas fa-times-circle text-danger"></i> Error al subir`;
                checkDiv.classList.remove('text-success', 'text-muted');
                checkDiv.classList.add('text-danger');
                if (fileNameDiv) fileNameDiv.textContent = '';
                mostrarToast("Ocurri√≥ un error al subir el archivo.", "danger");
                console.error("Error al subir archivo evidencia:", error);
            }
        };


        function llenarResumenPaso4() {
            // Asume que tienes estas variables globales llenas desde los pasos previos:
            // window.metaSeleccionada, window.accionSeleccionada, window.descripcionEvidencia, window.archivosSeleccionados

            document.getElementById('resumenMeta').textContent = window.metaSeleccionada?.nombre || '';
            document.getElementById('resumenAccion').textContent = window.accionSeleccionada?.nombre || '';
            document.getElementById('resumenDescripcion').textContent = window.descripcionEvidencia || '';

            // Archivos
            const archivos = window.archivosSeleccionados || [];
            const contenedor = document.getElementById('listaResumenArchivos');
            if (archivos.length === 0) {
                contenedor.innerHTML = `<span class="text-muted small">No se han subido archivos.</span>`;
            } else {
                contenedor.innerHTML = archivos.map(file => `
                <div class="d-flex align-items-center py-2 border-bottom" style="gap: 12px;">
                    <i class="fas ${obtenerIconoPorTipo(file.name)} fs-4"></i>
                    <span class="flex-grow-1">${file.name}</span>
                    <span class="badge bg-light text-dark px-2">${(file.size / 1024 / 1024).toFixed(2)}MB</span>
                    <a href="${file.url || '#'}" target="_blank" class="btn btn-outline-success btn-sm ms-2">
                        <i class="fas fa-eye"></i> Ver
                    </a>
                    <button class="btn btn-outline-danger btn-sm ms-2" onclick="eliminarArchivoResumen('${file.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
            }
        }


        function obtenerExtensionFormato(nombreArchivo) {
            if (!nombreArchivo || typeof nombreArchivo !== "string") return "";
            const partes = nombreArchivo.split(".");
            return partes.length > 1 ? partes.pop().toLowerCase() : "";
        }

        // Helper para icono seg√∫n tipo archivo
        function obtenerIconoPorTipo(nombre) {
            if (nombre.match(/\.pdf$/i)) return 'fa-file-pdf text-danger';
            if (nombre.match(/\.(jpg|jpeg|png|gif)$/i)) return 'fa-file-image text-primary';
            if (nombre.match(/\.(xls|xlsx)$/i)) return 'fa-file-excel text-success';
            return 'fa-file text-secondary';
        }

        // Puedes implementar eliminarArchivoResumen si permites borrar en este paso.

        function renderizarResumenEvidencias() {
            // Sup√≥n que tienes window.evidenciasSubidas = [{ meta, accion, descripcion, archivos: [..] }]
            const evidencias = window.evidenciasSubidas || [];
            // Obt√©n metas y acciones √∫nicas
            const metasSet = new Set();
            const accionesSet = new Set();
            evidencias.forEach(e => {
                metasSet.add(e.metaNombre);
                accionesSet.add(e.accionNombre);
            });

            document.getElementById('resumenTotalMetas').textContent = metasSet.size;
            document.getElementById('resumenTotalAcciones').textContent = accionesSet.size;
            document.getElementById('resumenTotalEvidencias').textContent = evidencias.length;

            // Tabla
            const tbody = document.getElementById('tablaResumenEvidencias');
            if (evidencias.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No has subido ninguna evidencia a√∫n.</td></tr>`;
            } else {
                tbody.innerHTML = evidencias.map((ev, idx) => `
                <tr>
                    <td class="text-start">${limitarTexto(ev.metaNombre, 10)}</td>
                    <td class="text-start">${limitarTexto(ev.accionNombre, 10)}</td>
                    <td class="text-center">
                        ${ev.archivos.map(f => `<span class="badge bg-light text-dark mx-1">${f.name}</span>`).join('')}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-sm" onclick="abrirModalEdicionEvidencia(${idx})">
                            <i class="fas fa-edit"></i> Revisar
                        </button>
                    </td>
                </tr>
            `).join('');
            }


        }


        function validarEvidenciasCompletas(panel, evidenciasArr, cicloActivo) {
            const btnFinalizar = document.getElementById('btnFinalizarEvidenciasWizard');

            // El bot√≥n solo se deshabilita si no hay ninguna evidencia en el checklist
            btnFinalizar.disabled = evidenciasArr.length === 0;

            btnFinalizar.onclick = function () {
                // Identifica las que NO han sido subidas en este ciclo
                const pendientes = evidenciasArr.filter(ev => !(ev.uploads && ev.uploads[cicloActivo]));

                if (pendientes.length > 0) {
                    // Alerta elegante, puedes reemplazar por modal SweetAlert o similar
                    const nombresPendientes = pendientes.map(ev => `‚Ä¢ ${ev.nombre}`).join('<br>');
                    Swal.fire({
                        icon: 'warning',
                        title: '¬°Evidencias pendientes!',
                        html: `
                        No se han subido las siguientes evidencias:<br>
                        <div class="text-start mt-2" style="font-size:.97em;">${nombresPendientes}</div>
                        <br>
                        ¬øDeseas finalizar de todas formas?
                    `,
                        showCancelButton: true,
                        confirmButtonText: 'S√≠, finalizar',
                        cancelButtonText: 'Seguir subiendo'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            finalizarEntregaEvidencias();
                        }
                        // Si cancela, no hace nada y puede seguir subiendo.
                    });
                } else {
                    finalizarEntregaEvidencias();
                }
            };
        }

        function finalizarEntregaEvidencias() {
            // Aqu√≠ podr√≠as hacer alg√∫n guardado extra si hace falta (API, Firebase, etc.)
            // Por ahora solo mostramos confirmaci√≥n

            Swal.fire({
                icon: 'success',
                title: '¬°Entrega completada!',
                text: 'Tus evidencias fueron subidas correctamente.',
                confirmButtonText: 'Aceptar',
                timer: 2500,
                timerProgressBar: true
            }).then(() => {
                // Despu√©s de aceptar o de que pase el timer, cerrar popup
                window.close();
            });
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Choices.js JS -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

</body>

</html>